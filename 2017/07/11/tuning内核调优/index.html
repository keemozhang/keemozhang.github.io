<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"keemozhang.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="一、内核参数文档的查看1. 在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用安装kernel-doc 1[root@student02 ~]# yum -y install kernel-doc  所有的内核参数都可以查询文档 1[root@student02 ~]# ls &#x2F;usr&#x2F;share&#x2F;doc&#x2F;kernel-doc-3">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux性能调优">
<meta property="og:url" content="https://keemozhang.com/2017/07/11/tuning%E5%86%85%E6%A0%B8%E8%B0%83%E4%BC%98/index.html">
<meta property="og:site_name" content="keemozhang blog">
<meta property="og:description" content="一、内核参数文档的查看1. 在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用安装kernel-doc 1[root@student02 ~]# yum -y install kernel-doc  所有的内核参数都可以查询文档 1[root@student02 ~]# ls &#x2F;usr&#x2F;share&#x2F;doc&#x2F;kernel-doc-3">
<meta property="og:locale">
<meta property="article:published_time" content="2017-07-11T15:45:20.000Z">
<meta property="article:modified_time" content="2022-12-14T07:55:49.983Z">
<meta property="article:author" content="keemozhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://keemozhang.com/2017/07/11/tuning%E5%86%85%E6%A0%B8%E8%B0%83%E4%BC%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Linux性能调优 | keemozhang blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">keemozhang blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/tuning%E5%86%85%E6%A0%B8%E8%B0%83%E4%BC%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux性能调优
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 23:45:20" itemprop="dateCreated datePublished" datetime="2017-07-11T23:45:20+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="一、内核参数文档的查看"><a href="#一、内核参数文档的查看" class="headerlink" title="一、内核参数文档的查看"></a>一、内核参数文档的查看</h3><h4 id="1-在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用"><a href="#1-在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用" class="headerlink" title="1. 在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用"></a>1. 在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用</h4><p>安装kernel-doc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install kernel-doc</span></span><br></pre></td></tr></table></figure>

<p>所有的内核参数都可以查询文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ls /usr/share/doc/kernel-doc-3.10.0/Documentation/</span></span><br></pre></td></tr></table></figure>

<p>可以查询vm.drop_caches参数的文档，在文件vm.txt的182行记录echo 3 可以清空内存里面的缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># grep -irn --color=auto vm.drop_caches /usr/share/doc/kernel-doc-3.10.0/Documentation/</span></span><br><span class="line">/usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/vm.txt:178:   <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">/usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/vm.txt:180:   <span class="built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">/usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/vm.txt:182:   <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>

<h3 id="二、性能调优工具"><a href="#二、性能调优工具" class="headerlink" title="二、性能调优工具"></a>二、性能调优工具</h3><h4 id="1-tuned"><a href="#1-tuned" class="headerlink" title="1. tuned"></a>1. tuned</h4><p>安装tuned启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install tuned</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl start tuned</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl enable tuned</span></span><br></pre></td></tr></table></figure>

<p>查看系统中对于不同应用场景的调优方案</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tuned-adm list</span></span><br><span class="line">Available profiles:</span><br><span class="line">- balanced                    - General non-specialized tuned profile</span><br><span class="line">- desktop                     - Optmize <span class="keyword">for</span> the desktop use-case</span><br><span class="line">- latency-performance         - Optimize <span class="keyword">for</span> deterministic performance at the cost of increased power consumption</span><br><span class="line">- network-latency             - Optimize <span class="keyword">for</span> deterministic performance at the cost of increased power consumption, focused on low latency network performance</span><br><span class="line">- network-throughput          - Optimize <span class="keyword">for</span> streaming network throughput.  Generally only necessary on older CPUs or 40G+ networks.</span><br><span class="line">- powersave                   - Optimize <span class="keyword">for</span> low power consumption</span><br><span class="line">- throughput-performance      - Broadly applicable tuning that provides excellent performance across a variety of common server workloads.  This is the default profile     <span class="keyword">for</span> RHEL7.</span><br><span class="line">- virtual-guest               - Optimize <span class="keyword">for</span> running inside a virtual guest.</span><br><span class="line">- virtual-host                - Optimize <span class="keyword">for</span> running KVM guests</span><br><span class="line">Current active profile: virtual-guest</span><br></pre></td></tr></table></figure>

<p>查看当前的调优方案</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tuned-adm active</span></span><br><span class="line">Current active profile: virtual-guest</span><br></pre></td></tr></table></figure>

<p><code>balanced</code>：一般的非专业的调优配置     </p>
<p><code>desktop</code>：优化桌面使用环境</p>
<p><code>latency-performance</code>：以增加功耗为代价优化确定的性能</p>
<p><code>network-latency</code>：以增加功耗为代价优化确定的性能，重点是低延迟网络性能</p>
<p><code>network-throughput</code>：优化网络吞吐量，一般只需要用在旧的CPU和40G+的网络中</p>
<p><code>powersave</code>：低功率的优化</p>
<p><code>throughput-performance</code>：广泛适用的调整，可在各种常见服务器工作负载下提供出色的性能，这是RHEL7的默认配置文件。</p>
<p><code>virtual-guest</code>：优化运行在主机内部的虚拟机</p>
<p><code>virtual-host</code>：优化运行KVM虚拟机的主机</p>
<p>使用高性能的配置策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tuned-adm profile throughput-performance </span></span><br><span class="line">[root@student02 ~]<span class="comment"># tuned-adm active </span></span><br><span class="line">Current active profile: throughput-performance</span><br></pre></td></tr></table></figure>

<p>tuned调优的配置文件，也可以自己添加一个目录，修改成自己适合的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ls /usr/lib/tuned/</span></span><br><span class="line">balanced  desktop  <span class="built_in">functions</span>  latency-performance  network-latency  network-throughput  powersave  recommend.conf  throughput-performance  virtual-guest  virtual-host</span><br></pre></td></tr></table></figure>

<h4 id="2-limits"><a href="#2-limits" class="headerlink" title="2. limits"></a>2. limits</h4><p>limits的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br></pre></td></tr></table></figure>

<p>硬限制用户只能打开2048个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line">student          hard    nofile          2048</span><br><span class="line">[student@student02 ~]$ <span class="built_in">ulimit</span> -n</span><br><span class="line">2048</span><br></pre></td></tr></table></figure>

<p>硬限制用户只能使用10M虚拟内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line">student          hard    as              102400</span><br><span class="line">[I have no name!@student02 ~]$ <span class="built_in">ulimit</span> -v</span><br><span class="line">102400</span><br></pre></td></tr></table></figure>

<p>查看limits对我的所有限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ulimit -a</span></span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 3821</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 65535</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 3821</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br></pre></td></tr></table></figure>

<p>软限制用户只能使用100M虚拟内存，用户可以在硬限制范围内修改软限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line">student          soft    as              102400</span><br><span class="line">[root@student02 ~]<span class="comment"># ulimit -v</span></span><br><span class="line">10240</span><br><span class="line">[root@student02 ~]<span class="comment"># ulimit -v 20480</span></span><br></pre></td></tr></table></figure>

<h4 id="3-cgroup"><a href="#3-cgroup" class="headerlink" title="3. cgroup"></a>3. cgroup</h4><p>安装cgroup启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install libcgroup-tools</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl start cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl enable cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl start cgred</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl enable cgred</span></span><br></pre></td></tr></table></figure>

<p>启动服务后会产生一个cgroup的临时目录，查看对各种资源限制的配置，每个目录里面还有很多限制子选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># df -h |grep cgroup</span></span><br><span class="line">tmpfs       489M     0  489M   0% /sys/fs/cgroup</span><br><span class="line">[root@student02 cgroup]<span class="comment"># ls</span></span><br><span class="line">blkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  systemd    cpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio  pids</span><br></pre></td></tr></table></figure>

<p>查看参数名，cgconfig.conf中创建一个组test，限制磁盘读bps为1M，内存使用256M</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ll /dev/sda</span></span><br><span class="line">brw-rw---- 1 root disk 8, 0 Jun  1 20:43 /dev/sda</span><br><span class="line">[root@student02 ~]<span class="comment"># ls /sys/fs/cgroup/blkio/test/ |grep read_bps</span></span><br><span class="line">blkio.throttle.read_bps_device</span><br><span class="line">[root@student02 ~]<span class="comment"># ls /sys/fs/cgroup/memory/ |grep memory.limit</span></span><br><span class="line">memory.limit_in_bytes</span><br><span class="line">[root@student02 ~]<span class="comment"># vim /etc/cgconfig.conf</span></span><br><span class="line">group <span class="built_in">test</span> &#123;</span><br><span class="line">blkio &#123;</span><br><span class="line">blkio.throttle.read_bps_device = <span class="string">&quot;8:0 1048576&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">memory &#123;</span><br><span class="line">memory.limit_in_bytes = <span class="string">&quot;256M&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/blkio/test/blkio.throttle.read_bps_device </span></span><br><span class="line">8:0 1048576</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/memory/test/memory.limit_in_bytes </span></span><br><span class="line">268435456</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgconfig</span></span><br></pre></td></tr></table></figure>

<p>cgrules.conf中配置策略，用户student的blkio和memory应用test组策略的限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/cgrules.conf</span></span><br><span class="line">student         blkio,memory    <span class="built_in">test</span>/</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgred</span></span><br></pre></td></tr></table></figure>

<p>也可以具体限制到命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/cgrules.conf</span></span><br><span class="line">student:<span class="built_in">cp</span>      blkio,memory    <span class="built_in">test</span>/</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgred</span></span><br></pre></td></tr></table></figure>

<h3 id="三、系统状态监控工具"><a href="#三、系统状态监控工具" class="headerlink" title="三、系统状态监控工具"></a>三、系统状态监控工具</h3><h4 id="1-iostat命令，监控系统设备的IO负载情况"><a href="#1-iostat命令，监控系统设备的IO负载情况" class="headerlink" title="1. iostat命令，监控系统设备的IO负载情况"></a>1. iostat命令，监控系统设备的IO负载情况</h4><p>不接参数，显示系统启动以来的i&#x2F;o状态的平均结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># iostat</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span>  %system %iowait  %steal   %idle</span><br><span class="line">0.26    0.03    0.42    0.28    0.00   99.01</span><br></pre></td></tr></table></figure>

<p><code>%user</code>：显示在用户级别(application)运行使用 CPU 总时间的百分比。</p>
<p><code>%nice</code>：显示在用户级别，用于nice操作，所占用 CPU 总时间的百分比。</p>
<p><code>%system</code>：在核心级别(kernel)运行所使用 CPU 总时间的百分比。</p>
<p><code>%iowait</code>：显示用于等待I&#x2F;O操作占用 CPU 总时间的百分比。</p>
<p><code>%steal</code>：管理程序(hypervisor)为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。</p>
<p><code>%idle</code>：显示 CPU 空闲时间占用 CPU 总时间的百分比。</p>
<blockquote>
<ol>
<li>若 %iowait 的值过高，表示硬盘存在I&#x2F;O瓶颈</li>
<li>若 %idle 的值高但系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量</li>
<li>若 %idle 的值持续低于1，则系统的 CPU处理能力相对较低，表明系统中最需要解决的资源是 CPU 。</li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># iostat 1 #1秒钟显示一次，一直监控</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 2 #1秒钟显示一次，监控两次</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 2 sda #只显示sda磁盘</span></span><br><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/zero of=/dev/null &amp; #后台运行dd命令</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1#发现系统内核占用CPU资源很大</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">22.77    0.00   77.23    0.00    0.00    0.00</span><br><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/urandom of=/dev/null &amp; #写入随机数</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 #CPU被系统占用完了</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">0.00    0.00  100.00    0.00    0.00    0.00</span><br><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/zero of=/tmp/test bs=1M count=1000 &amp; #往磁盘写入文件</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 #系统和iowait消耗CPU资源比较多</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">0.00    0.00   54.55   36.36    0.00    9.09</span><br><span class="line">Device:     tps     kB_read/s    kB_wrtn/s    kB_read    kB_wrtn <span class="comment">#以block为单位（512字节）</span></span><br><span class="line">sda         554.55     10909.09    196763.64       1200      21644</span><br></pre></td></tr></table></figure>

<p><code>Device</code>：磁盘设备</p>
<p><code>tps</code>：多少I&#x2F;O请求数&#x2F;s</p>
<p><code>kB_read/s</code>：读多少block&#x2F;s</p>
<p><code>kB_wrtn/s</code>：写多少block&#x2F;s</p>
<p><code>kB_read</code>：一共读block</p>
<p><code>kB_wrtn</code>：一共写block</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo &quot;(10909+196763)*512/1024/1024&quot; |bc</span></span><br><span class="line">101 <span class="comment">#计算出I/O速度为101M每秒</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat -x #显示更多的参数</span></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br></pre></td></tr></table></figure>

<blockquote>
<p>kB_wrtn&#x2F;s除以tps就可以得到每个I&#x2F;O的大小，可以通过I&#x2F;O大小判断组建哪种RAID，RAID5适合顺序的大I&#x2F;O，RAID10适合随机的小I&#x2F;</p>
</blockquote>
<h4 id="2-sar命令，对系统的活动进行报告"><a href="#2-sar命令，对系统的活动进行报告" class="headerlink" title="2. sar命令，对系统的活动进行报告"></a>2. sar命令，对系统的活动进行报告</h4><p>参数介绍：</p>
<p><code>-A</code>：所有报告的总和</p>
<p><code>-u</code>：输出CPU使用情况的统计信息</p>
<p><code>-v</code>：输出inode、文件和其他内核表的统计信息</p>
<p><code>-d</code>：输出每一个块设备的活动信息</p>
<p><code>-r</code>：输出内存和交换空间的统计信息</p>
<p><code>-b</code>：显示I&#x2F;O和传送速率的统计信息</p>
<p><code>-a</code>：文件读写情况</p>
<p><code>-c</code>：输出进程统计信息，每秒创建的进程数</p>
<p><code>-R</code>：输出内存页面的统计信息</p>
<p><code>-y</code>：终端设备活动情况</p>
<p><code>-w</code>：输出系统交换活动信息</p>
<p>查看CPU负载信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -u 1 10</span></span><br><span class="line">04:56:39 PM     CPU     %user     %<span class="built_in">nice</span>   %system   %iowait    %steal     %idle</span><br><span class="line">04:56:40 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br></pre></td></tr></table></figure>

<p><code>%user</code>：显示在用户级别(application)运行使用 CPU 总时间的百分比。</p>
<p><code>%nice</code>：显示在用户级别，用于nice操作，所占用 CPU 总时间的百分比。</p>
<p><code>%system</code>：在核心级别(kernel)运行所使用 CPU 总时间的百分比。</p>
<p><code>%iowait</code>：显示用于等待I&#x2F;O操作占用 CPU 总时间的百分比。</p>
<p><code>%steal</code>：管理程序(hypervisor)为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。</p>
<p><code>%idle</code>：显示 CPU 空闲时间占用 CPU 总时间的百分比。</p>
<blockquote>
<ol>
<li>若 %iowait 的值过高，表示硬盘存在I&#x2F;O瓶颈</li>
<li>若 %idle 的值高但系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量</li>
<li>若 %idle 的值持续低于1，则系统的 CPU处理能力相对较低，表明系统中最需要解决的资源是 CPU 。</li>
</ol>
</blockquote>
<p>以24小时制来显示时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># alias sar=&#x27;LANG=C sar&#x27;</span></span><br></pre></td></tr></table></figure>
<p>内存和交换空间监控</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -r 1 10</span></span><br><span class="line">17:02:29    kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">17:02:30       688816    311124     31.11        12    177876    221100      7.14    110672    103680         4</span><br></pre></td></tr></table></figure>

<p><code>kbmemfree</code>：这个值和free命令中的free值基本一致,所以它不包括buffer和cache的空间.</p>
<p><code>kbmemused</code>：这个值和free命令中的used值基本一致,所以它包括buffer和cache的空间.</p>
<p><code>%memused</code>：这个值是kbmemused和内存总量(不包括swap)的一个百分比.</p>
<p><code>kbbuffers和kbcached</code>：这两个值就是free命令中的buffer和cache.</p>
<p><code>kbcommit</code>：保证当前系统所需要的内存,即为了确保不溢出而需要的内存(RAM+swap).</p>
<p><code>%commit</code>：这个值是kbcommit与内存总量(包括swap)的一个百分比.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -d 1 10 #显示磁盘负载信息以及10s的平均负载</span></span><br><span class="line">[root@student02 ~]<span class="comment"># sar -u 1 10 #显示CPU负载信息以及10s的平均负载</span></span><br><span class="line">[root@student02 ~]<span class="comment"># sar -r 1 10 #显示内存负载以及10s的平均负载</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /etc/cron.d/sysstat |egrep -v &quot;^#|^$&quot; #系统本来就有sar的计划任务</span></span><br><span class="line">*/10 * * * * root /usr/lib64/sa/sa1 1 1</span><br><span class="line">53 23 * * * root /usr/lib64/sa/sa2 -A</span><br><span class="line">[root@student02 ~]<span class="comment"># ls /var/log/sa/ #计划任务记录每天的记录</span></span><br><span class="line">sa01  sa22  sa23  sa24  sa25  sa26  sa27  sa30  sa31  sar22</span><br><span class="line">[root@student02 ~]<span class="comment"># sar -f /var/log/sa/sa01 #查看文件中保存的记录</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /var/log/sa/sar01 #查看一天的汇总记录</span></span><br><span class="line">[root@student02 ~]<span class="comment"># sar -u -s 15:00:00 -e 16:00:00 -f /var/log/sa/sa01 #查看时间范围内的记录</span></span><br></pre></td></tr></table></figure>

<h4 id="3-vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况-IO读写情况"><a href="#3-vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况-IO读写情况" class="headerlink" title="3. vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况"></a>3. vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vmstat 1 10</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line">r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">1  0      0 835992     12  84764    0    0  8890   160   83   71  0  3 96  1  0</span><br></pre></td></tr></table></figure>
<p><code>r</code>：表示运行队列，多少个进程分配到cpu，这个值超过了CPU数目就会出现CPU瓶颈，如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。</p>
<p><code>b</code>：表示阻塞的进程</p>
<p><code>swpd</code>： 虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了。</p>
<p><code>free</code>：空闲的物理内存的大小。</p>
<p><code>buff</code>：存储文件列表，权限等的缓存。</p>
<p><code>cache</code>：文件内容的缓存。</p>
<p><code>si</code>：每秒从磁盘读入虚拟内存的大小。</p>
<p><code>so</code>：每秒虚拟内存写入磁盘的大小。</p>
<p><code>bi</code>：块设备每秒接收的块数量。</p>
<p><code>bo</code>：块设备每秒发送的块数量，读取文件，bo就会大于0。</p>
<p><code>in</code>：每秒CPU的中断次数，包括时间中断。</p>
<p><code>cs</code>：CPU每秒上下文切换次数，调用系统函数，线程的切换要进行上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目，web服务器中需要调节这个值最小。</p>
<p><code>us</code>：用户CPU时间</p>
<p><code>sy</code>：系统CPU时间</p>
<p><code>id</code>：空闲CPU时间</p>
<p><code>wt</code>：I&#x2F;O等待CPU时间</p>
<h4 id="4-free"><a href="#4-free" class="headerlink" title="4. free"></a>4. free</h4><p>free命令是linux的一个入门级命令，显示的是一个比较总述性的信息，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># free -m</span></span><br><span class="line">total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            976         132         600           6         242         626</span><br><span class="line">Swap:          2047           0        2047</span><br></pre></td></tr></table></figure>

<p>比如上面的输出中，我们大致可以看到我总内存为1G（995，其中hardward和firmware在启动时会预先占用一点）。其中已使用874M ，其中可用121M，buffers和cached加用的量为105M + 249M ，这里需要注意的是平时我们在查看时，一般会以第二行的结果为准，即实际可用477M，已用518M。为什么这样说？因为buffers和cached是为了加快运算速度，会预占用一部分内存，可以理解为缓存的概念。由于这部分不是本篇的重点，想深究的可以找谷歌。这部分内存可以通过如下的命令进行回收：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -w vm.drop_caches=3</span></span><br><span class="line">vm.drop_caches = 3</span><br></pre></td></tr></table></figure>
<p>在有业务运行的情况下，强烈不建议这样操作，因为可能会造成数据丢失。</p>
<h4 id="5-top"><a href="#5-top" class="headerlink" title="5. top"></a>5. top</h4><p>即然内存被使用，到底被谁占去了呢？可以借助强大的top查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># top</span></span><br><span class="line">top - 11:54:31 up  2:26,  1 user,  load average: 0.00, 0.01, 0.05</span><br><span class="line">Tasks:  97 total,   1 running,  96 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :   999940 total,   824676 free,    83216 used,    92048 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  2097148 free,        0 used.   774152 avail Mem </span><br><span class="line"></span><br><span class="line">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND             </span><br><span class="line">879 root      20   0  553152  16424   5784 S  0.0  1.6   0:02.76 tuned               </span><br><span class="line">647 polkitd   20   0  527516  11984   4580 S  0.0  1.2   0:00.18 polkitd             </span><br><span class="line">671 root      20   0  437488   7848   6068 S  0.0  0.8   0:00.19 NetworkManager</span><br></pre></td></tr></table></figure>
<p>在top下我们输入大M就可以按内存使用率排序。上面可以看到我内存主要被hhvm进程占用掉了，占比总内存的34.3% 。可以看到，实际上top上面也有free的功能，对memory会有概述性报告的。其中RES是我们要关注的项，即实际该进程占用的内存量，基本上这样我们就定位到内存用到那去了。现网中经常还需要一种情况，top看到的所有进程的RES使用都不大，而内存一下子少了几十G，这个怎么破呢？看下面。</p>
<h4 id="6-x2F-proc-x2F-meminfo"><a href="#6-x2F-proc-x2F-meminfo" class="headerlink" title="6. &#x2F;proc&#x2F;meminfo"></a>6. &#x2F;proc&#x2F;meminfo</h4><p>meminfo文件显示出的也是内存的概述性信息，只不过其比free -m的结果要更详细，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@361way ~]<span class="comment"># cat /proc/meminfo</span></span><br><span class="line">MemTotal:        1019644 kB    所有可用RAM大小 （即物理内存减去一些预留位和内核的二进</span><br><span class="line">制代码大小）</span><br><span class="line">MemFree:          119464 kB    LowFree与HighFree的总和，被系统留着未使用的内存</span><br><span class="line">Buffers:          110680 kB    用来给文件做缓冲大小</span><br><span class="line">Cached:           256796 kB    被高速缓冲存储器（cache memory）用的内存的大小（等于</span><br><span class="line">diskcache +　SwapCache ）</span><br><span class="line">SwapCached:            0 kB　　　</span><br><span class="line">Active:           680560 kB　　在活跃使用中的缓冲或高速缓冲存储器页面文件的大小，除非非常必要否则不会被移作他用</span><br><span class="line">Inactive:         145228 kB    在不经常使用中的缓冲或高速缓冲存储器页面文件的大小，可能被用于其他途径</span><br><span class="line">Active(anon):     458208 kB</span><br><span class="line">Inactive(anon):      280 kB</span><br><span class="line">Active(file):     222352 kB</span><br><span class="line">Inactive(file):   144948 kB</span><br><span class="line">Unevictable:           0 kB</span><br><span class="line">Mlocked:               0 kB</span><br><span class="line">SwapTotal:             0 kB</span><br><span class="line">SwapFree:              0 kB</span><br><span class="line">Dirty:                92 kB   脏页，等待被写回到磁盘的内存大小</span><br><span class="line">Writeback:             0 kB   正在被写回到磁盘的内存大小</span><br><span class="line">AnonPages:        458328 kB   未映射页的内存大小</span><br><span class="line">Mapped:            27072 kB   设备和文件等映射的大小</span><br><span class="line">Shmem:               176 kB</span><br><span class="line">Slab:              53564 kB   内核数据结构缓存的大小，可以减少申请和释放内存带来的消耗</span><br><span class="line">SReclaimable:      32404 kB   可收回Slab的大小</span><br><span class="line">SUnreclaim:        21160 kB   不可收回Slab的大小（SUnreclaim+SReclaimable＝Slab）</span><br><span class="line">KernelStack:        1136 kB   内核栈大小占用的内存</span><br><span class="line">PageTables:         5856 kB   管理内存分页页面的索引表的大小</span><br><span class="line">NFS_Unstable:          0 kB   不稳定页表的大小</span><br><span class="line">Bounce:                0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line">CommitLimit:      509820 kB</span><br><span class="line">Committed_AS:    1483868 kB</span><br><span class="line">VmallocTotal:   34359738367 kB  可以vmalloc虚拟内存大小</span><br><span class="line">VmallocUsed:        7472 kB     已经被使用的虚拟内存大小</span><br><span class="line">VmallocChunk:   34359728764 kB</span><br><span class="line">HardwareCorrupted:     0 kB</span><br><span class="line">AnonHugePages:    198656 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">DirectMap4k:        7168 kB</span><br><span class="line">DirectMap2M:     1044480 kB</span><br></pre></td></tr></table></figure>

<h4 id="7-缓存命中率cache-hit"><a href="#7-缓存命中率cache-hit" class="headerlink" title="7. 缓存命中率cache-hit"></a>7. 缓存命中率cache-hit</h4><p>安装valgrind</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install valgrind</span></span><br></pre></td></tr></table></figure>

<p>查看命令或者脚本的cache-miss</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># valgrind --tool=cachegrind ls</span></span><br><span class="line">......</span><br><span class="line">==2005== D1  miss rate:     1.5% (    2.0%     +     0.8%  )</span><br><span class="line">==2005== LLd miss rate:     1.0% (    1.2%     +     0.7%  )</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="8-strace用来跟踪一个进程的系统调用或信号产生的情况"><a href="#8-strace用来跟踪一个进程的系统调用或信号产生的情况" class="headerlink" title="8. strace用来跟踪一个进程的系统调用或信号产生的情况"></a>8. strace用来跟踪一个进程的系统调用或信号产生的情况</h4><p>查看复制文件的状态跟踪</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># strace -fc cp /etc/passwd /tmp/</span></span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">25.08    0.000234           9        25           mmap</span><br><span class="line">19.40    0.000181          12        15           close</span><br><span class="line">17.58    0.000164          10        16           mprotect</span><br><span class="line">13.08    0.000122          10        12           open</span><br><span class="line">11.25    0.000105          10        11           <span class="built_in">read</span></span><br><span class="line">3.22    0.000030           3        12           fstat</span><br><span class="line">3.00    0.000028          14         2         1 access</span><br><span class="line">2.68    0.000025          13         2           munmap</span><br><span class="line">2.36    0.000022          22         1           execve</span><br><span class="line">0.54    0.000005           3         2           rt_sigaction</span><br><span class="line">0.32    0.000003           3         1           rt_sigprocmask</span><br><span class="line">0.32    0.000003           3         1           getrlimit</span><br><span class="line">0.32    0.000003           3         1           arch_prctl</span><br><span class="line">0.32    0.000003           3         1           set_tid_address</span><br><span class="line">0.32    0.000003           3         1           set_robust_list</span><br><span class="line">0.21    0.000002           1         3           brk</span><br><span class="line">0.00    0.000000           0         1           write</span><br><span class="line">0.00    0.000000           0         4         2 <span class="built_in">stat</span></span><br><span class="line">0.00    0.000000           0         1         1 lseek</span><br><span class="line">0.00    0.000000           0         1           geteuid</span><br><span class="line">0.00    0.000000           0         2         2 statfs</span><br><span class="line">0.00    0.000000           0         1           fadvise64</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00    0.000933                   116         6 total</span><br></pre></td></tr></table></figure>

<p>可以具体到查看命令打开了什么文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># strace -e open cp /etc/passwd /tmp/</span></span><br><span class="line">open(<span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libselinux.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libacl.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libattr.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libc.so.6&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libpcre.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libdl.so.2&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libpthread.so.0&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/proc/filesystems&quot;</span>, O_RDONLY)     = 3</span><br><span class="line">open(<span class="string">&quot;/usr/lib/locale/locale-archive&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY)           = 3</span><br><span class="line">open(<span class="string">&quot;/tmp/passwd&quot;</span>, O_WRONLY|O_TRUNC)   = 4</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>

<h4 id="9-ltrace用来跟踪进程调用库函数的情况"><a href="#9-ltrace用来跟踪进程调用库函数的情况" class="headerlink" title="9. ltrace用来跟踪进程调用库函数的情况"></a>9. ltrace用来跟踪进程调用库函数的情况</h4><p>查看命令对系统和库的调用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ltrace -Sfc cp /etc/passwd /tmp/</span></span><br><span class="line">% time     seconds  usecs/call     calls      <span class="keyword">function</span></span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line">42.06    0.013412       13412         1 __libc_start_main</span><br><span class="line">15.75    0.005023        5023         1 <span class="built_in">exit</span></span><br><span class="line">3.95    0.001261        1261         1 exit_group</span><br><span class="line">3.22    0.001027         342         3 __xstat</span><br><span class="line">2.97    0.000946         946         1 __errno_location</span><br><span class="line">2.82    0.000900          52        17 close</span><br><span class="line">2.81    0.000897         224         4 free</span><br><span class="line">2.51    0.000801         160         5 __freading</span><br><span class="line">2.40    0.000766         255         3 fclose</span><br><span class="line">1.93    0.000614         153         4 strlen</span><br><span class="line">1.80    0.000575         143         4 fileno</span><br><span class="line">1.55    0.000494          35        14 open</span><br><span class="line">1.33    0.000424         141         3 brk</span><br><span class="line">1.14    0.000362         181         2 fflush</span><br><span class="line">1.10    0.000350          26        13 <span class="built_in">read</span></span><br><span class="line">1.07    0.000340         340         1 posix_fadvise</span><br><span class="line">1.03    0.000327         109         3 malloc</span><br><span class="line">......</span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line">100.00    0.031885                   176 total</span><br></pre></td></tr></table></figure>

<h3 id="四、文件系统的调优"><a href="#四、文件系统的调优" class="headerlink" title="四、文件系统的调优"></a>四、文件系统的调优</h3><h4 id="1-tune2fs"><a href="#1-tune2fs" class="headerlink" title="1. tune2fs"></a>1. tune2fs</h4><p>查看文件系统信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tune2fs -l /dev/sda3 </span></span><br><span class="line">tune2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          b1b4ea64-5a17-421c-b022-3ac84c14a1e6</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision <span class="comment">#:    1 (dynamic)</span></span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype     needs_reco</span><br><span class="line">very extent 64bit flex_bg sparse_super large_file huge_file uninit_bg dir_nlink     extra_isizeFilesystem flags:         signed_directory_hash </span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">Filesystem state:         clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS <span class="built_in">type</span>:       Linux</span><br><span class="line">Inode count:              65536</span><br><span class="line">Block count:              262144</span><br><span class="line">Reserved block count:     13107</span><br><span class="line">Free blocks:              249189</span><br><span class="line">Free inodes:              65525</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Group descriptor size:    64</span><br><span class="line">Reserved GDT blocks:      127</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         8192</span><br><span class="line">Inode blocks per group:   512</span><br><span class="line">Flex block group size:    16</span><br><span class="line">Filesystem created:       Fri Jun  2 17:01:20 2017</span><br><span class="line">Last mount time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Last write time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      -1</span><br><span class="line">Last checked:             Fri Jun  2 17:01:20 2017</span><br><span class="line">Check interval:           0 (&lt;none&gt;)</span><br><span class="line">Lifetime writes:          33 MB</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:           256</span><br><span class="line">Required extra isize:     28</span><br><span class="line">Desired extra isize:      28</span><br><span class="line">Journal inode:            8</span><br><span class="line">Default directory <span class="built_in">hash</span>:   half_md4</span><br><span class="line">Directory Hash Seed:      448602f1-b2c4-4522-a428-3746969036d6</span><br><span class="line">Journal backup:           inode blocks</span><br></pre></td></tr></table></figure>

<p>df查看分区有一部分空间（976M-2.6M-907M&#x3D;66.4M）看不到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># df -h |grep sda3</span></span><br><span class="line">/dev/sda3            976M  2.6M  907M   1% /mnt</span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -l /dev/sda3 |grep &quot;Reserved block count&quot;</span></span><br><span class="line">Reserved block count:     26214</span><br></pre></td></tr></table></figure>

<p><code>Reserved GDT blocks</code>：每个分区5%的block会被保留</p>
<p>修改分区保留比例为1%</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tune2fs -m 10 /dev/sda3</span></span><br><span class="line">Setting reserved blocks percentage to 1% (26214 blocks)</span><br></pre></td></tr></table></figure>

<p>修改磁盘的UUID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># blkid |grep sda3</span></span><br><span class="line">/dev/sda3: UUID=<span class="string">&quot;b1b4ea64-5a17-421c-b022-3ac84c14a1e7&quot;</span> TYPE=<span class="string">&quot;ext4&quot;</span> </span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -U b1b4ea64-5a17-421c-b022-3ac84c14a1e8 /dev/sda3</span></span><br><span class="line">[root@student02 ~]<span class="comment"># blkid |grep sda3</span></span><br><span class="line">/dev/sda3: UUID=<span class="string">&quot;b1b4ea64-5a17-421c-b022-3ac84c14a1e8&quot;</span> TYPE=<span class="string">&quot;ext4&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-dumpe2fs，查看文件系统结构"><a href="#2-dumpe2fs，查看文件系统结构" class="headerlink" title="2. dumpe2fs，查看文件系统结构"></a>2. dumpe2fs，查看文件系统结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># dumpe2fs /dev/sda3 </span></span><br><span class="line">dumpe2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          b1b4ea64-5a17-421c-b022-3ac84c14a1e6</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision <span class="comment">#:    1 (dynamic)</span></span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype     needs_reco</span><br><span class="line">very extent 64bit flex_bg sparse_super large_file huge_file uninit_bg dir_nlink     extra_isizeFilesystem flags:         signed_directory_hash </span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">Filesystem state:         clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS <span class="built_in">type</span>:       Linux</span><br><span class="line">Inode count:              65536</span><br><span class="line">Block count:              262144</span><br><span class="line">Reserved block count:     13107</span><br><span class="line">Free blocks:              249189</span><br><span class="line">Free inodes:              65525</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Group descriptor size:    64</span><br><span class="line">Reserved GDT blocks:      127</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         8192</span><br><span class="line">Inode blocks per group:   512</span><br><span class="line">Flex block group size:    16</span><br><span class="line">Filesystem created:       Fri Jun  2 17:01:20 2017</span><br><span class="line">Last mount time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Last write time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      -1</span><br><span class="line">Last checked:             Fri Jun  2 17:01:20 2017</span><br><span class="line">Check interval:           0 (&lt;none&gt;)</span><br><span class="line">Lifetime writes:          33 MB</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:           256</span><br><span class="line">Required extra isize:     28</span><br><span class="line">Desired extra isize:      28</span><br><span class="line">Journal inode:            8</span><br><span class="line">Default directory <span class="built_in">hash</span>:   half_md4</span><br><span class="line">Directory Hash Seed:      448602f1-b2c4-4522-a428-3746969036d6</span><br><span class="line">Journal backup:           inode blocks</span><br><span class="line">Journal features:         journal_64bit</span><br><span class="line">Journal size:             32M</span><br><span class="line">Journal length:           8192</span><br><span class="line">Journal sequence:         0x00000002</span><br><span class="line">Journal start:            1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Group 0: (Blocks 0-32767) [ITABLE_ZEROED]</span><br><span class="line">Checksum 0x5492, unused inodes 8181</span><br><span class="line">Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">Reserved GDT blocks at 2-128</span><br><span class="line">Block bitmap at 129 (+129), Inode bitmap at 145 (+145)</span><br><span class="line">Inode table at 161-672 (+161)</span><br><span class="line">28521 free blocks, 8181 free inodes, 2 directories, 8181 unused inodes</span><br><span class="line">Free blocks: 142-144, 153-160, 4258-32767</span><br><span class="line">Free inodes: 12-8192</span><br><span class="line">Group 1: (Blocks 32768-65535) [INODE_UNINIT, ITABLE_ZEROED]</span><br><span class="line">Checksum 0xb3fe, unused inodes 8192</span><br><span class="line">Backup superblock at 32768, Group descriptors at 32769-32769</span><br><span class="line">Reserved GDT blocks at 32770-32896</span><br><span class="line">Block bitmap at 130 (<span class="built_in">bg</span> <span class="comment">#0 + 130), Inode bitmap at 146 (bg #0 + 146)</span></span><br><span class="line">Inode table at 673-1184 (<span class="built_in">bg</span> <span class="comment">#0 + 673)</span></span><br><span class="line">32639 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes</span><br><span class="line">Free blocks: 32897-65535</span><br><span class="line">Free inodes: 8193-16384</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><code>Journal size</code>：日志区大小</p>
<p><code>Group x</code>：文件系统会把block分成很多个group，每个group的大小为32768个block，当文件系统在使用的时候每个group都是平均使用的，不会使用完，当已经写入的文件需要扩大的时候可以就文件当前的group上面分配空间，让文件尽可能连续，不必到距离很远的block分配空间，可以提升文件读取性能。</p>
<p><code>superblock</code>：superblock在第0个group上，第1、3、 5、7、9个group上面有superblock的备份</p>
<p><code>Group descriptors</code>：每个group的第一个block存放group的描述信息</p>
<p><code>Reserved GDT blocks</code>：每个group有127个保留的block</p>
<p><code>Block bitmap</code>：记录block的位图区</p>
<p><code>Inode bitmap</code>：记录inode索引文件的位图区</p>
<p><code>Inode table</code>：inode索引表</p>
<p><code>Free blocks</code>：未使用的block</p>
<p><code>Free inodes</code>：未使用的inode</p>
<h4 id="3-修复文件系统"><a href="#3-修复文件系统" class="headerlink" title="3. 修复文件系统"></a>3. 修复文件系统</h4><p>破坏超级快和block保留区，挂载失败</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/zero of=/dev/sda3 bs=1K count=516</span></span><br><span class="line">[root@student02 ~]<span class="comment"># mount /dev/sda3 /mnt/</span></span><br><span class="line">mount: /dev/sda3 is write-protected, mounting read-only</span><br><span class="line">mount: unknown filesystem <span class="built_in">type</span> <span class="string">&#x27;(null)&#x27;</span></span><br></pre></td></tr></table></figure>

<p>用fsck修复文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># fsck -v /dev/sda3</span></span><br></pre></td></tr></table></figure>

<p>有的情况下fsck修复不了可以使用e2fsck指定超级快修复</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># e2fsck -b 98304 /dev/sda3</span></span><br></pre></td></tr></table></figure>

<h4 id="4-非日志型文件系统与日志型文件系统"><a href="#4-非日志型文件系统与日志型文件系统" class="headerlink" title="4. 非日志型文件系统与日志型文件系统"></a>4. 非日志型文件系统与日志型文件系统</h4><p>非日志型文件系统：fat32、ext2</p>
<p>文件系统无日志区，文件写入过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">文件索引写入到inode--&gt;文件内容写入到block</span><br><span class="line">文件内容写入到block--&gt;文件写入完成</span><br></pre></td></tr></table></figure>

<p>在非日志型文件系统中，对文件系统实施一个写操作，内核会首先修改对应的元数据，然后修改数据块。如果在写入元数据时，文件系统发生崩溃或某种故障，那么数据的一致性将会遭到破坏。fsck命令可以在下次重启时检查所有的元数据并修复数据一致性，但是如果文件系统非常大，或者系统运行关键业务不允许停机，使用非日志型文件系统的风险会非常高。</p>
<p>日志型文件系统：ntfs、ext3、ext4、xfs、jfs</p>
<p>文件系统有日志区，文件写入过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">文件索引写入到journal--&gt;文件内容写入到block</span><br><span class="line">文件内容写入到block--&gt;文件索引写入到inode</span><br><span class="line">文件索引写入到inode--&gt;文件写入完成</span><br></pre></td></tr></table></figure>

<p>日志型文件系统的区别在于，在进行对文件系统写数据之前，写将数据写到「日志区」，然后再写入文件系统，在写入文件系统之后删除日志。日志区可以在文件系统内部也可以在文件系统外部。日志区的数据称作文件系统日志，这些数据包含了修改了的元数据，也可能包含将要修改的数据。写日志也会带来一定的额外开销。</p>
<p>查看文件系统的日志区大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># dumpe2fs /dev/sda3 |grep &quot;Journal size&quot;</span></span><br><span class="line">Journal size:             32M</span><br></pre></td></tr></table></figure>

<h4 id="5-内部日志区和外部日志区"><a href="#5-内部日志区和外部日志区" class="headerlink" title="5. 内部日志区和外部日志区"></a>5. 内部日志区和外部日志区</h4><p>内部日志区，日志区在当前文件系统，会对文件系统进行两次索引信息写入</p>
<p>外部日志区，单独一个文件系统做日志区，减少访问次数，减少服务时间</p>
<p>创建外部日志区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># umount /dev/sda3 #先卸载文件系统</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /proc/partitions |grep sda4 #新建128M的分区</span></span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -O ^has_journal /dev/sda3 #去掉文件系统内部日志区功能</span></span><br><span class="line">[root@student02 ~]<span class="comment"># mke2fs -O journal_dev -b 4096 /dev/sda4 #把分区格式化成日志区设备</span></span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -j -J device=/dev/sda4 /dev/sda3 #把sda4设置为sda3的外部日志区</span></span><br><span class="line">Creating journal on device /dev/sda4: <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>不更新atime，适用于频繁读取文件的业务减少磁盘写</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># mount -o remount,noatime /home/</span></span><br><span class="line">[root@student02 ~]<span class="comment"># mount |grep /home</span></span><br><span class="line">/dev/mapper/cl-home on /home <span class="built_in">type</span> xfs (rw,noatime,attr2,inode64,noquota)</span><br></pre></td></tr></table></figure>

<h4 id="6-cache"><a href="#6-cache" class="headerlink" title="6. cache"></a>6. cache</h4><p>磁盘写入数据，数据先写到硬盘的缓存中，进行io的聚合排序后，再从缓存写到硬盘中，电梯算法</p>
<p>修改磁盘缓存的队列长度，队列长度越长，io得到更多的聚合，但是更消耗内存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/nr_requests </span></span><br><span class="line">128</span><br><span class="line">[root@student02 ~]<span class="comment"># echo 256 &gt; /sys/block/sda/queue/nr_requests</span></span><br></pre></td></tr></table></figure>

<h4 id="7-读策略"><a href="#7-读策略" class="headerlink" title="7. 读策略"></a>7. 读策略</h4><p>读预取的作用：</p>
<ul>
<li>在处理IO请求时，从磁盘按顺序读取IO数据以外更多的数据，预先缓存到cache中，以便下一个顺序读IO请求到达时，可直接在cache中获取，得到更高的性能表现。</li>
<li>当读IO很随机是，不当的读预取策略会给存储系统带来额外的资源开销，不到无法保证后续IO再cache中的命中，而且还会带来性能的降低。</li>
</ul>
<p>四种预取算法：固定预取、可变预取、智能预取和不预取。</p>
<ul>
<li>固定预取：固定大小数据的预取。</li>
<li>可变预取：固定IO数量的预取。</li>
<li>智能预取：顺序IO的时候就预取，随机IO的时候就不预取，默认预取算法。</li>
<li>不预取：不预取数据。</li>
</ul>
<p>默认读预取大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/read_ahead_kb </span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<p>查询读预取扇区数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># blockdev --getra /dev/sda3 </span></span><br><span class="line">8192</span><br></pre></td></tr></table></figure>

<p>修改读预取扇区数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># blockdev --setra 4096 /dev/sda3 </span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/read_ahead_kb </span></span><br><span class="line">2048</span><br><span class="line">[root@student02 ~]<span class="comment"># blockdev --getra /dev/sda3 </span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<p>想要重启生效，需要写到开机脚本里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo &quot;blockdev --setra 4096 /dev/sda3&quot; &gt;&gt;/etc/rc.local</span></span><br></pre></td></tr></table></figure>

<h4 id="8-scheduler，磁盘调度算法，可以搭配tuned来使用"><a href="#8-scheduler，磁盘调度算法，可以搭配tuned来使用" class="headerlink" title="8. scheduler，磁盘调度算法，可以搭配tuned来使用"></a>8. scheduler，磁盘调度算法，可以搭配tuned来使用</h4><p>三种调度算法：</p>
<ul>
<li>deadline：最终期限，适合小IO，一个IO读500ms或者写了5000ms没有完成，就放到队列里面排队，优化了等待时间。</li>
<li>noop：不使用任何参数</li>
<li>cfq：完全公平，轮询，默认算法</li>
</ul>
<p>查看当前的调度算法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/scheduler </span></span><br><span class="line">noop [deadline] cfq</span><br></pre></td></tr></table></figure>

<p>修改调度算法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo deadline &gt; /sys/block/sda/queue/scheduler </span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/scheduler</span></span><br><span class="line">noop [deadline] cfq</span><br></pre></td></tr></table></figure>

<p>deadline的算法参数front_merges、read_expire、write_expire</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ls /sys/block/sda/queue/iosched/</span></span><br><span class="line">fifo_batch  front_merges  read_expire  write_expire  writes_starved</span><br></pre></td></tr></table></figure>

<p>查询内核参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 kernel-doc-3.10.0]<span class="comment"># grep -irn --color=auto ^read_expire  .</span></span><br><span class="line">./Documentation/block/deadline-iosched.txt:17:read_expire   (<span class="keyword">in</span> ms)</span><br></pre></td></tr></table></figure>

<p>cfq模式下可以用ionice做进程优先级微调</p>
<p>ionice的级别</p>
<ul>
<li>class1，实时的，子级别有0-7，数字越大优先级越低</li>
<li>class2，尽力的，子级别有0-7，数字越大优先级越低</li>
<li>class3，空闲的</li>
</ul>
<p>修改优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># pidof vsftpd</span></span><br><span class="line">1805</span><br><span class="line">[root@student02 ~]<span class="comment"># ionice -p 1805 -c 2 -n 0</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ionice -p 1805</span></span><br><span class="line">best-effort: prio 0</span><br></pre></td></tr></table></figure>

<h3 id="五、Linux模块的调优"><a href="#五、Linux模块的调优" class="headerlink" title="五、Linux模块的调优"></a>五、Linux模块的调优</h3><h4 id="1-列出系统中加载的模块，查找ext4文件系统模块"><a href="#1-列出系统中加载的模块，查找ext4文件系统模块" class="headerlink" title="1. 列出系统中加载的模块，查找ext4文件系统模块"></a>1. 列出系统中加载的模块，查找ext4文件系统模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># lsmod |grep ^ext4</span></span><br><span class="line">Module    Size  Used by</span><br><span class="line">ext4                   985347  3</span><br></pre></td></tr></table></figure>
<p><code>Module</code>：模块名<br><code>Size</code>：模块大小<br><code>Used</code>：正在使用次数<br><code>by</code>：描述</p>
<h4 id="2-查看模块驱动的详细信息"><a href="#2-查看模块驱动的详细信息" class="headerlink" title="2. 查看模块驱动的详细信息"></a>2. 查看模块驱动的详细信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># modinfo st</span></span><br><span class="line">filename:       /lib/modules/3.10.0-514.16.1.el7.x86_64/kernel/drivers/scsi/st.ko</span><br><span class="line"><span class="built_in">alias</span>:          scsi:t-0x01*</span><br><span class="line"><span class="built_in">alias</span>:          char-major-9-*</span><br><span class="line">license:        GPL</span><br><span class="line">description:    SCSI tape (st) driver</span><br><span class="line">author:         Kai Makisara</span><br><span class="line">rhelversion:    7.3</span><br><span class="line">srcversion:     5C10DC43BF58E63A59D8660</span><br><span class="line">depends:        </span><br><span class="line">intree:         Y</span><br><span class="line">vermagic:       3.10.0-514.16.1.el7.x86_64 SMP mod_unload modversions </span><br><span class="line">signer:         CentOS Linux kernel signing key</span><br><span class="line">sig_key:        3F:E1:EB:8B:4F:91:D4:84:CD:55:44:84:54:A0:24:DE:56:34:E1:06</span><br><span class="line">sig_hashalgo:   sha256</span><br><span class="line">parm:           buffer_kbs:Default driver buffer size <span class="keyword">for</span> fixed block mode (KB; 32)     (int)</span><br><span class="line">parm:           max_sg_segs:Maximum number of scatter/gather segments to use (256) (int)</span><br><span class="line">parm:           try_direct_io:Try direct I/O between user buffer and tape drive (1)     (int)</span><br><span class="line">parm:           debug_flag:Enable DEBUG, same as setting debugging=1 (int)</span><br><span class="line">parm:           try_rdio:Try direct <span class="built_in">read</span> i/o when possible (int)</span><br><span class="line">parm:           try_wdio:Try direct write i/o when possible (int)</span><br></pre></td></tr></table></figure>

<h4 id="3-手动加载模块"><a href="#3-手动加载模块" class="headerlink" title="3. 手动加载模块"></a>3. 手动加载模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># modprobe st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># lsmod |grep st</span></span><br><span class="line">st                     54238  0</span><br></pre></td></tr></table></figure>


<h4 id="4-手动卸载模块"><a href="#4-手动卸载模块" class="headerlink" title="4. 手动卸载模块"></a>4. 手动卸载模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># modprobe -r st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># lsmod |grep ^st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h4 id="5-查看模块驱动的参数fixed-buffer-size"><a href="#5-查看模块驱动的参数fixed-buffer-size" class="headerlink" title="5. 查看模块驱动的参数fixed_buffer_size"></a>5. 查看模块驱动的参数fixed_buffer_size</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 st]<span class="comment"># modinfo st |grep parm |grep buffer_kbs</span></span><br><span class="line">parm:           buffer_kbs:Default driver buffer size <span class="keyword">for</span> fixed block mode (KB; 32) (int</span><br><span class="line">[root@student02 ~]<span class="comment"># cd /sys/bus/scsi/drivers/st/</span></span><br><span class="line">[root@student02 st]<span class="comment"># echo &quot;`cat fixed_buffer_size`/1024&quot; |bc</span></span><br><span class="line">32</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 6. 修改st模块的固定缓存，写到模块的配置文件中</span></span><br><span class="line">```bash</span><br><span class="line">[root@student02]<span class="comment"># echo &quot;options st buffer_kbs=128&quot; &gt; /etc/modprobe.d/st.conf</span></span><br><span class="line">[root@student02]<span class="comment"># modprobe -r st</span></span><br><span class="line">[root@student02]<span class="comment"># modprobe st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo &quot;`cat /sys/bus/scsi/drivers/st/fixed_buffer_size`/1024&quot; |bc</span></span><br><span class="line">128</span><br></pre></td></tr></table></figure>

<h3 id="六、内存的调优"><a href="#六、内存的调优" class="headerlink" title="六、内存的调优"></a>六、内存的调优</h3><h4 id="1-当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存"><a href="#1-当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存" class="headerlink" title="1. 当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存"></a>1. 当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存</h4><p>先用free命令查看缓存的使用情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># free -m</span></span><br><span class="line">total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            976         131          76           6         768         649</span><br><span class="line">Swap:          2047           0        2047</span><br></pre></td></tr></table></figure>

<p>看到buff&#x2F;cache占用了768M的内存空间，在清空缓存前用sync命令把dirty页的内容写回硬盘，以免数据丢失</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sync</span></span><br></pre></td></tr></table></figure>

<p>现在可以尝试使用内核参数vm.drop_caches来清空缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -w vm.drop_caches=3</span></span><br><span class="line">vm.drop_caches = 3</span><br></pre></td></tr></table></figure>

<p>再来看看缓存的情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># free -m</span></span><br><span class="line">total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            976         123         762           6          90         713</span><br><span class="line">Swap:          2047           0        2047</span><br></pre></td></tr></table></figure>

<p>发现已经只有90M的buff&#x2F;cache，free的内存空间大了很多</p>
<h4 id="2-虚拟内存与物理内存"><a href="#2-虚拟内存与物理内存" class="headerlink" title="2. 虚拟内存与物理内存"></a>2. 虚拟内存与物理内存</h4><p>查看进程占用的虚拟内存和物理内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ps -aux |grep -E &quot;^nginx|RSS&quot; |grep -v grep</span></span><br><span class="line">USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">nginx      3167  0.0  0.1  46104  1992 ?        S    17:01   0:00 nginx: worker process</span><br></pre></td></tr></table></figure>

<p><code>VSZ</code>：申请虚拟内存大小，不是立即使用这么多内存<br><code>RSS</code>：实际占用物理内存大小</p>
<h4 id="3-PTE和TLB"><a href="#3-PTE和TLB" class="headerlink" title="3. PTE和TLB"></a>3. PTE和TLB</h4><p>PTE，页表条目 (Page Table Entry),是页表的最低层,它直接处理页,该值包含某页的虚拟内存到物理内存的映射关系</p>
<p>TLB，是虚拟寻址的缓存，其中每一行都保存着一个由单个PTE(Page Table Entry,页表项)组成的块，用于虚拟地址与实地址之间的交互，提供一个寻找实地址的缓存区，能够有效减少寻找物理地址所消耗时间。</p>
<p>hugepage，大页，用来做TLB的</p>
<p>配置hugepage，添加内核参数，分配40M空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a |grep -w vm.nr_hugepages |sed &#x27;s/0/20/&#x27; &gt;&gt;/etc/sysctl.conf </span></span><br><span class="line">[root@student02 ~]<span class="comment"># sysctl -p</span></span><br><span class="line">vm.nr_hugepages = 20</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /proc/meminfo |grep -i &quot;^hugepage&quot;</span></span><br><span class="line">HugePages_Total:      20</span><br><span class="line">HugePages_Free:       20</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br></pre></td></tr></table></figure>

<p>默认是不启用大页的，大页的空间是立即分配的，不使用也会占用一段内存</p>
<h4 id="4-页中断"><a href="#4-页中断" class="headerlink" title="4. 页中断"></a>4. 页中断</h4><p>查看进程的次页中断和主页中断</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ps axo comm,pid,min_flt,maj_flt |grep -iE &quot;command|nginx&quot;</span></span><br><span class="line">COMMAND            PID  MINFL  MAJFL</span><br><span class="line">nginx             4551    100      0</span><br><span class="line">nginx             4552    292      0</span><br></pre></td></tr></table></figure>

<p>打开一个进程，需要去分配内存叫页中断，可以直接在内存中调用叫次页中断，需要去硬盘swap中调用叫主页中断，出现大量主页中断的时候就说明内存存在瓶颈</p>
<h4 id="5-内存页的状态"><a href="#5-内存页的状态" class="headerlink" title="5. 内存页的状态"></a>5. 内存页的状态</h4><p>内存页的四种状态：<br><code>free</code>：是空闲的页，随时可以被使用<br><code>inactive clean</code>：未激活的干净的页，页中的数据已经写到磁盘中，从磁盘读到内存中未被修改，这个页也可以分配，例如，cached<br><code>inactive dirty</code>：脏页，不能被使用，页中的数据修改未写到磁盘，例如脏页，特别是复制文件的时候，dirty是实时变化的<br><code>active</code>：激活的页，正在被进程使用，不能被分配</p>
<p>查看脏页的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/meminfo |grep -w Dirty</span></span><br><span class="line">Dirty:                 4 kB</span><br></pre></td></tr></table></figure>

<p>脏页快速回写的百分比</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep dirty_ratio</span></span><br><span class="line">vm.dirty_ratio = 40</span><br></pre></td></tr></table></figure>
<p>当脏页占用内存20%以下的时候，低速写到磁盘中，高于20%的时候高速写回磁盘中，大io可以设置比较小，快点写入硬盘，小io可以慢点写入硬盘，得到聚合，存储一般设置比较高，因为存储有掉电保护BBU</p>
<p>脏页的过期时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep dirty_exp</span></span><br><span class="line">vm.dirty_expire_centisecs = 3000</span><br></pre></td></tr></table></figure>
<p>默认30s，30s到了即使比例不达到20%也要快速写到磁盘中</p>
<p>脏页比例的检查时间，5s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep dirty_w</span></span><br><span class="line">vm.dirty_writeback_centisecs = 500</span><br></pre></td></tr></table></figure>

<p>也可以用命令sync立即把脏页内容写到硬盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sync</span></span><br></pre></td></tr></table></figure>

<p>还有一个文件也可以强制同步，还支持很多其他指令，模拟各种场景，可以查看内核文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo s &gt;/proc/sysrq-trigger</span></span><br></pre></td></tr></table></figure>

<p>当内存紧张的时候倾向于释放cached使用还是去使用swap，值为0到100,0倾向于保留cached使用swap，100倾向于释放cached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep swapp</span></span><br><span class="line">vm.swappiness = 10</span><br></pre></td></tr></table></figure>

<h4 id="6-内存溢出"><a href="#6-内存溢出" class="headerlink" title="6. 内存溢出"></a>6. 内存溢出</h4><p>oom-kill，内存溢出的保护机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo -17 &gt;/proc/1161/oom_adj</span></span><br></pre></td></tr></table></figure>
<p>这个值的取值范围-17到15，值越小，内存溢出不会杀死这个进程，我们可以把重要的进程值设置比较小，不重要的进程设置为15，内存溢出的时候优先杀死这个进程，腾出内存来，重启生效需要写到开机脚本里</p>
<p>关闭oom-kill的功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a |grep -i panic_on_oom</span></span><br><span class="line">vm.panic_on_oom = 0</span><br></pre></td></tr></table></figure>
<p>这个值设置为1，关闭oom-kill</p>
<h4 id="7-内存泄漏"><a href="#7-内存泄漏" class="headerlink" title="7. 内存泄漏"></a>7. 内存泄漏</h4><p>进程使用了内存，进程结束也不能回收的部分内存，只有重启才能回收泄漏的内存</p>
<p>检查程序的内存泄漏</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># valgrind --tool=memcheck vsftpd</span></span><br><span class="line">......</span><br><span class="line">==1243==    definitely lost: 0 bytes <span class="keyword">in</span> 0 blocks</span><br><span class="line">==1243==    indirectly lost: 0 bytes <span class="keyword">in</span> 0 blocks</span><br><span class="line">==1243==      possibly lost: 0 bytes <span class="keyword">in</span> 0 blocks</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="8-swap"><a href="#8-swap" class="headerlink" title="8. swap"></a>8. swap</h4><p>释放swap的空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># swapoff -a</span></span><br><span class="line">[root@student02 ~]<span class="comment"># swapon -a</span></span><br></pre></td></tr></table></figure>

<p>新增swap分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># mkswap /dev/sda4</span></span><br><span class="line">[root@student02 ~]<span class="comment"># swapon /dev/sda4</span></span><br></pre></td></tr></table></figure>

<p>查看swap分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># swapon -s</span></span><br></pre></td></tr></table></figure>

<p>当有几个swap分区时，设置优先级，数字越大优先级越高，优先级一样高，则轮询使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /etc/fstab |grep swap</span></span><br><span class="line">/dev/mapper/cl-swap     swap                    swap    defaults,pri=1        0 0</span><br></pre></td></tr></table></figure>

<h4 id="9-共享内存"><a href="#9-共享内存" class="headerlink" title="9. 共享内存"></a>9. 共享内存</h4><p>系统安装的时候有一个挂载设备&#x2F;dev&#x2F;shm，大小是内存的一般，这个设备就是用来做共享内存的，可以把内存当做磁盘使用，有很快的速度，满足一些业务的需求</p>
<p>查看共享内存的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># df -h |grep shm</span></span><br><span class="line">tmpfs                489M     0  489M   0% /dev/shm</span><br></pre></td></tr></table></figure>

<p>设置shm分区的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /etc/fstab |grep shm</span></span><br><span class="line">tmpfs   /dev/shm    tmpfs   defaults,size=128m</span><br><span class="line">[root@student02 ~]<span class="comment"># mount -o remount /dev/shm</span></span><br></pre></td></tr></table></figure>

<p>squid做反向代理就会使用共享内存</p>
<h4 id="10-内存复用"><a href="#10-内存复用" class="headerlink" title="10. 内存复用"></a>10. 内存复用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a |grep overcommit</span></span><br><span class="line">vm.overcommit_memory = 0</span><br><span class="line">vm.overcommit_ratio = 50</span><br></pre></td></tr></table></figure>
<p>0代表更多的尝试过量使用，能过量的就给，1总是过量使用内存，不能过量就释放别的进程，可能把系统搞死机，2能申请的内存等于swap加上内存的百分比，设置模式为0和1的时候百分比设置无效，设置模式2才有效</p>
<h3 id="七、cpu与进程的调优"><a href="#七、cpu与进程的调优" class="headerlink" title="七、cpu与进程的调优"></a>七、cpu与进程的调优</h3><h4 id="1-irq的均衡"><a href="#1-irq的均衡" class="headerlink" title="1. irq的均衡"></a>1. irq的均衡</h4><p>每个设备都有自己的irq号码，查看设备的中断号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/interrupts </span></span><br><span class="line">CPU0       CPU1       </span><br><span class="line">0:         21          0   IO-APIC-edge      timer</span><br><span class="line">1:         10          0   IO-APIC-edge      i8042</span><br><span class="line">6:          2          0   IO-APIC-edge      floppy</span><br><span class="line">8:          1          0   IO-APIC-edge      rtc0</span><br><span class="line">9:          0          0   IO-APIC-fasteoi   acpi</span><br><span class="line">12:         16          0   IO-APIC-edge      i8042</span><br><span class="line">14:          0          0   IO-APIC-edge      ata_piix</span><br><span class="line">15:        160          0   IO-APIC-edge      ata_piix</span><br><span class="line">16:          2          0   IO-APIC-fasteoi   vmwgfx</span><br><span class="line">17:       6606        719   IO-APIC-fasteoi   ioc0</span><br><span class="line">18:         12         58   IO-APIC-fasteoi   ens32</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>第一列数字就是设备中断号，我们看到网卡的中断号是18</p>
<p>CPU1对应的数字在增大，CPU1处理网卡的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/interrupts |grep -E &quot;CPU|ens32&quot;</span></span><br><span class="line">CPU0       CPU1       </span><br><span class="line">18:         14       1455   IO-APIC-fasteoi   ens32</span><br></pre></td></tr></table></figure>

<p>设置网卡的亲和性，让CPU0处理网卡的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt; /proc/irq/18/smp_affinity</span></span><br></pre></td></tr></table></figure>

<p>4U的服务器设置4个CPU同时处理网卡的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo f &gt; /proc/irq/18/smp_affinity</span></span><br></pre></td></tr></table></figure>

<p>同理，可以设置其他设备的CPU亲和性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo x &gt; /proc/irq/&#123;irq_number&#125;/smp_affinity</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：x是一个16进制的数值，f的16进制是1111，代表4个CPU同时工作</p>
</blockquote>
<h4 id="2-均衡CPU的访问次数"><a href="#2-均衡CPU的访问次数" class="headerlink" title="2. 均衡CPU的访问次数"></a>2. 均衡CPU的访问次数</h4><p>任务会在所有CPU上面均衡，繁忙的时候100ms均衡一次，空闲的时候1ms均衡一次，用以下命令可以看到cp文件的时候cpu在不停的均衡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># watch -n .1 &#x27;ps axo comm,pid,psr |grep cp&#x27;</span></span><br></pre></td></tr></table></figure>

<p>CPU的调度均衡可以平衡CPU的负载，但是也会降低缓存的命中率</p>
<p>如果想提高CPU缓存命中率，可以设置进程运行在某个CPU上面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># taskset -p 1 5993</span></span><br><span class="line">pid 5993<span class="string">&#x27;s current affinity mask: 3</span></span><br><span class="line"><span class="string">pid 5993&#x27;</span>s new affinity mask: 1</span><br></pre></td></tr></table></figure>

<h4 id="3-cpu的隔离"><a href="#3-cpu的隔离" class="headerlink" title="3. cpu的隔离"></a>3. cpu的隔离</h4><p>开机内核启动的时候隔离某个cpu，用来运行单独的业务,可以使用taskset命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># grep isolcpus /boot/grub2/grub.cfg</span></span><br><span class="line">linux16 /vmlinuz-3.10.0-514.16.1.el7.x86_64 root=/dev/mapper/cl-root ro rd.lvm.lv=cl/root rd.lvm.lv=</span><br><span class="line">cl/swap rhgb quiet LANG=en_US.UTF-8 isolcpus=1</span><br></pre></td></tr></table></figure>

<h4 id="4-在线关闭cpu"><a href="#4-在线关闭cpu" class="headerlink" title="4. 在线关闭cpu"></a>4. 在线关闭cpu</h4><p>当服务器某个cpu故障的时候，我们又不能关机更换CPU，这时候就可以使用以下命令关闭故障cpu在线更换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo 0 &gt;/sys/devices/system/cpu/cpu0/online</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lscpu命令可以看到有一个cpu被关闭了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># lscpu |head -n 6</span></span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                2</span><br><span class="line">On-line CPU(s) list:   0</span><br><span class="line">Off-line CPU(s) list:  1</span><br></pre></td></tr></table></figure>

<h4 id="5-调度域，cgroup之cpuset"><a href="#5-调度域，cgroup之cpuset" class="headerlink" title="5. 调度域，cgroup之cpuset"></a>5. 调度域，cgroup之cpuset</h4><p>所谓cpuset,就是在用户空间中操作cgroup文件系统来执行进程与cpu和进程与内存节点之间的绑定，限制进程只能使用子cpuset里面的资源</p>
<p>根cpuset包含所有的资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/cpuset.cpus</span></span><br><span class="line">0-1</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/cpuset.mems </span></span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>创建一个子cpuset,包含1号cpu，和所有内存，因为虚拟机不支持NUMA，所以只能设置所有内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># mkdir /sys/fs/cgroup/cpuset/mycpuset/</span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt; /sys/fs/cgroup/cpuset/mycpuset/cpuset.cpus</span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo 0 &gt;/sys/fs/cgroup/cpuset/mycpuset/cpuset.mems</span></span><br></pre></td></tr></table></figure>

<p>还可以设置某个进程运行在cpuset里面，根cpuset包含了所有的进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/tasks </span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>让nginx进程运行在mycpuset里面，同时根cpuset里面没有这个进程了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># pidof nginx</span></span><br><span class="line">1698 1697</span><br><span class="line">[root@student02 ~]<span class="comment"># echo -e &quot;1698\n1697&quot; &gt;/sys/fs/cgroup/cpuset/mycpuset/tasks</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/tasks |grep -E &quot;169[7|8]&quot;</span></span><br></pre></td></tr></table></figure>

<p>反过来看进程在哪个cpuset里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/1697/cpuset</span></span><br><span class="line">/mycpuset</span><br></pre></td></tr></table></figure>

<p>以上的配置都是重启不会生效的，如果要重启生效需要写到cgroup里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /etc/cgconfig.conf |grep -A 5 mycpuset</span></span><br><span class="line">group mycpuset &#123;</span><br><span class="line">cpuset &#123;</span><br><span class="line">cpuset.cpus = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">cpuset.mems = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /etc/cgrules.conf |grep mycpuset</span></span><br><span class="line">*:nginx     cpuset      mycpuset/</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgred</span></span><br></pre></td></tr></table></figure>

<p>重启nginx服务测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -s stop ;nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># pidof nginx</span></span><br><span class="line">2944 2943</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/mycpuset/tasks </span></span><br><span class="line">2943</span><br><span class="line">2944</span><br></pre></td></tr></table></figure>

<p>默认情况下多个子cpuset可以同时使用cpu的资源，如果想要一个cpuset独占cpu资源，可以打开这个开关，需要开机生效也要写到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt;/sys/fs/cgroup/cpuset/cpuset.cpu_exclusive </span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt;/sys/fs/cgroup/cpuset/mycpuset/cpuset.cpu_exclusive</span></span><br></pre></td></tr></table></figure>

<h4 id="6-进程上下文切换cs"><a href="#6-进程上下文切换cs" class="headerlink" title="6. 进程上下文切换cs"></a>6. 进程上下文切换cs</h4><p>上下文切换的理解</p>
<p>context switch过高会导致CPU像个搬运工，频繁在寄存器和运行队列之间奔波，更多的时间花在了线程切换，而不是真正工作的线程上。直接的消耗包括CPU寄存器需要保存和加载，系统调度器的代码需要执行。间接消耗在于多核cache之间的共享数据。</p>
<p>引起上下文切换的原因</p>
<ul>
<li>当前任务的时间片用完之后，系统CPU正常调度下一个任务；</li>
<li>当前任务碰到IO阻塞，调度线程将挂起此任务，继续下一个任务；</li>
<li>多个任务抢占锁资源，当前任务没有抢到，被调度器挂起，继续下一个任务；</li>
<li>用户代码挂起当前任务，让出CPU时间；</li>
<li>硬件中断；</li>
</ul>
<p>进程上下文切换的检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vmstat 1 5</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line">r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">4  0      0 618300    968 246528    0    0    25     3   30   58  0  0 99  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     2   31   44  0  0 100  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     0   28   37  0  1 99  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     0   23   37  0  0 100  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     0   33   45  0  1 99  0  0</span><br></pre></td></tr></table></figure>
<p><code>bi</code>：block in数量<br><code>bo</code>：block out数量<br><code>in</code>：每称的中断数<br><code>cs</code>：每秒的上下文切换</p>
<p>每个进程每秒刷新输出上下文切换情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># pidstat -w 1 5</span></span><br><span class="line">Linux 3.10.0-514.16.1.el7.x86_64 (student02)    06/06/2017  _x86_64_    (1 CPU)</span><br><span class="line">11:11:08 AM   UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">11:11:09 AM     0         3      2.97      0.00  ksoftirqd/0</span><br><span class="line">11:11:09 AM     0         6      0.99      0.00  kworker/u256:0</span><br><span class="line">11:11:09 AM     0         9      3.96      0.00  rcu_sched</span><br><span class="line">11:11:09 AM     0        10      0.99      0.00  watchdog/0</span><br><span class="line">11:11:09 AM     0        41      3.96      0.00  kworker/0:2</span><br><span class="line">11:11:09 AM     0       400     20.79      0.00  xfsaild/dm-0</span><br><span class="line">11:11:09 AM     0       653      9.90      0.00  vmtoolsd</span><br><span class="line">11:11:09 AM     0      1479      0.99      0.99  pidstat</span><br></pre></td></tr></table></figure>
<p><code>cswch</code>：自愿的上下文切换<br><code>nvcswch</code>：非自愿的上下文切换</p>
<p>看出主机上总的上下文件切换的情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -w 1 5</span></span><br><span class="line">Linux 3.10.0-514.16.1.el7.x86_64 (student02)    06/06/2017  _x86_64_    (1 CPU)</span><br><span class="line">11:21:09 AM    proc/s   cswch/s</span><br><span class="line">11:21:10 AM      0.00     89.00</span><br><span class="line">11:21:11 AM      0.00     87.76</span><br><span class="line">11:21:12 AM      0.00     77.23</span><br><span class="line">11:21:13 AM      0.00     81.82</span><br><span class="line">11:21:14 AM      0.00     86.00</span><br><span class="line">Average:         0.00     84.34</span><br></pre></td></tr></table></figure>

<p>查看具体进程的每秒上下文切换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># grep ctxt /proc/1501/status </span></span><br><span class="line">voluntary_ctxt_switches:    1 <span class="comment">#自愿的上下文切换</span></span><br><span class="line">nonvoluntary_ctxt_switches: 0 <span class="comment">#非自愿的上下文切换</span></span><br></pre></td></tr></table></figure>

<p><code>cswch/s</code>: 每秒任务主动(自愿的)切换上下文的次数，当某一任务处于阻塞等待时，将主动让出自己的CPU资源。<br><code>nvcswch/s</code>: 每秒任务被动(不自愿的)切换上下文的次数，CPU分配给某一任务的时间片已经用完，因此将强迫该进程让出CPU的执行权。</p>
<p>nagios check_mk默认有对上下文的监控，其使用的方法是通过两&#x2F;proc&#x2F;stat文件里取到ctxt行，并取两个时间段之间的差值来确认。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/stat|grep ctxt</span></span><br><span class="line">ctxt 397480</span><br></pre></td></tr></table></figure>
<h4 id="7-运行队列"><a href="#7-运行队列" class="headerlink" title="7. 运行队列"></a>7. 运行队列</h4><p>每个CPU有两个运行队列，活动队列和过期队列，正在运行的任务被优先级高的抢占了，这个任务就到了过期队列，活动队列的任务运行完了，就又变成活动队列继续处理，活动队列和过期队列是一直相互交换的</p>
<p>nice的默认优先级区间为-20到19，数字越小，优先级越高<br>优先级有两种，静态优先级和动态优先级，nice是动态优先级，他的-20到19对应100-139，对应的静态优先级都是0</p>
<p>修改nice优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># renice -20 1805</span></span><br><span class="line">1805 (process ID) old priority 0, new priority -20</span><br><span class="line">[root@student02 ~]<span class="comment"># ps axo pid,comm,%cpu,nice |grep vsftpd</span></span><br><span class="line">1805 vsftpd           0.0 -20</span><br></pre></td></tr></table></figure>

<p>进程有三种优先级，f大于r大于o的优先级<br>sched_fifo先进先出，一个任务处理完了才轮到下个任务，一个优先级高的任务来了要先处理，处理完了继续我这个任务<br>sched_rr轮询，每个任务相同的时间，但是优先级高的拥有更多的时间片<br>sched_other其它优先级，nice，renice</p>
<p>给进程设置先进先出优先级，也可以跟命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># chrt -f -p 20 1805</span></span><br></pre></td></tr></table></figure>

<p>给进程设置轮询优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># chrt -r -p 20 1805</span></span><br></pre></td></tr></table></figure>

<h3 id="八、TCP-x2F-IP、Socket参数"><a href="#八、TCP-x2F-IP、Socket参数" class="headerlink" title="八、TCP&#x2F;IP、Socket参数"></a>八、TCP&#x2F;IP、Socket参数</h3><p>所有的TCP&#x2F;IP参数都位于&#x2F;proc&#x2F;sys&#x2F;net目录下，对&#x2F;proc&#x2F;sys&#x2F;net目录下内容的修改都是临时的，需要写到sysctl.conf文件中</p>
<table>
<thead>
<tr>
<th align="left">参数（路径+文件）</th>
<th align="left">描述</th>
<th align="left">默认值</th>
<th align="left">优化值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;rmem_default</td>
<td align="left">默认的TCP数据接收窗口大小（字节）</td>
<td align="left">229376</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;rmem_max</td>
<td align="left">最大的TCP数据接收窗口（字节）</td>
<td align="left">131071</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;wmem_default</td>
<td align="left">默认的TCP数据发送窗口大小（字节）</td>
<td align="left">229376</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;wmem_max</td>
<td align="left">最大的TCP数据发送窗口（字节）</td>
<td align="left">131071</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;netdev_max_backlog</td>
<td align="left">在每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</td>
<td align="left">1000</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn</td>
<td align="left">定义了系统中每一个端口最大的监听队列的长度，这是个全局的参数</td>
<td align="left">128</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;optmem_max</td>
<td align="left">表示每个套接字所允许的最大缓冲区的大小</td>
<td align="left">20480</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_mem</td>
<td align="left">确定TCP栈应该如何反映内存使用，每个值的单位都是内存页（通常是4KB）。第一个值是内存使用的下限；第二个值是内存压力模式开始对缓冲区使用应用压力的上限；第三个值是内存使用的上限。在这个层次上可以将报文丢弃，从而减少对内存的使用。对于较大的BDP可以增大这些值（注意，其单位是内存页而不是字节）</td>
<td align="left">94011  125351  188022</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_rmem</td>
<td align="left">为自动调优定义socket使用的内存。第一个值是为socket接收缓冲区分配的最少字节数；第二个值是默认值（该值会被rmem_default覆盖），缓冲区在系统负载不重的情况下可以增长到这个值；第三个值是接收缓冲区空间的最大字节数（该值会被rmem_max覆盖）</td>
<td align="left">4096  87380  4011232</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_wmem</td>
<td align="left">为自动调优定义socket使用的内存。第一个值是为socket发送缓冲区分配的最少字节数；第二个值是默认值（该值会被wmem_default覆盖），缓冲区在系统负载不重的情况下可以增长到这个值；第三个值是发送缓冲区空间的最大字节数（该值会被wmem_max覆盖）</td>
<td align="left">4096  16384  4011232</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_keepalive_time</td>
<td align="left">TCP发送keepalive探测消息的间隔时间（秒），用于确认TCP连接是否有效</td>
<td align="left">7200</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_keepalive_intvl</td>
<td align="left">探测消息未获得响应时，重发该消息的间隔时间（秒）</td>
<td align="left">75</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_keepalive_probes</td>
<td align="left">在认定TCP连接失效之前，最多发送多少个keepalive探测消息</td>
<td align="left">9</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_sack</td>
<td align="left">启用有选择的应答（1表示启用），通过有选择地应答乱序接收到的报文来提高性能，让发送者只发送丢失的报文段，（对于广域网通信来说）这个选项应该启用，但是会增加对CPU的占用。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_fack</td>
<td align="left">启用转发应答，可以进行有选择应答（SACK）从而减少拥塞情况的发生，这个选项也应该启用。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_timestamps</td>
<td align="left">TCP时间戳（会在TCP包头增加12个字节），以一种比重发超时更精确的方法（参考RFC 1323）来启用对RTT 的计算，为实现更好的性能应该启用这个选项。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_window_scaling</td>
<td align="left">启用RFC 1323定义的window scaling，要支持超过64KB的TCP窗口，必须启用该值（1表示启用），TCP窗口最大至1GB，TCP连接双方都启用时才生效。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_syncookies</td>
<td align="left">表示是否打开TCP同步标签（syncookie），内核必须打开了CONFIG_SYN_COOKIES项进行编译，同步标签可以防止一个套接字在有过多试图连接到达时引起过载。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_reuse</td>
<td align="left">表示是否允许将处于TIME-WAIT状态的socket（TIME-WAIT的端口）用于新的TCP连接 。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_recycle</td>
<td align="left">能够更快地回收TIME-WAIT套接字。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_fin_timeout</td>
<td align="left">对于本端断开的socket连接，TCP保持在FIN-WAIT-2状态的时间（秒）。对方可能会断开连接或一直不结束连接或不可预料的进程死亡。</td>
<td align="left">60</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_local_port_range</td>
<td align="left">表示TCP&#x2F;UDP协议允许使用的本地端口号</td>
<td align="left">32768  61000</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlog</td>
<td align="left">对于还未获得对方确认的连接请求，可保存在队列中的最大数目。如果服务器经常出现过载，可以尝试增加这个数字。</td>
<td align="left">2048</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_low_latency</td>
<td align="left">允许TCP&#x2F;IP栈适应在高吞吐量情况下低延时的情况，这个选项应该禁用。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_westwood</td>
<td align="left">启用发送者端的拥塞控制算法，它可以维护对吞吐量的评估，并试图对带宽的整体利用情况进行优化，对于WAN 通信来说应该启用这个选项。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_bic</td>
<td align="left">为快速长距离网络启用Binary Increase Congestion，这样可以更好地利用以GB速度进行操作的链接，对于WAN通信应该启用这个选项。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
</tbody></table>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/07/11/regular%E6%AD%A3%E5%88%99/" rel="prev" title="正则表达式">
      <i class="fa fa-chevron-left"></i> 正则表达式
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/07/11/tcp%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/" rel="next" title="tcp调优参数">
      tcp调优参数 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E6%96%87%E6%A1%A3%E7%9A%84%E6%9F%A5%E7%9C%8B"><span class="nav-number">1.</span> <span class="nav-text">一、内核参数文档的查看</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%9C%A8Linux%E7%B3%BB%E7%BB%9F%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E9%83%BD%E5%8F%AF%E4%BB%A5%E6%9F%A5%E8%AF%A2%E5%88%B0%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85%E5%AE%98%E6%96%B9%E5%AE%89%E8%A3%85%E5%8C%85kernel-doc%EF%BC%8C%E5%85%88%E5%AD%A6%E4%B9%A0%E4%B8%8B%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E5%B8%AE%E5%8A%A9%E6%96%87%E6%A1%A3%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">1.1.</span> <span class="nav-text">1. 在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7"><span class="nav-number">2.</span> <span class="nav-text">二、性能调优工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-tuned"><span class="nav-number">2.1.</span> <span class="nav-text">1. tuned</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-limits"><span class="nav-number">2.2.</span> <span class="nav-text">2. limits</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-cgroup"><span class="nav-number">2.3.</span> <span class="nav-text">3. cgroup</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7"><span class="nav-number">3.</span> <span class="nav-text">三、系统状态监控工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-iostat%E5%91%BD%E4%BB%A4%EF%BC%8C%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E5%A4%87%E7%9A%84IO%E8%B4%9F%E8%BD%BD%E6%83%85%E5%86%B5"><span class="nav-number">3.1.</span> <span class="nav-text">1. iostat命令，监控系统设备的IO负载情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-sar%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%AF%B9%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%B4%BB%E5%8A%A8%E8%BF%9B%E8%A1%8C%E6%8A%A5%E5%91%8A"><span class="nav-number">3.2.</span> <span class="nav-text">2. sar命令，对系统的活动进行报告</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-vmstat%E5%91%BD%E4%BB%A4%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84CPU%E4%BD%BF%E7%94%A8%E7%8E%87%EF%BC%8C%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%BA%A4%E6%8D%A2%E6%83%85%E5%86%B5-IO%E8%AF%BB%E5%86%99%E6%83%85%E5%86%B5"><span class="nav-number">3.3.</span> <span class="nav-text">3. vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-free"><span class="nav-number">3.4.</span> <span class="nav-text">4. free</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-top"><span class="nav-number">3.5.</span> <span class="nav-text">5. top</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-x2F-proc-x2F-meminfo"><span class="nav-number">3.6.</span> <span class="nav-text">6. &#x2F;proc&#x2F;meminfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E7%8E%87cache-hit"><span class="nav-number">3.7.</span> <span class="nav-text">7. 缓存命中率cache-hit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-strace%E7%94%A8%E6%9D%A5%E8%B7%9F%E8%B8%AA%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%88%96%E4%BF%A1%E5%8F%B7%E4%BA%A7%E7%94%9F%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">3.8.</span> <span class="nav-text">8. strace用来跟踪一个进程的系统调用或信号产生的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-ltrace%E7%94%A8%E6%9D%A5%E8%B7%9F%E8%B8%AA%E8%BF%9B%E7%A8%8B%E8%B0%83%E7%94%A8%E5%BA%93%E5%87%BD%E6%95%B0%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">3.9.</span> <span class="nav-text">9. ltrace用来跟踪进程调用库函数的情况</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%B0%83%E4%BC%98"><span class="nav-number">4.</span> <span class="nav-text">四、文件系统的调优</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-tune2fs"><span class="nav-number">4.1.</span> <span class="nav-text">1. tune2fs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-dumpe2fs%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84"><span class="nav-number">4.2.</span> <span class="nav-text">2. dumpe2fs，查看文件系统结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E4%BF%AE%E5%A4%8D%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">4.3.</span> <span class="nav-text">3. 修复文件系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E9%9D%9E%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">4.4.</span> <span class="nav-text">4. 非日志型文件系统与日志型文件系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%86%85%E9%83%A8%E6%97%A5%E5%BF%97%E5%8C%BA%E5%92%8C%E5%A4%96%E9%83%A8%E6%97%A5%E5%BF%97%E5%8C%BA"><span class="nav-number">4.5.</span> <span class="nav-text">5. 内部日志区和外部日志区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-cache"><span class="nav-number">4.6.</span> <span class="nav-text">6. cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E8%AF%BB%E7%AD%96%E7%95%A5"><span class="nav-number">4.7.</span> <span class="nav-text">7. 读策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-scheduler%EF%BC%8C%E7%A3%81%E7%9B%98%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%90%AD%E9%85%8Dtuned%E6%9D%A5%E4%BD%BF%E7%94%A8"><span class="nav-number">4.8.</span> <span class="nav-text">8. scheduler，磁盘调度算法，可以搭配tuned来使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94%E3%80%81Linux%E6%A8%A1%E5%9D%97%E7%9A%84%E8%B0%83%E4%BC%98"><span class="nav-number">5.</span> <span class="nav-text">五、Linux模块的调优</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%97%E5%87%BA%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%9F%A5%E6%89%BEext4%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97"><span class="nav-number">5.1.</span> <span class="nav-text">1. 列出系统中加载的模块，查找ext4文件系统模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%9F%A5%E7%9C%8B%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="nav-number">5.2.</span> <span class="nav-text">2. 查看模块驱动的详细信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%89%8B%E5%8A%A8%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">5.3.</span> <span class="nav-text">3. 手动加载模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%89%8B%E5%8A%A8%E5%8D%B8%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">5.4.</span> <span class="nav-text">4. 手动卸载模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E6%9F%A5%E7%9C%8B%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%8F%82%E6%95%B0fixed-buffer-size"><span class="nav-number">5.5.</span> <span class="nav-text">5. 查看模块驱动的参数fixed_buffer_size</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%86%85%E5%AD%98%E7%9A%84%E8%B0%83%E4%BC%98"><span class="nav-number">6.</span> <span class="nav-text">六、内存的调优</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%BD%93%E5%9C%A8Linux%E4%B8%8B%E9%A2%91%E7%B9%81%E5%AD%98%E5%8F%96%E6%96%87%E4%BB%B6%E5%90%8E%EF%BC%8Ccached%E5%8D%A0%E7%94%A8%E5%BE%88%E5%A4%9A%E8%B5%84%E6%BA%90%EF%BC%8C%E8%99%BD%E7%84%B6cache%E6%98%AF%E4%B8%BA%E4%BA%86%E6%8F%90%E9%AB%98%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%95%88%E7%8E%87%EF%BC%8C%E5%9C%A8%E6%9C%89%E9%9C%80%E6%B1%82%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E5%8F%AF%E4%BB%A5%E6%B8%85%E7%A9%BA%E7%BC%93%E5%AD%98"><span class="nav-number">6.1.</span> <span class="nav-text">1. 当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-number">6.2.</span> <span class="nav-text">2. 虚拟内存与物理内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-PTE%E5%92%8CTLB"><span class="nav-number">6.3.</span> <span class="nav-text">3. PTE和TLB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E9%A1%B5%E4%B8%AD%E6%96%AD"><span class="nav-number">6.4.</span> <span class="nav-text">4. 页中断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%86%85%E5%AD%98%E9%A1%B5%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-number">6.5.</span> <span class="nav-text">5. 内存页的状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">6.6.</span> <span class="nav-text">6. 内存溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="nav-number">6.7.</span> <span class="nav-text">7. 内存泄漏</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-swap"><span class="nav-number">6.8.</span> <span class="nav-text">8. swap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="nav-number">6.9.</span> <span class="nav-text">9. 共享内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-%E5%86%85%E5%AD%98%E5%A4%8D%E7%94%A8"><span class="nav-number">6.10.</span> <span class="nav-text">10. 内存复用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83%E3%80%81cpu%E4%B8%8E%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B0%83%E4%BC%98"><span class="nav-number">7.</span> <span class="nav-text">七、cpu与进程的调优</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-irq%E7%9A%84%E5%9D%87%E8%A1%A1"><span class="nav-number">7.1.</span> <span class="nav-text">1. irq的均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%9D%87%E8%A1%A1CPU%E7%9A%84%E8%AE%BF%E9%97%AE%E6%AC%A1%E6%95%B0"><span class="nav-number">7.2.</span> <span class="nav-text">2. 均衡CPU的访问次数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-cpu%E7%9A%84%E9%9A%94%E7%A6%BB"><span class="nav-number">7.3.</span> <span class="nav-text">3. cpu的隔离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%9C%A8%E7%BA%BF%E5%85%B3%E9%97%ADcpu"><span class="nav-number">7.4.</span> <span class="nav-text">4. 在线关闭cpu</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E8%B0%83%E5%BA%A6%E5%9F%9F%EF%BC%8Ccgroup%E4%B9%8Bcpuset"><span class="nav-number">7.5.</span> <span class="nav-text">5. 调度域，cgroup之cpuset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E8%BF%9B%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2cs"><span class="nav-number">7.6.</span> <span class="nav-text">6. 进程上下文切换cs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E8%BF%90%E8%A1%8C%E9%98%9F%E5%88%97"><span class="nav-number">7.7.</span> <span class="nav-text">7. 运行队列</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AB%E3%80%81TCP-x2F-IP%E3%80%81Socket%E5%8F%82%E6%95%B0"><span class="nav-number">8.</span> <span class="nav-text">八、TCP&#x2F;IP、Socket参数</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="keemozhang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">keemozhang</p>
  <div class="site-description" itemprop="description">人的一切痛苦，本质上都是对自己的无能的愤怒。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">keemozhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
