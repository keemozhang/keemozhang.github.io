<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"keemozhang.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
<meta property="og:type" content="website">
<meta property="og:title" content="keemozhang blog">
<meta property="og:url" content="https://keemozhang.com/index.html">
<meta property="og:site_name" content="keemozhang blog">
<meta property="og:description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
<meta property="og:locale">
<meta property="article:author" content="keemozhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://keemozhang.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>keemozhang blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">keemozhang blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2020/01/06/kafka%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/06/kafka%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">kafka的基本命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-06 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-06T00:00:00+08:00">2020-01-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:58:11" itemprop="dateModified" datetime="2022-12-14T15:58:11+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kafka的基本命令"><a href="#kafka的基本命令" class="headerlink" title="kafka的基本命令"></a>kafka的基本命令</h1><p><strong>Kafka</strong>是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者规模的网站中的所有动作流数据。</p>
<hr>
<h2 id="基本命令使用"><a href="#基本命令使用" class="headerlink" title="基本命令使用"></a>基本命令使用</h2><h3 id="列出所有可用的topic"><a href="#列出所有可用的topic" class="headerlink" title="列出所有可用的topic"></a>列出所有可用的topic</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --list --zookeeper 172.20.40.51:2181</span><br></pre></td></tr></table></figure>

<h3 id="新建topic命令"><a href="#新建topic命令" class="headerlink" title="新建topic命令"></a>新建topic命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh -zookeeper 172.20.40.51:2181 -topic seclogs -replication-factor 1 -partitions 3 -create</span><br></pre></td></tr></table></figure>
<h3 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a>删除topic</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --delete --zookeeper 172.20.40.51:2181 --topic seclogs</span><br></pre></td></tr></table></figure>

<h3 id="查看kafka数据"><a href="#查看kafka数据" class="headerlink" title="查看kafka数据"></a>查看kafka数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --broker-info --group yunwei-logstash --topic seclogs --zookeeper 172.20.40.51:2181</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/13/nginx%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E6%AD%A5%E9%AA%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/13/nginx%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E6%AD%A5%E9%AA%A4/" class="post-title-link" itemprop="url">nginx版本升级步骤</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-13 21:38:00" itemprop="dateCreated datePublished" datetime="2017-07-13T21:38:00+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="nginx-x2F-openresty版本升级"><a href="#nginx-x2F-openresty版本升级" class="headerlink" title="nginx&#x2F;openresty版本升级"></a>nginx&#x2F;openresty版本升级</h3><hr>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWAAAABICAMAAAD/N9+RAAAAVFBMVEUAAAAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQDBect+AAAAG3RSTlMAB0AY8SD5SM82v1npsJ/YjSl0EVLftqllgMdZgsoQAAAHd0lEQVR42szZ6XabMBCG4ZGFxSazLzZz//fZc9I4JpbEN8LQ0/dnGwJ5DJGG0HdpM9kkuzVXiqussmRpLrRdnwqDp9ePyY7zXdFbqptHOz00RTVUxWiyquvJ26Upknp2/heWN0Uyzt3qYtKMn805ybsW/LdK01YVC6sVELH81XJ9o6j5q6Qkcepe83dJp8ipf161HSgm1TyPK5//cuN1d5KmE342bsnkLK6hre78LNG0KuWfOrFDwats69w8ln+qFIlrx9Vxf8808e8eJGx9YEXhCpZ3kX2gfFtbrX4m05IonTE7wsGLnpXY1/Kqr3v/5r+NcAOvy8HXCRt74W+alH568KqCJKmM37LafVhe3ZTU1/mmA7uV9Ar8vPjZVCPDZI+CDdwFC68yIooZnbhmIAx8XyoZu5mcYO9HzhSo47gGCqR53ULPlAGPkuyazJVeKWYsjH15Djy/VhPO8LoM/OJE4XNfeJ19LUfRj18KF9gLA2GZL4/UsLdFHQVccWyTCDjZD9wm7Kt2PgIgjH3ZBlf46iDgnOO7nwusavZmVoCaPU0q1pcnshyoOwa44PiS66nANw7U0isbK5x7j3gQB0uPAB54T8WZwA/RHrxhLIx9TbsBnLSfA6uRd9WdBzywCFiNUcJ5wr4eRByu7j8G7nhfpj0LuE0A8OtsSBj7ZooIL+dyYLxFm27+EvfSzgHua/GYXrK3Qol9a03bwNxEAeMt2ix/bptzgCeGwFhY7ouAufwIOA/PSni3nJ8B3DAElgtjXwxs8k+Al/BdiVfDWh0PPDAAjhXGvgTnVjkwujzbk1t4TWkOB24TBBwrjH2JQZnaC6xGsPdCT296MHA/MgKWC2NfL7Blp2ov8AM88/gNbX8osCrc5xMAA2Ho6wIXHTt1+4C1iZwMW8NvzYcCN67vAICBMPZ1galip3QXcAXHXzyVlB8AYyiT5wAYCWNfF1gtYGYWAufhNynyTWqiDwPOjeelnQiYShMQBr5+YNIWzMwy4CX69afv1NNRwHr07FKEwDT4hTPs6wL7P+tCxQKXm/eifJ963wmMF7hCYWBXGJdpAsBUopkZAyv3j3+i9PUtTa/U9VcAGC1wmgAwFsa+LnBooLxj4K0t2qjo8AAwWuAIAO8TznoSANMEZmYErA14p3EyMF7gSgLAQBj4ImBVg5kZAM/8u4VAJwJ7l+2GADAQBr4A2D+1Z0oMnKM3Y2cD4wUOAANh5IuB6cJOsxg4Q0eeCwwXuFETBnZLDfSVA1NwZsbAJXwN/C+B7771BAAjYeyLgX0z8yACVlawx1NaXh+5TcMLHACGwtgXA6OZ2QUObdGsorfabjIsr4wcNOACB4CBMPLFwOHpcuwx8NWgLXTJURW0H1gtngUOA8cLLz1FAsOZWQ4MfFH5B8CV7x75b4D/NHduS47CMBCVwYFAiDEmCQT+/z/3ZWumah1otZdL/MxMZc5gybJanU8tLI9DhF8PESXJ10k64PAxyn1LiPisMhr/N8kNHF+bpwPOis95+juS3IJOrsgQYBlXj2mWFVHRgHGC+4pj2kKjbG4ufKGRLmdtTTJgc12WKn1BofE7zBTXzAhwtlIqP9h5gmTAbq1xcHqpvBbHBgRY7suXPTl/ROMB4wR36mUPKjXnNwLcrVxXXimRZTLgDBSiZ15XYj3XAwAWv3zh7gnAXtIAx6Etnq888cIdX/fZDgDul1tGvf4Vtn0S4M8J7i7ROq1lhCVHzzwGvBpYbJ5AOEgq4EEzZn5K01MrmqvNOmDTLrft+8FSRzQecFBpO05p26tlnw7oIso14YnJ3i5aL6DF0wMuleqkM4Qn+smcAKRTL1Y65UDQVAO+WK2+7gTplH54usjWAXek+K+LCuxEwGMLul0R4EPFfz8L18zzKmDxIKSCN95LIuBGr3GujpevErqxGQDuLaPuyUAfBAPGg6Mx4OME2DhQVgUJWAIzQnBFfRAeMI5N1XEjBBiwjCxg0+qHYG7wt/GA8capDh+CqYkpCoykjPKWesio2gywEwD4qDEuDNjUJGCptQqUAB5MB3w1APBhg4gYsPQtCbib00Zpi3wrwM1FAOBjR2lrZBXCARY3J623bAS4yAQAPnIYHAOWkgSc2xS+T7MV4CAA8LF2BhiwBAwYP4+lPBsBdgIAH2XIgQHjTf+SrRw5auEAG5Dg9ID3t5TBgM3EWR88eMAVCVieYM5aDXgHUyQAmKiZR9nIFckJC/gFnALUgHew9QKAiZq5A3+EXspDAw7gP64GvIcxXQvfHl2B7tiozSf+y1JSNQ31gRYDQb6HteKQ4B3s4QucflRrDW8OKiHBujCO3s0u5qAjwKR0vnkDozL1emgd5W6EWa1ud7l97G0n3jhYzACOEMlHtVpjeBA/mLf/7IOoQsa7y+b7GDR3Rbw98fKQLy+5xv7VIXowIhy1ztUfbdzLYrz7cbrvRb/K+nf7wPPQpAXsEQ/7l2AXW97/AGkCwaNsIif8zU3y5eZaO/mK/jKDV1s872/Fz11K5TLE1zzEiP1km8ndDMcj3JvmFfqdvubhD8TgHPiN+LViAAAAAElFTkSuQmCC"></p>
<blockquote>
<p>nginx和openresty升级方式大同小异，这里以openresty为例介绍openresty平滑升级的详细操作方法</p>
</blockquote>
<h4 id="1-查看nginx当前版本以及编译参数"><a href="#1-查看nginx当前版本以及编译参数" class="headerlink" title="1. 查看nginx当前版本以及编译参数"></a>1. 查看nginx当前版本以及编译参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~<span class="comment"># /usr/local/openresty/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: openresty/1.11.2.1</span><br><span class="line">configure arguments: --prefix=/usr/local/openresty/nginx</span><br></pre></td></tr></table></figure>

<h4 id="2-下载最新版本nginx-解压"><a href="#2-下载最新版本nginx-解压" class="headerlink" title="2. 下载最新版本nginx,解压"></a>2. 下载最新版本nginx,解压</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~<span class="comment"># wget https://openresty.org/download/openresty-1.11.2.4.tar.gz -O /tmp/openresty-1.11.2.4.tar.gz</span></span><br><span class="line">root@yunwei:~<span class="comment"># cd /tmp/</span></span><br><span class="line">root@yunwei:/tmp<span class="comment"># tar -xzvf openresty-1.11.2.4.tar.gz</span></span><br></pre></td></tr></table></figure>

<h4 id="3-编译openresty"><a href="#3-编译openresty" class="headerlink" title="3. 编译openresty"></a>3. 编译openresty</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:/tmp<span class="comment"># cd openresty-1.11.2.4/</span></span><br><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># ./configure --prefix=/usr/local/openresty  --with-luajit --with-http_iconv_module --with-http_stub_status_module --add-module=../ngx_dynamic_upstream-master -j6 &amp;&amp; make -j6</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：不要进行make install，这里的编译参数要与原环境编译参数一致，否则可能引起服务启动失败</p>
</blockquote>
<h4 id="4-找到编辑的二进制命令，测试能否执行"><a href="#4-找到编辑的二进制命令，测试能否执行" class="headerlink" title="4. 找到编辑的二进制命令，测试能否执行"></a>4. 找到编辑的二进制命令，测试能否执行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># ls build/nginx-1.11.2/objs/nginx</span></span><br><span class="line">build/nginx-1.11.2/objs/nginx</span><br><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># build/nginx-1.11.2/objs/nginx -v</span></span><br><span class="line">nginx version: openresty/1.11.2.4</span><br></pre></td></tr></table></figure>

<h4 id="5-备份旧版本的nginx文件"><a href="#5-备份旧版本的nginx文件" class="headerlink" title="5. 备份旧版本的nginx文件"></a>5. 备份旧版本的nginx文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@openresty-japi-write01:~<span class="comment"># cp /usr/local/openresty/nginx/sbin/nginx /tmp/nginx.bak</span></span><br></pre></td></tr></table></figure>

<h4 id="6-使用编译生成的二进制nginx文件，升级生产环境版本"><a href="#6-使用编译生成的二进制nginx文件，升级生产环境版本" class="headerlink" title="6. 使用编译生成的二进制nginx文件，升级生产环境版本"></a>6. 使用编译生成的二进制nginx文件，升级生产环境版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># install build/nginx-1.11.2/objs/nginx /usr/local/openresty/nginx/sbin/nginx</span></span><br><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># /usr/local/openresty/nginx/sbin/nginx -v</span></span><br><span class="line">nginx version: openresty/1.11.2.4</span><br></pre></td></tr></table></figure>

<h4 id="7-在不影响生产环境的情况下重启nginx服务，才能生效"><a href="#7-在不影响生产环境的情况下重启nginx服务，才能生效" class="headerlink" title="7. 在不影响生产环境的情况下重启nginx服务，才能生效"></a>7. 在不影响生产环境的情况下重启nginx服务，才能生效</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~# /usr/local/openresty/nginx/sbin/nginx -s stop</span><br><span class="line">root@yunwei:~# /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">root@yunwei:~# curl -I 127.0.0.1:8081</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Server: openresty/1.11.2.4</span><br><span class="line">Date: Thu, 13 Jul 2017 08:34:35 GMT</span><br></pre></td></tr></table></figure>

<h4 id="8-最后检查日志是否正常"><a href="#8-最后检查日志是否正常" class="headerlink" title="8. 最后检查日志是否正常"></a>8. 最后检查日志是否正常</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~<span class="comment"># tailf /data/nginx/log/access.log</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/13/ansible%E7%9A%84%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/13/ansible%E7%9A%84%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">ansible的学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-13 21:37:00" itemprop="dateCreated datePublished" datetime="2017-07-13T21:37:00+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、ansible的安装"><a href="#一、ansible的安装" class="headerlink" title="一、ansible的安装"></a>一、ansible的安装</h3><h4 id="1-安装ansible，ansible需要python支持，所有一并安装python"><a href="#1-安装ansible，ansible需要python支持，所有一并安装python" class="headerlink" title="1. 安装ansible，ansible需要python支持，所有一并安装python"></a>1. 安装ansible，ansible需要python支持，所有一并安装python</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># yum -y install python ansible</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="2-创建一个工作目录，hosts包含一台主机"><a href="#2-创建一个工作目录，hosts包含一台主机" class="headerlink" title="2.创建一个工作目录，hosts包含一台主机"></a>2.创建一个工作目录，hosts包含一台主机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># mkdir playbook</span></span><br><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts</span></span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
<h4 id="3-ansible服务器与其他机器创建信任关系"><a href="#3-ansible服务器与其他机器创建信任关系" class="headerlink" title="3. ansible服务器与其他机器创建信任关系"></a>3. ansible服务器与其他机器创建信任关系</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">[root@student01 ~]<span class="comment"># ssh-copy-id root@student02</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="4-使用ping模块测试连通状态"><a href="#4-使用ping模块测试连通状态" class="headerlink" title="4. 使用ping模块测试连通状态"></a>4. 使用ping模块测试连通状态</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m ping</span></span><br><span class="line">student02 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>注：如果命令执行失败，可以在命令后面加上-vvvv，查看详细信息</p>
</blockquote>
<pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m ping -vvvv</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="5-查看服务器启动时间"><a href="#5-查看服务器启动时间" class="headerlink" title="5.  查看服务器启动时间"></a>5.  查看服务器启动时间</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -a &quot;uptime&quot;</span></span><br><span class="line">student02 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"> 16:33:32 up  1:22,  2 <span class="built_in">users</span>,  load average: 0.00, 0.01, 0.05</span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="6-安装nginx服务以及重启nginx服务"><a href="#6-安装nginx服务以及重启nginx服务" class="headerlink" title="6. 安装nginx服务以及重启nginx服务"></a>6. 安装nginx服务以及重启nginx服务</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m yum -a &quot;name=nginx&quot;</span></span><br><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m service -a &quot;name=nginx state=restarted&quot;</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h3 id="二、YAML语法介绍"><a href="#二、YAML语法介绍" class="headerlink" title="二、YAML语法介绍"></a>二、YAML语法介绍</h3><h4 id="1-文件的起始"><a href="#1-文件的起始" class="headerlink" title="1. 文件的起始"></a>1. <strong>文件的起始</strong></h4><p>YAML文件以<code>---</code>开头以标记文件的开头，如果忘记开头三个减号，也不会影响Ansible的运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---</span><br></pre></td></tr></table></figure>
<h4 id="2-注释"><a href="#2-注释" class="headerlink" title="2. 注释"></a>2. <strong>注释</strong></h4><p>注释以<code>#</code>开头，一直到本行的结束</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#This is a YAML comment</span></span><br></pre></td></tr></table></figure>
<h4 id="3-字符串"><a href="#3-字符串" class="headerlink" title="3. 字符串"></a>3. <strong>字符串</strong></h4><p>YAML字符串不需要使用<code>&quot;&quot;</code>引起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ansible playbook</span><br></pre></td></tr></table></figure>
<h4 id="4-布尔值"><a href="#4-布尔值" class="headerlink" title="4. 布尔值"></a>4. <strong>布尔值</strong></h4><p>Ansible经常使用的布尔值有<code>ture</code>和<code>false</code>，<code>yes</code>和<code>no</code></p>
<h4 id="5-列表"><a href="#5-列表" class="headerlink" title="5. 列表"></a>5. <strong>列表</strong></h4><p>列表中的所有成员都开始于相同的缩进级别, 并且使用一个<code>- </code> 作为开头</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- bash shell</span><br><span class="line">- python</span><br><span class="line">- c++</span><br></pre></td></tr></table></figure>
<h4 id="6-字典"><a href="#6-字典" class="headerlink" title="6. 字典"></a>6. <strong>字典</strong></h4><p>由一个简单的<code>键: 值</code>的形式组成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostname: student01</span><br><span class="line">ip: 172.25.0.11</span><br><span class="line">server: web</span><br></pre></td></tr></table></figure>
<h4 id="7-折行"><a href="#7-折行" class="headerlink" title="7. 折行"></a>7. <strong>折行</strong></h4><p>在需要向模块传递很多参数的时候，为了美观可以把很长的段落写成多行，使用<code>&gt;</code>标记折行，YAML会把折行替换为空格</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip: &gt;</span><br><span class="line">172.25.0.11</span><br><span class="line">172.25.0.12</span><br></pre></td></tr></table></figure>
<blockquote>
<p>  注：JSON文件可以直接当做YAML文件使用，但是不建议把playbook写成JSON脚本，因为YAML的亮点就是易于阅读</p>
</blockquote>
<h3 id="三、playbook简介"><a href="#三、playbook简介" class="headerlink" title="三、playbook简介"></a>三、playbook简介</h3><blockquote>
<p>playbook是用于配置管理的脚本，使用Ansible时大部分时间在编写playbook</p>
</blockquote>
<h4 id="1-我们先写一个简单的playbook，搭建web服务"><a href="#1-我们先写一个简单的playbook，搭建web服务" class="headerlink" title="1. 我们先写一个简单的playbook，搭建web服务"></a>1. 我们先写一个简单的playbook，搭建web服务</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/web-configure.yml </span></span><br><span class="line">- name: configure webserver with nginx</span><br><span class="line">  hosts: webserver</span><br><span class="line">  sudo: Ture</span><br><span class="line">  tasks:</span><br><span class="line">    - name: install nginx</span><br><span class="line">      yum: name=nginx update_cache=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">    - name: copy nginx config file</span><br><span class="line">      copy: src=files/nginx_8080_localhost.conf dest=/etc/nginx/conf.d/8080</span><br><span class="line">_localhost.conf</span><br><span class="line">    </span><br><span class="line">    - name: copy index.html</span><br><span class="line">      template: src=templates/index.html.j2 dest=/usr/share/nginx/html/inde</span><br><span class="line">x.html mode=0644</span><br><span class="line">    </span><br><span class="line">    - name: restart nginx</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line">       </span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>在playbook中，建议向模块传递参数的时候用yes和no，在其他地方使用ture和false</p>
</blockquote>
<h4 id="2-把nginx的配置文件放在playbook-x2F-files-x2F-nginx-8080-localhost-conf-，用这个配置文件覆盖默认的配置文件"><a href="#2-把nginx的配置文件放在playbook-x2F-files-x2F-nginx-8080-localhost-conf-，用这个配置文件覆盖默认的配置文件" class="headerlink" title="2. 把nginx的配置文件放在playbook&#x2F;files&#x2F;nginx_8080_localhost.conf ，用这个配置文件覆盖默认的配置文件"></a>2. 把nginx的配置文件放在playbook&#x2F;files&#x2F;nginx_8080_localhost.conf ，用这个配置文件覆盖默认的配置文件</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">	[root@student01 ~]<span class="comment"># cat playbook/files/nginx_8080_localhost.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">listen       8080 default_server;</span><br><span class="line">listen       [::]:8080 default_server;</span><br><span class="line"></span><br><span class="line">root         /usr/share/nginx/html;</span><br><span class="line">	index index.html index.htm;</span><br><span class="line">	server_name localhost;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page 404 /404.html;</span><br><span class="line">location = /40x.html &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page 500 502 503 504 /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>安装惯例，我们把一般文件放在files目录中，将jinja2模板文件放在templates目录中</p>
</blockquote>
<h4 id="3-创建一个首页"><a href="#3-创建一个首页" class="headerlink" title="3. 创建一个首页"></a>3. 创建一个首页</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 templates]<span class="comment"># cat index.html.j2 </span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;<span class="built_in">head</span>&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;nginx, configured by ansible&lt;/h1&gt;</span><br><span class="line">  &lt;p&gt; <span class="keyword">if</span> you can see this, ansible successfully installed nginx.&lt;/p&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123; ansible_managed &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>这个模板引用了一个ansible变量<em>ansible_managed</em>，当ansible渲染这个模板的时候，会将变量替换成这个模板文件生成时间相关信息</p>
</blockquote>
<h4 id="4-在hosts文件的主机前面加上-webserver-，创建一个webserver群组，表明下面的主机属于webserver"><a href="#4-在hosts文件的主机前面加上-webserver-，创建一个webserver群组，表明下面的主机属于webserver" class="headerlink" title="4. 在hosts文件的主机前面加上[webserver]，创建一个webserver群组，表明下面的主机属于webserver"></a>4. 在hosts文件的主机前面加上[webserver]，创建一个webserver群组，表明下面的主机属于webserver</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver]</span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br><span class="line">student03 ansible_ssh_host=172.25.0.13 ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="5-执行playbook"><a href="#5-执行playbook" class="headerlink" title="5. 执行playbook"></a>5. 执行playbook</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment">#ansible-playbook -i playbook/inventory/hosts      playbook/web-configure.yml</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="6-如果没有任何报错，现在可以通过浏览器访问http-localhost-8080并看到HTML网页"><a href="#6-如果没有任何报错，现在可以通过浏览器访问http-localhost-8080并看到HTML网页" class="headerlink" title="6. 如果没有任何报错，现在可以通过浏览器访问http://localhost:8080并看到HTML网页"></a>6. 如果没有任何报错，现在可以通过浏览器访问<a href="http://localhost:8080并看到HTML网页">http://localhost:8080并看到HTML网页</a></h4><h3 id="四、playbook深入剖析"><a href="#四、playbook深入剖析" class="headerlink" title="四、playbook深入剖析"></a>四、playbook深入剖析</h3><h4 id="1-play"><a href="#1-play" class="headerlink" title="1. play"></a>1. <strong>play</strong></h4><p>通过观察YAML发现，playbook就是一组play组成的列表，每个play都必须包含两项</p>
<p><code>host</code>：需要配置一组主机</p>
<p><code>task</code>：需要在这些主机上执行的任务</p>
<p>play还支持一些可选的配置，先介绍三个最常用的</p>
<p><code>name</code>：一个注释，描述这个play是做什么的</p>
<p><code>sudo</code>：如果为真，Ansible会在执行task的时候运行sudo切换root用户执行</p>
<p><code>var</code>：变量和值组成的列表</p>
<h4 id="2-task"><a href="#2-task" class="headerlink" title="2. task"></a>2. <strong>task</strong></h4><p>举例一个安装nginx的task</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">yum: name=nginx update_cache=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<p>这个task告诉yum安装一个叫nginx的软件包，安装前更新安装包缓存</p>
<p>如果想要把参数写成多行的话，可以使用折行语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">yum: &gt;</span><br><span class="line">name=nginx</span><br><span class="line">update_cacha=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<h4 id="3-模块"><a href="#3-模块" class="headerlink" title="3. 模块"></a>3. <strong>模块</strong></h4><p>模块是由Ansible包装后在主机上执行的一系列脚本，常用的有以下模块<br><code>yum</code>：使用yum包管理器安装和删除软件包<br><code>copy</code>：将文件从本地复制到主机<br><code>file</code>：设置文件、符号链接或者目录属性<br><code>service</code>：启动、停止或者重启服务<br><code>template</code>：从模板生成文件并复制到主机</p>
<blockquote>
<p>  ansible-doc命令工具可以查看官方文档</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible-doc service</span></span><br></pre></td></tr></table></figure>
<h4 id="4-将他们整合到一起，组成一个play"><a href="#4-将他们整合到一起，组成一个play" class="headerlink" title="4. 将他们整合到一起，组成一个play"></a>4. <strong>将他们整合到一起，组成一个play</strong></h4><p>这是一张实体关系图，他描述了playbook、play、host、task和module之间的关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">playbook--&gt;play</span><br><span class="line">play--&gt;host</span><br><span class="line">play--&gt;task</span><br><span class="line">task--&gt;module</span><br></pre></td></tr></table></figure>
<h4 id="5-跟踪主机状态"><a href="#5-跟踪主机状态" class="headerlink" title="5. 跟踪主机状态"></a>5. <strong>跟踪主机状态</strong></h4><p>当运行ansible-playbook时，Ansible便会输出他在play中执行每一个task的状态信息</p>
<p>有些任务的状态是changed，显示的黄色，状态ok，显示的是绿色</p>
<p>Ansible模块会在采取任何行动之前查看主机的状态是否需要改变，如果主机的参数与模块的参数相匹配，那么不会做任何操作，直接响应ok，如果参数不匹配，则会改变主机的状态并的返回changed</p>
<h4 id="6-vars"><a href="#6-vars" class="headerlink" title="6. vars"></a>6. <strong>vars</strong></h4><p>在playbook的play中可以使用vars区段定义变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">server_name: localhost</span><br></pre></td></tr></table></figure>
<h4 id="7-handler"><a href="#7-handler" class="headerlink" title="7. handler"></a>7. <strong>handler</strong></h4><p>handler是Ansible提供的条件机制之一，handler和task很相似，但是他只有被task通知后才会执行，Ansible识别到task改变了系统的状态，task就会触发通知机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">- name: install nginx</span><br><span class="line">	    yum: name=nginx update_cache=<span class="built_in">yes</span></span><br><span class="line">	    notify: restart nginx</span><br><span class="line">	handler:</span><br><span class="line">	  - name: restart nginx</span><br><span class="line">	    service: &gt;</span><br><span class="line">	        name=nginx</span><br><span class="line">	        state=restarted</span><br></pre></td></tr></table></figure>
<pre><code>  task将handler的名字`restart nginx`作为参数传递，只有`install nginx`这个task被执行成功了，才会触发`restart nginx`
</code></pre>
<blockquote>
<p>  注意：handler只会在task执行完毕了才会执行，即使触发了很多次也只会执行一次</p>
</blockquote>
<h3 id="五、inventory：描述你的服务器"><a href="#五、inventory：描述你的服务器" class="headerlink" title="五、inventory：描述你的服务器"></a>五、inventory：描述你的服务器</h3><h4 id="1-inventory描述"><a href="#1-inventory描述" class="headerlink" title="1. inventory描述"></a>1. <strong>inventory描述</strong></h4><p>在Ansible中，描述主机的方法是把它们写到inventory文件中，一个简单的inventory可以只包含一些主机列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">student01</span><br><span class="line">student02.example.com</span><br><span class="line">172.25.0.13</span><br></pre></td></tr></table></figure>
<h4 id="2-inventory行为参数"><a href="#2-inventory行为参数" class="headerlink" title="2. inventory行为参数"></a>2. <strong>inventory行为参数</strong></h4><table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">默认值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ansible_ssh_host</td>
<td align="left">主机的名字</td>
<td align="left">ssh目的主机</td>
</tr>
<tr>
<td align="left">ansible_ssh_port</td>
<td align="left">22</td>
<td align="left">ssh目的端口</td>
</tr>
<tr>
<td align="left">ansible_ssh_user</td>
<td align="left">root</td>
<td align="left">ssh登录用户</td>
</tr>
<tr>
<td align="left">ansible_ssh_pass</td>
<td align="left">none</td>
<td align="left">ssh认证密码</td>
</tr>
<tr>
<td align="left">ansible_connection</td>
<td align="left">smart</td>
<td align="left">ssh连接主机的连接模式</td>
</tr>
<tr>
<td align="left">ansible_ssh_private_key_file</td>
<td align="left">none</td>
<td align="left">ssh认证秘钥</td>
</tr>
<tr>
<td align="left">ansible_shell_type</td>
<td align="left">bash</td>
<td align="left">命令使用的shell</td>
</tr>
<tr>
<td align="left">ansible_python_interpreter</td>
<td align="left">&#x2F;usr&#x2F;bin&#x2F;python</td>
<td align="left">python解释器路径</td>
</tr>
</tbody></table>
<h4 id="3-群组"><a href="#3-群组" class="headerlink" title="3. 群组"></a>3. <strong>群组</strong></h4><p>在执行task的时候，我们希望针对一组主机执行操作，这时候就可以定义群组，Ansible有一个默认的群组<code>all</code>，包含了所有的主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible all -i playbook/inventory/hosts -a &#x27;date&#x27;</span></span><br><span class="line">student02 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Fri May 19 16:11:53 CST 2017</span><br><span class="line"></span><br><span class="line">student03 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Fri May 19 16:11:53 CST 2017</span><br></pre></td></tr></table></figure>
<p>我们可以在inventory文件中定义自己的群组，inventory文件是<code>.ini</code>格式的，在<code>.ini</code>格式中，同类的配置值归类在一起组成区段，我定义了一个群组webserver，包含两台主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver]</span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br><span class="line">student03 ansible_ssh_host=172.25.0.13 ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
<p>上面的playbook&#x2F;inventory&#x2F;hosts中，student02是主机<code>172.25.0.12</code>的别名，指定ssh端口为22</p>
<h4 id="4-群组嵌套"><a href="#4-群组嵌套" class="headerlink" title="4. 群组嵌套"></a>4. 群组嵌套</h4><p>Ansible还支持群组嵌套，定义一个群组包含已经定义的两个群组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver02]</span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br><span class="line">[webserver03]</span><br><span class="line">student03 ansible_ssh_host=172.25.0.13 ansible_ssh_port=22</span><br><span class="line">[webserver]</span><br><span class="line">webserver02</span><br><span class="line">webserver03</span><br></pre></td></tr></table></figure>
<h4 id="5-编号主机"><a href="#5-编号主机" class="headerlink" title="5. 编号主机"></a>5. 编号主机</h4><p>当inventory包含很多主机的时候，可以通过编号范围指定主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver]</span><br><span class="line">student[01:20] ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
<h4 id="6-群组变量"><a href="#6-群组变量" class="headerlink" title="6. 群组变量"></a>6. 群组变量</h4><p>可以在工作目录playbook目录中新建目录host_vars&#x2F;production来存放变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/host_vars/production/webserver </span></span><br><span class="line">webserver:</span><br><span class="line">name=webserver</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/13/nginx%E7%9A%84%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/13/nginx%E7%9A%84%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">nginx的学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-13 21:37:00" itemprop="dateCreated datePublished" datetime="2017-07-13T21:37:00+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、用户访问网站的完整访问流程"><a href="#一、用户访问网站的完整访问流程" class="headerlink" title="一、用户访问网站的完整访问流程"></a>一、用户访问网站的完整访问流程</h3><h4 id="1-客户端用户在浏览器输入网址www-baidu-com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www-baidu-com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www-baidu-com的服务器。"><a href="#1-客户端用户在浏览器输入网址www-baidu-com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www-baidu-com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www-baidu-com的服务器。" class="headerlink" title="1. 客户端用户在浏览器输入网址www.baidu.com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www.baidu.com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www.baidu.com的服务器。"></a>1. 客户端用户在浏览器输入网址<a target="_blank" rel="noopener" href="http://www.baidu.com,回车后,系统首先会查找系统本地的dns缓存及hosts文件信息,确定是否存在www.baidu.com域名对应的ip解析记录,如果有就直接获取ip地址,然后去访问这个ip地址对应的域名www.baidu.com的服务器./">www.baidu.com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www.baidu.com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www.baidu.com的服务器。</a></h4><h4 id="2-如果客户端本地DNS缓存及hosts文件没有www-baidu-com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local-DNS服务器解析，如果local-DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local-DNS会请求其他的DNS服务器"><a href="#2-如果客户端本地DNS缓存及hosts文件没有www-baidu-com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local-DNS服务器解析，如果local-DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local-DNS会请求其他的DNS服务器" class="headerlink" title="2. 如果客户端本地DNS缓存及hosts文件没有www.baidu.com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local DNS服务器解析，如果local DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local DNS会请求其他的DNS服务器"></a>2. 如果客户端本地DNS缓存及hosts文件没有<a target="_blank" rel="noopener" href="http://www.baidu.com域名对应的ip解析记录,那么系统会把浏览器的解析请求发送给客户端本地设置的local/">www.baidu.com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local</a> DNS服务器解析，如果local DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local DNS会请求其他的DNS服务器</h4><h4 id="3-local-DNS从DNS系统的根开始请求对www-baidu-com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www-baidu-com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www-baidu-com对应的ip解析记录，如果没有解析记录，表示企业没有对www-baidu-com域名做解析设置，即网站没有架设好"><a href="#3-local-DNS从DNS系统的根开始请求对www-baidu-com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www-baidu-com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www-baidu-com对应的ip解析记录，如果没有解析记录，表示企业没有对www-baidu-com域名做解析设置，即网站没有架设好" class="headerlink" title="3. local DNS从DNS系统的根开始请求对www.baidu.com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www.baidu.com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www.baidu.com对应的ip解析记录，如果没有解析记录，表示企业没有对www.baidu.com域名做解析设置，即网站没有架设好"></a>3. local DNS从DNS系统的根开始请求对<a target="_blank" rel="noopener" href="http://www.baidu.com域名的解析,并针对各个层级的dns服务器系统进行一系列的查找,最终会找到www.baidu.com域名对应的授权dns服务器,而这个授权的dns服务器是企业购买域名时用于管理域名解析的服务器,这个授权服务器会有www.baidu.com对应的ip解析记录,如果没有解析记录,表示企业没有对www.baidu.com域名做解析设置,即网站没有架设好/">www.baidu.com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www.baidu.com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www.baidu.com对应的ip解析记录，如果没有解析记录，表示企业没有对www.baidu.com域名做解析设置，即网站没有架设好</a></h4><h4 id="4-www-baidu-com域名的授权DNS服务器会把www-baidu-com对应的最终ip解析记录发给local-DNS"><a href="#4-www-baidu-com域名的授权DNS服务器会把www-baidu-com对应的最终ip解析记录发给local-DNS" class="headerlink" title="4. www.baidu.com域名的授权DNS服务器会把www.baidu.com对应的最终ip解析记录发给local DNS"></a>4. <a target="_blank" rel="noopener" href="http://www.baidu.com域名的授权dns服务器会把www.baidu.com对应的最终ip解析记录发给local/">www.baidu.com域名的授权DNS服务器会把www.baidu.com对应的最终ip解析记录发给local</a> DNS</h4><h4 id="5-local-DNS把来自授权DNS服务器www-baidu-com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS-TTL值控制的时间内不会过期"><a href="#5-local-DNS把来自授权DNS服务器www-baidu-com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS-TTL值控制的时间内不会过期" class="headerlink" title="5. local DNS把来自授权DNS服务器www.baidu.com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS TTL值控制的时间内不会过期"></a>5. local DNS把来自授权DNS服务器<a target="_blank" rel="noopener" href="http://www.baidu.com对应的ip解析记录发给客户端浏览器,并且他会把该域名和ip的对应解析缓存起来,以便下一次更快的返回相同解析请求的记录,这些缓存记录在dns/">www.baidu.com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS</a> TTL值控制的时间内不会过期</h4><h4 id="6-客户端浏览器获取www-baidu-com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器"><a href="#6-客户端浏览器获取www-baidu-com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器" class="headerlink" title="6. 客户端浏览器获取www.baidu.com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器"></a>6. 客户端浏览器获取<a target="_blank" rel="noopener" href="http://www.baidu.com的对应ip,浏览器会请求获得ip地址对应的网站服务器,网站服务器接收到客户的请求并响应处理,将客户请求的内容返回给客户端浏览器/">www.baidu.com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器</a></h4><h3 id="二、ginx源码包安装"><a href="#二、ginx源码包安装" class="headerlink" title="二、ginx源码包安装"></a>二、ginx源码包安装</h3><h4 id="1-安装Nginx依赖包"><a href="#1-安装Nginx依赖包" class="headerlink" title="1. 安装Nginx依赖包"></a>1. 安装Nginx依赖包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel open openssl-devel</span></span><br></pre></td></tr></table></figure>
<h4 id="2-解压nginx安装包"><a href="#2-解压nginx安装包" class="headerlink" title="2. 解压nginx安装包"></a>2. 解压nginx安装包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tar -xzvf nginx-1.13.0.tar.gz</span></span><br></pre></td></tr></table></figure>
<h4 id="3-生成Makefile文件"><a href="#3-生成Makefile文件" class="headerlink" title="3. 生成Makefile文件"></a>3. 生成Makefile文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cd nginx-1.13.0/</span></span><br><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx-1.13.0 --with-http_stub_status_module --with-http_ssl_module</span></span><br><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># ll Makefile </span></span><br><span class="line">-rw-r--r--. 1 root root 376 May 22 10:39 Makefile</span><br></pre></td></tr></table></figure>
<h4 id="4-nginx的编译安装"><a href="#4-nginx的编译安装" class="headerlink" title="4. nginx的编译安装"></a>4. nginx的编译安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@student02 ~]<span class="comment"># useradd nginx -s /sbin/nologin -M</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ln -s /usr/local/nginx-1.13.0 /usr/local/nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ln -s /usr/local/nginx/sbin/nginx /usr/sbin/nginx</span></span><br></pre></td></tr></table></figure>
<h4 id="5-nginx安装目录介绍"><a href="#5-nginx安装目录介绍" class="headerlink" title="5. nginx安装目录介绍"></a>5. nginx安装目录介绍</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># cd /usr/local/nginx/</span></span><br><span class="line">[root@student02 nginx]<span class="comment"># ls</span></span><br><span class="line">conf  html  logs  sbin</span><br></pre></td></tr></table></figure>
<blockquote>
<p>conf存放了nginx所有的配置文件，nginx.conf是nginx的主配置文件，html目录存放了nginx服务器在运行过程中调用的网页文件，logs目录存放nginx的日志，sbin目录只有一个nginx文件，是nginx服务器的主程序</p>
</blockquote>
<h4 id="6-nginx的版本"><a href="#6-nginx的版本" class="headerlink" title="6. nginx的版本"></a>6. nginx的版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -v</span></span><br><span class="line">nginx version: nginx/1.10.2</span><br></pre></td></tr></table></figure>
<h4 id="7-检查nginx配置文件语法"><a href="#7-检查nginx配置文件语法" class="headerlink" title="7. 检查nginx配置文件语法"></a>7. 检查nginx配置文件语法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure>
<h4 id="8-启动nginx服务"><a href="#8-启动nginx服务" class="headerlink" title="8. 启动nginx服务"></a>8. 启动nginx服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ps -ef |grep nginx</span></span><br><span class="line">root       3757      1  0 11:00 ?        00:00:00 nginx: master process nginx</span><br><span class="line">nginx      3758   3757  0 11:00 ?        00:00:00 nginx: worker process</span><br><span class="line">root       3760   1074  0 11:00 pts/0    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>
<h4 id="9-重启nginx服务"><a href="#9-重启nginx服务" class="headerlink" title="9. 重启nginx服务"></a>9. 重启nginx服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -s stop</span></span><br><span class="line">[root@student02 ~]<span class="comment"># nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># nginx -s reload</span></span><br></pre></td></tr></table></figure>
<h4 id="10-查看nginx服务端口"><a href="#10-查看nginx服务端口" class="headerlink" title="10. 查看nginx服务端口"></a>10. 查看nginx服务端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># lsof -i :80</span></span><br><span class="line">COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx   3757  root    8u  IPv4  23526      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   3757  root    9u  IPv6  23527      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   3809 nginx    8u  IPv4  23526      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   3809 nginx    9u  IPv6  23527      0t0  TCP *:http (LISTEN)</span><br><span class="line">[root@student02 ~]<span class="comment"># netstat -nultp |grep :80&#x27; &#x27;</span></span><br><span class="line">tcp        0      0 0.0.0.0:80    0.0.0.0:*      LISTEN  3757/nginx: master</span><br><span class="line">tcp6       0      0 :::80         :::*           LISTEN  3757/nginx: master</span><br></pre></td></tr></table></figure>
<h4 id="11-检测nginx访问"><a href="#11-检测nginx访问" class="headerlink" title="11. 检测nginx访问"></a>11. 检测nginx访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># wget 172.25.0.12</span></span><br><span class="line">[root@student02 ~]<span class="comment"># curl 172.25.0.12</span></span><br></pre></td></tr></table></figure>

<h3 id="三、HTTP协议"><a href="#三、HTTP协议" class="headerlink" title="三、HTTP协议"></a>三、HTTP协议</h3><h4 id="1-HTTP的请求方法"><a href="#1-HTTP的请求方法" class="headerlink" title="1. HTTP的请求方法"></a>1. HTTP的请求方法</h4><p>在HTTP通信中，每个HTTP请求报文都包含一个请求方法，用于告诉web服务器需要执行哪些具体动作，这些动作包括：获取指定web页面、提交内容到服务器、删除服务器上资源文件等，这些HTTP请求报文的方法称作HTTP请求方法</p>
<table>
<thead>
<tr>
<th align="left">HTTP请求方法</th>
<th align="left">作用描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">客户端请求指定资源信息，服务器返回指定资源</td>
</tr>
<tr>
<td align="left">HEAD</td>
<td align="left">值请求相应报文中的HTTP首部</td>
</tr>
<tr>
<td align="left">POST</td>
<td align="left">将客户端的数据提交到服务器</td>
</tr>
<tr>
<td align="left">PUT</td>
<td align="left">从客户端上传数据取代指定的文档内容</td>
</tr>
<tr>
<td align="left">DELETE</td>
<td align="left">请求服务器删除Request-URI所标识的资源</td>
</tr>
<tr>
<td align="left">MOVE</td>
<td align="left">请求服务器将指定的页面移至另一个网络地址</td>
</tr>
</tbody></table>
<h4 id="2-HTTP状态码"><a href="#2-HTTP状态码" class="headerlink" title="2. HTTP状态码"></a>2. HTTP状态码</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/elk%E5%AD%A6%E4%B9%A0%E4%B9%8Belasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/elk%E5%AD%A6%E4%B9%A0%E4%B9%8Belasticsearch/" class="post-title-link" itemprop="url">elk学习之elasticsearch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 23:45:20" itemprop="dateCreated datePublished" datetime="2017-07-11T23:45:20+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="ELK的学习之Elasticsearch"><a href="#ELK的学习之Elasticsearch" class="headerlink" title="ELK的学习之Elasticsearch"></a>ELK的学习之Elasticsearch</h3><h4 id="安装Elasticsearch5-5"><a href="#安装Elasticsearch5-5" class="headerlink" title="安装Elasticsearch5.5"></a>安装Elasticsearch5.5</h4><p>Elasticsearch至少需要Java 8，安装并检查java版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$JAVA_HOME</span></span><br></pre></td></tr></table></figure>

<p>下载Elasticsearch5.5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.5.0.tar.gz</span><br><span class="line">tar -xvf elasticsearch-5.5.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>简单启动Elasticsearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> elasticsearch-5.5.0/bin</span><br><span class="line">./elasticsearch</span><br></pre></td></tr></table></figure>

<p>如果一切顺利安装，您应该看到一堆如下所示的消息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[2016-09-16T14:17:51,251][INFO ][o.e.n.Node               ] [] initializing ...</span><br><span class="line">[2016-09-16T14:17:51,329][INFO ][o.e.e.NodeEnvironment    ] [6-bjhwl] using [1] data paths, mounts [[/ (/dev/sda1)]], net usable_space [317.7gb], net total_space [453.6gb], spins? [no], types [ext4]</span><br><span class="line">[2016-09-16T14:17:51,330][INFO ][o.e.e.NodeEnvironment    ] [6-bjhwl] heap size [1.9gb], compressed ordinary object pointers [<span class="literal">true</span>]</span><br><span class="line">[2016-09-16T14:17:51,333][INFO ][o.e.n.Node               ] [6-bjhwl] node name [6-bjhwl] derived from node ID; <span class="built_in">set</span> [node.name] to override</span><br><span class="line">[2016-09-16T14:17:51,334][INFO ][o.e.n.Node               ] [6-bjhwl] version[5.5.0], pid[21261], build[f5daa16/2016-09-16T09:12:24.346Z], OS[Linux/4.4.0-36-generic/amd64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_60/25.60-b23]</span><br><span class="line">[2016-09-16T14:17:51,967][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [aggs-matrix-stats]</span><br><span class="line">[2016-09-16T14:17:51,967][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [ingest-common]</span><br><span class="line">[2016-09-16T14:17:51,967][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [lang-expression]</span><br><span class="line">[2016-09-16T14:17:51,967][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [lang-groovy]</span><br><span class="line">[2016-09-16T14:17:51,967][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [lang-mustache]</span><br><span class="line">[2016-09-16T14:17:51,967][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [lang-painless]</span><br><span class="line">[2016-09-16T14:17:51,967][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [percolator]</span><br><span class="line">[2016-09-16T14:17:51,968][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [reindex]</span><br><span class="line">[2016-09-16T14:17:51,968][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [transport-netty3]</span><br><span class="line">[2016-09-16T14:17:51,968][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded module [transport-netty4]</span><br><span class="line">[2016-09-16T14:17:51,968][INFO ][o.e.p.PluginsService     ] [6-bjhwl] loaded plugin [mapper-murmur3]</span><br><span class="line">[2016-09-16T14:17:53,521][INFO ][o.e.n.Node               ] [6-bjhwl] initialized</span><br><span class="line">[2016-09-16T14:17:53,521][INFO ][o.e.n.Node               ] [6-bjhwl] starting ...</span><br><span class="line">[2016-09-16T14:17:53,671][INFO ][o.e.t.TransportService   ] [6-bjhwl] publish_address &#123;192.168.8.112:9300&#125;, bound_addresses &#123;&#123;192.168.8.112:9300&#125;</span><br><span class="line">[2016-09-16T14:17:53,676][WARN ][o.e.b.BootstrapCheck     ] [6-bjhwl] max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]</span><br><span class="line">[2016-09-16T14:17:56,731][INFO ][o.e.h.HttpServer         ] [6-bjhwl] publish_address &#123;192.168.8.112:9200&#125;, bound_addresses &#123;[::1]:9200&#125;, &#123;192.168.8.112:9200&#125;</span><br><span class="line">[2016-09-16T14:17:56,732][INFO ][o.e.g.GatewayService     ] [6-bjhwl] recovered [0] indices into cluster_state</span><br><span class="line">[2016-09-16T14:17:56,748][INFO ][o.e.n.Node               ] [6-bjhwl] started</span><br></pre></td></tr></table></figure>

<p>可以在启动Elasticsearch时指定集群和节点名，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch -Ecluster.name=my_cluster_name -Enode.name=my_node_name</span><br></pre></td></tr></table></figure>

<h4 id="集群健康检查"><a href="#集群健康检查" class="headerlink" title="集群健康检查"></a>集群健康检查</h4><p>要检查群集运行状况，我们将使用_cat API</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/_cat/health?v&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到，我们的名为“elasticsearch”的集群已经处于绿色状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1475247709 17:01:49  elasticsearch green           1         1      0   0    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure>

<p>我们还可以得到我们集群中节点的列表如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/_cat/nodes?v&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到我们的一个名为“PB2SGZY”的节点，它是当前在我们的集群中的单个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">127.0.0.1           10           5   5    4.46                        mdi      *      PB2SGZY</span><br></pre></td></tr></table></figure>

<p>现在我们来看看所有的指数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/_cat/indices?v&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这只是意味着我们在集群中没有任何索引</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size</span><br></pre></td></tr></table></figure>

<h4 id="创建一个索引"><a href="#创建一个索引" class="headerlink" title="创建一个索引"></a>创建一个索引</h4><p>现在我们创建一个名为“customer”的索引，然后再次列出所有索引</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">&#x27;localhost:9200/customer?pretty&amp;pretty&#x27;</span></span><br><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/_cat/indices?v&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>

<p>第一个命令使用PUT动词创建名为“customer”的索引<br>第二个命令的结果告诉我们，我们现在有一个名为customer的索引，它有5个主分片和1个副本（默认值），它包含0个文档。</p>
<h4 id="索引和查询文档"><a href="#索引和查询文档" class="headerlink" title="索引和查询文档"></a>索引和查询文档</h4><p>我们现在把一些东西放在我们的指数中，要索引一个文档，我们必须告诉Elasticsearch应该去哪里索引</p>
<p>我们将一个简单的客户文档索引到客户索引“外部”类型中，ID为1，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">&#x27;localhost:9200/customer/external/1?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;John Doe&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>得到的显示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;customer&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;external&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_version&quot;</span> : 1,</span><br><span class="line">  <span class="string">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : 2,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : 1,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;created&quot;</span> : <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看出，在客户索引和外部类型中成功创建了一个新的客户文档。该文档的内部ID为1，我们在索引时指定。</p>
<p>重要的是要注意，在您可以将文档编入索引之前，Elasticsearch不要求您首先创建索引</p>
<p>我们现在检索我们刚刚编入索引的文档：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/customer/external/1?pretty&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>

<p>我们发现我们发现了一个带有请求的ID 1和另一个字段_source的文档，它返回了从上一步索引的完整的JSON文档。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;customer&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;external&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_version&quot;</span> : 1,</span><br><span class="line">  <span class="string">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;_source&quot;</span> : &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><p>现在我们来删除我们刚刚创建的索引，然后再次列出所有索引：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">&#x27;localhost:9200/customer?pretty&amp;pretty&#x27;</span></span><br><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/_cat/indices?v&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>
<p>显示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size</span><br></pre></td></tr></table></figure>

<p>这意味着索引被成功删除，现在我们回到我们集群中没有任何东西的地方。</p>
<p>在继续之前，让我们再来看一下我们迄今为止学到的一些API命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /customer</span><br><span class="line">PUT /customer/external/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">GET /customer/external/1</span><br><span class="line">DELETE /customer</span><br></pre></td></tr></table></figure>

<p>如果我们仔细研究上述命令，我们实际上可以看到我们如何访问Elasticsearch中的数据。该模式可以总结如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;REST Verb&gt; /&lt;Index&gt;/&lt;Type&gt;/&lt;ID&gt;</span><br></pre></td></tr></table></figure>

<p>这个REST访问模式在所有API命令中是如此的普及，如果你可以简单地记住它，你将会很好地掌握Elasticsearch</p>
<h4 id="修改你的数据"><a href="#修改你的数据" class="headerlink" title="修改你的数据"></a>修改你的数据</h4><p>Elasticsearch提供近乎实时的数据操作和搜索功能。默认情况下，您可以从您索引&#x2F;更新&#x2F;删除数据的时间延迟一秒钟的延迟（刷新间隔），直到其出现在搜索结果中的时间为止。这是与其他平台（如SQL）的重要区别，其中数据在事务完成后立即可用。</p>
<p>我们以前看过我们如何索引一个文档。让我们再次回想一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">&#x27;localhost:9200/customer/external/1?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;John Doe&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>再次，上述将指定的文档索引到客户索引，外部类型，ID为1.如果我们再次使用不同（或相同）的文档执行上述命令，Elasticsearch将替换（即重新索引）一个新文档，其中ID为1：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">&#x27;localhost:9200/customer/external/2?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;Jane Doe&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>以上索引一个ID为2的新文档。索引时，ID部分是可选的。如果未指定，Elasticsearch将生成一个随机ID，然后使用它来索引文档。</p>
<p>此示例显示如何索引没有显示ID的文档：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&#x27;localhost:9200/customer/external?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;Jane Doe&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>请注意，在上述情况下，我们使用POST动词而不是PUT，因为我们没有指定ID。</p>
<h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><p>除了能够索引和替换文档之外，我们还可以更新文档。注意，虽然Elasticsearch实际上并没有在底下进行就地更新。每当我们进行更新时，Elasticsearch都会删除旧的文档，然后一次性地对更新应用的新文档进行索引</p>
<p>此示例显示如何通过将名称字段更改为“Jane Doe”来更新我们以前的文档（ID为1）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&#x27;localhost:9200/customer/external/1/_update?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;doc&quot;: &#123; &quot;name&quot;: &quot;Jane Doe&quot; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>此示例显示如何通过将名称字段更改为“Jane Doe”来更新我们以前的文档（ID为1），同时在其中添加一个年龄字段：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&#x27;localhost:9200/customer/external/1/_update?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;doc&quot;: &#123; &quot;name&quot;: &quot;Jane Doe&quot;, &quot;age&quot;: 20 &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>还可以使用简单的脚本来执行更新。此示例使用脚本将年龄增加5：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&#x27;localhost:9200/customer/external/1/_update?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;script&quot; : &quot;ctx._source.age += 5&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，ctx._source指的是当前的源文档即将被更新。</p>
<p>请注意，在撰写本文时，一次只能对单个文档执行更新。在将来，Elasticsearch可能会提供更新多个文档的能力，因为它具有查询条件（如SQL UPDATE-WHERE语句）。</p>
<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><p>删除文档是相当简单的。此示例显示如何删除我们之前的ID为2的客户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">&#x27;localhost:9200/customer/external/2?pretty&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>

<p>值得注意的是，删除整个索引而不是使用“按查询删除”API删除所有文档效率更高。</p>
<h4 id="按查询删除API"><a href="#按查询删除API" class="headerlink" title="按查询删除API"></a>按查询删除API</h4><p>_delete_by_query的最简单的用法只是在与查询匹配的每个文档上执行删除。这是API：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&#x27;localhost:9200/twitter/_delete_by_query?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; </span></span><br><span class="line"><span class="string">    &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;message&quot;: &quot;some message&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>该查询必须以与搜索API相同的方式作为查询键的值传递。您也可以以与搜索api相同的方式使用q参数。</p>
<p>_delete_by_query在启动时获取索引的快照，并使用内部版本控制删除它所发现的内容。这意味着如果文档在拍摄快照和处理删除请求之间发生变化，则会发生版本冲突。当版本匹配的文档被删除。</p>
<h4 id="批量处理"><a href="#批量处理" class="headerlink" title="批量处理"></a>批量处理</h4><p>除了能够索引，更新和删除单个文档外，Elasticsearch还提供了使用_bulk API批量执行上述任何操作的功能。这个功能很重要，因为它提供了一个非常有效的机制来尽可能快地进行多个操作，尽可能少的网络往返行程。</p>
<p>作为一个快速示例，以下调用在一个批量操作中调用两个文档（ID 1 - John Doe和ID 2 - Jane Doe）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&#x27;localhost:9200/customer/external/_bulk?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;name&quot;: &quot;John Doe&quot; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;name&quot;: &quot;Jane Doe&quot; &#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>此示例更新第一个文档（ID为1），然后在一个批量操作中删除第二个文档（ID为2）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&#x27;localhost:9200/customer/external/_bulk?pretty&amp;pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;&quot;update&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;doc&quot;: &#123; &quot;name&quot;: &quot;John Doe becomes Jane Doe&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;delete&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>请注意，对于删除操作，在它之后没有相应的源文档，因为删除只需要要删除的文档的ID。</p>
<h4 id="探索你的数据"><a href="#探索你的数据" class="headerlink" title="探索你的数据"></a>探索你的数据</h4><h5 id="样本数据集"><a href="#样本数据集" class="headerlink" title="样本数据集"></a>样本数据集</h5><p>现在我们已经看到了一些基础知识，我们来尝试一个更逼真的数据集。我准备了客户银行帐户信息的虚构JSON文档示例，每个文档都具有以下模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;account_number&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;balance&quot;</span>: 16623,</span><br><span class="line">    <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;Bradshaw&quot;</span>,</span><br><span class="line">    <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;Mckenzie&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: 29,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;F&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;244 Columbus Place&quot;</span>,</span><br><span class="line">    <span class="string">&quot;employer&quot;</span>: <span class="string">&quot;Euron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;bradshawmckenzie@euron.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Hobucken&quot;</span>,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;CO&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了好奇，我从<a target="_blank" rel="noopener" href="http://www.json-generator.com/%E7%94%9F%E6%88%90%E4%BA%86%E8%BF%99%E4%BA%9B%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%89%80%E4%BB%A5%E8%AF%B7%E5%BF%BD%E7%95%A5%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%9E%E9%99%85%E5%80%BC%E5%92%8C%E8%AF%AD%E4%B9%89%EF%BC%8C%E5%9B%A0%E4%B8%BA%E8%BF%99%E4%BA%9B%E9%83%BD%E6%98%AF%E9%9A%8F%E6%9C%BA%E7%94%9F%E6%88%90%E7%9A%84%E3%80%82">www.json-generator.com/生成了这些数据，所以请忽略数据的实际值和语义，因为这些都是随机生成的。</a></p>
<h5 id="加载样本数据集"><a href="#加载样本数据集" class="headerlink" title="加载样本数据集"></a>加载样本数据集</h5><p>您可以从这里下载示例数据集（accounts.json）。将其提取到我们当前的目录，并将其加载到我们的集群中，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/elastic/elasticsearch/master/docs/src/test/resources/accounts.json</span><br><span class="line">curl -H <span class="string">&quot;Content-Type: application/json&quot;</span> -XPOST <span class="string">&#x27;localhost:9200/bank/account/_bulk?pretty&amp;refresh&#x27;</span> --data-binary <span class="string">&quot;@accounts.json&quot;</span></span><br><span class="line">curl <span class="string">&#x27;localhost:9200/_cat/indices?v&#x27;</span></span><br></pre></td></tr></table></figure>

<p>显示结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   bank  l7sSYV2cQXmu6_4rJWVIww   5   1       1000            0    128.6kb        128.6kb</span><br></pre></td></tr></table></figure>

<p>这意味着我们刚刚成功地将1000个文档批量索引到银行索引（在帐户类型下）。</p>
<h4 id="搜索API"><a href="#搜索API" class="headerlink" title="搜索API"></a>搜索API</h4><p>现在我们来开始一些简单的搜索。运行搜索有两种基本的方法：一种是通过REST请求URI发送搜索参数，另一种是通过REST请求体发送它们。请求体方法允许您更具表现力，并且还可以以更可读的JSON格式定义搜索。我们将尝试一个请求URI方法的示例，但是在本教程的其余部分中，我们将专门使用请求体方法</p>
<p>用于搜索的REST API可以从_search端点访问。此示例返回银行索引中的所有文档：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?q=*&amp;sort=account_number:asc&amp;pretty&amp;pretty&#x27;</span></span><br></pre></td></tr></table></figure>

<p>我们首先剖析搜索电话。我们在银行索引中搜索（_search endpoint），并且q &#x3D; *参数指示Elasticsearch匹配索引中的所有文档,sort &#x3D; account_number：asc参数表示使用每个文档的account_number字段按升序对结果进行排序。pretty参数，再次告诉Elasticsearch返回适合打印的JSON结果</p>
<p>返回的搜索结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : 63,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : 5,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : 5,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : 1000,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : null,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [ &#123;</span><br><span class="line">      <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;bank&quot;</span>,</span><br><span class="line">      <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;account&quot;</span>,</span><br><span class="line">      <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;sort&quot;</span>: [0],</span><br><span class="line">      <span class="string">&quot;_score&quot;</span> : null,</span><br><span class="line">      <span class="string">&quot;_source&quot;</span> : &#123;<span class="string">&quot;account_number&quot;</span>:0,<span class="string">&quot;balance&quot;</span>:16623,<span class="string">&quot;firstname&quot;</span>:<span class="string">&quot;Bradshaw&quot;</span>,<span class="string">&quot;lastname&quot;</span>:<span class="string">&quot;Mckenzie&quot;</span>,<span class="string">&quot;age&quot;</span>:29,<span class="string">&quot;gender&quot;</span>:<span class="string">&quot;F&quot;</span>,<span class="string">&quot;address&quot;</span>:<span class="string">&quot;244 Columbus Place&quot;</span>,<span class="string">&quot;employer&quot;</span>:<span class="string">&quot;Euron&quot;</span>,<span class="string">&quot;email&quot;</span>:<span class="string">&quot;bradshawmckenzie@euron.com&quot;</span>,<span class="string">&quot;city&quot;</span>:<span class="string">&quot;Hobucken&quot;</span>,<span class="string">&quot;state&quot;</span>:<span class="string">&quot;CO&quot;</span>&#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;bank&quot;</span>,</span><br><span class="line">      <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;account&quot;</span>,</span><br><span class="line">      <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;sort&quot;</span>: [1],</span><br><span class="line">      <span class="string">&quot;_score&quot;</span> : null,</span><br><span class="line">      <span class="string">&quot;_source&quot;</span> : &#123;<span class="string">&quot;account_number&quot;</span>:1,<span class="string">&quot;balance&quot;</span>:39225,<span class="string">&quot;firstname&quot;</span>:<span class="string">&quot;Amber&quot;</span>,<span class="string">&quot;lastname&quot;</span>:<span class="string">&quot;Duke&quot;</span>,<span class="string">&quot;age&quot;</span>:32,<span class="string">&quot;gender&quot;</span>:<span class="string">&quot;M&quot;</span>,<span class="string">&quot;address&quot;</span>:<span class="string">&quot;880 Holmes Lane&quot;</span>,<span class="string">&quot;employer&quot;</span>:<span class="string">&quot;Pyrami&quot;</span>,<span class="string">&quot;email&quot;</span>:<span class="string">&quot;amberduke@pyrami.com&quot;</span>,<span class="string">&quot;city&quot;</span>:<span class="string">&quot;Brogan&quot;</span>,<span class="string">&quot;state&quot;</span>:<span class="string">&quot;IL&quot;</span>&#125;</span><br><span class="line">    &#125;, ...</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数解释</p>
<p><code>took</code> - Elasticsearch执行搜索的时间（以毫秒为单位）<br><code>timed_out</code> - 告诉我们搜索是否超时<br><code>_shards</code> - 告诉我们搜索了多少个分片，以及搜索成功&#x2F;失败的分片的数量<br><code>hits</code> - 搜索结果<br><code>hits.total</code> - 符合我们搜索条件的文件总数<br><code>hits.hits</code> - 实际搜索结果数组（默认为前10个文档）<br><code>hits.sort</code> - 排序结果的关键字（如果按分数排序，则丢失）<br><code>hits._score</code> and <code>max_score</code> - 现在忽略这些字段</p>
<p>以上是使用备用请求体方法的上述相同的精确搜索：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  &quot;sort&quot;: [</span></span><br><span class="line"><span class="string">    &#123; &quot;account_number&quot;: &quot;asc&quot; &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里的不同之处在于，我们不会在URI中传递q &#x3D; *，而是向_search API发送一个JSON样式的查询请求体。我们将在下一节讨论这个JSON查询。</p>
<p>重要的是要明白，一旦您获得了搜索结果，Elasticsearch就完成了该请求，并且不会保留任何类型的服务器端资源或打开游标到您的结果中。</p>
<h4 id="介绍查询语言"><a href="#介绍查询语言" class="headerlink" title="介绍查询语言"></a>介绍查询语言</h4><p>Elasticsearch提供了一种可用于执行查询的JSON风格的特定于域的语言。这被称为查询DSL。查询语言十分全面，可以勉强恐慌，但实际学习的最好方式是从几个基本的例子开始。 回到我们的最后一个例子，我们执行了这个查询：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>解析上面的内容，query部分告诉我们我们的查询定义是什么，而match_all部分只是我们要运行的查询类型。</p>
<p>除query参数外，我们还可以传递其他参数来影响搜索结果。在上面的例子中我们通过sort，这里我们传递size：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>请注意，如果未指定size，则默认为10。</p>
<p>此示例执行一个match_all并返回文档11到20：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  &quot;from&quot;: 10,</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 10</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>from参数（基于0）指定要从哪个文档索引开始，size参数指定从from参数开始返回多少个文档。执行搜索结果分页时，此功能非常有用。请注意，如果未指定from，则默认为0。</p>
<p>此示例执行match_all，并按结果按降序排列帐户余额，并返回前10名（默认大小）文档。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  &quot;sort&quot;: &#123; &quot;balance&quot;: &#123; &quot;order&quot;: &quot;desc&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="执行搜索"><a href="#执行搜索" class="headerlink" title="执行搜索"></a>执行搜索</h4><p>现在我们已经看到了一些基本的搜索参数，我们来进一步探讨Query DSL。我们先来看看返回的文档字段。默认情况下，完整的JSON文档作为所有搜索的一部分返回。这被称为源（搜索命中中的_source字段），如果我们不希望返回整个源文档，我们有能力仅从源代码中请求几个字段被返回。</p>
<p>此示例显示如何从搜索返回两个字段account_number和balance（_source内部）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  &quot;_source&quot;: [&quot;account_number&quot;, &quot;balance&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>请注意，上述示例简单地减少_source字段。它仍然只返回一个名为_source的字段，但在其中只包含字段account_number和余额。</p>
<p>如果您来自SQL背景，上述内容在概念上与SQL SELECT FROM字段列表有些相似。</p>
<p>现在我们来看看查询部分。以前，我们已经看到了如何使用match_all查询来匹配所有文档。现在我们来介绍一个称为匹配查询的新查询，它可以被认为是基本的字段搜索查询（即针对特定字段或一组字段进行搜索）。 此示例返回的帐号为20：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;account_number&quot;: 20 &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>此示例返回在地址中包含术语“mill”的所有帐户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>此示例返回在地址中包含术语“mill”或“lane”的所有帐户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill lane&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>此示例是匹配（match_phrase）的变体，它返回所有包含地址中的“mill lane”短语的帐户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">&#x27;localhost:9200/bank/_search?pretty&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill lane&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/gpg%E5%8A%A0%E8%A7%A3%E5%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/gpg%E5%8A%A0%E8%A7%A3%E5%AF%86/" class="post-title-link" itemprop="url">使用GPG加密解密步骤</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 23:45:20" itemprop="dateCreated datePublished" datetime="2017-07-11T23:45:20+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>安装gpg软件包<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># yum -y install gnupg</span></span><br></pre></td></tr></table></figure></li>
<li>生成密钥对<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># gpg --gen-key</span></span><br><span class="line">Please select what kind of key you want:</span><br><span class="line">(1) RSA and RSA (default)</span><br><span class="line">(2) DSA and Elgamal</span><br><span class="line">(3) DSA (sign only)</span><br><span class="line">(4) RSA (sign only)</span><br><span class="line">Your selection?1 <span class="comment">###直接回车，默认加密方式</span></span><br><span class="line">RSA keys may be between 1024 and 4096 bits long.</span><br><span class="line">What keysize <span class="keyword">do</span> you want? (2048) <span class="comment">###直接回车，默认秘钥长度</span></span><br><span class="line">Please specify how long the key should be valid.</span><br><span class="line">0 = key does not expire</span><br><span class="line">&lt;n&gt;  = key expires <span class="keyword">in</span> n days</span><br><span class="line">&lt;n&gt;w = key expires <span class="keyword">in</span> n weeks</span><br><span class="line">&lt;n&gt;m = key expires <span class="keyword">in</span> n months</span><br><span class="line">&lt;n&gt;y = key expires <span class="keyword">in</span> n years</span><br><span class="line">Key is valid <span class="keyword">for</span>? (0) <span class="comment">###直接回车，秘钥不过期</span></span><br><span class="line">Is this correct? (y/N)y <span class="comment">###“y”，确认</span></span><br><span class="line">Real name: welab <span class="comment">##输入姓名“welab”</span></span><br><span class="line">Email address:  <span class="comment">###可以不填</span></span><br><span class="line">Comment: <span class="comment">###可以不填</span></span><br><span class="line">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O <span class="comment">###&quot;O&quot;确认信息正确</span></span><br><span class="line">Passphrase ************* <span class="comment">###输入私钥的保护密码&quot;Welaboper2017&quot;</span></span><br><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line">some other action (<span class="built_in">type</span> on the keyboard, move the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance to gain enough entropy. <span class="comment">###这时候需要一些动作帮助生成秘钥</span></span><br><span class="line">gpg: checking the trustdb</span><br><span class="line">gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</span><br><span class="line">gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</span><br><span class="line">pub   2048R/C2673128 2017-05-17</span><br><span class="line">Key fingerprint = 853E BF25 AAEB 7DD7 42AD  F6E0 A13E DDBA C267 3128</span><br><span class="line">uid                  welab</span><br><span class="line">sub   2048R/62345630 2017-05-17 <span class="comment">###秘钥生成成功</span></span><br></pre></td></tr></table></figure></li>
<li>查看生成的公私钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># gpg -K ###查看公钥</span></span><br><span class="line">/root/.gnupg/secring.gpg</span><br><span class="line">------------------------</span><br><span class="line">sec   2048R/C2673128 2017-05-17</span><br><span class="line">uid                  welab</span><br><span class="line">ssb   2048R/62345630 2017-05-17</span><br><span class="line">[root@student01 ~]<span class="comment"># gpg -k</span></span><br><span class="line">/root/.gnupg/pubring.gpg <span class="comment">###查看私钥</span></span><br><span class="line">------------------------</span><br><span class="line">pub   2048R/C2673128 2017-05-17</span><br><span class="line">uid                  welab</span><br><span class="line">sub   2048R/62345630 2017-05-17</span><br></pre></td></tr></table></figure></li>
<li>导出公私钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># gpg --export -a C2673128 -o welab_C2673128_pub.key ##导出公钥</span></span><br><span class="line">[root@student01 ~]<span class="comment"># gpg --export-secret-keys -a C2673128 -o C2673128_welab_sec.key ###导出私钥</span></span><br></pre></td></tr></table></figure></li>
<li>将公钥发送给合作伙伴<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># scp C2673128_welab_pub.key root@student02:/root/</span></span><br></pre></td></tr></table></figure></li>
<li>导入合作伙伴公钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># gpg --import C2673128_welab_pub.key</span></span><br></pre></td></tr></table></figure></li>
<li>合作伙伴使用公钥加密文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo test &gt;test.txt</span></span><br><span class="line">[root@student02 ~]<span class="comment"># gpg -aer C2673128 test.txt ###指定公钥加密文件</span></span><br><span class="line">gpg: 62345630: There is no assurance this key belongs to the named user</span><br><span class="line"></span><br><span class="line">pub  2048R/62345630 2017-05-17 welab</span><br><span class="line">Primary key fingerprint: 853E BF25 AAEB 7DD7 42AD  F6E0 A13E DDBA C267 3128</span><br><span class="line">Subkey fingerprint: 1705 894F 9842 52CA 9BC8  10BA AC23 FFC1 6234 5630</span><br><span class="line"></span><br><span class="line">It is NOT certain that the key belongs to the person named</span><br><span class="line"><span class="keyword">in</span> the user ID.  If you *really* know what you are doing,</span><br><span class="line">you may answer the next question with <span class="built_in">yes</span>.</span><br><span class="line"></span><br><span class="line">Use this key anyway? (y/N) y <span class="comment">###使用key</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ls test.txt.asc </span></span><br><span class="line">test.txt.asc <span class="comment">###生成加密文件</span></span><br></pre></td></tr></table></figure></li>
<li>合作伙伴把加密后的文件发送给我们，我们用私钥解密<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># scp test.txt.asc root@student01:/root/</span></span><br><span class="line">[root@student01 ~]<span class="comment"># gpg --passphrase Welaboper2017 -o test.txt -d test.txt.asc ###输入私钥密码，使用私钥解密文件</span></span><br><span class="line">[root@student01 ~]<span class="comment"># cat test.txt</span></span><br><span class="line"><span class="built_in">test</span> <span class="comment">###文件已解密</span></span><br></pre></td></tr></table></figure></li>
<li>有时需要两台机器都能使用私钥来解密文件，可以把私钥发给第二台机器导入 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># scp C2673128_welab_sec.key root@student02:/root/</span></span><br><span class="line">[root@student02 ~]<span class="comment"># gpg --import C2673128_welab_sec.key ###导入私钥</span></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/tcp%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/tcp%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/" class="post-title-link" itemprop="url">tcp调优参数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 23:45:20" itemprop="dateCreated datePublished" datetime="2017-07-11T23:45:20+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>统计tcp各种状态的个数</p>
<blockquote>
<p>netstat -an |awk ‘&#x2F;^tcp&#x2F; {++state[$6]} END {for (key in state) print key,”\t”,state[key]}’</p>
</blockquote>
<p>对于一个新建连接，内核要发送多少个SYN连接请求才决定放弃。默认值：6，对应于180秒左右时间，对于大负载而物理通信良好的网络而言,这个值偏高,可修改为2.这个值仅仅是针对新建对外的连接</p>
<blockquote>
<p>net.ipv4.tcp_syn_retries &#x3D; 2</p>
</blockquote>
<p>TCP提供可靠连接的途径是通过接受方确认发送方的数据实现的，数据和确认都可能丢失，这就需要及时发现数据或者确认丢失而进行重传。重传最重要的是要确定超时间隔和重传频率。</p>
<p>该变量设置放弃回应一个tcp连接请求前，需要进行多少次重试。默认值：3，相当于3秒~8分钟</p>
<blockquote>
<p>net.ipv4.tcp_retries1&#x3D;2</p>
</blockquote>
<p>缺省值是15，相当于13~30分钟，在丢弃已建立通讯的TCP连接之前﹐需要进行多少次重试，低值可以更早的检测到与远程主机失效的连接，因此服务器可以更快的释放该连接。</p>
<blockquote>
<p>net.ipv4.tcp_retries2&#x3D;5</p>
</blockquote>
<p>对于远端的连接请求SYN，内核会发送SYN+ACK数据报，以确认收到上一个 SYN连接请求包。这是所谓的三次握手( threeway handshake)机制的第二个步骤。这里内核决定放弃连接之前所送出的SYN+ACK数目。</p>
<blockquote>
<p>net.ipv4.tcp_synack_retries&#x3D;3</p>
</blockquote>
<p>丢弃无进程的TCP连接之前﹐要进行多少次重试。默认值为8,相当于 50秒 - 16分钟,如果您的计算机是加载的WEB服务器，则应考虑降低此值，这样的套接字可能会消耗大量资源。</p>
<blockquote>
<p>tcp_orphan_retries&#x3D;3</p>
</blockquote>
<p>当连接关闭的时候，TCP默认缓存了很多连接指标在 route cache 中，以至于在不久的将来，连接建立的时候，可以用这些值来设置初始化条件。通常，这提升了整体的性能，但是，有时候会引起性能下降， 如果设置的话，TCP 在关闭的时候不缓存这些指标。<br>3.2版本之前的未打补丁的内核tcp_no_metrics_save &#x3D; 0 的sysctl设置会更致命。此设置将保存数据在所有连接上，并试图用它来优化网络。不幸的是，这实际上使性能更差，因为TCP会将一个丢包的例外情况下采取的策略适用于这个客户端中几分钟的窗口内的每一个新连接。换句话说，在某些情况下，一个人从手机浏览您的网站如果一些随机数据包丢失，能够降低你的服务器的性能，尽管他。如果你希望你的访问者从移动，有损连接来了，你不能升级或修补的内核，我建议设置tcp_no_metrics_save &#x3D; 1 ,Linux的3.2 的PRR能降低影响TCP性能的有损连接的数量。</p>
<blockquote>
<p>net.ipv4.tcp_no_metrics_save&#x3D;1</p>
</blockquote>
<p>每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的最大数目，一旦超过将被丢弃。</p>
<blockquote>
<p>net.core.netdev_max_backlog&#x3D;262144</p>
</blockquote>
<p>指定为已知的第三方应用程序保留的端口。这些端口不会被自动端口分配使用。</p>
<blockquote>
<p>net.ipv4.ip_local_reserved_ports &#x3D; 8000-10000</p>
</blockquote>
<p>在TCP keepalive打开的情况下，最后一次数据交换到TCP发送第一个keepalive探测包的间隔，即允许的持续空闲时长，或者说每次正常发送心跳的周期，默认值为7200s。</p>
<blockquote>
<p>net.ipv4.tcp_keepalive_time &#x3D; 300</p>
</blockquote>
<p>在tcp_keepalive_time之后，没有接收到对方确认，继续发送保活探测包的发送频率，默认值为75s。<br>发送频率tcp_keepalive_intvl乘以发送次数tcp_keepalive_probes，就得到了从开始探测到放弃探测确定连接断开的时间</p>
<blockquote>
<p>net.ipv4.tcp_keepalive_intvl &#x3D; 30</p>
</blockquote>
<p>在tcp_keepalive_time之后，没有接收到对方确认，继续发送保活探测包次数，默认值为9（次）</p>
<blockquote>
<p>net.ipv4.tcp_keepalive_probes &#x3D; 6</p>
</blockquote>
<p>若设置，服务器在客户端连接空闲的时候，每300秒发送一次保活探测包到客户端，若没有及时收到客户端的TCP Keepalive ACK确认，将继续等待30秒*6&#x3D;180秒。总之可以在300s+180s&#x3D;480秒时间内可检测到连接失效与否。</p>
<p>支持超过 64KB 的窗口的TCP窗口，使用窗口扩大选项可以使得发送端得到更大的通告窗口，这样就可以在ACK到来前发送更多的数据，减少了等待的时间，提高了数据传输效率。</p>
<blockquote>
<p>net.ipv4.tcp_window_scaling&#x3D;1</p>
</blockquote>
<p>表示socket监听（listen）的backlog上限。什么是backlog呢？backlog就是socket的监听队列，当一个请求（request）尚未被处理或建立时，他会进入backlog。而socket server可以一次性处理backlog中的所有请求，处理后的请求不再位于监听队列中。当server处理请求较慢，以至于监听队列被填满后，新来的请求会被拒绝。限制了接收新 TCP 连接侦听队列的大小。对于一个经常处理新连接的高负载web服务环境来说，默认的 128 太小了,而nginx定义的NGX_LISTEN_BACKLOG默认为511,大多数环境这个值建议增加到 1024 或者更多。大的侦听队列对防止拒绝服务 DoS 攻击也会有所帮助。</p>
<blockquote>
<p>net.core.somaxconn&#x3D;65536</p>
</blockquote>
<p>表示系统同时保持TIME_WAIT socket的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。之所以要设定这个限制﹐纯粹为了抵御那些简单的 DoS攻击﹐千万不要人为的降低这个限制﹐不过﹐如果网络条件需要比默认值更多﹐则可以提高它(或许还要增加内存)。</p>
<blockquote>
<p>net.ipv4.tcp_max_tw_buckets&#x3D;32768</p>
</blockquote>
<p>表示系统所能处理不属于任何进程的<br>socket数量，当我们需要快速建立大量连接时，就需要关注下这个值了。当不属于任何进程的socket的数量大于这个值时，dmesg就会看<br>到”too many of orphaned sockets”。</p>
<blockquote>
<p>net.ipv4.tcp_max_orphans&#x3D;65536</p>
</blockquote>
<p>linux中查看socket状态：</p>
<blockquote>
<p>cat &#x2F;proc&#x2F;net&#x2F;sockstat<br>sockets: used 137 TCP: inuse 49 orphan 0 tw 3272 alloc 52 mem 46 UDP: inuse 1 mem 0 RAW: inuse 0 FRAG: inuse 0 memory 0 </p>
</blockquote>
<p>下面几行的参数可以很好的减少TIME_WAIT数量</p>
<p>在 tcp 建立连接的 3 路握手过程中，当服务端收到最初的 SYN 请求时，会检查应用程序的 syn_backlog 队列是否已满。若已满，通常行为是丢弃此 SYN 包。若未满，会再检查应用程序的backlog队列是否已满。若已满并且系统根据历史记录判断该应用程序不会较快消耗连接时，则丢弃此 SYN 包。如果启用 tcp_syncookies 则在检查到 syn_backlog 队列已满时，不丢弃该 SYN 包，而改用 syncookie 技术进行 3 路握手。<br>警告：使用 syncookie 进行握手时，因为该技术挪用了 tcp_options 字段空间，会强制关闭 tcp 高级流控技术而退化成原始 tcp 模式。此模式会导致 封包 丢失时 对端 要等待 MSL 时间来发现丢包事件并重试，以及关闭连接时 TIME_WAIT 状态保持 2MSL 时间。该技术应该仅用于保护 syn_flood 攻击。如果在正常服务器环境中服务器负载较重导致 syn_backlog 和 backlog 队列满时，应优化 服务端应用程序 的 负载能力，加大应用程序 backlog 值。不过，所幸该参数是自动值，仅在 syn_backlog 队列满时才会触发 (在队列恢复可用时此行为关闭)。<br>启用 syncookie 虽然也可以解决超高并发时的 <code>can’t connect</code> 问题，但会导致 TIME_WAIT 状态 fallback 为保持 2MSL 时间，高峰期时会导致客户端无可复用连接而无法连接服务器 (tcp 连接复用是基于 &lt;src_ip, src_port, dst_ip, dst_port&gt; 四元组值必须不相同，就访问同一个目标服务器而言，&lt;src_ip, dst_ip, dst_port&gt; 三元组值不变，所以此时可用的连接数限制为仅 src_port 所允许数目，这里处于 TIME_WAIT 状态的相同 src_port 连接不可复用。Linux 系统甚至更严格，只使用了 &lt;src_ip, src_port, dst_ip&gt; 三元组…)。故不建议依赖 syncookie。</p>
<blockquote>
<p>net.ipv4.tcp_syncookies&#x3D;1</p>
</blockquote>
<p>net.ipv4.tcp_tw_reuse&#x3D;1<br>表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；<br>启用net.ipv4.tcp_tw_reuse后，如果新的时间戳，比以前存储的时间戳更大，那么linux将会从TIME-WAIT状态的存活连接中，选取一个，重新分配给新的连接出去的TCP连接。</p>
<p>net.ipv4.tcp_tw_recycle&#x3D;0<br>表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。<br>TCP有一种行为，可以缓存每个连接最新的时间戳，后续请求中如果时间戳小于缓存的时间戳，即视为无效，相应的数据包会被丢弃。<br>特别注意的是：当client与server之间有如NAT这类网络转换设备时，开启tcp_tw_recycle选项可能会导致server端drop（直接发送RST）来自client的SYN包。<br>当请求到达LVS后，它修改地址数据后便转发给后端服务器，但不会修改时间戳数据，对于后端服务器来说，请求的源地址就是LVS的地址，加上端口会复用，所以从后端服务器的角度看，原本不同客户端的请求经过LVS的转发，就可能会被认为是同一个连接，加之不同客户端的时间可能不一致，所以就会出现时间戳错乱的现象，于是后面的数据包就被丢弃了，具体的表现通常是是客户端明明发送的SYN，但服务端就是不响应ACK,如果服务器身处NAT环境，安全起见，通常要禁止tcp_tw_recycle，至于TIME_WAIT连接过多的问题，可以通过激活tcp_tw_reuse来缓解</p>
<p>net.ipv4.ip_local_port_range &#x3D; 32768	60999    net.ipv4.ip_local_port_range &#x3D; 1024	65535<br>当系统中某一时刻同时存在太多的TCP客户端连接时，由于每个TCP客户端连接都要占用一个唯一的本地端口号(此端口号在系统的本地端口号范围限制中)，如果现有的TCP客户端连接已将所有的本地端口号占满，则此时就无法为新的TCP客户端连接分配一个本地端口号了，因此系统会在这种情况下在connect()调用中返回失败，并将错误提示消息设为“Can’t assignrequested address”。最好是这些数字有不同的奇偶性。（一个偶数和一个奇数值）默认值分别为32768和60999。</p>
<p>net.ipv4.tcp_max_syn_backlog&#x3D;262144<br>表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数。syn_backlog 队列实际上是个 hash 表，并且 hash 表大小为 2 的次方。所以实际 syn_backlog 的队列长度要 略大于 应用程序设置的 backlog 值 —— 取对应 2 的次方值。</p>
<p>net.ipv4.tcp_fin_timeout&#x3D;30<br>这个参数是用来设置保持在FIN_WAIT_2状态的时间。tcp四次挥手，正常的处理流程就是在FIN_WAIT_2情况下接收到FIN进入到TIME_WAIT的情况，tcp_fin_timeout参数对处于TIME_WAIT状态的时间没有任何影响。但是如果这个参数设的比较小，会缩短从FIN_WAIT_2到TIME_WAIT的时间，从而使连接更早地进入TIME_WAIT状态。状态开始的早，等待相同的时间，结束的也早，客观上也加速了TIME_WAIT状态套接字的清理速度。</p>
<p>编辑完成后，请执行以下命令使变动立即生效：<br>&#x2F;sbin&#x2F;sysctl -p<br>&#x2F;sbin&#x2F;sysctl -w net.ipv4.route.flush&#x3D;1—</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/tuning%E5%86%85%E6%A0%B8%E8%B0%83%E4%BC%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/tuning%E5%86%85%E6%A0%B8%E8%B0%83%E4%BC%98/" class="post-title-link" itemprop="url">Linux性能调优</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 23:45:20" itemprop="dateCreated datePublished" datetime="2017-07-11T23:45:20+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、内核参数文档的查看"><a href="#一、内核参数文档的查看" class="headerlink" title="一、内核参数文档的查看"></a>一、内核参数文档的查看</h3><h4 id="1-在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用"><a href="#1-在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用" class="headerlink" title="1. 在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用"></a>1. 在Linux系统中所有的内核参数都可以查询到，只需要安装官方安装包kernel-doc，先学习下内核参数帮助文档的使用</h4><p>安装kernel-doc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install kernel-doc</span></span><br></pre></td></tr></table></figure>

<p>所有的内核参数都可以查询文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ls /usr/share/doc/kernel-doc-3.10.0/Documentation/</span></span><br></pre></td></tr></table></figure>

<p>可以查询vm.drop_caches参数的文档，在文件vm.txt的182行记录echo 3 可以清空内存里面的缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># grep -irn --color=auto vm.drop_caches /usr/share/doc/kernel-doc-3.10.0/Documentation/</span></span><br><span class="line">/usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/vm.txt:178:   <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">/usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/vm.txt:180:   <span class="built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">/usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/vm.txt:182:   <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>

<h3 id="二、性能调优工具"><a href="#二、性能调优工具" class="headerlink" title="二、性能调优工具"></a>二、性能调优工具</h3><h4 id="1-tuned"><a href="#1-tuned" class="headerlink" title="1. tuned"></a>1. tuned</h4><p>安装tuned启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install tuned</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl start tuned</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl enable tuned</span></span><br></pre></td></tr></table></figure>

<p>查看系统中对于不同应用场景的调优方案</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tuned-adm list</span></span><br><span class="line">Available profiles:</span><br><span class="line">- balanced                    - General non-specialized tuned profile</span><br><span class="line">- desktop                     - Optmize <span class="keyword">for</span> the desktop use-case</span><br><span class="line">- latency-performance         - Optimize <span class="keyword">for</span> deterministic performance at the cost of increased power consumption</span><br><span class="line">- network-latency             - Optimize <span class="keyword">for</span> deterministic performance at the cost of increased power consumption, focused on low latency network performance</span><br><span class="line">- network-throughput          - Optimize <span class="keyword">for</span> streaming network throughput.  Generally only necessary on older CPUs or 40G+ networks.</span><br><span class="line">- powersave                   - Optimize <span class="keyword">for</span> low power consumption</span><br><span class="line">- throughput-performance      - Broadly applicable tuning that provides excellent performance across a variety of common server workloads.  This is the default profile     <span class="keyword">for</span> RHEL7.</span><br><span class="line">- virtual-guest               - Optimize <span class="keyword">for</span> running inside a virtual guest.</span><br><span class="line">- virtual-host                - Optimize <span class="keyword">for</span> running KVM guests</span><br><span class="line">Current active profile: virtual-guest</span><br></pre></td></tr></table></figure>

<p>查看当前的调优方案</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tuned-adm active</span></span><br><span class="line">Current active profile: virtual-guest</span><br></pre></td></tr></table></figure>

<p><code>balanced</code>：一般的非专业的调优配置     </p>
<p><code>desktop</code>：优化桌面使用环境</p>
<p><code>latency-performance</code>：以增加功耗为代价优化确定的性能</p>
<p><code>network-latency</code>：以增加功耗为代价优化确定的性能，重点是低延迟网络性能</p>
<p><code>network-throughput</code>：优化网络吞吐量，一般只需要用在旧的CPU和40G+的网络中</p>
<p><code>powersave</code>：低功率的优化</p>
<p><code>throughput-performance</code>：广泛适用的调整，可在各种常见服务器工作负载下提供出色的性能，这是RHEL7的默认配置文件。</p>
<p><code>virtual-guest</code>：优化运行在主机内部的虚拟机</p>
<p><code>virtual-host</code>：优化运行KVM虚拟机的主机</p>
<p>使用高性能的配置策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tuned-adm profile throughput-performance </span></span><br><span class="line">[root@student02 ~]<span class="comment"># tuned-adm active </span></span><br><span class="line">Current active profile: throughput-performance</span><br></pre></td></tr></table></figure>

<p>tuned调优的配置文件，也可以自己添加一个目录，修改成自己适合的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ls /usr/lib/tuned/</span></span><br><span class="line">balanced  desktop  <span class="built_in">functions</span>  latency-performance  network-latency  network-throughput  powersave  recommend.conf  throughput-performance  virtual-guest  virtual-host</span><br></pre></td></tr></table></figure>

<h4 id="2-limits"><a href="#2-limits" class="headerlink" title="2. limits"></a>2. limits</h4><p>limits的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br></pre></td></tr></table></figure>

<p>硬限制用户只能打开2048个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line">student          hard    nofile          2048</span><br><span class="line">[student@student02 ~]$ <span class="built_in">ulimit</span> -n</span><br><span class="line">2048</span><br></pre></td></tr></table></figure>

<p>硬限制用户只能使用10M虚拟内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line">student          hard    as              102400</span><br><span class="line">[I have no name!@student02 ~]$ <span class="built_in">ulimit</span> -v</span><br><span class="line">102400</span><br></pre></td></tr></table></figure>

<p>查看limits对我的所有限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ulimit -a</span></span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 3821</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 65535</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 3821</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br></pre></td></tr></table></figure>

<p>软限制用户只能使用100M虚拟内存，用户可以在硬限制范围内修改软限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line">student          soft    as              102400</span><br><span class="line">[root@student02 ~]<span class="comment"># ulimit -v</span></span><br><span class="line">10240</span><br><span class="line">[root@student02 ~]<span class="comment"># ulimit -v 20480</span></span><br></pre></td></tr></table></figure>

<h4 id="3-cgroup"><a href="#3-cgroup" class="headerlink" title="3. cgroup"></a>3. cgroup</h4><p>安装cgroup启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install libcgroup-tools</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl start cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl enable cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl start cgred</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl enable cgred</span></span><br></pre></td></tr></table></figure>

<p>启动服务后会产生一个cgroup的临时目录，查看对各种资源限制的配置，每个目录里面还有很多限制子选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># df -h |grep cgroup</span></span><br><span class="line">tmpfs       489M     0  489M   0% /sys/fs/cgroup</span><br><span class="line">[root@student02 cgroup]<span class="comment"># ls</span></span><br><span class="line">blkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  systemd    cpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio  pids</span><br></pre></td></tr></table></figure>

<p>查看参数名，cgconfig.conf中创建一个组test，限制磁盘读bps为1M，内存使用256M</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ll /dev/sda</span></span><br><span class="line">brw-rw---- 1 root disk 8, 0 Jun  1 20:43 /dev/sda</span><br><span class="line">[root@student02 ~]<span class="comment"># ls /sys/fs/cgroup/blkio/test/ |grep read_bps</span></span><br><span class="line">blkio.throttle.read_bps_device</span><br><span class="line">[root@student02 ~]<span class="comment"># ls /sys/fs/cgroup/memory/ |grep memory.limit</span></span><br><span class="line">memory.limit_in_bytes</span><br><span class="line">[root@student02 ~]<span class="comment"># vim /etc/cgconfig.conf</span></span><br><span class="line">group <span class="built_in">test</span> &#123;</span><br><span class="line">blkio &#123;</span><br><span class="line">blkio.throttle.read_bps_device = <span class="string">&quot;8:0 1048576&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">memory &#123;</span><br><span class="line">memory.limit_in_bytes = <span class="string">&quot;256M&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/blkio/test/blkio.throttle.read_bps_device </span></span><br><span class="line">8:0 1048576</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/memory/test/memory.limit_in_bytes </span></span><br><span class="line">268435456</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgconfig</span></span><br></pre></td></tr></table></figure>

<p>cgrules.conf中配置策略，用户student的blkio和memory应用test组策略的限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/cgrules.conf</span></span><br><span class="line">student         blkio,memory    <span class="built_in">test</span>/</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgred</span></span><br></pre></td></tr></table></figure>

<p>也可以具体限制到命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vim /etc/cgrules.conf</span></span><br><span class="line">student:<span class="built_in">cp</span>      blkio,memory    <span class="built_in">test</span>/</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgred</span></span><br></pre></td></tr></table></figure>

<h3 id="三、系统状态监控工具"><a href="#三、系统状态监控工具" class="headerlink" title="三、系统状态监控工具"></a>三、系统状态监控工具</h3><h4 id="1-iostat命令，监控系统设备的IO负载情况"><a href="#1-iostat命令，监控系统设备的IO负载情况" class="headerlink" title="1. iostat命令，监控系统设备的IO负载情况"></a>1. iostat命令，监控系统设备的IO负载情况</h4><p>不接参数，显示系统启动以来的i&#x2F;o状态的平均结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># iostat</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span>  %system %iowait  %steal   %idle</span><br><span class="line">0.26    0.03    0.42    0.28    0.00   99.01</span><br></pre></td></tr></table></figure>

<p><code>%user</code>：显示在用户级别(application)运行使用 CPU 总时间的百分比。</p>
<p><code>%nice</code>：显示在用户级别，用于nice操作，所占用 CPU 总时间的百分比。</p>
<p><code>%system</code>：在核心级别(kernel)运行所使用 CPU 总时间的百分比。</p>
<p><code>%iowait</code>：显示用于等待I&#x2F;O操作占用 CPU 总时间的百分比。</p>
<p><code>%steal</code>：管理程序(hypervisor)为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。</p>
<p><code>%idle</code>：显示 CPU 空闲时间占用 CPU 总时间的百分比。</p>
<blockquote>
<ol>
<li>若 %iowait 的值过高，表示硬盘存在I&#x2F;O瓶颈</li>
<li>若 %idle 的值高但系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量</li>
<li>若 %idle 的值持续低于1，则系统的 CPU处理能力相对较低，表明系统中最需要解决的资源是 CPU 。</li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># iostat 1 #1秒钟显示一次，一直监控</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 2 #1秒钟显示一次，监控两次</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 2 sda #只显示sda磁盘</span></span><br><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/zero of=/dev/null &amp; #后台运行dd命令</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1#发现系统内核占用CPU资源很大</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">22.77    0.00   77.23    0.00    0.00    0.00</span><br><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/urandom of=/dev/null &amp; #写入随机数</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 #CPU被系统占用完了</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">0.00    0.00  100.00    0.00    0.00    0.00</span><br><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/zero of=/tmp/test bs=1M count=1000 &amp; #往磁盘写入文件</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat 1 #系统和iowait消耗CPU资源比较多</span></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">0.00    0.00   54.55   36.36    0.00    9.09</span><br><span class="line">Device:     tps     kB_read/s    kB_wrtn/s    kB_read    kB_wrtn <span class="comment">#以block为单位（512字节）</span></span><br><span class="line">sda         554.55     10909.09    196763.64       1200      21644</span><br></pre></td></tr></table></figure>

<p><code>Device</code>：磁盘设备</p>
<p><code>tps</code>：多少I&#x2F;O请求数&#x2F;s</p>
<p><code>kB_read/s</code>：读多少block&#x2F;s</p>
<p><code>kB_wrtn/s</code>：写多少block&#x2F;s</p>
<p><code>kB_read</code>：一共读block</p>
<p><code>kB_wrtn</code>：一共写block</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo &quot;(10909+196763)*512/1024/1024&quot; |bc</span></span><br><span class="line">101 <span class="comment">#计算出I/O速度为101M每秒</span></span><br><span class="line">[root@student02 ~]<span class="comment"># iostat -x #显示更多的参数</span></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br></pre></td></tr></table></figure>

<blockquote>
<p>kB_wrtn&#x2F;s除以tps就可以得到每个I&#x2F;O的大小，可以通过I&#x2F;O大小判断组建哪种RAID，RAID5适合顺序的大I&#x2F;O，RAID10适合随机的小I&#x2F;</p>
</blockquote>
<h4 id="2-sar命令，对系统的活动进行报告"><a href="#2-sar命令，对系统的活动进行报告" class="headerlink" title="2. sar命令，对系统的活动进行报告"></a>2. sar命令，对系统的活动进行报告</h4><p>参数介绍：</p>
<p><code>-A</code>：所有报告的总和</p>
<p><code>-u</code>：输出CPU使用情况的统计信息</p>
<p><code>-v</code>：输出inode、文件和其他内核表的统计信息</p>
<p><code>-d</code>：输出每一个块设备的活动信息</p>
<p><code>-r</code>：输出内存和交换空间的统计信息</p>
<p><code>-b</code>：显示I&#x2F;O和传送速率的统计信息</p>
<p><code>-a</code>：文件读写情况</p>
<p><code>-c</code>：输出进程统计信息，每秒创建的进程数</p>
<p><code>-R</code>：输出内存页面的统计信息</p>
<p><code>-y</code>：终端设备活动情况</p>
<p><code>-w</code>：输出系统交换活动信息</p>
<p>查看CPU负载信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -u 1 10</span></span><br><span class="line">04:56:39 PM     CPU     %user     %<span class="built_in">nice</span>   %system   %iowait    %steal     %idle</span><br><span class="line">04:56:40 PM     all      0.00      0.00      0.00      0.00      0.00    100.00</span><br></pre></td></tr></table></figure>

<p><code>%user</code>：显示在用户级别(application)运行使用 CPU 总时间的百分比。</p>
<p><code>%nice</code>：显示在用户级别，用于nice操作，所占用 CPU 总时间的百分比。</p>
<p><code>%system</code>：在核心级别(kernel)运行所使用 CPU 总时间的百分比。</p>
<p><code>%iowait</code>：显示用于等待I&#x2F;O操作占用 CPU 总时间的百分比。</p>
<p><code>%steal</code>：管理程序(hypervisor)为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。</p>
<p><code>%idle</code>：显示 CPU 空闲时间占用 CPU 总时间的百分比。</p>
<blockquote>
<ol>
<li>若 %iowait 的值过高，表示硬盘存在I&#x2F;O瓶颈</li>
<li>若 %idle 的值高但系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量</li>
<li>若 %idle 的值持续低于1，则系统的 CPU处理能力相对较低，表明系统中最需要解决的资源是 CPU 。</li>
</ol>
</blockquote>
<p>以24小时制来显示时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># alias sar=&#x27;LANG=C sar&#x27;</span></span><br></pre></td></tr></table></figure>
<p>内存和交换空间监控</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -r 1 10</span></span><br><span class="line">17:02:29    kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">17:02:30       688816    311124     31.11        12    177876    221100      7.14    110672    103680         4</span><br></pre></td></tr></table></figure>

<p><code>kbmemfree</code>：这个值和free命令中的free值基本一致,所以它不包括buffer和cache的空间.</p>
<p><code>kbmemused</code>：这个值和free命令中的used值基本一致,所以它包括buffer和cache的空间.</p>
<p><code>%memused</code>：这个值是kbmemused和内存总量(不包括swap)的一个百分比.</p>
<p><code>kbbuffers和kbcached</code>：这两个值就是free命令中的buffer和cache.</p>
<p><code>kbcommit</code>：保证当前系统所需要的内存,即为了确保不溢出而需要的内存(RAM+swap).</p>
<p><code>%commit</code>：这个值是kbcommit与内存总量(包括swap)的一个百分比.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -d 1 10 #显示磁盘负载信息以及10s的平均负载</span></span><br><span class="line">[root@student02 ~]<span class="comment"># sar -u 1 10 #显示CPU负载信息以及10s的平均负载</span></span><br><span class="line">[root@student02 ~]<span class="comment"># sar -r 1 10 #显示内存负载以及10s的平均负载</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /etc/cron.d/sysstat |egrep -v &quot;^#|^$&quot; #系统本来就有sar的计划任务</span></span><br><span class="line">*/10 * * * * root /usr/lib64/sa/sa1 1 1</span><br><span class="line">53 23 * * * root /usr/lib64/sa/sa2 -A</span><br><span class="line">[root@student02 ~]<span class="comment"># ls /var/log/sa/ #计划任务记录每天的记录</span></span><br><span class="line">sa01  sa22  sa23  sa24  sa25  sa26  sa27  sa30  sa31  sar22</span><br><span class="line">[root@student02 ~]<span class="comment"># sar -f /var/log/sa/sa01 #查看文件中保存的记录</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /var/log/sa/sar01 #查看一天的汇总记录</span></span><br><span class="line">[root@student02 ~]<span class="comment"># sar -u -s 15:00:00 -e 16:00:00 -f /var/log/sa/sa01 #查看时间范围内的记录</span></span><br></pre></td></tr></table></figure>

<h4 id="3-vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况-IO读写情况"><a href="#3-vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况-IO读写情况" class="headerlink" title="3. vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况"></a>3. vmstat命令，服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vmstat 1 10</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line">r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">1  0      0 835992     12  84764    0    0  8890   160   83   71  0  3 96  1  0</span><br></pre></td></tr></table></figure>
<p><code>r</code>：表示运行队列，多少个进程分配到cpu，这个值超过了CPU数目就会出现CPU瓶颈，如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。</p>
<p><code>b</code>：表示阻塞的进程</p>
<p><code>swpd</code>： 虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了。</p>
<p><code>free</code>：空闲的物理内存的大小。</p>
<p><code>buff</code>：存储文件列表，权限等的缓存。</p>
<p><code>cache</code>：文件内容的缓存。</p>
<p><code>si</code>：每秒从磁盘读入虚拟内存的大小。</p>
<p><code>so</code>：每秒虚拟内存写入磁盘的大小。</p>
<p><code>bi</code>：块设备每秒接收的块数量。</p>
<p><code>bo</code>：块设备每秒发送的块数量，读取文件，bo就会大于0。</p>
<p><code>in</code>：每秒CPU的中断次数，包括时间中断。</p>
<p><code>cs</code>：CPU每秒上下文切换次数，调用系统函数，线程的切换要进行上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目，web服务器中需要调节这个值最小。</p>
<p><code>us</code>：用户CPU时间</p>
<p><code>sy</code>：系统CPU时间</p>
<p><code>id</code>：空闲CPU时间</p>
<p><code>wt</code>：I&#x2F;O等待CPU时间</p>
<h4 id="4-free"><a href="#4-free" class="headerlink" title="4. free"></a>4. free</h4><p>free命令是linux的一个入门级命令，显示的是一个比较总述性的信息，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># free -m</span></span><br><span class="line">total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            976         132         600           6         242         626</span><br><span class="line">Swap:          2047           0        2047</span><br></pre></td></tr></table></figure>

<p>比如上面的输出中，我们大致可以看到我总内存为1G（995，其中hardward和firmware在启动时会预先占用一点）。其中已使用874M ，其中可用121M，buffers和cached加用的量为105M + 249M ，这里需要注意的是平时我们在查看时，一般会以第二行的结果为准，即实际可用477M，已用518M。为什么这样说？因为buffers和cached是为了加快运算速度，会预占用一部分内存，可以理解为缓存的概念。由于这部分不是本篇的重点，想深究的可以找谷歌。这部分内存可以通过如下的命令进行回收：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -w vm.drop_caches=3</span></span><br><span class="line">vm.drop_caches = 3</span><br></pre></td></tr></table></figure>
<p>在有业务运行的情况下，强烈不建议这样操作，因为可能会造成数据丢失。</p>
<h4 id="5-top"><a href="#5-top" class="headerlink" title="5. top"></a>5. top</h4><p>即然内存被使用，到底被谁占去了呢？可以借助强大的top查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># top</span></span><br><span class="line">top - 11:54:31 up  2:26,  1 user,  load average: 0.00, 0.01, 0.05</span><br><span class="line">Tasks:  97 total,   1 running,  96 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :   999940 total,   824676 free,    83216 used,    92048 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  2097148 free,        0 used.   774152 avail Mem </span><br><span class="line"></span><br><span class="line">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND             </span><br><span class="line">879 root      20   0  553152  16424   5784 S  0.0  1.6   0:02.76 tuned               </span><br><span class="line">647 polkitd   20   0  527516  11984   4580 S  0.0  1.2   0:00.18 polkitd             </span><br><span class="line">671 root      20   0  437488   7848   6068 S  0.0  0.8   0:00.19 NetworkManager</span><br></pre></td></tr></table></figure>
<p>在top下我们输入大M就可以按内存使用率排序。上面可以看到我内存主要被hhvm进程占用掉了，占比总内存的34.3% 。可以看到，实际上top上面也有free的功能，对memory会有概述性报告的。其中RES是我们要关注的项，即实际该进程占用的内存量，基本上这样我们就定位到内存用到那去了。现网中经常还需要一种情况，top看到的所有进程的RES使用都不大，而内存一下子少了几十G，这个怎么破呢？看下面。</p>
<h4 id="6-x2F-proc-x2F-meminfo"><a href="#6-x2F-proc-x2F-meminfo" class="headerlink" title="6. &#x2F;proc&#x2F;meminfo"></a>6. &#x2F;proc&#x2F;meminfo</h4><p>meminfo文件显示出的也是内存的概述性信息，只不过其比free -m的结果要更详细，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@361way ~]<span class="comment"># cat /proc/meminfo</span></span><br><span class="line">MemTotal:        1019644 kB    所有可用RAM大小 （即物理内存减去一些预留位和内核的二进</span><br><span class="line">制代码大小）</span><br><span class="line">MemFree:          119464 kB    LowFree与HighFree的总和，被系统留着未使用的内存</span><br><span class="line">Buffers:          110680 kB    用来给文件做缓冲大小</span><br><span class="line">Cached:           256796 kB    被高速缓冲存储器（cache memory）用的内存的大小（等于</span><br><span class="line">diskcache +　SwapCache ）</span><br><span class="line">SwapCached:            0 kB　　　</span><br><span class="line">Active:           680560 kB　　在活跃使用中的缓冲或高速缓冲存储器页面文件的大小，除非非常必要否则不会被移作他用</span><br><span class="line">Inactive:         145228 kB    在不经常使用中的缓冲或高速缓冲存储器页面文件的大小，可能被用于其他途径</span><br><span class="line">Active(anon):     458208 kB</span><br><span class="line">Inactive(anon):      280 kB</span><br><span class="line">Active(file):     222352 kB</span><br><span class="line">Inactive(file):   144948 kB</span><br><span class="line">Unevictable:           0 kB</span><br><span class="line">Mlocked:               0 kB</span><br><span class="line">SwapTotal:             0 kB</span><br><span class="line">SwapFree:              0 kB</span><br><span class="line">Dirty:                92 kB   脏页，等待被写回到磁盘的内存大小</span><br><span class="line">Writeback:             0 kB   正在被写回到磁盘的内存大小</span><br><span class="line">AnonPages:        458328 kB   未映射页的内存大小</span><br><span class="line">Mapped:            27072 kB   设备和文件等映射的大小</span><br><span class="line">Shmem:               176 kB</span><br><span class="line">Slab:              53564 kB   内核数据结构缓存的大小，可以减少申请和释放内存带来的消耗</span><br><span class="line">SReclaimable:      32404 kB   可收回Slab的大小</span><br><span class="line">SUnreclaim:        21160 kB   不可收回Slab的大小（SUnreclaim+SReclaimable＝Slab）</span><br><span class="line">KernelStack:        1136 kB   内核栈大小占用的内存</span><br><span class="line">PageTables:         5856 kB   管理内存分页页面的索引表的大小</span><br><span class="line">NFS_Unstable:          0 kB   不稳定页表的大小</span><br><span class="line">Bounce:                0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line">CommitLimit:      509820 kB</span><br><span class="line">Committed_AS:    1483868 kB</span><br><span class="line">VmallocTotal:   34359738367 kB  可以vmalloc虚拟内存大小</span><br><span class="line">VmallocUsed:        7472 kB     已经被使用的虚拟内存大小</span><br><span class="line">VmallocChunk:   34359728764 kB</span><br><span class="line">HardwareCorrupted:     0 kB</span><br><span class="line">AnonHugePages:    198656 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">DirectMap4k:        7168 kB</span><br><span class="line">DirectMap2M:     1044480 kB</span><br></pre></td></tr></table></figure>

<h4 id="7-缓存命中率cache-hit"><a href="#7-缓存命中率cache-hit" class="headerlink" title="7. 缓存命中率cache-hit"></a>7. 缓存命中率cache-hit</h4><p>安装valgrind</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install valgrind</span></span><br></pre></td></tr></table></figure>

<p>查看命令或者脚本的cache-miss</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># valgrind --tool=cachegrind ls</span></span><br><span class="line">......</span><br><span class="line">==2005== D1  miss rate:     1.5% (    2.0%     +     0.8%  )</span><br><span class="line">==2005== LLd miss rate:     1.0% (    1.2%     +     0.7%  )</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="8-strace用来跟踪一个进程的系统调用或信号产生的情况"><a href="#8-strace用来跟踪一个进程的系统调用或信号产生的情况" class="headerlink" title="8. strace用来跟踪一个进程的系统调用或信号产生的情况"></a>8. strace用来跟踪一个进程的系统调用或信号产生的情况</h4><p>查看复制文件的状态跟踪</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># strace -fc cp /etc/passwd /tmp/</span></span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">25.08    0.000234           9        25           mmap</span><br><span class="line">19.40    0.000181          12        15           close</span><br><span class="line">17.58    0.000164          10        16           mprotect</span><br><span class="line">13.08    0.000122          10        12           open</span><br><span class="line">11.25    0.000105          10        11           <span class="built_in">read</span></span><br><span class="line">3.22    0.000030           3        12           fstat</span><br><span class="line">3.00    0.000028          14         2         1 access</span><br><span class="line">2.68    0.000025          13         2           munmap</span><br><span class="line">2.36    0.000022          22         1           execve</span><br><span class="line">0.54    0.000005           3         2           rt_sigaction</span><br><span class="line">0.32    0.000003           3         1           rt_sigprocmask</span><br><span class="line">0.32    0.000003           3         1           getrlimit</span><br><span class="line">0.32    0.000003           3         1           arch_prctl</span><br><span class="line">0.32    0.000003           3         1           set_tid_address</span><br><span class="line">0.32    0.000003           3         1           set_robust_list</span><br><span class="line">0.21    0.000002           1         3           brk</span><br><span class="line">0.00    0.000000           0         1           write</span><br><span class="line">0.00    0.000000           0         4         2 <span class="built_in">stat</span></span><br><span class="line">0.00    0.000000           0         1         1 lseek</span><br><span class="line">0.00    0.000000           0         1           geteuid</span><br><span class="line">0.00    0.000000           0         2         2 statfs</span><br><span class="line">0.00    0.000000           0         1           fadvise64</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00    0.000933                   116         6 total</span><br></pre></td></tr></table></figure>

<p>可以具体到查看命令打开了什么文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># strace -e open cp /etc/passwd /tmp/</span></span><br><span class="line">open(<span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libselinux.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libacl.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libattr.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libc.so.6&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libpcre.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libdl.so.2&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/lib64/libpthread.so.0&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/proc/filesystems&quot;</span>, O_RDONLY)     = 3</span><br><span class="line">open(<span class="string">&quot;/usr/lib/locale/locale-archive&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY)           = 3</span><br><span class="line">open(<span class="string">&quot;/tmp/passwd&quot;</span>, O_WRONLY|O_TRUNC)   = 4</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>

<h4 id="9-ltrace用来跟踪进程调用库函数的情况"><a href="#9-ltrace用来跟踪进程调用库函数的情况" class="headerlink" title="9. ltrace用来跟踪进程调用库函数的情况"></a>9. ltrace用来跟踪进程调用库函数的情况</h4><p>查看命令对系统和库的调用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ltrace -Sfc cp /etc/passwd /tmp/</span></span><br><span class="line">% time     seconds  usecs/call     calls      <span class="keyword">function</span></span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line">42.06    0.013412       13412         1 __libc_start_main</span><br><span class="line">15.75    0.005023        5023         1 <span class="built_in">exit</span></span><br><span class="line">3.95    0.001261        1261         1 exit_group</span><br><span class="line">3.22    0.001027         342         3 __xstat</span><br><span class="line">2.97    0.000946         946         1 __errno_location</span><br><span class="line">2.82    0.000900          52        17 close</span><br><span class="line">2.81    0.000897         224         4 free</span><br><span class="line">2.51    0.000801         160         5 __freading</span><br><span class="line">2.40    0.000766         255         3 fclose</span><br><span class="line">1.93    0.000614         153         4 strlen</span><br><span class="line">1.80    0.000575         143         4 fileno</span><br><span class="line">1.55    0.000494          35        14 open</span><br><span class="line">1.33    0.000424         141         3 brk</span><br><span class="line">1.14    0.000362         181         2 fflush</span><br><span class="line">1.10    0.000350          26        13 <span class="built_in">read</span></span><br><span class="line">1.07    0.000340         340         1 posix_fadvise</span><br><span class="line">1.03    0.000327         109         3 malloc</span><br><span class="line">......</span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line">100.00    0.031885                   176 total</span><br></pre></td></tr></table></figure>

<h3 id="四、文件系统的调优"><a href="#四、文件系统的调优" class="headerlink" title="四、文件系统的调优"></a>四、文件系统的调优</h3><h4 id="1-tune2fs"><a href="#1-tune2fs" class="headerlink" title="1. tune2fs"></a>1. tune2fs</h4><p>查看文件系统信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tune2fs -l /dev/sda3 </span></span><br><span class="line">tune2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          b1b4ea64-5a17-421c-b022-3ac84c14a1e6</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision <span class="comment">#:    1 (dynamic)</span></span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype     needs_reco</span><br><span class="line">very extent 64bit flex_bg sparse_super large_file huge_file uninit_bg dir_nlink     extra_isizeFilesystem flags:         signed_directory_hash </span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">Filesystem state:         clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS <span class="built_in">type</span>:       Linux</span><br><span class="line">Inode count:              65536</span><br><span class="line">Block count:              262144</span><br><span class="line">Reserved block count:     13107</span><br><span class="line">Free blocks:              249189</span><br><span class="line">Free inodes:              65525</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Group descriptor size:    64</span><br><span class="line">Reserved GDT blocks:      127</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         8192</span><br><span class="line">Inode blocks per group:   512</span><br><span class="line">Flex block group size:    16</span><br><span class="line">Filesystem created:       Fri Jun  2 17:01:20 2017</span><br><span class="line">Last mount time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Last write time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      -1</span><br><span class="line">Last checked:             Fri Jun  2 17:01:20 2017</span><br><span class="line">Check interval:           0 (&lt;none&gt;)</span><br><span class="line">Lifetime writes:          33 MB</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:           256</span><br><span class="line">Required extra isize:     28</span><br><span class="line">Desired extra isize:      28</span><br><span class="line">Journal inode:            8</span><br><span class="line">Default directory <span class="built_in">hash</span>:   half_md4</span><br><span class="line">Directory Hash Seed:      448602f1-b2c4-4522-a428-3746969036d6</span><br><span class="line">Journal backup:           inode blocks</span><br></pre></td></tr></table></figure>

<p>df查看分区有一部分空间（976M-2.6M-907M&#x3D;66.4M）看不到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># df -h |grep sda3</span></span><br><span class="line">/dev/sda3            976M  2.6M  907M   1% /mnt</span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -l /dev/sda3 |grep &quot;Reserved block count&quot;</span></span><br><span class="line">Reserved block count:     26214</span><br></pre></td></tr></table></figure>

<p><code>Reserved GDT blocks</code>：每个分区5%的block会被保留</p>
<p>修改分区保留比例为1%</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tune2fs -m 10 /dev/sda3</span></span><br><span class="line">Setting reserved blocks percentage to 1% (26214 blocks)</span><br></pre></td></tr></table></figure>

<p>修改磁盘的UUID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># blkid |grep sda3</span></span><br><span class="line">/dev/sda3: UUID=<span class="string">&quot;b1b4ea64-5a17-421c-b022-3ac84c14a1e7&quot;</span> TYPE=<span class="string">&quot;ext4&quot;</span> </span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -U b1b4ea64-5a17-421c-b022-3ac84c14a1e8 /dev/sda3</span></span><br><span class="line">[root@student02 ~]<span class="comment"># blkid |grep sda3</span></span><br><span class="line">/dev/sda3: UUID=<span class="string">&quot;b1b4ea64-5a17-421c-b022-3ac84c14a1e8&quot;</span> TYPE=<span class="string">&quot;ext4&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-dumpe2fs，查看文件系统结构"><a href="#2-dumpe2fs，查看文件系统结构" class="headerlink" title="2. dumpe2fs，查看文件系统结构"></a>2. dumpe2fs，查看文件系统结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># dumpe2fs /dev/sda3 </span></span><br><span class="line">dumpe2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          b1b4ea64-5a17-421c-b022-3ac84c14a1e6</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision <span class="comment">#:    1 (dynamic)</span></span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype     needs_reco</span><br><span class="line">very extent 64bit flex_bg sparse_super large_file huge_file uninit_bg dir_nlink     extra_isizeFilesystem flags:         signed_directory_hash </span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">Filesystem state:         clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS <span class="built_in">type</span>:       Linux</span><br><span class="line">Inode count:              65536</span><br><span class="line">Block count:              262144</span><br><span class="line">Reserved block count:     13107</span><br><span class="line">Free blocks:              249189</span><br><span class="line">Free inodes:              65525</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Group descriptor size:    64</span><br><span class="line">Reserved GDT blocks:      127</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         8192</span><br><span class="line">Inode blocks per group:   512</span><br><span class="line">Flex block group size:    16</span><br><span class="line">Filesystem created:       Fri Jun  2 17:01:20 2017</span><br><span class="line">Last mount time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Last write time:          Fri Jun  2 17:01:25 2017</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      -1</span><br><span class="line">Last checked:             Fri Jun  2 17:01:20 2017</span><br><span class="line">Check interval:           0 (&lt;none&gt;)</span><br><span class="line">Lifetime writes:          33 MB</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:           256</span><br><span class="line">Required extra isize:     28</span><br><span class="line">Desired extra isize:      28</span><br><span class="line">Journal inode:            8</span><br><span class="line">Default directory <span class="built_in">hash</span>:   half_md4</span><br><span class="line">Directory Hash Seed:      448602f1-b2c4-4522-a428-3746969036d6</span><br><span class="line">Journal backup:           inode blocks</span><br><span class="line">Journal features:         journal_64bit</span><br><span class="line">Journal size:             32M</span><br><span class="line">Journal length:           8192</span><br><span class="line">Journal sequence:         0x00000002</span><br><span class="line">Journal start:            1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Group 0: (Blocks 0-32767) [ITABLE_ZEROED]</span><br><span class="line">Checksum 0x5492, unused inodes 8181</span><br><span class="line">Primary superblock at 0, Group descriptors at 1-1</span><br><span class="line">Reserved GDT blocks at 2-128</span><br><span class="line">Block bitmap at 129 (+129), Inode bitmap at 145 (+145)</span><br><span class="line">Inode table at 161-672 (+161)</span><br><span class="line">28521 free blocks, 8181 free inodes, 2 directories, 8181 unused inodes</span><br><span class="line">Free blocks: 142-144, 153-160, 4258-32767</span><br><span class="line">Free inodes: 12-8192</span><br><span class="line">Group 1: (Blocks 32768-65535) [INODE_UNINIT, ITABLE_ZEROED]</span><br><span class="line">Checksum 0xb3fe, unused inodes 8192</span><br><span class="line">Backup superblock at 32768, Group descriptors at 32769-32769</span><br><span class="line">Reserved GDT blocks at 32770-32896</span><br><span class="line">Block bitmap at 130 (<span class="built_in">bg</span> <span class="comment">#0 + 130), Inode bitmap at 146 (bg #0 + 146)</span></span><br><span class="line">Inode table at 673-1184 (<span class="built_in">bg</span> <span class="comment">#0 + 673)</span></span><br><span class="line">32639 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes</span><br><span class="line">Free blocks: 32897-65535</span><br><span class="line">Free inodes: 8193-16384</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><code>Journal size</code>：日志区大小</p>
<p><code>Group x</code>：文件系统会把block分成很多个group，每个group的大小为32768个block，当文件系统在使用的时候每个group都是平均使用的，不会使用完，当已经写入的文件需要扩大的时候可以就文件当前的group上面分配空间，让文件尽可能连续，不必到距离很远的block分配空间，可以提升文件读取性能。</p>
<p><code>superblock</code>：superblock在第0个group上，第1、3、 5、7、9个group上面有superblock的备份</p>
<p><code>Group descriptors</code>：每个group的第一个block存放group的描述信息</p>
<p><code>Reserved GDT blocks</code>：每个group有127个保留的block</p>
<p><code>Block bitmap</code>：记录block的位图区</p>
<p><code>Inode bitmap</code>：记录inode索引文件的位图区</p>
<p><code>Inode table</code>：inode索引表</p>
<p><code>Free blocks</code>：未使用的block</p>
<p><code>Free inodes</code>：未使用的inode</p>
<h4 id="3-修复文件系统"><a href="#3-修复文件系统" class="headerlink" title="3. 修复文件系统"></a>3. 修复文件系统</h4><p>破坏超级快和block保留区，挂载失败</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># dd if=/dev/zero of=/dev/sda3 bs=1K count=516</span></span><br><span class="line">[root@student02 ~]<span class="comment"># mount /dev/sda3 /mnt/</span></span><br><span class="line">mount: /dev/sda3 is write-protected, mounting read-only</span><br><span class="line">mount: unknown filesystem <span class="built_in">type</span> <span class="string">&#x27;(null)&#x27;</span></span><br></pre></td></tr></table></figure>

<p>用fsck修复文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># fsck -v /dev/sda3</span></span><br></pre></td></tr></table></figure>

<p>有的情况下fsck修复不了可以使用e2fsck指定超级快修复</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># e2fsck -b 98304 /dev/sda3</span></span><br></pre></td></tr></table></figure>

<h4 id="4-非日志型文件系统与日志型文件系统"><a href="#4-非日志型文件系统与日志型文件系统" class="headerlink" title="4. 非日志型文件系统与日志型文件系统"></a>4. 非日志型文件系统与日志型文件系统</h4><p>非日志型文件系统：fat32、ext2</p>
<p>文件系统无日志区，文件写入过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">文件索引写入到inode--&gt;文件内容写入到block</span><br><span class="line">文件内容写入到block--&gt;文件写入完成</span><br></pre></td></tr></table></figure>

<p>在非日志型文件系统中，对文件系统实施一个写操作，内核会首先修改对应的元数据，然后修改数据块。如果在写入元数据时，文件系统发生崩溃或某种故障，那么数据的一致性将会遭到破坏。fsck命令可以在下次重启时检查所有的元数据并修复数据一致性，但是如果文件系统非常大，或者系统运行关键业务不允许停机，使用非日志型文件系统的风险会非常高。</p>
<p>日志型文件系统：ntfs、ext3、ext4、xfs、jfs</p>
<p>文件系统有日志区，文件写入过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">文件索引写入到journal--&gt;文件内容写入到block</span><br><span class="line">文件内容写入到block--&gt;文件索引写入到inode</span><br><span class="line">文件索引写入到inode--&gt;文件写入完成</span><br></pre></td></tr></table></figure>

<p>日志型文件系统的区别在于，在进行对文件系统写数据之前，写将数据写到「日志区」，然后再写入文件系统，在写入文件系统之后删除日志。日志区可以在文件系统内部也可以在文件系统外部。日志区的数据称作文件系统日志，这些数据包含了修改了的元数据，也可能包含将要修改的数据。写日志也会带来一定的额外开销。</p>
<p>查看文件系统的日志区大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># dumpe2fs /dev/sda3 |grep &quot;Journal size&quot;</span></span><br><span class="line">Journal size:             32M</span><br></pre></td></tr></table></figure>

<h4 id="5-内部日志区和外部日志区"><a href="#5-内部日志区和外部日志区" class="headerlink" title="5. 内部日志区和外部日志区"></a>5. 内部日志区和外部日志区</h4><p>内部日志区，日志区在当前文件系统，会对文件系统进行两次索引信息写入</p>
<p>外部日志区，单独一个文件系统做日志区，减少访问次数，减少服务时间</p>
<p>创建外部日志区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># umount /dev/sda3 #先卸载文件系统</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /proc/partitions |grep sda4 #新建128M的分区</span></span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -O ^has_journal /dev/sda3 #去掉文件系统内部日志区功能</span></span><br><span class="line">[root@student02 ~]<span class="comment"># mke2fs -O journal_dev -b 4096 /dev/sda4 #把分区格式化成日志区设备</span></span><br><span class="line">[root@student02 ~]<span class="comment"># tune2fs -j -J device=/dev/sda4 /dev/sda3 #把sda4设置为sda3的外部日志区</span></span><br><span class="line">Creating journal on device /dev/sda4: <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>不更新atime，适用于频繁读取文件的业务减少磁盘写</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># mount -o remount,noatime /home/</span></span><br><span class="line">[root@student02 ~]<span class="comment"># mount |grep /home</span></span><br><span class="line">/dev/mapper/cl-home on /home <span class="built_in">type</span> xfs (rw,noatime,attr2,inode64,noquota)</span><br></pre></td></tr></table></figure>

<h4 id="6-cache"><a href="#6-cache" class="headerlink" title="6. cache"></a>6. cache</h4><p>磁盘写入数据，数据先写到硬盘的缓存中，进行io的聚合排序后，再从缓存写到硬盘中，电梯算法</p>
<p>修改磁盘缓存的队列长度，队列长度越长，io得到更多的聚合，但是更消耗内存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/nr_requests </span></span><br><span class="line">128</span><br><span class="line">[root@student02 ~]<span class="comment"># echo 256 &gt; /sys/block/sda/queue/nr_requests</span></span><br></pre></td></tr></table></figure>

<h4 id="7-读策略"><a href="#7-读策略" class="headerlink" title="7. 读策略"></a>7. 读策略</h4><p>读预取的作用：</p>
<ul>
<li>在处理IO请求时，从磁盘按顺序读取IO数据以外更多的数据，预先缓存到cache中，以便下一个顺序读IO请求到达时，可直接在cache中获取，得到更高的性能表现。</li>
<li>当读IO很随机是，不当的读预取策略会给存储系统带来额外的资源开销，不到无法保证后续IO再cache中的命中，而且还会带来性能的降低。</li>
</ul>
<p>四种预取算法：固定预取、可变预取、智能预取和不预取。</p>
<ul>
<li>固定预取：固定大小数据的预取。</li>
<li>可变预取：固定IO数量的预取。</li>
<li>智能预取：顺序IO的时候就预取，随机IO的时候就不预取，默认预取算法。</li>
<li>不预取：不预取数据。</li>
</ul>
<p>默认读预取大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/read_ahead_kb </span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<p>查询读预取扇区数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># blockdev --getra /dev/sda3 </span></span><br><span class="line">8192</span><br></pre></td></tr></table></figure>

<p>修改读预取扇区数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># blockdev --setra 4096 /dev/sda3 </span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/read_ahead_kb </span></span><br><span class="line">2048</span><br><span class="line">[root@student02 ~]<span class="comment"># blockdev --getra /dev/sda3 </span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<p>想要重启生效，需要写到开机脚本里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo &quot;blockdev --setra 4096 /dev/sda3&quot; &gt;&gt;/etc/rc.local</span></span><br></pre></td></tr></table></figure>

<h4 id="8-scheduler，磁盘调度算法，可以搭配tuned来使用"><a href="#8-scheduler，磁盘调度算法，可以搭配tuned来使用" class="headerlink" title="8. scheduler，磁盘调度算法，可以搭配tuned来使用"></a>8. scheduler，磁盘调度算法，可以搭配tuned来使用</h4><p>三种调度算法：</p>
<ul>
<li>deadline：最终期限，适合小IO，一个IO读500ms或者写了5000ms没有完成，就放到队列里面排队，优化了等待时间。</li>
<li>noop：不使用任何参数</li>
<li>cfq：完全公平，轮询，默认算法</li>
</ul>
<p>查看当前的调度算法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/scheduler </span></span><br><span class="line">noop [deadline] cfq</span><br></pre></td></tr></table></figure>

<p>修改调度算法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo deadline &gt; /sys/block/sda/queue/scheduler </span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/block/sda/queue/scheduler</span></span><br><span class="line">noop [deadline] cfq</span><br></pre></td></tr></table></figure>

<p>deadline的算法参数front_merges、read_expire、write_expire</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ls /sys/block/sda/queue/iosched/</span></span><br><span class="line">fifo_batch  front_merges  read_expire  write_expire  writes_starved</span><br></pre></td></tr></table></figure>

<p>查询内核参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 kernel-doc-3.10.0]<span class="comment"># grep -irn --color=auto ^read_expire  .</span></span><br><span class="line">./Documentation/block/deadline-iosched.txt:17:read_expire   (<span class="keyword">in</span> ms)</span><br></pre></td></tr></table></figure>

<p>cfq模式下可以用ionice做进程优先级微调</p>
<p>ionice的级别</p>
<ul>
<li>class1，实时的，子级别有0-7，数字越大优先级越低</li>
<li>class2，尽力的，子级别有0-7，数字越大优先级越低</li>
<li>class3，空闲的</li>
</ul>
<p>修改优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># pidof vsftpd</span></span><br><span class="line">1805</span><br><span class="line">[root@student02 ~]<span class="comment"># ionice -p 1805 -c 2 -n 0</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ionice -p 1805</span></span><br><span class="line">best-effort: prio 0</span><br></pre></td></tr></table></figure>

<h3 id="五、Linux模块的调优"><a href="#五、Linux模块的调优" class="headerlink" title="五、Linux模块的调优"></a>五、Linux模块的调优</h3><h4 id="1-列出系统中加载的模块，查找ext4文件系统模块"><a href="#1-列出系统中加载的模块，查找ext4文件系统模块" class="headerlink" title="1. 列出系统中加载的模块，查找ext4文件系统模块"></a>1. 列出系统中加载的模块，查找ext4文件系统模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># lsmod |grep ^ext4</span></span><br><span class="line">Module    Size  Used by</span><br><span class="line">ext4                   985347  3</span><br></pre></td></tr></table></figure>
<p><code>Module</code>：模块名<br><code>Size</code>：模块大小<br><code>Used</code>：正在使用次数<br><code>by</code>：描述</p>
<h4 id="2-查看模块驱动的详细信息"><a href="#2-查看模块驱动的详细信息" class="headerlink" title="2. 查看模块驱动的详细信息"></a>2. 查看模块驱动的详细信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># modinfo st</span></span><br><span class="line">filename:       /lib/modules/3.10.0-514.16.1.el7.x86_64/kernel/drivers/scsi/st.ko</span><br><span class="line"><span class="built_in">alias</span>:          scsi:t-0x01*</span><br><span class="line"><span class="built_in">alias</span>:          char-major-9-*</span><br><span class="line">license:        GPL</span><br><span class="line">description:    SCSI tape (st) driver</span><br><span class="line">author:         Kai Makisara</span><br><span class="line">rhelversion:    7.3</span><br><span class="line">srcversion:     5C10DC43BF58E63A59D8660</span><br><span class="line">depends:        </span><br><span class="line">intree:         Y</span><br><span class="line">vermagic:       3.10.0-514.16.1.el7.x86_64 SMP mod_unload modversions </span><br><span class="line">signer:         CentOS Linux kernel signing key</span><br><span class="line">sig_key:        3F:E1:EB:8B:4F:91:D4:84:CD:55:44:84:54:A0:24:DE:56:34:E1:06</span><br><span class="line">sig_hashalgo:   sha256</span><br><span class="line">parm:           buffer_kbs:Default driver buffer size <span class="keyword">for</span> fixed block mode (KB; 32)     (int)</span><br><span class="line">parm:           max_sg_segs:Maximum number of scatter/gather segments to use (256) (int)</span><br><span class="line">parm:           try_direct_io:Try direct I/O between user buffer and tape drive (1)     (int)</span><br><span class="line">parm:           debug_flag:Enable DEBUG, same as setting debugging=1 (int)</span><br><span class="line">parm:           try_rdio:Try direct <span class="built_in">read</span> i/o when possible (int)</span><br><span class="line">parm:           try_wdio:Try direct write i/o when possible (int)</span><br></pre></td></tr></table></figure>

<h4 id="3-手动加载模块"><a href="#3-手动加载模块" class="headerlink" title="3. 手动加载模块"></a>3. 手动加载模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># modprobe st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># lsmod |grep st</span></span><br><span class="line">st                     54238  0</span><br></pre></td></tr></table></figure>


<h4 id="4-手动卸载模块"><a href="#4-手动卸载模块" class="headerlink" title="4. 手动卸载模块"></a>4. 手动卸载模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># modprobe -r st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># lsmod |grep ^st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h4 id="5-查看模块驱动的参数fixed-buffer-size"><a href="#5-查看模块驱动的参数fixed-buffer-size" class="headerlink" title="5. 查看模块驱动的参数fixed_buffer_size"></a>5. 查看模块驱动的参数fixed_buffer_size</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 st]<span class="comment"># modinfo st |grep parm |grep buffer_kbs</span></span><br><span class="line">parm:           buffer_kbs:Default driver buffer size <span class="keyword">for</span> fixed block mode (KB; 32) (int</span><br><span class="line">[root@student02 ~]<span class="comment"># cd /sys/bus/scsi/drivers/st/</span></span><br><span class="line">[root@student02 st]<span class="comment"># echo &quot;`cat fixed_buffer_size`/1024&quot; |bc</span></span><br><span class="line">32</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 6. 修改st模块的固定缓存，写到模块的配置文件中</span></span><br><span class="line">```bash</span><br><span class="line">[root@student02]<span class="comment"># echo &quot;options st buffer_kbs=128&quot; &gt; /etc/modprobe.d/st.conf</span></span><br><span class="line">[root@student02]<span class="comment"># modprobe -r st</span></span><br><span class="line">[root@student02]<span class="comment"># modprobe st</span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo &quot;`cat /sys/bus/scsi/drivers/st/fixed_buffer_size`/1024&quot; |bc</span></span><br><span class="line">128</span><br></pre></td></tr></table></figure>

<h3 id="六、内存的调优"><a href="#六、内存的调优" class="headerlink" title="六、内存的调优"></a>六、内存的调优</h3><h4 id="1-当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存"><a href="#1-当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存" class="headerlink" title="1. 当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存"></a>1. 当在Linux下频繁存取文件后，cached占用很多资源，虽然cache是为了提高文件读取效率，在有需求的情况下通过命令可以清空缓存</h4><p>先用free命令查看缓存的使用情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># free -m</span></span><br><span class="line">total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            976         131          76           6         768         649</span><br><span class="line">Swap:          2047           0        2047</span><br></pre></td></tr></table></figure>

<p>看到buff&#x2F;cache占用了768M的内存空间，在清空缓存前用sync命令把dirty页的内容写回硬盘，以免数据丢失</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sync</span></span><br></pre></td></tr></table></figure>

<p>现在可以尝试使用内核参数vm.drop_caches来清空缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -w vm.drop_caches=3</span></span><br><span class="line">vm.drop_caches = 3</span><br></pre></td></tr></table></figure>

<p>再来看看缓存的情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># free -m</span></span><br><span class="line">total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            976         123         762           6          90         713</span><br><span class="line">Swap:          2047           0        2047</span><br></pre></td></tr></table></figure>

<p>发现已经只有90M的buff&#x2F;cache，free的内存空间大了很多</p>
<h4 id="2-虚拟内存与物理内存"><a href="#2-虚拟内存与物理内存" class="headerlink" title="2. 虚拟内存与物理内存"></a>2. 虚拟内存与物理内存</h4><p>查看进程占用的虚拟内存和物理内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ps -aux |grep -E &quot;^nginx|RSS&quot; |grep -v grep</span></span><br><span class="line">USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">nginx      3167  0.0  0.1  46104  1992 ?        S    17:01   0:00 nginx: worker process</span><br></pre></td></tr></table></figure>

<p><code>VSZ</code>：申请虚拟内存大小，不是立即使用这么多内存<br><code>RSS</code>：实际占用物理内存大小</p>
<h4 id="3-PTE和TLB"><a href="#3-PTE和TLB" class="headerlink" title="3. PTE和TLB"></a>3. PTE和TLB</h4><p>PTE，页表条目 (Page Table Entry),是页表的最低层,它直接处理页,该值包含某页的虚拟内存到物理内存的映射关系</p>
<p>TLB，是虚拟寻址的缓存，其中每一行都保存着一个由单个PTE(Page Table Entry,页表项)组成的块，用于虚拟地址与实地址之间的交互，提供一个寻找实地址的缓存区，能够有效减少寻找物理地址所消耗时间。</p>
<p>hugepage，大页，用来做TLB的</p>
<p>配置hugepage，添加内核参数，分配40M空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a |grep -w vm.nr_hugepages |sed &#x27;s/0/20/&#x27; &gt;&gt;/etc/sysctl.conf </span></span><br><span class="line">[root@student02 ~]<span class="comment"># sysctl -p</span></span><br><span class="line">vm.nr_hugepages = 20</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /proc/meminfo |grep -i &quot;^hugepage&quot;</span></span><br><span class="line">HugePages_Total:      20</span><br><span class="line">HugePages_Free:       20</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br></pre></td></tr></table></figure>

<p>默认是不启用大页的，大页的空间是立即分配的，不使用也会占用一段内存</p>
<h4 id="4-页中断"><a href="#4-页中断" class="headerlink" title="4. 页中断"></a>4. 页中断</h4><p>查看进程的次页中断和主页中断</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># ps axo comm,pid,min_flt,maj_flt |grep -iE &quot;command|nginx&quot;</span></span><br><span class="line">COMMAND            PID  MINFL  MAJFL</span><br><span class="line">nginx             4551    100      0</span><br><span class="line">nginx             4552    292      0</span><br></pre></td></tr></table></figure>

<p>打开一个进程，需要去分配内存叫页中断，可以直接在内存中调用叫次页中断，需要去硬盘swap中调用叫主页中断，出现大量主页中断的时候就说明内存存在瓶颈</p>
<h4 id="5-内存页的状态"><a href="#5-内存页的状态" class="headerlink" title="5. 内存页的状态"></a>5. 内存页的状态</h4><p>内存页的四种状态：<br><code>free</code>：是空闲的页，随时可以被使用<br><code>inactive clean</code>：未激活的干净的页，页中的数据已经写到磁盘中，从磁盘读到内存中未被修改，这个页也可以分配，例如，cached<br><code>inactive dirty</code>：脏页，不能被使用，页中的数据修改未写到磁盘，例如脏页，特别是复制文件的时候，dirty是实时变化的<br><code>active</code>：激活的页，正在被进程使用，不能被分配</p>
<p>查看脏页的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/meminfo |grep -w Dirty</span></span><br><span class="line">Dirty:                 4 kB</span><br></pre></td></tr></table></figure>

<p>脏页快速回写的百分比</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep dirty_ratio</span></span><br><span class="line">vm.dirty_ratio = 40</span><br></pre></td></tr></table></figure>
<p>当脏页占用内存20%以下的时候，低速写到磁盘中，高于20%的时候高速写回磁盘中，大io可以设置比较小，快点写入硬盘，小io可以慢点写入硬盘，得到聚合，存储一般设置比较高，因为存储有掉电保护BBU</p>
<p>脏页的过期时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep dirty_exp</span></span><br><span class="line">vm.dirty_expire_centisecs = 3000</span><br></pre></td></tr></table></figure>
<p>默认30s，30s到了即使比例不达到20%也要快速写到磁盘中</p>
<p>脏页比例的检查时间，5s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep dirty_w</span></span><br><span class="line">vm.dirty_writeback_centisecs = 500</span><br></pre></td></tr></table></figure>

<p>也可以用命令sync立即把脏页内容写到硬盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sync</span></span><br></pre></td></tr></table></figure>

<p>还有一个文件也可以强制同步，还支持很多其他指令，模拟各种场景，可以查看内核文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo s &gt;/proc/sysrq-trigger</span></span><br></pre></td></tr></table></figure>

<p>当内存紧张的时候倾向于释放cached使用还是去使用swap，值为0到100,0倾向于保留cached使用swap，100倾向于释放cached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a|grep swapp</span></span><br><span class="line">vm.swappiness = 10</span><br></pre></td></tr></table></figure>

<h4 id="6-内存溢出"><a href="#6-内存溢出" class="headerlink" title="6. 内存溢出"></a>6. 内存溢出</h4><p>oom-kill，内存溢出的保护机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo -17 &gt;/proc/1161/oom_adj</span></span><br></pre></td></tr></table></figure>
<p>这个值的取值范围-17到15，值越小，内存溢出不会杀死这个进程，我们可以把重要的进程值设置比较小，不重要的进程设置为15，内存溢出的时候优先杀死这个进程，腾出内存来，重启生效需要写到开机脚本里</p>
<p>关闭oom-kill的功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a |grep -i panic_on_oom</span></span><br><span class="line">vm.panic_on_oom = 0</span><br></pre></td></tr></table></figure>
<p>这个值设置为1，关闭oom-kill</p>
<h4 id="7-内存泄漏"><a href="#7-内存泄漏" class="headerlink" title="7. 内存泄漏"></a>7. 内存泄漏</h4><p>进程使用了内存，进程结束也不能回收的部分内存，只有重启才能回收泄漏的内存</p>
<p>检查程序的内存泄漏</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># valgrind --tool=memcheck vsftpd</span></span><br><span class="line">......</span><br><span class="line">==1243==    definitely lost: 0 bytes <span class="keyword">in</span> 0 blocks</span><br><span class="line">==1243==    indirectly lost: 0 bytes <span class="keyword">in</span> 0 blocks</span><br><span class="line">==1243==      possibly lost: 0 bytes <span class="keyword">in</span> 0 blocks</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="8-swap"><a href="#8-swap" class="headerlink" title="8. swap"></a>8. swap</h4><p>释放swap的空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># swapoff -a</span></span><br><span class="line">[root@student02 ~]<span class="comment"># swapon -a</span></span><br></pre></td></tr></table></figure>

<p>新增swap分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># mkswap /dev/sda4</span></span><br><span class="line">[root@student02 ~]<span class="comment"># swapon /dev/sda4</span></span><br></pre></td></tr></table></figure>

<p>查看swap分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># swapon -s</span></span><br></pre></td></tr></table></figure>

<p>当有几个swap分区时，设置优先级，数字越大优先级越高，优先级一样高，则轮询使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /etc/fstab |grep swap</span></span><br><span class="line">/dev/mapper/cl-swap     swap                    swap    defaults,pri=1        0 0</span><br></pre></td></tr></table></figure>

<h4 id="9-共享内存"><a href="#9-共享内存" class="headerlink" title="9. 共享内存"></a>9. 共享内存</h4><p>系统安装的时候有一个挂载设备&#x2F;dev&#x2F;shm，大小是内存的一般，这个设备就是用来做共享内存的，可以把内存当做磁盘使用，有很快的速度，满足一些业务的需求</p>
<p>查看共享内存的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># df -h |grep shm</span></span><br><span class="line">tmpfs                489M     0  489M   0% /dev/shm</span><br></pre></td></tr></table></figure>

<p>设置shm分区的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /etc/fstab |grep shm</span></span><br><span class="line">tmpfs   /dev/shm    tmpfs   defaults,size=128m</span><br><span class="line">[root@student02 ~]<span class="comment"># mount -o remount /dev/shm</span></span><br></pre></td></tr></table></figure>

<p>squid做反向代理就会使用共享内存</p>
<h4 id="10-内存复用"><a href="#10-内存复用" class="headerlink" title="10. 内存复用"></a>10. 内存复用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sysctl -a |grep overcommit</span></span><br><span class="line">vm.overcommit_memory = 0</span><br><span class="line">vm.overcommit_ratio = 50</span><br></pre></td></tr></table></figure>
<p>0代表更多的尝试过量使用，能过量的就给，1总是过量使用内存，不能过量就释放别的进程，可能把系统搞死机，2能申请的内存等于swap加上内存的百分比，设置模式为0和1的时候百分比设置无效，设置模式2才有效</p>
<h3 id="七、cpu与进程的调优"><a href="#七、cpu与进程的调优" class="headerlink" title="七、cpu与进程的调优"></a>七、cpu与进程的调优</h3><h4 id="1-irq的均衡"><a href="#1-irq的均衡" class="headerlink" title="1. irq的均衡"></a>1. irq的均衡</h4><p>每个设备都有自己的irq号码，查看设备的中断号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/interrupts </span></span><br><span class="line">CPU0       CPU1       </span><br><span class="line">0:         21          0   IO-APIC-edge      timer</span><br><span class="line">1:         10          0   IO-APIC-edge      i8042</span><br><span class="line">6:          2          0   IO-APIC-edge      floppy</span><br><span class="line">8:          1          0   IO-APIC-edge      rtc0</span><br><span class="line">9:          0          0   IO-APIC-fasteoi   acpi</span><br><span class="line">12:         16          0   IO-APIC-edge      i8042</span><br><span class="line">14:          0          0   IO-APIC-edge      ata_piix</span><br><span class="line">15:        160          0   IO-APIC-edge      ata_piix</span><br><span class="line">16:          2          0   IO-APIC-fasteoi   vmwgfx</span><br><span class="line">17:       6606        719   IO-APIC-fasteoi   ioc0</span><br><span class="line">18:         12         58   IO-APIC-fasteoi   ens32</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>第一列数字就是设备中断号，我们看到网卡的中断号是18</p>
<p>CPU1对应的数字在增大，CPU1处理网卡的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/interrupts |grep -E &quot;CPU|ens32&quot;</span></span><br><span class="line">CPU0       CPU1       </span><br><span class="line">18:         14       1455   IO-APIC-fasteoi   ens32</span><br></pre></td></tr></table></figure>

<p>设置网卡的亲和性，让CPU0处理网卡的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt; /proc/irq/18/smp_affinity</span></span><br></pre></td></tr></table></figure>

<p>4U的服务器设置4个CPU同时处理网卡的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo f &gt; /proc/irq/18/smp_affinity</span></span><br></pre></td></tr></table></figure>

<p>同理，可以设置其他设备的CPU亲和性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo x &gt; /proc/irq/&#123;irq_number&#125;/smp_affinity</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：x是一个16进制的数值，f的16进制是1111，代表4个CPU同时工作</p>
</blockquote>
<h4 id="2-均衡CPU的访问次数"><a href="#2-均衡CPU的访问次数" class="headerlink" title="2. 均衡CPU的访问次数"></a>2. 均衡CPU的访问次数</h4><p>任务会在所有CPU上面均衡，繁忙的时候100ms均衡一次，空闲的时候1ms均衡一次，用以下命令可以看到cp文件的时候cpu在不停的均衡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># watch -n .1 &#x27;ps axo comm,pid,psr |grep cp&#x27;</span></span><br></pre></td></tr></table></figure>

<p>CPU的调度均衡可以平衡CPU的负载，但是也会降低缓存的命中率</p>
<p>如果想提高CPU缓存命中率，可以设置进程运行在某个CPU上面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># taskset -p 1 5993</span></span><br><span class="line">pid 5993<span class="string">&#x27;s current affinity mask: 3</span></span><br><span class="line"><span class="string">pid 5993&#x27;</span>s new affinity mask: 1</span><br></pre></td></tr></table></figure>

<h4 id="3-cpu的隔离"><a href="#3-cpu的隔离" class="headerlink" title="3. cpu的隔离"></a>3. cpu的隔离</h4><p>开机内核启动的时候隔离某个cpu，用来运行单独的业务,可以使用taskset命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># grep isolcpus /boot/grub2/grub.cfg</span></span><br><span class="line">linux16 /vmlinuz-3.10.0-514.16.1.el7.x86_64 root=/dev/mapper/cl-root ro rd.lvm.lv=cl/root rd.lvm.lv=</span><br><span class="line">cl/swap rhgb quiet LANG=en_US.UTF-8 isolcpus=1</span><br></pre></td></tr></table></figure>

<h4 id="4-在线关闭cpu"><a href="#4-在线关闭cpu" class="headerlink" title="4. 在线关闭cpu"></a>4. 在线关闭cpu</h4><p>当服务器某个cpu故障的时候，我们又不能关机更换CPU，这时候就可以使用以下命令关闭故障cpu在线更换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo 0 &gt;/sys/devices/system/cpu/cpu0/online</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lscpu命令可以看到有一个cpu被关闭了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># lscpu |head -n 6</span></span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                2</span><br><span class="line">On-line CPU(s) list:   0</span><br><span class="line">Off-line CPU(s) list:  1</span><br></pre></td></tr></table></figure>

<h4 id="5-调度域，cgroup之cpuset"><a href="#5-调度域，cgroup之cpuset" class="headerlink" title="5. 调度域，cgroup之cpuset"></a>5. 调度域，cgroup之cpuset</h4><p>所谓cpuset,就是在用户空间中操作cgroup文件系统来执行进程与cpu和进程与内存节点之间的绑定，限制进程只能使用子cpuset里面的资源</p>
<p>根cpuset包含所有的资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/cpuset.cpus</span></span><br><span class="line">0-1</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/cpuset.mems </span></span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>创建一个子cpuset,包含1号cpu，和所有内存，因为虚拟机不支持NUMA，所以只能设置所有内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># mkdir /sys/fs/cgroup/cpuset/mycpuset/</span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt; /sys/fs/cgroup/cpuset/mycpuset/cpuset.cpus</span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo 0 &gt;/sys/fs/cgroup/cpuset/mycpuset/cpuset.mems</span></span><br></pre></td></tr></table></figure>

<p>还可以设置某个进程运行在cpuset里面，根cpuset包含了所有的进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/tasks </span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>让nginx进程运行在mycpuset里面，同时根cpuset里面没有这个进程了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># pidof nginx</span></span><br><span class="line">1698 1697</span><br><span class="line">[root@student02 ~]<span class="comment"># echo -e &quot;1698\n1697&quot; &gt;/sys/fs/cgroup/cpuset/mycpuset/tasks</span></span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/tasks |grep -E &quot;169[7|8]&quot;</span></span><br></pre></td></tr></table></figure>

<p>反过来看进程在哪个cpuset里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/1697/cpuset</span></span><br><span class="line">/mycpuset</span><br></pre></td></tr></table></figure>

<p>以上的配置都是重启不会生效的，如果要重启生效需要写到cgroup里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /etc/cgconfig.conf |grep -A 5 mycpuset</span></span><br><span class="line">group mycpuset &#123;</span><br><span class="line">cpuset &#123;</span><br><span class="line">cpuset.cpus = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">cpuset.mems = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /etc/cgrules.conf |grep mycpuset</span></span><br><span class="line">*:nginx     cpuset      mycpuset/</span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgconfig</span></span><br><span class="line">[root@student02 ~]<span class="comment"># systemctl restart cgred</span></span><br></pre></td></tr></table></figure>

<p>重启nginx服务测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -s stop ;nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># pidof nginx</span></span><br><span class="line">2944 2943</span><br><span class="line">[root@student02 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/mycpuset/tasks </span></span><br><span class="line">2943</span><br><span class="line">2944</span><br></pre></td></tr></table></figure>

<p>默认情况下多个子cpuset可以同时使用cpu的资源，如果想要一个cpuset独占cpu资源，可以打开这个开关，需要开机生效也要写到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt;/sys/fs/cgroup/cpuset/cpuset.cpu_exclusive </span></span><br><span class="line">[root@student02 ~]<span class="comment"># echo 1 &gt;/sys/fs/cgroup/cpuset/mycpuset/cpuset.cpu_exclusive</span></span><br></pre></td></tr></table></figure>

<h4 id="6-进程上下文切换cs"><a href="#6-进程上下文切换cs" class="headerlink" title="6. 进程上下文切换cs"></a>6. 进程上下文切换cs</h4><p>上下文切换的理解</p>
<p>context switch过高会导致CPU像个搬运工，频繁在寄存器和运行队列之间奔波，更多的时间花在了线程切换，而不是真正工作的线程上。直接的消耗包括CPU寄存器需要保存和加载，系统调度器的代码需要执行。间接消耗在于多核cache之间的共享数据。</p>
<p>引起上下文切换的原因</p>
<ul>
<li>当前任务的时间片用完之后，系统CPU正常调度下一个任务；</li>
<li>当前任务碰到IO阻塞，调度线程将挂起此任务，继续下一个任务；</li>
<li>多个任务抢占锁资源，当前任务没有抢到，被调度器挂起，继续下一个任务；</li>
<li>用户代码挂起当前任务，让出CPU时间；</li>
<li>硬件中断；</li>
</ul>
<p>进程上下文切换的检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># vmstat 1 5</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line">r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">4  0      0 618300    968 246528    0    0    25     3   30   58  0  0 99  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     2   31   44  0  0 100  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     0   28   37  0  1 99  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     0   23   37  0  0 100  0  0</span><br><span class="line">0  0      0 618284    968 246528    0    0     0     0   33   45  0  1 99  0  0</span><br></pre></td></tr></table></figure>
<p><code>bi</code>：block in数量<br><code>bo</code>：block out数量<br><code>in</code>：每称的中断数<br><code>cs</code>：每秒的上下文切换</p>
<p>每个进程每秒刷新输出上下文切换情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># pidstat -w 1 5</span></span><br><span class="line">Linux 3.10.0-514.16.1.el7.x86_64 (student02)    06/06/2017  _x86_64_    (1 CPU)</span><br><span class="line">11:11:08 AM   UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">11:11:09 AM     0         3      2.97      0.00  ksoftirqd/0</span><br><span class="line">11:11:09 AM     0         6      0.99      0.00  kworker/u256:0</span><br><span class="line">11:11:09 AM     0         9      3.96      0.00  rcu_sched</span><br><span class="line">11:11:09 AM     0        10      0.99      0.00  watchdog/0</span><br><span class="line">11:11:09 AM     0        41      3.96      0.00  kworker/0:2</span><br><span class="line">11:11:09 AM     0       400     20.79      0.00  xfsaild/dm-0</span><br><span class="line">11:11:09 AM     0       653      9.90      0.00  vmtoolsd</span><br><span class="line">11:11:09 AM     0      1479      0.99      0.99  pidstat</span><br></pre></td></tr></table></figure>
<p><code>cswch</code>：自愿的上下文切换<br><code>nvcswch</code>：非自愿的上下文切换</p>
<p>看出主机上总的上下文件切换的情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># sar -w 1 5</span></span><br><span class="line">Linux 3.10.0-514.16.1.el7.x86_64 (student02)    06/06/2017  _x86_64_    (1 CPU)</span><br><span class="line">11:21:09 AM    proc/s   cswch/s</span><br><span class="line">11:21:10 AM      0.00     89.00</span><br><span class="line">11:21:11 AM      0.00     87.76</span><br><span class="line">11:21:12 AM      0.00     77.23</span><br><span class="line">11:21:13 AM      0.00     81.82</span><br><span class="line">11:21:14 AM      0.00     86.00</span><br><span class="line">Average:         0.00     84.34</span><br></pre></td></tr></table></figure>

<p>查看具体进程的每秒上下文切换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># grep ctxt /proc/1501/status </span></span><br><span class="line">voluntary_ctxt_switches:    1 <span class="comment">#自愿的上下文切换</span></span><br><span class="line">nonvoluntary_ctxt_switches: 0 <span class="comment">#非自愿的上下文切换</span></span><br></pre></td></tr></table></figure>

<p><code>cswch/s</code>: 每秒任务主动(自愿的)切换上下文的次数，当某一任务处于阻塞等待时，将主动让出自己的CPU资源。<br><code>nvcswch/s</code>: 每秒任务被动(不自愿的)切换上下文的次数，CPU分配给某一任务的时间片已经用完，因此将强迫该进程让出CPU的执行权。</p>
<p>nagios check_mk默认有对上下文的监控，其使用的方法是通过两&#x2F;proc&#x2F;stat文件里取到ctxt行，并取两个时间段之间的差值来确认。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cat /proc/stat|grep ctxt</span></span><br><span class="line">ctxt 397480</span><br></pre></td></tr></table></figure>
<h4 id="7-运行队列"><a href="#7-运行队列" class="headerlink" title="7. 运行队列"></a>7. 运行队列</h4><p>每个CPU有两个运行队列，活动队列和过期队列，正在运行的任务被优先级高的抢占了，这个任务就到了过期队列，活动队列的任务运行完了，就又变成活动队列继续处理，活动队列和过期队列是一直相互交换的</p>
<p>nice的默认优先级区间为-20到19，数字越小，优先级越高<br>优先级有两种，静态优先级和动态优先级，nice是动态优先级，他的-20到19对应100-139，对应的静态优先级都是0</p>
<p>修改nice优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># renice -20 1805</span></span><br><span class="line">1805 (process ID) old priority 0, new priority -20</span><br><span class="line">[root@student02 ~]<span class="comment"># ps axo pid,comm,%cpu,nice |grep vsftpd</span></span><br><span class="line">1805 vsftpd           0.0 -20</span><br></pre></td></tr></table></figure>

<p>进程有三种优先级，f大于r大于o的优先级<br>sched_fifo先进先出，一个任务处理完了才轮到下个任务，一个优先级高的任务来了要先处理，处理完了继续我这个任务<br>sched_rr轮询，每个任务相同的时间，但是优先级高的拥有更多的时间片<br>sched_other其它优先级，nice，renice</p>
<p>给进程设置先进先出优先级，也可以跟命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># chrt -f -p 20 1805</span></span><br></pre></td></tr></table></figure>

<p>给进程设置轮询优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># chrt -r -p 20 1805</span></span><br></pre></td></tr></table></figure>

<h3 id="八、TCP-x2F-IP、Socket参数"><a href="#八、TCP-x2F-IP、Socket参数" class="headerlink" title="八、TCP&#x2F;IP、Socket参数"></a>八、TCP&#x2F;IP、Socket参数</h3><p>所有的TCP&#x2F;IP参数都位于&#x2F;proc&#x2F;sys&#x2F;net目录下，对&#x2F;proc&#x2F;sys&#x2F;net目录下内容的修改都是临时的，需要写到sysctl.conf文件中</p>
<table>
<thead>
<tr>
<th align="left">参数（路径+文件）</th>
<th align="left">描述</th>
<th align="left">默认值</th>
<th align="left">优化值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;rmem_default</td>
<td align="left">默认的TCP数据接收窗口大小（字节）</td>
<td align="left">229376</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;rmem_max</td>
<td align="left">最大的TCP数据接收窗口（字节）</td>
<td align="left">131071</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;wmem_default</td>
<td align="left">默认的TCP数据发送窗口大小（字节）</td>
<td align="left">229376</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;wmem_max</td>
<td align="left">最大的TCP数据发送窗口（字节）</td>
<td align="left">131071</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;netdev_max_backlog</td>
<td align="left">在每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</td>
<td align="left">1000</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn</td>
<td align="left">定义了系统中每一个端口最大的监听队列的长度，这是个全局的参数</td>
<td align="left">128</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;optmem_max</td>
<td align="left">表示每个套接字所允许的最大缓冲区的大小</td>
<td align="left">20480</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_mem</td>
<td align="left">确定TCP栈应该如何反映内存使用，每个值的单位都是内存页（通常是4KB）。第一个值是内存使用的下限；第二个值是内存压力模式开始对缓冲区使用应用压力的上限；第三个值是内存使用的上限。在这个层次上可以将报文丢弃，从而减少对内存的使用。对于较大的BDP可以增大这些值（注意，其单位是内存页而不是字节）</td>
<td align="left">94011  125351  188022</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_rmem</td>
<td align="left">为自动调优定义socket使用的内存。第一个值是为socket接收缓冲区分配的最少字节数；第二个值是默认值（该值会被rmem_default覆盖），缓冲区在系统负载不重的情况下可以增长到这个值；第三个值是接收缓冲区空间的最大字节数（该值会被rmem_max覆盖）</td>
<td align="left">4096  87380  4011232</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_wmem</td>
<td align="left">为自动调优定义socket使用的内存。第一个值是为socket发送缓冲区分配的最少字节数；第二个值是默认值（该值会被wmem_default覆盖），缓冲区在系统负载不重的情况下可以增长到这个值；第三个值是发送缓冲区空间的最大字节数（该值会被wmem_max覆盖）</td>
<td align="left">4096  16384  4011232</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_keepalive_time</td>
<td align="left">TCP发送keepalive探测消息的间隔时间（秒），用于确认TCP连接是否有效</td>
<td align="left">7200</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_keepalive_intvl</td>
<td align="left">探测消息未获得响应时，重发该消息的间隔时间（秒）</td>
<td align="left">75</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_keepalive_probes</td>
<td align="left">在认定TCP连接失效之前，最多发送多少个keepalive探测消息</td>
<td align="left">9</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_sack</td>
<td align="left">启用有选择的应答（1表示启用），通过有选择地应答乱序接收到的报文来提高性能，让发送者只发送丢失的报文段，（对于广域网通信来说）这个选项应该启用，但是会增加对CPU的占用。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_fack</td>
<td align="left">启用转发应答，可以进行有选择应答（SACK）从而减少拥塞情况的发生，这个选项也应该启用。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_timestamps</td>
<td align="left">TCP时间戳（会在TCP包头增加12个字节），以一种比重发超时更精确的方法（参考RFC 1323）来启用对RTT 的计算，为实现更好的性能应该启用这个选项。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_window_scaling</td>
<td align="left">启用RFC 1323定义的window scaling，要支持超过64KB的TCP窗口，必须启用该值（1表示启用），TCP窗口最大至1GB，TCP连接双方都启用时才生效。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_syncookies</td>
<td align="left">表示是否打开TCP同步标签（syncookie），内核必须打开了CONFIG_SYN_COOKIES项进行编译，同步标签可以防止一个套接字在有过多试图连接到达时引起过载。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_reuse</td>
<td align="left">表示是否允许将处于TIME-WAIT状态的socket（TIME-WAIT的端口）用于新的TCP连接 。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_tw_recycle</td>
<td align="left">能够更快地回收TIME-WAIT套接字。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_fin_timeout</td>
<td align="left">对于本端断开的socket连接，TCP保持在FIN-WAIT-2状态的时间（秒）。对方可能会断开连接或一直不结束连接或不可预料的进程死亡。</td>
<td align="left">60</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_local_port_range</td>
<td align="left">表示TCP&#x2F;UDP协议允许使用的本地端口号</td>
<td align="left">32768  61000</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlog</td>
<td align="left">对于还未获得对方确认的连接请求，可保存在队列中的最大数目。如果服务器经常出现过载，可以尝试增加这个数字。</td>
<td align="left">2048</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_low_latency</td>
<td align="left">允许TCP&#x2F;IP栈适应在高吞吐量情况下低延时的情况，这个选项应该禁用。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_westwood</td>
<td align="left">启用发送者端的拥塞控制算法，它可以维护对吞吐量的评估，并试图对带宽的整体利用情况进行优化，对于WAN 通信来说应该启用这个选项。</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_bic</td>
<td align="left">为快速长距离网络启用Binary Increase Congestion，这样可以更好地利用以GB速度进行操作的链接，对于WAN通信应该启用这个选项。</td>
<td align="left">1</td>
<td align="left"></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/regular%E6%AD%A3%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/regular%E6%AD%A3%E5%88%99/" class="post-title-link" itemprop="url">正则表达式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 23:45:00" itemprop="dateCreated datePublished" datetime="2017-07-11T23:45:00+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<ul>
<li>正则表达式的特殊字符包括：*.*[]^${}\+?|()*</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th align="left">字符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">\</td>
<td align="left">对特殊字符转义</td>
</tr>
<tr>
<td align="left">^</td>
<td align="left">以什么字符开头</td>
</tr>
<tr>
<td align="left">$</td>
<td align="left">以什么字符结尾</td>
</tr>
<tr>
<td align="left">.</td>
<td align="left">匹配单个字符</td>
</tr>
<tr>
<td align="left">[ ]</td>
<td align="left">匹配一组字符</td>
</tr>
<tr>
<td align="left">[^ ]</td>
<td align="left">排除字符</td>
</tr>
<tr>
<td align="left">[ - ]</td>
<td align="left">匹配数字、字母的区间范围</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">匹配字符出现0次或多次</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">匹配字符出现0次或1次</td>
</tr>
<tr>
<td align="left">+</td>
<td align="left">匹配字符出现1次或多次</td>
</tr>
<tr>
<td align="left">{ }</td>
<td align="left">具体指定字符出现的次数</td>
</tr>
<tr>
<td align="left">|</td>
<td align="left">符号前后逻辑或</td>
</tr>
</tbody></table>
<ol>
<li><strong>转义字符 \</strong></li>
</ol>
<p>如果要用特殊字符作为文本字符，就必须使用（\）转义。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;3/2&quot;| sed -n &#x27;/\//p&#x27;</span></span><br><span class="line">3/2</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;3/2&quot;| sed -n &#x27;///p&#x27;</span></span><br><span class="line">sed: -e expression <span class="comment">#1, char 3: unknown command: `/&#x27;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>脱字符 ^</strong></li>
</ol>
<p>定义从数据文本行的行首开始的模式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;Books are great&quot; |sed -n &#x27;/^Book/p&#x27;</span></span><br><span class="line">Books are great</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;The book store&quot; |sed -n &#x27;/^book/p&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>美元符 $</strong></li>
</ol>
<p>放在文本模式之后来指明数据行必须以该文本模式结尾。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;This is a good book&quot; |sed -n &#x27;/book$/p&#x27;</span></span><br><span class="line">This is a good book</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;This book is good&quot; |sed -n &#x27;/book$/p&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：脱字符和美元符可以组合使用。<br>4. <strong>点号字符 .</strong></p>
</blockquote>
<p>特殊字符点号用来匹配除换行符之外的任意单个字符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat data.txt </span></span><br><span class="line">This is a <span class="built_in">test</span> of a line.</span><br><span class="line">The <span class="built_in">cat</span> is sleeping.</span><br><span class="line">This <span class="built_in">test</span> is at line four.</span><br><span class="line">at ten o<span class="string">&#x27;clock we&#x27;</span>ll go home.</span><br><span class="line">[root@student01 ~]<span class="comment"># sed -n &#x27;/.at/p&#x27; data.txt </span></span><br><span class="line">The <span class="built_in">cat</span> is sleeping.</span><br><span class="line">This <span class="built_in">test</span> is at line four.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：在正则表达式中，空格也是字符。<br>5. <strong>字符组 [ ]</strong></p>
</blockquote>
<p>定义用来匹配文本模式中某个位置的一组字符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;Yes&quot; |sed -n &#x27;/[Yy][Ee][Ss]/p&#x27;</span></span><br><span class="line">Yes</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;YES&quot; |sed -n &#x27;/[Yy][Ee][Ss]/p&#x27;</span></span><br><span class="line">YES</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><strong>排除型字符组 [^]</strong></li>
</ol>
<p>在正则表达式模式中，也可以反转字符组的作用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;I have a apple&quot; |sed -n     &#x27;/[ab]pple/p&#x27;</span></span><br><span class="line">I have a apple </span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;I have a apple&quot; |sed -n     &#x27;/[^ab]pple/p&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment">#</span></span><br><span class="line">7. **区间   [-]**</span><br><span class="line"></span><br><span class="line">可以用单破折线符号在字符组中表示字符区间。</span><br><span class="line">```bash</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;1234&quot; |sed -n &#x27;/^[0-9][0-9][0-9][0-9]$/p&#x27;</span></span><br><span class="line">1234</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;Abcd&quot; |sed -n &#x27;/^[A-Z][a-z][a-z][a-d]$/p&#x27;</span></span><br><span class="line">Abcd</span><br></pre></td></tr></table></figure>
<p>还可以在单个字符组指定多个不连续的区间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat data.txt </span></span><br><span class="line"><span class="built_in">cat</span></span><br><span class="line">Hat</span><br><span class="line">[root@student01 ~]<span class="comment"># cat data.txt |sed -n &#x27;/^[c-dH-N]/p&#x27;</span></span><br><span class="line"><span class="built_in">cat</span></span><br><span class="line">Hat</span><br></pre></td></tr></table></figure>
<ol start="8">
<li><strong>特殊的字符组</strong></li>
</ol>
<p>基础正则表达式引擎还包含一些特殊的字符组，可用来匹配特定类型的字符。</p>
<table>
<thead>
<tr>
<th align="left">组</th>
<th align="right">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">[[:alpha:]]</td>
<td align="right">匹配任意字母字符，不管是大写还是小写</td>
</tr>
<tr>
<td align="left">[[:alnum:]]</td>
<td align="right">匹配任意字母数字字符0<del>9、A</del>Z或a~z</td>
</tr>
<tr>
<td align="left">[[:blank:]]</td>
<td align="right">匹配空格或制表符</td>
</tr>
<tr>
<td align="left">[[:digit:]]</td>
<td align="right">匹配0~9之间的数字</td>
</tr>
<tr>
<td align="left">[[:lower:]]</td>
<td align="right">匹配小写字母字符a~z</td>
</tr>
<tr>
<td align="left">[[:print:]]</td>
<td align="right">匹配任意可打印字符</td>
</tr>
<tr>
<td align="left">[[:punct:]]</td>
<td align="right">匹配标点符号</td>
</tr>
<tr>
<td align="left">[[: space:]]</td>
<td align="right">匹配任意空白字符：空格、制表符等</td>
</tr>
<tr>
<td align="left">[[:upper:]]</td>
<td align="right">匹配任意大写字母字符A~Z</td>
</tr>
</tbody></table>
<p>可以在正则表达式模式中将特殊字符组像普通字符组一样使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;abc&quot; |sed -n &#x27;/[[:alpha:]]/p&#x27;</span></span><br><span class="line">abc</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;This is, a test&quot; |sed -n     &#x27;/[[:punct:]]/p&#x27;</span></span><br><span class="line">This is, a <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<ol start="9">
<li><strong>星号 *</strong></li>
</ol>
<p>在字符后面放置星号表明该字符必须在匹配模式的文本中出现0次或多次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;ik&quot; |sed -n &#x27;/ie*k/p&#x27;</span></span><br><span class="line">ik</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;ieek&quot; |sed -n &#x27;/ie*k/p&#x27;</span></span><br><span class="line">ieek</span><br></pre></td></tr></table></figure>
<p>将点号特殊字符和星号特殊字符组合起来。这个组合能够匹配任意数量的任意字符。它通常用在数据流中两个可能相邻或不相邻的文本字符串之间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;I am sorry&quot; |sed -n &#x27;/I.*sorry/p&#x27;</span></span><br><span class="line">I am sorry</span><br></pre></td></tr></table></figure>
<p>星号还能用在字符组上。它允许指定可能在文本中出现多次的字符组或字符区间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bt&quot; |sed -n &#x27;/b[ae]*t/p&#x27;</span></span><br><span class="line">bt</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beet&quot; |sed -n &#x27;/b[ae]*t/p&#x27;</span></span><br><span class="line">beet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;btt&quot; |sed -n &#x27;/b[ae]*t/p&#x27;</span></span><br><span class="line">btt</span><br></pre></td></tr></table></figure>
<ol start="10">
<li><strong>问号 ?</strong></li>
</ol>
<p>问号类似于星号，不过有点细微的不同。问号表明前面的字符可以出现0次或1次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bt&quot; |gawk &#x27;/be?t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">bt</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bet&quot; |gawk &#x27;/be?t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">bet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beet&quot; |awk &#x27;/be?t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>与星号一样，你可以将问号和字符组一起使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bt&quot; |awk &#x27;/b[ae]?t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">bt</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bat&quot; |awk &#x27;/b[ae]?t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">bat</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;baet&quot; |awk &#x27;/b[ae]?t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>如果字符组中的字符出现了0次或1次，模式匹配成立。但如果两个字符都出现了，或者其中一个字符出现了2次，模式匹配就不成立。<br>11. <strong>加号 +</strong></p>
<p>加号表明前面的字符可以出现1次或多次，但必须至少出现1次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beet&quot; |awk &#x27;/be+t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">beet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bet&quot; |awk &#x27;/be+t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">bet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bt&quot; |awk &#x27;/be+t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>加号同样适用于字符组.<br>12. <strong>花括号 {}</strong></p>
<p>花括号允许你为可重复的正则表达式指定一个上限，可以用两种格式来指定区间。</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> m：正则表达式准确出现m次。</li>
<li><input checked="" disabled="" type="checkbox"> m, n：正则表达式至少出现m次，至多n次。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beet&quot; |awk &#x27;/be&#123;2&#125;t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">beet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bet&quot; |awk &#x27;/be&#123;2&#125;t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
通过指定间隔为2，限定了该字符在匹配模式的字符串中出现的次数。如果次数为1或者其他都不匹配。<br>也可以同时设置上限和下限<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beet&quot; |awk &#x27;/be&#123;2,3&#125;t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">beet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beeet&quot; |awk &#x27;/be&#123;2,3&#125;t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">beeet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beeeet&quot; |awk &#x27;/be&#123;2,3&#125;t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">[root@student01 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>
间隔模式匹配同样适用于字符组。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;beeet&quot; |awk &#x27;/b[ae]&#123;2,3&#125;t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">beeet</span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;baaat&quot; |awk &#x27;/b[ae]&#123;2,3&#125;t/&#123;print $0&#125;&#x27;</span></span><br><span class="line">baaat</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="13">
<li><strong>管道符号 |</strong></li>
</ol>
<p>管道符号允许你在检查数据流时，用逻辑OR方式指定正则表达式引擎要用的两个或多个模式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;The cat is asleep&quot; |awk &#x27;/cat|dog/&#123;print $0&#125;&#x27;</span></span><br><span class="line">The <span class="built_in">cat</span> is asleep</span><br></pre></td></tr></table></figure>
<p>管道符号两侧的正则表达式可以采用任何正则表达式模式（包括字符组）来定义文本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;The cat is asleep&quot; |awk &#x27;/[ch]at|dog/&#123;print $0&#125;&#x27;</span></span><br><span class="line">The <span class="built_in">cat</span> is asleep</span><br></pre></td></tr></table></figure>
<ol start="14">
<li><strong>表达式分组 ( )</strong></li>
</ol>
<p>正则表达式模式也可以用圆括号进行分组。将分组和管道符号一起使用是常见的做法。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># echo &quot;cat&quot; | gawk &#x27;/(c|b)a(b|t)/&#123;print $0&#125;&#x27;</span></span><br><span class="line"><span class="built_in">cat</span></span><br><span class="line">[root@student01 ~]<span class="comment"># echo &quot;bat&quot; | gawk &#x27;/(c|b)a(b|t)/&#123;print $0&#125;&#x27;</span></span><br><span class="line">bat</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/docker%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/docker%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">docker的安装配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 13:05:20" itemprop="dateCreated datePublished" datetime="2017-07-11T13:05:20+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:55:49" itemprop="dateModified" datetime="2022-12-14T15:55:49+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>容器是linux支持的</p>
<p>容器的隔离</p>
<p><code>chroot</code>：隔离分区<br><code>cgroup</code>：隔离资源（CPU、内存）<br><code>netns</code>：隔离网络<br>namespace<br>ipc</p>
<p>docker安装前提</p>
<p>3.0以后版本的内核</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># uname -r</span></span><br><span class="line">3.10.0-229.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>实验环境</p>
<table>
<thead>
<tr>
<th align="left">docker节点</th>
<th align="left">机器域名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">控制节点</td>
<td align="left">master.pod0.example.com</td>
</tr>
<tr>
<td align="left">计算节点</td>
<td align="left">node.pod0.example.com</td>
</tr>
</tbody></table>
<p>master节点安装docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@foundation0 ~]<span class="comment"># ssh root@master.pod0.example.com</span></span><br><span class="line">[root@master ~]<span class="comment"># yum -y install docker</span></span><br></pre></td></tr></table></figure>

<p>启动docker服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># systemctl enable docker</span></span><br><span class="line">[root@master ~]<span class="comment"># systemctl start docker</span></span><br></pre></td></tr></table></figure>


<p>docker子命令不能tab补齐，安装bash命令补齐工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># yum -y install bash-completion</span></span><br><span class="line">[root@master ~]<span class="comment"># su -</span></span><br><span class="line">[root@master ~]<span class="comment"># docker </span></span><br><span class="line">attach   commit   create   events   <span class="built_in">export</span>   <span class="built_in">history</span>  import   inspect  load     <span class="built_in">logout</span>   pause    ps       push     restart  rmi      save     start    stop     top      version  </span><br><span class="line">build    <span class="built_in">cp</span>       diff     <span class="built_in">exec</span>     <span class="built_in">help</span>     images   info     <span class="built_in">kill</span>     login    logs     port     pull     rename   <span class="built_in">rm</span>       run      search   stats    tag      unpause  <span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<p>查看docker版本,docker是使用go语言写的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker version</span></span><br><span class="line">Client version: 1.7.1</span><br><span class="line">Client API version: 1.19</span><br><span class="line">Package Version (client): docker-1.7.1-108.el7.x86_64</span><br><span class="line">Go version (client): go1.4.2</span><br><span class="line">Git commit (client): 3043001/1.7.1</span><br><span class="line">OS/Arch (client): linux/amd64</span><br><span class="line">Server version: 1.7.1</span><br><span class="line">Server API version: 1.19</span><br><span class="line">Package Version (server): docker-1.7.1-108.el7.x86_64</span><br><span class="line">Go version (server): go1.4.2</span><br><span class="line">Git commit (server): 3043001/1.7.1</span><br><span class="line">OS/Arch (server): linux/amd64</span><br></pre></td></tr></table></figure>

<p>容器和镜像</p>
<p>需要先有镜像，docker所有的镜像都是分层的tar包，分层利于二次修改，底层镜像尽量使用厂商的镜像</p>
<p>镜像启动之后就是容器</p>
<p>docker的配置文件中修改docker仓库的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># vim /etc/sysconfig/docker</span></span><br><span class="line">ADD_REGISTRY=<span class="string">&#x27;--add-registry workstation.pod0.example.com:5000&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在不使用证书加密的情况下，加入信任的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSECURE_REGISTRY=<span class="string">&#x27;--insecure-registry workstation.pod0.example.com:5000&#x27;</span></span><br></pre></td></tr></table></figure>

<p>把docker官网加入黑名单，不到docker官网搜索镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BLOCK_REGISTRY=<span class="string">&#x27;--block-registry docker.io&#x27;</span></span><br></pre></td></tr></table></figure>

<p>修改配置文件后重启生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<p>docker搜索镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker search rhel7</span></span><br><span class="line">INDEX         NAME                                                            DESCRIPTION   STARS     OFFICIAL   AUTOMATED</span><br><span class="line">example.com   workstation.pod0.example.com:5000/library/rhel7                               0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/mysql-55-rhel7                   0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/nodejs-010-rhel7                 0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/php-55-rhel7                     0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/ruby-20-rhel7                    0</span><br></pre></td></tr></table></figure>

<p>下载rhel7镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker pull rhel7</span></span><br></pre></td></tr></table></figure>

<p>查看本地镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">workstation.pod0.example.com:5000/rhel7   latest              275be1d3d070        22 months ago       158.3 MB</span><br></pre></td></tr></table></figure>
<p>docker的工作目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cd /var/lib/docker/</span></span><br><span class="line">[root@master docker]<span class="comment"># ls</span></span><br><span class="line">containers  devicemapper  graph  init  linkgraph.db  repositories-devicemapper  tmp  trust  volumes</span><br></pre></td></tr></table></figure>

<p>docker启动后的临时文件在containers目录中</p>
<p>运行rhel7镜像，打开bash服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker run -it rhel7 bash</span></span><br><span class="line">Usage of loopback devices is strongly discouraged <span class="keyword">for</span> production use. Either use `--storage-opt dm.thinpooldev` or u</span><br><span class="line">se `--storage-opt dm.no_warn_on_loop_devices=<span class="literal">true</span>` to suppress this warning.</span><br><span class="line">[root@48632bcb1e45 /]<span class="comment"># ls</span></span><br><span class="line">bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure>

<p><code>-i</code>：交互式界面<br><code>-t</code>：打开一个命令行终端<br><code>-d</code>：启动后放到后台运行</p>
<p>发现容器是一个独立的系统，有自己的根分区</p>
<p>查看启动的容器任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">7b34f87319b2        rhel7               <span class="string">&quot;bash&quot;</span>              2 minutes ago       Up About a minute                       adoring_hoover</span><br></pre></td></tr></table></figure>

<p>查看容器的进程列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker top 7b34f87319b2</span></span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                1044                711                 0                   09:22               pts/2               00:00:00            bash</span><br></pre></td></tr></table></figure>

<p>持久化存储需要挂载外部存储设备</p>
<p>停止和启动docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker stop 7b34f87319b2</span></span><br><span class="line">7b34f87319b2</span><br><span class="line">[root@master ~]<span class="comment"># docker start 7b34f87319b2</span></span><br><span class="line">7b34f87319b2</span><br></pre></td></tr></table></figure>

<p>下载hello-openshift镜像,镜像里面有一个8080端口的jboss服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker search hello</span></span><br><span class="line">INDEX         NAME                                                          DESCRIPTION   STARS     OFFICIAL   AUTOMATED</span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift/hello-openshift                 0 </span><br><span class="line">[root@master ~]<span class="comment"># docker pull openshift/hello-openshift</span></span><br></pre></td></tr></table></figure>

<p>启动hello-openshift镜像，把容器的8080端口映射到物理机的18080端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker run -p 18080:8080 openshift/hello-openshift</span></span><br><span class="line">Usage of loopback devices is strongly discouraged <span class="keyword">for</span> production use. Either use `--storage-opt dm.thinpooldev` or use `--storage-opt dm.no_warn_</span><br><span class="line">on_loop_devices=<span class="literal">true</span>` to suppress this warning.</span><br><span class="line">serving on 8080</span><br><span class="line">serving on 8888</span><br></pre></td></tr></table></figure>

<p>查看容器启动的进程，可以看到状况映射的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND              CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">7ed43f0360a5        openshift/hello-openshift   <span class="string">&quot;/hello-openshift&quot;</span>   3 minutes ago       Up 3 minutes        8888/tcp, 0.0.0.0:18080-&gt;8080/tcp   clever_sinoussi</span><br></pre></td></tr></table></figure>

<p>查看容器的所有信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker inspect 7ed43f0360a5</span></span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;Id&quot;</span>: <span class="string">&quot;7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4&quot;</span>,</span><br><span class="line"><span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2017-06-12T02:37:32.33856856Z&quot;</span>,</span><br><span class="line"><span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/hello-openshift&quot;</span>,</span><br><span class="line"><span class="string">&quot;Args&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Running&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;Paused&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Restarting&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;OOMKilled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Dead&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Pid&quot;</span>: 1414,</span><br><span class="line"><span class="string">&quot;ExitCode&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2017-06-12T02:37:33.008916483Z&quot;</span>,</span><br><span class="line"><span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Image&quot;</span>: <span class="string">&quot;0f7a086fa28fd211eb84e4b88c3aadca2eabb3dc02eba94bd4e5efaf2ba65ee5&quot;</span>,</span><br><span class="line"><span class="string">&quot;NetworkSettings&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Bridge&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;dfb34bb05f5e8b49a339e7403d210910ecef129c9962421fda1d48eb0c548c37&quot;</span>,</span><br><span class="line"><span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.42.1&quot;</span>,</span><br><span class="line"><span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;HairpinMode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.3&quot;</span>,</span><br><span class="line"><span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line"><span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;LinkLocalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;LinkLocalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line"><span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;ad45105bbd0e776c6770a2c3587049f033ed0bb7c05c9eacf6fddafa230478e7&quot;</span>,</span><br><span class="line"><span class="string">&quot;PortMapping&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Ports&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;8080/tcp&quot;</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;18080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;8888/tcp&quot;</span>: null</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;SandboxKey&quot;</span>: <span class="string">&quot;/var/run/docker/netns/7ed43f0360a5&quot;</span>,</span><br><span class="line"><span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;SecondaryIPv6Addresses&quot;</span>: null</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;ResolvConfPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/resolv.conf&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostnamePath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/hostname&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostsPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/hosts&quot;</span>,</span><br><span class="line"><span class="string">&quot;LogPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1</span></span><br><span class="line"><span class="string">cc3adb5a4e4-json.log&quot;</span>,    <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;/clever_sinoussi&quot;</span>,</span><br><span class="line"><span class="string">&quot;RestartCount&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;devicemapper&quot;</span>,</span><br><span class="line"><span class="string">&quot;ExecDriver&quot;</span>: <span class="string">&quot;native-0.2&quot;</span>,</span><br><span class="line"><span class="string">&quot;MountLabel&quot;</span>: <span class="string">&quot;system_u:object_r:svirt_sandbox_file_t:s0:c882,c888&quot;</span>,</span><br><span class="line"><span class="string">&quot;ProcessLabel&quot;</span>: <span class="string">&quot;system_u:system_r:svirt_lxc_net_t:s0:c882,c888&quot;</span>,</span><br><span class="line"><span class="string">&quot;Volumes&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;VolumesRW&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;AppArmorProfile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;ExecIDs&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;HostConfig&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Binds&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ContainerIDFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;LxcConf&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;Memory&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;MemorySwap&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;CpuShares&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;CpuPeriod&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;CpusetCpus&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;CpusetMems&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;CpuQuota&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;BlkioWeight&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;OomKillDisable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Privileged&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;PortBindings&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;8080/tcp&quot;</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;18080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;PublishAllPorts&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Dns&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;DnsSearch&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ExtraHosts&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;VolumesFrom&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Devices&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;NetworkMode&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line"><span class="string">&quot;IpcMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;PidMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;UTSMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;CapAdd&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;CapDrop&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;RestartPolicy&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Name&quot;</span>: <span class="string">&quot;no&quot;</span>,</span><br><span class="line"><span class="string">&quot;MaximumRetryCount&quot;</span>: 0</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;SecurityOpt&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ReadonlyRootfs&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Ulimits&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;LogConfig&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Type&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line"><span class="string">&quot;Config&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;CgroupParent&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;7ed43f0360a5&quot;</span>,</span><br><span class="line"><span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;PortSpecs&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;8080/tcp&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;8888/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Env&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Cmd&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Image&quot;</span>: <span class="string">&quot;openshift/hello-openshift&quot;</span>,</span><br><span class="line"><span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;VolumeDriver&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;Entrypoint&quot;</span>: [</span><br><span class="line"><span class="string">&quot;/hello-openshift&quot;</span></span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;NetworkDisabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;Init&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>从容器的信息中查找容器的ip地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker inspect 7ed43f0360a5 |grep -iw ipaddress</span></span><br><span class="line"><span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.3&quot;</span>,</span><br></pre></td></tr></table></figure>

<p>访问容器里面的服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># curl http://172.17.0.3:8080</span></span><br><span class="line">Hello OpenShift!</span><br></pre></td></tr></table></figure>

<p>安装完docker后自动生成一个docker的虚拟网卡，相当于一个虚拟交换机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># ifconfig docker0</span></span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">inet 172.17.42.1  netmask 255.255.0.0  broadcast 0.0.0.0</span><br><span class="line">inet6 fe80::5484:7aff:fefe:9799  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">ether 56:84:7a:fe:97:99  txqueuelen 0  (Ethernet)</span><br><span class="line">RX packets 27  bytes 1810 (1.7 KiB)</span><br><span class="line">RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">TX packets 16  bytes 1247 (1.2 KiB)</span><br><span class="line">TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

<p>访问本机的18080端口效果是一样的，这就是docker端口映射</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># curl http://master.pod0.example.com:18080</span></span><br><span class="line">Hello OpenShift!</span><br></pre></td></tr></table></figure>

<p>查看所有的容器，包含停止运行的容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                      PORTS               NAMES</span><br><span class="line">7b34f87319b2        rhel7               <span class="string">&quot;bash&quot;</span>              14 hours ago        Exited (137) 12 hours ago                       adoring_hoover</span><br></pre></td></tr></table></figure>

<p>删除容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker stop 16cf4aa41625</span></span><br><span class="line">16cf4aa41625</span><br><span class="line">[root@master ~]<span class="comment"># docker rm 16cf4aa41625</span></span><br><span class="line">16cf4aa41625</span><br></pre></td></tr></table></figure>

<p>删除镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                                                    TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">workstation.pod0.example.com:5000/openshift/hello-openshift   latest              0f7a086fa28f        22 months ago       5.77 MB</span><br><span class="line">workstation.pod0.example.com:5000/rhel7                       latest              275be1d3d070        22 months ago       158.3 MB</span><br><span class="line">[root@master ~]<span class="comment"># docker rmi 0f7a086fa28f</span></span><br><span class="line">Untagged: workstation.pod0.example.com:5000/openshift/hello-openshift:latest</span><br><span class="line">Deleted: 0f7a086fa28fd211eb84e4b88c3aadca2eabb3dc02eba94bd4e5efaf2ba65ee5</span><br><span class="line">Deleted: 0b3f61faa394f34f8444abf70ffc3ffe52fd913bd58cdc2a3de7366b007e7d73</span><br><span class="line">Deleted: 77bb0f21469da7badd05d18664260c33d7e2fc81766715c3aac3f2d0e5e93ad0</span><br><span class="line">Deleted: 66849f7009a5237fb9651fa489555256b15a0df0415d9927fe828345804bbe2c</span><br></pre></td></tr></table></figure>

<p>把下载的镜像标准输出到tar包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker save 0f7a086fa28f &gt; hello-openshift.tar</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="keemozhang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">keemozhang</p>
  <div class="site-description" itemprop="description">人的一切痛苦，本质上都是对自己的无能的愤怒。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">keemozhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
