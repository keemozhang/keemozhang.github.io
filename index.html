<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"keemozhang.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
<meta property="og:type" content="website">
<meta property="og:title" content="keemozhang blog">
<meta property="og:url" content="https://keemozhang.com/index.html">
<meta property="og:site_name" content="keemozhang blog">
<meta property="og:description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
<meta property="og:locale">
<meta property="article:author" content="keemozhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://keemozhang.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>keemozhang blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">keemozhang blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2020/01/06/kafka%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/06/kafka%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">kafka的基本命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-06 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-06T00:00:00+08:00">2020-01-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 15:58:11" itemprop="dateModified" datetime="2022-12-14T15:58:11+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kafka的基本命令"><a href="#kafka的基本命令" class="headerlink" title="kafka的基本命令"></a>kafka的基本命令</h1><p><strong>Kafka</strong>是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者规模的网站中的所有动作流数据。</p>
<hr>
<h2 id="基本命令使用"><a href="#基本命令使用" class="headerlink" title="基本命令使用"></a>基本命令使用</h2><h3 id="列出所有可用的topic"><a href="#列出所有可用的topic" class="headerlink" title="列出所有可用的topic"></a>列出所有可用的topic</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --list --zookeeper 172.20.40.51:2181</span><br></pre></td></tr></table></figure>

<h3 id="新建topic命令"><a href="#新建topic命令" class="headerlink" title="新建topic命令"></a>新建topic命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh -zookeeper 172.20.40.51:2181 -topic seclogs -replication-factor 1 -partitions 3 -create</span><br></pre></td></tr></table></figure>
<h3 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a>删除topic</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --delete --zookeeper 172.20.40.51:2181 --topic seclogs</span><br></pre></td></tr></table></figure>

<h3 id="查看kafka数据"><a href="#查看kafka数据" class="headerlink" title="查看kafka数据"></a>查看kafka数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --broker-info --group yunwei-logstash --topic seclogs --zookeeper 172.20.40.51:2181</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2019/11/21/%E5%89%8D%E7%AB%AF%E4%B8%89%E7%A7%8D%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/21/%E5%89%8D%E7%AB%AF%E4%B8%89%E7%A7%8D%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">前端三种路由配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-21 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-21T00:00:00+08:00">2019-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:02:39" itemprop="dateModified" datetime="2022-12-14T16:02:39+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前端三种路由配置"><a href="#前端三种路由配置" class="headerlink" title="前端三种路由配置"></a>前端三种路由配置</h3><ul>
<li><p>第一种</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /anti-fraud &#123;</span><br><span class="line">    <span class="built_in">alias</span> /opt/welab/anti-fraud;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">    error_page 404 /anti-fraud/index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /financial-life &#123;</span><br><span class="line">    rewrite /financial-life/(.+) /<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line">    root /opt/welab/financial-life;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三种</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /sjd &#123;</span><br><span class="line">    <span class="built_in">alias</span> /opt/welab/sjd;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">    try_files <span class="variable">$uri</span> /sjd/login /sjd/main.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>跨域配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add_header Access-Control-Allow-Origin *;</span><br><span class="line">add_header Access-Control-Allow-Headers content-type,x-user-token;</span><br><span class="line">add_header Access-Control-Allow-Methods GET,POST;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2019/07/12/python%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/12/python%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">python学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-12 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-12T00:00:00+08:00">2019-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:09:27" itemprop="dateModified" datetime="2022-12-14T16:09:27+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="python学习笔记"><a href="#python学习笔记" class="headerlink" title="python学习笔记"></a>python学习笔记</h3><p>[toc]</p>
<h4 id="推导式"><a href="#推导式" class="headerlink" title="推导式"></a>推导式</h4><blockquote>
<p>推导式是从一个或者多个迭代器快速简洁地创建数据结构的一种方法。它可以将循环和条件判断结合，从而避免语法冗长的代码。</p>
</blockquote>
<h5 id="列表推导式"><a href="#列表推导式" class="headerlink" title="列表推导式"></a>列表推导式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">number_list = [number <span class="keyword">for</span> number <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>) <span class="keyword">if</span> number % <span class="number">2</span> == <span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(number_list)</span><br><span class="line">[<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>]</span><br></pre></td></tr></table></figure>

<h5 id="字典推导式"><a href="#字典推导式" class="headerlink" title="字典推导式"></a>字典推导式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">word = <span class="string">&#x27;letters&#x27;</span></span><br><span class="line">letter_counts = &#123;letter:word.count(letter) <span class="keyword">for</span> letter <span class="keyword">in</span> <span class="built_in">set</span>(word)&#125;</span><br><span class="line"><span class="built_in">print</span>(letter_counts)</span><br><span class="line">&#123;<span class="string">&#x27;t&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;l&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;e&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;r&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;s&#x27;</span>: <span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="集合推导式"><a href="#集合推导式" class="headerlink" title="集合推导式"></a>集合推导式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a_set = &#123;number <span class="keyword">for</span> number <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>) <span class="keyword">if</span> number % <span class="number">3</span> == <span class="number">1</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(a_set)</span><br><span class="line">&#123;<span class="number">1</span>, <span class="number">4</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="生成器函数"><a href="#生成器函数" class="headerlink" title="生成器函数"></a>生成器函数</h5><blockquote>
<p> 生成器函数：函数体含有yield关键字，生成器就是迭代器</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h4><blockquote>
<p>装饰器的功能是在不修改被装饰对象源代码以及调用方式的前提下，为其添加新功能。</p>
</blockquote>
<ul>
<li>res是一个用户密码认证的装饰器，index要运行的函数，用装饰器扩展功能后，运行index可以增加用户认证的功能。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">user_dit=&#123;</span><br><span class="line">    <span class="string">&#x27;user01&#x27;</span>:<span class="string">&#x27;python01&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;user02&#x27;</span>:<span class="string">&#x27;python02&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;user03&#x27;</span>:<span class="string">&#x27;python03&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">login_status = &#123;</span><br><span class="line">    <span class="string">&#x27;user&#x27;</span>:<span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;login&#x27;</span>:<span class="literal">False</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;auth_info.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.seek(<span class="number">0</span>)</span><br><span class="line">    f.truncate()</span><br><span class="line">    f.write(<span class="built_in">str</span>(user_dit))</span><br><span class="line"></span><br><span class="line">db_file = <span class="string">&#x27;auth_info.txt&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">res</span>(<span class="params">app</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">auth</span>(<span class="params">*args,**kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> login_status[<span class="string">&#x27;user&#x27;</span>] <span class="keyword">and</span> login_status[<span class="string">&#x27;login&#x27;</span>] :</span><br><span class="line">            user_name = login_status[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">            app(user_name, **kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user_name = <span class="built_in">input</span>(<span class="string">&#x27;user name: &#x27;</span>)</span><br><span class="line">            user_passwd = <span class="built_in">input</span>(<span class="string">&#x27;user passwd: &#x27;</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(db_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f_out = <span class="built_in">eval</span>(f.read())</span><br><span class="line">            <span class="keyword">if</span> user_name <span class="keyword">in</span>  f_out <span class="keyword">and</span> user_passwd == f_out[user_name]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;login seccess&#x27;</span>)</span><br><span class="line">                login_status[<span class="string">&#x27;user&#x27;</span>] =  user_name</span><br><span class="line">                login_status[<span class="string">&#x27;login&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                app(user_name,**kwargs)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;username or passwd error&#x27;</span>)</span><br><span class="line">                sys.exit()</span><br><span class="line">    <span class="keyword">return</span> auth</span><br><span class="line"></span><br><span class="line"><span class="meta">@res </span><span class="comment"># index = res(index)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">user_name,**kwargs</span>):</span><br><span class="line">    time.sleep(random.randrange(<span class="number">1</span>,<span class="number">5</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;welecome to %s index page!&#x27;</span> %user_name)</span><br><span class="line"></span><br><span class="line">index()</span><br><span class="line"></span><br><span class="line">index() <span class="comment"># 第一次登录成功后，后面再次操作不需要输入密码</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = [ num <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>) ]</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><blockquote>
<p> 函数体内包含yield关键字，运行时遇到yield暂停完成一次迭代，生成器就是迭代器。</p>
</blockquote>
<h5 id="生成器模拟linux命令"><a href="#生成器模拟linux命令" class="headerlink" title="生成器模拟linux命令"></a>生成器模拟linux命令</h5><blockquote>
<p><code>tail -f filename | grep word</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tail</span>(<span class="params">file_name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.seek(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            line = f.readline()</span><br><span class="line">            <span class="keyword">if</span> line:</span><br><span class="line">                <span class="keyword">yield</span> line</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">grep</span>(<span class="params">lines,word</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> word <span class="keyword">in</span> i:</span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">g = tail(<span class="string">&#x27;a.txt&#x27;</span>)</span><br><span class="line">grep(g,<span class="string">&#x27;error&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = (number <span class="keyword">for</span> number <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>) <span class="keyword">if</span> number % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>

<h5 id="表达式形式的yield"><a href="#表达式形式的yield" class="headerlink" title="表达式形式的yield"></a>表达式形式的yield</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">res</span>(<span class="params">*args,**kwargs</span>):</span><br><span class="line">        g = func(*args,**kwargs)</span><br><span class="line">        <span class="built_in">next</span>(g)</span><br><span class="line">        <span class="keyword">return</span> g</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">init</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = <span class="keyword">yield</span></span><br><span class="line">        <span class="built_in">print</span>(x)</span><br><span class="line"></span><br><span class="line">g = foo()</span><br></pre></td></tr></table></figure>

<h4 id="三元表达式"><a href="#三元表达式" class="headerlink" title="三元表达式"></a>三元表达式</h4><blockquote>
<p>可以缩写if判断</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">max</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="comment"># if x &gt; y:</span></span><br><span class="line">    <span class="comment">#     return x</span></span><br><span class="line">    <span class="comment"># else:</span></span><br><span class="line">    <span class="comment">#     return y</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  x <span class="keyword">if</span> x &gt; y <span class="keyword">else</span> y</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(<span class="number">1</span>,<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<h4 id="匿名函数lambda"><a href="#匿名函数lambda" class="headerlink" title="匿名函数lambda"></a>匿名函数lambda</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = <span class="keyword">lambda</span> x,y:x*y</span><br><span class="line"><span class="built_in">print</span>(res(<span class="number">2</span>,<span class="number">3</span>))</span><br></pre></td></tr></table></figure>

<h4 id="递归调用"><a href="#递归调用" class="headerlink" title="递归调用"></a>递归调用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">18</span></span><br><span class="line">    <span class="keyword">return</span> age(n+<span class="number">1</span>)+<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(age(<span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<h4 id="爬虫工具"><a href="#爬虫工具" class="headerlink" title="爬虫工具"></a>爬虫工具</h4><h5 id="selenium"><a href="#selenium" class="headerlink" title="selenium"></a>selenium</h5><blockquote>
<p><code>pip install selenium</code>安装，需要下载chrome驱动。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> selenium</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">driver = webdriver.Chrome()</span><br><span class="line">driver.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(driver.page_source)</span><br></pre></td></tr></table></figure>

<h5 id="phantomjs"><a href="#phantomjs" class="headerlink" title="phantomjs"></a>phantomjs</h5><blockquote>
<p><a target="_blank" rel="noopener" href="http://phantomjs.org/download.html">phantomjs下载页</a>，不需要打开浏览器，静默爬虫。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> selenium</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">driver = webdriver.PhantomJS()</span><br><span class="line">driver.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(driver.page_source)</span><br></pre></td></tr></table></figure>

<h5 id="pyquery"><a href="#pyquery" class="headerlink" title="pyquery"></a>pyquery</h5><blockquote>
<p><code>pip install pyquery</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line">doc = pq(<span class="string">&#x27;&lt;html&gt;Hello World!&lt;/html&gt;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(doc(<span class="string">&#x27;html&#x27;</span>).text())</span><br></pre></td></tr></table></figure>

<h5 id="jupyter"><a href="#jupyter" class="headerlink" title="jupyter"></a>jupyter</h5><blockquote>
<p>可以web运行python命令，写笔记。</p>
</blockquote>
<h4 id="命令行传参"><a href="#命令行传参" class="headerlink" title="命令行传参"></a>命令行传参</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Program agruments: &#x27;</span>,sys.argv)</span><br></pre></td></tr></table></figure>

<h4 id="正则re"><a href="#正则re" class="headerlink" title="正则re"></a>正则re</h4><h5 id="查找findall"><a href="#查找findall" class="headerlink" title="查找findall"></a>查找<code>findall</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">r = re.<span class="built_in">compile</span>(<span class="string">&quot;a\d&quot;</span>)</span><br><span class="line">res = r.findall(<span class="string">&quot;a1,ab&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="分组"><a href="#分组" class="headerlink" title="分组( )"></a>分组( )</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">r = re.<span class="built_in">compile</span>(<span class="string">&quot;(?P&lt;year&gt;20[0|1]\d)-(?P&lt;month&gt;\d&#123;1,2&#125;)&quot;</span>)</span><br><span class="line">res = r.search(<span class="string">&quot;2018-03&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res.group(<span class="string">&quot;year&quot;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="爬虫豆瓣电影排名"><a href="#爬虫豆瓣电影排名" class="headerlink" title="爬虫豆瓣电影排名"></a>爬虫豆瓣电影排名</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getpage</span>():</span><br><span class="line">    res = requests.get(<span class="string">&quot;https://movie.douban.com/top250?start=25&amp;filter=&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> res.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    ret = getpage()</span><br><span class="line">    r = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;div class=&quot;item&quot;&gt;.*?&lt;em.*?&gt;(\d+)&lt;/em&gt;?.*?&lt;div class=&quot;info&quot;&gt;.*?&lt;span class=&quot;title&quot;&gt;(.*?)&lt;/span&gt;?.*?&lt;div class=&quot;star&quot;&gt;.*?&lt;span&gt;(\d+)人评价&lt;/span&gt;&#x27;</span>,re.S)</span><br><span class="line">    res = r.findall(ret)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> res:</span><br><span class="line">        <span class="built_in">print</span>(item)</span><br><span class="line"></span><br><span class="line">run()</span><br></pre></td></tr></table></figure>

<h4 id="configparser模块（ini文件）"><a href="#configparser模块（ini文件）" class="headerlink" title="configparser模块（ini文件）"></a><code>configparser</code>模块（ini文件）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"></span><br><span class="line">cfg = configparser.ConfigParser()</span><br><span class="line"><span class="comment"># DEFAULT全局配置</span></span><br><span class="line">cfg[<span class="string">&quot;DEFAULT&quot;</span>] = &#123;<span class="string">&quot;Access&quot;</span>:<span class="string">&quot;ReadWrite&quot;</span>,<span class="string">&quot;Connect&quot;</span>:<span class="string">&quot;DSN=AdvWorks&quot;</span>&#125;</span><br><span class="line">cfg[<span class="string">&quot;USER&quot;</span>] = &#123;<span class="string">&quot;Name&quot;</span>:<span class="string">&quot;User&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;cfg.ini&quot;</span>,<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cfg.write(f)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"></span><br><span class="line">cfg = configparser.ConfigParser()</span><br><span class="line">cfg.read(<span class="string">&quot;cfg.ini&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cfg[<span class="string">&quot;DEFAULT&quot;</span>][<span class="string">&quot;Access&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(cfg.items(<span class="string">&quot;USER&quot;</span>))</span><br></pre></td></tr></table></figure>

<h4 id="subprocess模块（子进程执行linux命令）"><a href="#subprocess模块（子进程执行linux命令）" class="headerlink" title="subprocess模块（子进程执行linux命令）"></a><code>subprocess</code>模块（子进程执行linux命令）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">s = subprocess.Popen(<span class="string">&quot;dir&quot;</span>,shell=<span class="literal">True</span>)</span><br><span class="line">s.wait()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ending&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">s = subprocess.Popen(<span class="string">&quot;dir&quot;</span>,shell=<span class="literal">True</span>,stdout=subprocess.PIPE)</span><br><span class="line"><span class="built_in">print</span>(s.stdout.read().decode(<span class="string">&quot;gbk&quot;</span>))</span><br></pre></td></tr></table></figure>

<h4 id="class，-init-方法"><a href="#class，-init-方法" class="headerlink" title="class，__init__方法"></a>class，<code>__init__</code>方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Chinese</span>:</span><br><span class="line">    country = <span class="string">&quot;china&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">work</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;work&quot;</span>)</span><br><span class="line"></span><br><span class="line">p1 = Chinese(<span class="string">&quot;user01&quot;</span>,<span class="string">&quot;22&quot;</span>)</span><br><span class="line">p2 = Chinese(<span class="string">&quot;user02&quot;</span>,<span class="string">&quot;23&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="pyhton代码规范检查"><a href="#pyhton代码规范检查" class="headerlink" title="pyhton代码规范检查"></a>pyhton代码规范检查</h4><h5 id="pycodestyle检查代码是否符合pep-8规范"><a href="#pycodestyle检查代码是否符合pep-8规范" class="headerlink" title="pycodestyle检查代码是否符合pep 8规范"></a>pycodestyle检查代码是否符合pep 8规范</h5><blockquote>
<p>python官方提供了检查pep8代码规范的命令行工具pycodestyle，改工具可以检查python代码是否违反pep 8规范，并对违反的地方给出提示。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pip install pycodestyle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对python代码检查并打印检查报告</span></span><br><span class="line">pycodestyle --first test.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># --show-source显示不规范的源码</span></span><br><span class="line">pycodestyle --show-source --show-pep8 test.py</span><br></pre></td></tr></table></figure>

<h5 id="使用autopep8将代码格式化"><a href="#使用autopep8将代码格式化" class="headerlink" title="使用autopep8将代码格式化"></a>使用autopep8将代码格式化</h5><blockquote>
<p>autopep8是一个开源的命令行工具，他能够将python代码自动格式化为pep8风格。autopep8使用pycodestyle来决定哪部分代码需要格式化。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install autopep8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码自动格式化pep8规范</span></span><br><span class="line">autopep8 --<span class="keyword">in</span>-place test.py</span><br></pre></td></tr></table></figure>

<h4 id="读取标准输出"><a href="#读取标准输出" class="headerlink" title="读取标准输出"></a>读取标准输出</h4><p><code>cat fileinput.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fileinput</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> fileinput.<span class="built_in">input</span>():</span><br><span class="line">    <span class="built_in">print</span>(line, end=<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fileinput.py /etc/passwd /etc/hosts</span><br></pre></td></tr></table></figure>

<h4 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h4><blockquote>
<p>继承是创建新的类的一种方式，继承可以减少重复代码。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">people</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">walk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s is walking&#x27;</span> %self.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">teacher</span>(<span class="title class_ inherited__">people</span>):</span><br><span class="line">    school = <span class="string">&quot;abc&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age,sex</span>):</span><br><span class="line">        people.__init__(self,name,age)</span><br><span class="line">        self.sex = sex</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">teach</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s is teaching&#x27;</span> %self.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">student</span>(<span class="title class_ inherited__">people</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age,level</span>):</span><br><span class="line">        people.__init__(self,name,age)</span><br><span class="line">        self.level = level</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">study</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s is studying&#x27;</span> %self.name)</span><br><span class="line"></span><br><span class="line">t = teacher(<span class="string">&#x27;egon&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;man&#x27;</span>) <span class="comment"># 实例化</span></span><br><span class="line"><span class="built_in">print</span>(t.name,t.age,t.school,t.sex)</span><br></pre></td></tr></table></figure>

<h6 id="super"><a href="#super" class="headerlink" title="super"></a>super</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">people</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">walk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s is walking&#x27;</span> %self.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">teacher</span>(<span class="title class_ inherited__">people</span>):</span><br><span class="line">    school = <span class="string">&quot;abc&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age,sex</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name,age)</span><br><span class="line">        self.sex = sex</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">teach</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s is teaching&#x27;</span> %self.name)</span><br><span class="line"></span><br><span class="line">t = teacher(<span class="string">&#x27;egon&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;man&#x27;</span>) <span class="comment"># 实例化</span></span><br><span class="line"><span class="built_in">print</span>(t.name,t.age,t.school,t.sex)</span><br></pre></td></tr></table></figure>

<h4 id="类的组合"><a href="#类的组合" class="headerlink" title="类的组合"></a>类的组合</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">date</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,year,mon,day</span>):</span><br><span class="line">        self.year = year</span><br><span class="line">        self.mon = mon</span><br><span class="line">        self.day = day</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">tell_date</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;今天的日期是：%s年-%s月-%s日&#x27;</span> %(self.year,self.mon,self.day))</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">teacher</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age,year,mon,day</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        self.date = date(year,mon,day)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">teach</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; is teaching&#x27;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line"></span><br><span class="line">t = teacher(<span class="string">&#x27;user01&#x27;</span>,<span class="number">18</span>,<span class="number">2018</span>,<span class="number">22</span>,<span class="number">12</span>)</span><br><span class="line"><span class="built_in">print</span>(t.name,t.age,t.date.year,t.date.mon,t.date.day)</span><br></pre></td></tr></table></figure>

<h4 id="归一化接口"><a href="#归一化接口" class="headerlink" title="归一化接口"></a>归一化接口</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>(metaclass=abc.ABCMeta):</span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">talk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">people</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">talk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;say hello&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">talk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;wang wang wang&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d = dog()</span><br><span class="line">d.talk()</span><br></pre></td></tr></table></figure>

<h4 id="绑定方法与非绑定方法"><a href="#绑定方法与非绑定方法" class="headerlink" title="绑定方法与非绑定方法"></a>绑定方法与非绑定方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>(metaclass=abc.ABCMeta):</span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">talk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">people</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">talk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;say hello&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;say func&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sum</span>(<span class="params">x,y</span>):</span><br><span class="line">        <span class="built_in">print</span>(x+y)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定到函数的方法</span></span><br><span class="line">p = people()</span><br><span class="line">p.talk()</span><br><span class="line"><span class="comment"># 绑定到类的方法</span></span><br><span class="line">people.func()</span><br><span class="line"><span class="comment"># 非绑定方法</span></span><br><span class="line">people.<span class="built_in">sum</span>(<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h4 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h4><h5 id="hasattr查看对象是否有某个属性"><a href="#hasattr查看对象是否有某个属性" class="headerlink" title="hasattr查看对象是否有某个属性"></a><code>hasattr</code>查看对象是否有某个属性</h5><h5 id="getattr查看对象某个属性的值"><a href="#getattr查看对象某个属性的值" class="headerlink" title="getattr查看对象某个属性的值"></a><code>getattr</code>查看对象某个属性的值</h5><h5 id="setattr-设置对象某个属性的值"><a href="#setattr-设置对象某个属性的值" class="headerlink" title="setattr 设置对象某个属性的值"></a><code>setattr</code> 设置对象某个属性的值</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">foo</span>:</span><br><span class="line">    say = <span class="string">&quot;hello&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hasattr</span>(foo,<span class="string">&quot;say&quot;</span>))</span><br><span class="line"><span class="built_in">setattr</span>(foo,<span class="string">&quot;say&quot;</span>,<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getattr</span>(foo,<span class="string">&quot;say&quot;</span>))</span><br></pre></td></tr></table></figure>

<h4 id="面向对象高级用法"><a href="#面向对象高级用法" class="headerlink" title="面向对象高级用法"></a>面向对象高级用法</h4><h5 id="str-可以替换内存地址信息为别的信息"><a href="#str-可以替换内存地址信息为别的信息" class="headerlink" title="__str__可以替换内存地址信息为别的信息"></a><code>__str__</code>可以替换内存地址信息为别的信息</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">foo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.name,self.age)</span><br><span class="line"></span><br><span class="line">f = foo(<span class="string">&quot;user&quot;</span>,<span class="number">18</span>)</span><br><span class="line"><span class="built_in">print</span>(f)</span><br></pre></td></tr></table></figure>

<h5 id="del-程序执行完后的操作，执行清理操作"><a href="#del-程序执行完后的操作，执行清理操作" class="headerlink" title="__del__程序执行完后的操作，执行清理操作"></a><code>__del__</code>程序执行完后的操作，执行清理操作</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">foo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;程序运行完成&quot;</span>)</span><br><span class="line"></span><br><span class="line">f = foo(<span class="string">&quot;user&quot;</span>,<span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<h5 id="类使用-取值"><a href="#类使用-取值" class="headerlink" title="类使用[ ]取值"></a>类使用<code>[ ]</code>取值</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">foo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(self,item)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="built_in">setattr</span>(self,key,value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delitem__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="built_in">delattr</span>(self,key)</span><br><span class="line"></span><br><span class="line">f = foo(<span class="string">&quot;user&quot;</span>,<span class="number">18</span>)</span><br><span class="line"><span class="built_in">print</span>(f.__dict__)</span><br><span class="line">f[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;user01&quot;</span></span><br><span class="line"><span class="built_in">print</span>(f.__dict__)</span><br><span class="line"><span class="keyword">del</span> f[<span class="string">&quot;name&quot;</span>]</span><br><span class="line"><span class="built_in">print</span>(f.__dict__)</span><br></pre></td></tr></table></figure>

<h4 id="socket编程"><a href="#socket编程" class="headerlink" title="socket编程"></a>socket编程</h4><h5 id="tcp-socket模拟ssh"><a href="#tcp-socket模拟ssh" class="headerlink" title="tcp socket模拟ssh"></a>tcp socket模拟ssh</h5><p>server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">sock.bind((<span class="string">&quot;&quot;</span>,<span class="number">9999</span>))</span><br><span class="line">sock.listen(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn,addr = sock.accept() <span class="comment">#等待、阻塞</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;got a new customer&quot;</span>,conn,addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>) <span class="comment">#等待 bytes</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;received&quot;</span>,data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data: <span class="comment">#客户端断开了</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;conn %s is lost&quot;</span> % <span class="built_in">str</span>(addr) )</span><br><span class="line">            conn.close() <span class="comment">#清除了跟这个断开的链接的实例对象</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment">#conn.send(data.upper() )</span></span><br><span class="line">        cmd = subprocess.Popen(data.decode(<span class="string">&quot;utf-8&quot;</span>),</span><br><span class="line">                               shell=<span class="literal">True</span>,</span><br><span class="line">                               stdout=subprocess.PIPE,</span><br><span class="line">                               stderr=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">        stdout = cmd.stdout.read()</span><br><span class="line">        stderr = cmd.stderr.read()</span><br><span class="line">        cmd_res = stdout + stderr</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cmd_res:</span><br><span class="line">            cmd_res = <span class="string">b&#x27;cmd has not output&#x27;</span></span><br><span class="line"></span><br><span class="line">        conn.sendall(cmd_res) <span class="comment">#不能发空消息</span></span><br><span class="line"></span><br><span class="line">sock.close() <span class="comment">#关闭端口和服务</span></span><br></pre></td></tr></table></figure>

<p>client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM) <span class="comment">#数据流</span></span><br><span class="line">sock.connect((<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">9999</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt;:&quot;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg : <span class="keyword">continue</span></span><br><span class="line">    sock.send(msg.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    response = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;received:&quot;</span>,response.decode(<span class="string">&quot;gbk&quot;</span>))</span><br><span class="line"></span><br><span class="line">sock.close()</span><br></pre></td></tr></table></figure>

<h5 id="udp-socket"><a href="#udp-socket" class="headerlink" title="udp socket"></a>udp socket</h5><p>server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">ip_port = (<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">udp_server_client = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line">udp_server_client.bind(ip_port)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg,addr = udp_server_client.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(msg,addr)</span><br><span class="line">    udp_server_client.sendto(msg,addr)</span><br></pre></td></tr></table></figure>

<p>client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">ip_port = (<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">udp_server_client = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&gt;: &#x27;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:<span class="keyword">continue</span></span><br><span class="line">    udp_server_client.sendto(msg.encode(<span class="string">&#x27;utf-8&#x27;</span>),ip_port)</span><br><span class="line"></span><br><span class="line">    bank_msg,addr = udp_server_client.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(bank_msg.decode(<span class="string">&#x27;utf-8&#x27;</span>),addr)</span><br></pre></td></tr></table></figure>

<h4 id="threading线程"><a href="#threading线程" class="headerlink" title="threading线程"></a>threading线程</h4><h5 id="event"><a href="#event" class="headerlink" title="event"></a>event</h5><blockquote>
<p>当有几个线程的时候，可能线程A依赖线程B的运行，可以用event对象让线程A等待线程B</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">event = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;wait...&quot;</span>)</span><br><span class="line">    event.wait(<span class="number">10</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;connect to redis server&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> event.is_set():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;waiting for even...&quot;</span>)</span><br><span class="line">        event.wait(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    t1 = threading.Thread(target=foo,args=())</span><br><span class="line">    t1.start()</span><br><span class="line"></span><br><span class="line">t2 = threading.Thread(target=bar,args=())</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;attempt to start redis server&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;set...&quot;</span>)</span><br><span class="line">event.<span class="built_in">set</span>()</span><br></pre></td></tr></table></figure>

<h5 id="线程队列queue"><a href="#线程队列queue" class="headerlink" title="线程队列queue"></a>线程队列queue</h5><blockquote>
<p>先进先出和先进后出</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    q.put(<span class="number">3.14</span>)</span><br><span class="line">    q.put(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">    q.put(<span class="string">&quot;yes&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt;start...&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> q.empty():</span><br><span class="line">        <span class="built_in">print</span>(q.get())</span><br><span class="line">        q.task_done()</span><br><span class="line"></span><br><span class="line">q = queue.Queue(<span class="number">10</span>) <span class="comment"># queue.LifoQueue(10) # queue.PriorityQueue(10)</span></span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=foo,args=())</span><br><span class="line">t2 = threading.Thread(target=bar,args=())</span><br><span class="line"></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>优先级模式</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    q.put([<span class="number">1</span>,<span class="number">3.14</span>])</span><br><span class="line">    q.put([<span class="number">3</span>,<span class="string">&quot;hello&quot;</span>])</span><br><span class="line">    q.put([<span class="number">2</span>,<span class="string">&quot;yes&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt;start...&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> q.empty():</span><br><span class="line">        <span class="built_in">print</span>(q.get()【】)</span><br><span class="line">        q.task_done()</span><br><span class="line"></span><br><span class="line">q = queue.PriorityQueue(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=foo,args=())</span><br><span class="line">t2 = threading.Thread(target=bar,args=())</span><br><span class="line"></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br></pre></td></tr></table></figure>

<h4 id="进程-multiprocessing"><a href="#进程-multiprocessing" class="headerlink" title="进程 multiprocessing"></a>进程 multiprocessing</h4><h5 id="multiprocessing"><a href="#multiprocessing" class="headerlink" title="multiprocessing"></a>multiprocessing</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">n</span>):</span><br><span class="line">    res = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,n):</span><br><span class="line">        res += i</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>(<span class="params">n</span>):</span><br><span class="line">    res = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,n):</span><br><span class="line">        res *= i</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">s = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    m1 = multiprocessing.Process(target=foo,args=(<span class="number">100000000</span>,))</span><br><span class="line">    m2 = multiprocessing.Process(target=bar,args=(<span class="number">100000</span>,))</span><br><span class="line">    m1.start()</span><br><span class="line">    m2.start()</span><br><span class="line">    m1.join()</span><br><span class="line">    m2.join()</span><br><span class="line">    <span class="built_in">print</span>(time.time() - s)</span><br></pre></td></tr></table></figure>

<h5 id="进程queue通信"><a href="#进程queue通信" class="headerlink" title="进程queue通信"></a>进程queue通信</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">q</span>):</span><br><span class="line">    q.put([<span class="number">11</span>,<span class="string">&quot;hello&quot;</span>,<span class="literal">True</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    q = multiprocessing.Queue()</span><br><span class="line">    m = multiprocessing.Process(target=foo,args=(q,))</span><br><span class="line">    m.start()</span><br><span class="line">    <span class="built_in">print</span>(q.get())</span><br></pre></td></tr></table></figure>

<h5 id="管道pipe通信"><a href="#管道pipe通信" class="headerlink" title="管道pipe通信"></a>管道pipe通信</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pipe,Process</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">sock</span>):</span><br><span class="line">    sock.send(<span class="string">&quot;hello world!&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(sock.recv())</span><br><span class="line"></span><br><span class="line">sock,conn = Pipe()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    m = Process(target=foo, args=(sock,))</span><br><span class="line">    m.start()</span><br><span class="line">    <span class="built_in">print</span>(conn.recv())</span><br><span class="line">    conn.send(<span class="string">&quot;hi boy!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="manage进程通信（最优方法）"><a href="#manage进程通信（最优方法）" class="headerlink" title="manage进程通信（最优方法）"></a>manage进程通信（最优方法）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Manager,Process</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">l,i</span>):</span><br><span class="line">    l.append(i*i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    manage = Manager()</span><br><span class="line">    mlist = manage.<span class="built_in">list</span>([<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        p = Process(target=foo, args=(mlist,i))</span><br><span class="line">        p.start()</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(mlist)</span><br></pre></td></tr></table></figure>

<h5 id="使用进程池并发pool"><a href="#使用进程池并发pool" class="headerlink" title="使用进程池并发pool"></a>使用进程池并发pool</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="built_in">print</span>(n)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    p = Pool(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        p.apply_async(func=foo,args=(i,))</span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ending...&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h4><h6 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>():</span><br><span class="line">    r = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        n = <span class="keyword">yield</span> r</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;consumer: &quot;</span>,n)</span><br><span class="line">        time.sleep(<span class="number">3</span>)</span><br><span class="line">        r = <span class="string">&quot;200 ok&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">produce</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="built_in">next</span>(c)</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;produce: &quot;</span>,n)</span><br><span class="line">        cr = c.send(n)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;consumer return: &quot;</span>,cr)</span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    c = consumer()</span><br><span class="line">    produce(c)</span><br></pre></td></tr></table></figure>

<h6 id="greenlet"><a href="#greenlet" class="headerlink" title="greenlet"></a>greenlet</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ok1&quot;</span>)</span><br><span class="line">    g2.switch()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ok3&quot;</span>)</span><br><span class="line">    g2.switch()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ok2&quot;</span>)</span><br><span class="line">    g1.switch()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ok4&quot;</span>)</span><br><span class="line"></span><br><span class="line">g1 = greenlet(foo)</span><br><span class="line">g2 = greenlet(bar)</span><br><span class="line"></span><br><span class="line">g1.switch()</span><br></pre></td></tr></table></figure>

<h5 id="geven"><a href="#geven" class="headerlink" title="geven"></a>geven</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">url</span>):</span><br><span class="line">    res = requests.get(url)</span><br><span class="line">    res_str = res.text</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;len: &quot;</span>,<span class="built_in">len</span>(res_str))</span><br><span class="line"></span><br><span class="line">s = time.time()</span><br><span class="line">gevent.joinall([</span><br><span class="line">    gevent.spawn(foo, <span class="string">&quot;https://www.baidu.com/&quot;</span>),</span><br><span class="line">    gevent.spawn(foo, <span class="string">&quot;https://translate.google.cn/&quot;</span>),</span><br><span class="line">    gevent.spawn(foo, <span class="string">&quot;https://www.zhihu.com/&quot;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(time.time() - s)</span><br></pre></td></tr></table></figure>

<h4 id="io多路复用"><a href="#io多路复用" class="headerlink" title="io多路复用"></a>io多路复用</h4><p><code>select</code>、<code>poll</code>、<code>epoll</code>模型</p>
<h4 id="socketserver"><a href="#socketserver" class="headerlink" title="socketserver"></a>socketserver</h4><p>server端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">myserver</span>(socketserver.BaseRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;from conn: &quot;</span>,self.request)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = self.request.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="built_in">print</span>(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> data.decode(<span class="string">&quot;utf-8&quot;</span>) == <span class="string">&quot;q&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            response = subprocess.Popen(data.decode(<span class="string">&quot;utf-8&quot;</span>),</span><br><span class="line">                                        shell=<span class="literal">True</span>,</span><br><span class="line">                                        stdout=subprocess.PIPE,</span><br><span class="line">                                        stderr=subprocess.PIPE)</span><br><span class="line">            stdout = response.stdout.read()</span><br><span class="line">            stderr = response.stderr.read()</span><br><span class="line">            res = stdout + stderr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(res) <span class="keyword">is</span> <span class="built_in">bytes</span>:</span><br><span class="line">                self.request.send(res)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.request.send(res.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line"></span><br><span class="line">s = socketserver.ThreadingTCPServer((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8800</span>),myserver)</span><br><span class="line"></span><br><span class="line">s.serve_forever()</span><br></pre></td></tr></table></figure>

<p>client端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line">sock = socket.socket()</span><br><span class="line">sock.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8800</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt;: &quot;</span>)</span><br><span class="line">    sock.send(data.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    response = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">if</span> platform.system() == <span class="string">&quot;Windows&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(response.decode(<span class="string">&quot;gbk&quot;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(response.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br></pre></td></tr></table></figure>


<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><h5 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Timer</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_timer</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;hello timer&#x27;</span>)</span><br><span class="line">    timer = Timer(<span class="number">1</span>, do_timer)</span><br><span class="line">    timer.start()</span><br><span class="line"></span><br><span class="line">do_timer()</span><br></pre></td></tr></table></figure>

<h5 id="schedule"><a href="#schedule" class="headerlink" title="schedule"></a>schedule</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> schedule</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">job</span>():</span><br><span class="line">    <span class="built_in">print</span>(datetime.datetime.now())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_job</span>():</span><br><span class="line">    Thread(target=job).start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="comment"># #每10分钟执行一次job函数</span></span><br><span class="line">    <span class="comment"># schedule.every(10).minutes.do(test)</span></span><br><span class="line">    <span class="comment"># # 每10秒执行一次job函数</span></span><br><span class="line">    <span class="comment"># schedule.every(10).seconds.do(test)</span></span><br><span class="line">    <span class="comment"># # 当every()没参数时默认是1小时/分钟/秒执行一次job函数</span></span><br><span class="line">    <span class="comment"># schedule.every().hour.do(test)</span></span><br><span class="line">    <span class="comment"># schedule.every().day.at(&quot;10:30&quot;).do(test)</span></span><br><span class="line">    <span class="comment"># schedule.every().monday.do(test)</span></span><br><span class="line">    <span class="comment"># # 具体某一天某个时刻执行一次job函数</span></span><br><span class="line">    <span class="comment"># schedule.every().wednesday.at(&quot;13:15&quot;).do(test)</span></span><br><span class="line">    <span class="comment"># # 可以同时定时执行多个任务，但是每个任务是按顺序执行</span></span><br><span class="line">    <span class="comment"># schedule.every(10).seconds.do(job2)</span></span><br><span class="line">    <span class="comment"># # 如果job函数有有参数时，这么写</span></span><br><span class="line">    <span class="comment"># schedule.every(10).seconds.do(job，&quot;参数&quot;)</span></span><br><span class="line"></span><br><span class="line">    schedule.every(<span class="number">10</span>).minutes.do(do_job)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        schedule.run_pending()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">run()</span><br></pre></td></tr></table></figure>

<h4 id="re正则"><a href="#re正则" class="headerlink" title="re正则"></a>re正则</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">re_obj = re.<span class="built_in">compile</span>(<span class="string">&#x27;(\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;T\d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;.\d&#123;3&#125;)\d&#123;3&#125;(Z)&#x27;</span>)</span><br><span class="line">start_time = re_obj.<span class="keyword">match</span>(format_start_time).group(<span class="number">1</span>) + re_obj.<span class="keyword">match</span>(format_start_time).group(<span class="number">2</span>)</span><br><span class="line">end_time = re_obj.<span class="keyword">match</span>(format_end_time).group(<span class="number">1</span>) + re_obj.<span class="keyword">match</span>(format_end_time).group(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<h4 id="flask-caching增加缓存"><a href="#flask-caching增加缓存" class="headerlink" title="flask_caching增加缓存"></a>flask_caching增加缓存</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_caching <span class="keyword">import</span> Cache</span><br><span class="line"></span><br><span class="line">cache = Cache(config=&#123;<span class="string">&#x27;CACHE_TYPE&#x27;</span>: <span class="string">&#x27;simple&#x27;</span>&#125;)</span><br><span class="line">cache.init_app(app)</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### xml转doct</span></span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line"><span class="keyword">import</span> xmltodict</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;server.xml&#x27;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f_xml = f.read()</span><br><span class="line">f_dict = xmltodict.parse(f_xml)</span><br></pre></td></tr></table></figure>

<h4 id="url编码解码"><a href="#url编码解码" class="headerlink" title="url编码解码"></a>url编码解码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line">parse.quote_plus(<span class="string">&#x27;抱歉&#x27;</span>)</span><br><span class="line">parse.unquote_plus(<span class="string">&#x27;%E6%8A%B1%E6%AD%89&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h3><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">str</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]))</span><br><span class="line">[<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="add-apt-repository"><a href="#add-apt-repository" class="headerlink" title="add-apt-repository"></a>add-apt-repository</h3><p>apt-get install python-software-properties<br>apt-get install software-properties-common</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/11/21/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD%E4%B8%8E%E6%89%A9%E5%AE%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/21/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD%E4%B8%8E%E6%89%A9%E5%AE%B9/" class="post-title-link" itemprop="url">服务器磁盘挂载与扩容</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-21 00:00:00" itemprop="dateCreated datePublished" datetime="2017-11-21T00:00:00+08:00">2017-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-06 16:12:42" itemprop="dateModified" datetime="2020-01-06T16:12:42+08:00">2020-01-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="云服务器磁盘挂载与扩容"><a href="#云服务器磁盘挂载与扩容" class="headerlink" title="云服务器磁盘挂载与扩容"></a>云服务器磁盘挂载与扩容</h3><h4 id="磁盘挂载"><a href="#磁盘挂载" class="headerlink" title="磁盘挂载"></a>磁盘挂载</h4><ol>
<li><p>上传脚本至服务器，命令行运行<code>bash -x init.disk.sh</code>执行脚本，等待脚本运行结束。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment">### 自动挂载磁盘</span></span><br><span class="line"><span class="comment">### 适用于阿里云服务器自动挂载磁盘</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 功能</span></span><br><span class="line"><span class="comment"># 适用于阿里云服务器第一次</span></span><br><span class="line"><span class="comment"># 将挂载的磁盘，每块依次挂载到/data/ /data1/ /data2目录</span></span><br><span class="line"><span class="comment"># 无需传参，自动使用磁盘所有存储空间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#信号非0退出脚本</span></span><br><span class="line"><span class="comment">#set -e</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#去掉rc.local</span></span><br><span class="line">grep init_disk.sh /etc/rc.local &gt;/dev/null &amp;&amp; sed -i <span class="string">&#x27;s/^bash \/usr\/local\/scripts\/init_disk.sh/# &amp;/g&#x27;</span> /etc/rc.local</span><br><span class="line"></span><br><span class="line"><span class="comment">#清理脚本</span></span><br><span class="line"><span class="built_in">trap</span> <span class="string">&quot;rm -rf <span class="variable">$&#123;BASH_SOURCE&#125;</span>&quot;</span> EXIT</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctrl+c</span></span><br><span class="line"><span class="built_in">trap</span> <span class="string">&quot;&quot;</span> SIGINT SIGQUIT</span><br><span class="line"></span><br><span class="line"><span class="comment">### 先检查磁盘信息</span></span><br><span class="line"><span class="function"><span class="title">__check</span></span>() &#123;</span><br><span class="line"><span class="comment">#获取磁盘信息</span></span><br><span class="line">_dev=`fdisk -l 2&gt; /dev/null |grep /dev/...1 |<span class="built_in">head</span> -n 1 |<span class="built_in">cut</span> -c 1-7`</span><br><span class="line">_disk_all=(</span><br><span class="line">`fdisk -l 2&gt;/dev/null |grep -v <span class="string">&quot;doesn&#x27;t contain&quot;</span> |grep -o <span class="string">&quot;<span class="variable">$&#123;_dev&#125;</span>.&quot;</span> |<span class="built_in">uniq</span> -c |grep -oP <span class="string">&quot;(?&lt;=1 )<span class="variable">$&#123;_dev&#125;</span>.&quot;</span>`</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查磁盘（没有可操作的磁盘则退出脚本）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;_disk_all[@]&#125;</span> |grep -E <span class="string">&quot;/dev/[a-z]&#123;3&#125;&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;No new disks were found&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 前期准备</span></span><br><span class="line"><span class="function"><span class="title">__ready</span></span>() &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据主机名修改hosts</span></span><br><span class="line">_hostname=`hostname`</span><br><span class="line">grep <span class="variable">$&#123;_hostname&#125;</span> /etc/hosts || sed -i <span class="string">&quot;s/.*127.0.0.1.*/127.0.0.1    <span class="variable">$&#123;_hostname&#125;</span>    localhost/g&quot;</span> /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断系统</span></span><br><span class="line"><span class="built_in">which</span> apt-get &amp;&amp; system=ubuntu</span><br><span class="line"><span class="built_in">which</span> yum &amp;&amp; system=centos</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件包</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$&#123;system&#125;</span> <span class="keyword">in</span></span><br><span class="line">    ubuntu)</span><br><span class="line">        apt-get update</span><br><span class="line">        apt-get -y install lvm2 || <span class="built_in">echo</span> <span class="string">&quot;lvm2 Already installed&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">    centos)</span><br><span class="line">        yum -y install lvm2 || <span class="built_in">echo</span> <span class="string">&quot;lvm2 Already installed&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Unidentified _system environment variable&quot;</span></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行主程序</span></span><br><span class="line"><span class="function"><span class="title">__main</span></span>() &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">#磁盘分区</span></span><br><span class="line">fdisk <span class="variable">$&#123;_disk&#125;</span> &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">n</span></span><br><span class="line"><span class="string">p</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string">8e</span></span><br><span class="line"><span class="string">wq</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建lvm</span></span><br><span class="line"><span class="built_in">sync</span> ;<span class="built_in">sleep</span> 2</span><br><span class="line">pvcreate <span class="variable">$&#123;_disk&#125;</span>1</span><br><span class="line">vgcreate welab_vg<span class="variable">$&#123;_num&#125;</span> <span class="variable">$&#123;_disk&#125;</span>1</span><br><span class="line">lvcreate -l 100%VG -n welab_vol<span class="variable">$&#123;_num&#125;</span> welab_vg<span class="variable">$&#123;_num&#125;</span></span><br><span class="line">mkfs -t ext4 /dev/welab_vg<span class="variable">$&#123;_num&#125;</span>/welab_vol<span class="variable">$&#123;_num&#125;</span></span><br><span class="line">[ -d /data<span class="variable">$&#123;_num&#125;</span> ] || <span class="built_in">mkdir</span> -p /data<span class="variable">$&#123;_num&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># parted /dev/vdc</span></span><br><span class="line"><span class="comment"># mklabel gpt</span></span><br><span class="line"><span class="comment"># mkpart primary 1024K 3220G</span></span><br><span class="line"><span class="comment"># Ignore</span></span><br><span class="line"><span class="comment"># toggle 1 lvm</span></span><br><span class="line"><span class="comment"># q</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pvcreate /dev/vdc1</span></span><br><span class="line"><span class="comment"># vgcreate welab_vg1 /dev/vdc1</span></span><br><span class="line"><span class="comment"># lvcreate -L 2998G -n welab_vol1 welab_vg1</span></span><br><span class="line"><span class="comment"># mkfs -t ext4 /dev/welab_vg1/welab_vol1</span></span><br><span class="line"><span class="comment"># mkdir /data1</span></span><br><span class="line"><span class="comment"># echo &quot;UUID=`blkid /dev/welab_vg1/welab_vol1 |awk -F&#x27;&quot;&#x27; &#x27;&#123;print $2&#125;&#x27;` /data1 ext4 defaults 0 0&quot; &gt;&gt; /etc/fstab</span></span><br><span class="line"><span class="comment"># mount -a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pvcreate /dev/vd[cdef]1</span></span><br><span class="line"><span class="comment"># vgcreate -A y -s 128M welab_vg1 /dev/vd[cdef]1</span></span><br><span class="line"><span class="comment"># lvcreate -A y -i 4 -I 8 -l 100%VG -n welab_vol1 welab_vg1</span></span><br><span class="line"><span class="comment"># mkfs.ext4 /dev/welab_vg1/welab_vol1 -m 0 -O extent,uninit_bg -E lazy_itable_init=1,stride=2,stripe_width=32 -b 4096 -T largefile -L welab_vol1</span></span><br><span class="line"><span class="comment"># echo &quot;UUID=`blkid /dev/welab_vg1/welab_vol1 |awk -F&#x27;&quot;&#x27; &#x27;&#123;print $2&#125;&#x27;` /data1 ext4 defaults,noatime,nodiratime,nodelalloc,barrier=0,data=writeback 0 0&quot; &gt;&gt; /etc/fstab</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#去掉遗留的data挂载</span></span><br><span class="line"><span class="comment">#sed -ri &#x27;/\/data[0-9]?/d&#x27; /etc/fstab</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#挂载磁盘</span></span><br><span class="line">[ -b /dev/welab_vg<span class="variable">$&#123;_num&#125;</span>/welab_vol<span class="variable">$&#123;_num&#125;</span> ] &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;UUID=`blkid /dev/welab_vg<span class="variable">$&#123;_num&#125;</span>/welab_vol<span class="variable">$&#123;_num&#125;</span> |awk -F&#x27;&quot;</span><span class="string">&#x27; &#x27;</span>&#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;<span class="string">&#x27;` /data$&#123;_num&#125; ext4 defaults 0 0&quot; &gt;&gt; /etc/fstab</span></span><br><span class="line"><span class="string">sleep 3</span></span><br><span class="line"><span class="string">mount -a</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">__do_main() &#123;</span></span><br><span class="line"><span class="string">_data_name=`df -h |grep -oP &quot;data(\d*)?&quot;`</span></span><br><span class="line"><span class="string">_data_num=`echo $&#123;_data_name&#125; |sed &#x27;</span>s/data//g<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">[ x$&#123;_data_num&#125; == x&#x27;</span><span class="string">&#x27; ] &amp;&amp; _num=-1 || _num=$[ $&#123;_data_num&#125;+1 ]</span></span><br><span class="line"><span class="string">[ x$&#123;_data_name&#125; == x&#x27;</span>data<span class="string">&#x27; ] &amp;&amp; _num=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for _disk in $&#123;_disk_all[@]&#125; ; do</span></span><br><span class="line"><span class="string">  _size=$[ `fdisk -l 2&gt;/dev/null |grep $&#123;_disk&#125; |awk &#x27;</span>&#123;<span class="built_in">print</span> <span class="variable">$5</span>&#125;<span class="string">&#x27;`/1024/1024/1024-1 ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  if [ $&#123;_size&#125; -gt 20 ] ;then</span></span><br><span class="line"><span class="string">    _num=$[$&#123;_num&#125;+1]</span></span><br><span class="line"><span class="string">    [ $&#123;_num&#125; -eq 0 ] &amp;&amp; unset _num</span></span><br><span class="line"><span class="string">    __main</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    echo &quot;Disk $&#123;_disk&#125; capacity is less than 20G&quot;</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">__check</span></span><br><span class="line"><span class="string">__ready</span></span><br><span class="line"><span class="string">__do_main</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<h4 id="磁盘扩容"><a href="#磁盘扩容" class="headerlink" title="磁盘扩容"></a>磁盘扩容</h4></blockquote>
<ol>
<li><p>格式化分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/vdc &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">n</span></span><br><span class="line"><span class="string">p</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string">8e</span></span><br><span class="line"><span class="string">wq</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>先卸载需要扩容的磁盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /data</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加磁盘，创建pv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/vdc1</span><br></pre></td></tr></table></figure>
</li>
<li><p>扩容vg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgextend welab_vg /dev/vdc1</span><br></pre></td></tr></table></figure>
</li>
<li><p>扩容lv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvextend -l 100%VG /dev/welab_vg/welab_vol</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e2fsck -f /dev/welab_vg/welab_vol</span><br></pre></td></tr></table></figure>
</li>
<li><p>扩容文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resize2fs /dev/welab_vg/welab_vol</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加fatab，重新挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -a</span><br></pre></td></tr></table></figure>
</li>
<li><p>建议卸载磁盘，不能卸载的情况下可以最后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o remount,rw /data</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/13/ansible%E7%9A%84%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/13/ansible%E7%9A%84%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">ansible的学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-13 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-13T00:00:00+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:12:17" itemprop="dateModified" datetime="2022-12-14T16:12:17+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、ansible的安装"><a href="#一、ansible的安装" class="headerlink" title="一、ansible的安装"></a>一、ansible的安装</h3><h4 id="1-安装ansible，ansible需要python支持，所有一并安装python"><a href="#1-安装ansible，ansible需要python支持，所有一并安装python" class="headerlink" title="1. 安装ansible，ansible需要python支持，所有一并安装python"></a>1. 安装ansible，ansible需要python支持，所有一并安装python</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># yum -y install python ansible</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="2-创建一个工作目录，hosts包含一台主机"><a href="#2-创建一个工作目录，hosts包含一台主机" class="headerlink" title="2.创建一个工作目录，hosts包含一台主机"></a>2.创建一个工作目录，hosts包含一台主机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># mkdir playbook</span></span><br><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts</span></span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
<h4 id="3-ansible服务器与其他机器创建信任关系"><a href="#3-ansible服务器与其他机器创建信任关系" class="headerlink" title="3. ansible服务器与其他机器创建信任关系"></a>3. ansible服务器与其他机器创建信任关系</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">[root@student01 ~]<span class="comment"># ssh-copy-id root@student02</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="4-使用ping模块测试连通状态"><a href="#4-使用ping模块测试连通状态" class="headerlink" title="4. 使用ping模块测试连通状态"></a>4. 使用ping模块测试连通状态</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m ping</span></span><br><span class="line">student02 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>注：如果命令执行失败，可以在命令后面加上-vvvv，查看详细信息</p>
</blockquote>
<pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m ping -vvvv</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="5-查看服务器启动时间"><a href="#5-查看服务器启动时间" class="headerlink" title="5.  查看服务器启动时间"></a>5.  查看服务器启动时间</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -a &quot;uptime&quot;</span></span><br><span class="line">student02 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"> 16:33:32 up  1:22,  2 <span class="built_in">users</span>,  load average: 0.00, 0.01, 0.05</span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="6-安装nginx服务以及重启nginx服务"><a href="#6-安装nginx服务以及重启nginx服务" class="headerlink" title="6. 安装nginx服务以及重启nginx服务"></a>6. 安装nginx服务以及重启nginx服务</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m yum -a &quot;name=nginx&quot;</span></span><br><span class="line">[root@student01 ~]<span class="comment"># ansible student02 -i playbook/inventory/hosts -m service -a &quot;name=nginx state=restarted&quot;</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h3 id="二、YAML语法介绍"><a href="#二、YAML语法介绍" class="headerlink" title="二、YAML语法介绍"></a>二、YAML语法介绍</h3><h4 id="1-文件的起始"><a href="#1-文件的起始" class="headerlink" title="1. 文件的起始"></a>1. <strong>文件的起始</strong></h4><p>YAML文件以<code>---</code>开头以标记文件的开头，如果忘记开头三个减号，也不会影响Ansible的运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---</span><br></pre></td></tr></table></figure>
<h4 id="2-注释"><a href="#2-注释" class="headerlink" title="2. 注释"></a>2. <strong>注释</strong></h4><p>注释以<code>#</code>开头，一直到本行的结束</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#This is a YAML comment</span></span><br></pre></td></tr></table></figure>
<h4 id="3-字符串"><a href="#3-字符串" class="headerlink" title="3. 字符串"></a>3. <strong>字符串</strong></h4><p>YAML字符串不需要使用<code>&quot;&quot;</code>引起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ansible playbook</span><br></pre></td></tr></table></figure>
<h4 id="4-布尔值"><a href="#4-布尔值" class="headerlink" title="4. 布尔值"></a>4. <strong>布尔值</strong></h4><p>Ansible经常使用的布尔值有<code>ture</code>和<code>false</code>，<code>yes</code>和<code>no</code></p>
<h4 id="5-列表"><a href="#5-列表" class="headerlink" title="5. 列表"></a>5. <strong>列表</strong></h4><p>列表中的所有成员都开始于相同的缩进级别, 并且使用一个<code>- </code> 作为开头</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- bash shell</span><br><span class="line">- python</span><br><span class="line">- c++</span><br></pre></td></tr></table></figure>
<h4 id="6-字典"><a href="#6-字典" class="headerlink" title="6. 字典"></a>6. <strong>字典</strong></h4><p>由一个简单的<code>键: 值</code>的形式组成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostname: student01</span><br><span class="line">ip: 172.25.0.11</span><br><span class="line">server: web</span><br></pre></td></tr></table></figure>
<h4 id="7-折行"><a href="#7-折行" class="headerlink" title="7. 折行"></a>7. <strong>折行</strong></h4><p>在需要向模块传递很多参数的时候，为了美观可以把很长的段落写成多行，使用<code>&gt;</code>标记折行，YAML会把折行替换为空格</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip: &gt;</span><br><span class="line">172.25.0.11</span><br><span class="line">172.25.0.12</span><br></pre></td></tr></table></figure>
<blockquote>
<p>  注：JSON文件可以直接当做YAML文件使用，但是不建议把playbook写成JSON脚本，因为YAML的亮点就是易于阅读</p>
</blockquote>
<h3 id="三、playbook简介"><a href="#三、playbook简介" class="headerlink" title="三、playbook简介"></a>三、playbook简介</h3><blockquote>
<p>playbook是用于配置管理的脚本，使用Ansible时大部分时间在编写playbook</p>
</blockquote>
<h4 id="1-我们先写一个简单的playbook，搭建web服务"><a href="#1-我们先写一个简单的playbook，搭建web服务" class="headerlink" title="1. 我们先写一个简单的playbook，搭建web服务"></a>1. 我们先写一个简单的playbook，搭建web服务</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/web-configure.yml </span></span><br><span class="line">- name: configure webserver with nginx</span><br><span class="line">  hosts: webserver</span><br><span class="line">  sudo: Ture</span><br><span class="line">  tasks:</span><br><span class="line">    - name: install nginx</span><br><span class="line">      yum: name=nginx update_cache=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">    - name: copy nginx config file</span><br><span class="line">      copy: src=files/nginx_8080_localhost.conf dest=/etc/nginx/conf.d/8080</span><br><span class="line">_localhost.conf</span><br><span class="line">    </span><br><span class="line">    - name: copy index.html</span><br><span class="line">      template: src=templates/index.html.j2 dest=/usr/share/nginx/html/inde</span><br><span class="line">x.html mode=0644</span><br><span class="line">    </span><br><span class="line">    - name: restart nginx</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line">       </span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>在playbook中，建议向模块传递参数的时候用yes和no，在其他地方使用ture和false</p>
</blockquote>
<h4 id="2-把nginx的配置文件放在playbook-x2F-files-x2F-nginx-8080-localhost-conf-，用这个配置文件覆盖默认的配置文件"><a href="#2-把nginx的配置文件放在playbook-x2F-files-x2F-nginx-8080-localhost-conf-，用这个配置文件覆盖默认的配置文件" class="headerlink" title="2. 把nginx的配置文件放在playbook&#x2F;files&#x2F;nginx_8080_localhost.conf ，用这个配置文件覆盖默认的配置文件"></a>2. 把nginx的配置文件放在playbook&#x2F;files&#x2F;nginx_8080_localhost.conf ，用这个配置文件覆盖默认的配置文件</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">	[root@student01 ~]<span class="comment"># cat playbook/files/nginx_8080_localhost.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">listen       8080 default_server;</span><br><span class="line">listen       [::]:8080 default_server;</span><br><span class="line"></span><br><span class="line">root         /usr/share/nginx/html;</span><br><span class="line">	index index.html index.htm;</span><br><span class="line">	server_name localhost;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page 404 /404.html;</span><br><span class="line">location = /40x.html &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page 500 502 503 504 /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>安装惯例，我们把一般文件放在files目录中，将jinja2模板文件放在templates目录中</p>
</blockquote>
<h4 id="3-创建一个首页"><a href="#3-创建一个首页" class="headerlink" title="3. 创建一个首页"></a>3. 创建一个首页</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 templates]<span class="comment"># cat index.html.j2 </span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;<span class="built_in">head</span>&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;nginx, configured by ansible&lt;/h1&gt;</span><br><span class="line">  &lt;p&gt; <span class="keyword">if</span> you can see this, ansible successfully installed nginx.&lt;/p&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123; ansible_managed &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
<p>这个模板引用了一个ansible变量<em>ansible_managed</em>，当ansible渲染这个模板的时候，会将变量替换成这个模板文件生成时间相关信息</p>
</blockquote>
<h4 id="4-在hosts文件的主机前面加上-webserver-，创建一个webserver群组，表明下面的主机属于webserver"><a href="#4-在hosts文件的主机前面加上-webserver-，创建一个webserver群组，表明下面的主机属于webserver" class="headerlink" title="4. 在hosts文件的主机前面加上[webserver]，创建一个webserver群组，表明下面的主机属于webserver"></a>4. 在hosts文件的主机前面加上[webserver]，创建一个webserver群组，表明下面的主机属于webserver</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver]</span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br><span class="line">student03 ansible_ssh_host=172.25.0.13 ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="5-执行playbook"><a href="#5-执行playbook" class="headerlink" title="5. 执行playbook"></a>5. 执行playbook</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment">#ansible-playbook -i playbook/inventory/hosts      playbook/web-configure.yml</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="6-如果没有任何报错，现在可以通过浏览器访问http-localhost-8080并看到HTML网页"><a href="#6-如果没有任何报错，现在可以通过浏览器访问http-localhost-8080并看到HTML网页" class="headerlink" title="6. 如果没有任何报错，现在可以通过浏览器访问http://localhost:8080并看到HTML网页"></a>6. 如果没有任何报错，现在可以通过浏览器访问<a href="http://localhost:8080并看到HTML网页">http://localhost:8080并看到HTML网页</a></h4><h3 id="四、playbook深入剖析"><a href="#四、playbook深入剖析" class="headerlink" title="四、playbook深入剖析"></a>四、playbook深入剖析</h3><h4 id="1-play"><a href="#1-play" class="headerlink" title="1. play"></a>1. <strong>play</strong></h4><p>通过观察YAML发现，playbook就是一组play组成的列表，每个play都必须包含两项</p>
<p><code>host</code>：需要配置一组主机</p>
<p><code>task</code>：需要在这些主机上执行的任务</p>
<p>play还支持一些可选的配置，先介绍三个最常用的</p>
<p><code>name</code>：一个注释，描述这个play是做什么的</p>
<p><code>sudo</code>：如果为真，Ansible会在执行task的时候运行sudo切换root用户执行</p>
<p><code>var</code>：变量和值组成的列表</p>
<h4 id="2-task"><a href="#2-task" class="headerlink" title="2. task"></a>2. <strong>task</strong></h4><p>举例一个安装nginx的task</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">yum: name=nginx update_cache=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<p>这个task告诉yum安装一个叫nginx的软件包，安装前更新安装包缓存</p>
<p>如果想要把参数写成多行的话，可以使用折行语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">yum: &gt;</span><br><span class="line">name=nginx</span><br><span class="line">update_cacha=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<h4 id="3-模块"><a href="#3-模块" class="headerlink" title="3. 模块"></a>3. <strong>模块</strong></h4><p>模块是由Ansible包装后在主机上执行的一系列脚本，常用的有以下模块<br><code>yum</code>：使用yum包管理器安装和删除软件包<br><code>copy</code>：将文件从本地复制到主机<br><code>file</code>：设置文件、符号链接或者目录属性<br><code>service</code>：启动、停止或者重启服务<br><code>template</code>：从模板生成文件并复制到主机</p>
<blockquote>
<p>  ansible-doc命令工具可以查看官方文档</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible-doc service</span></span><br></pre></td></tr></table></figure>
<h4 id="4-将他们整合到一起，组成一个play"><a href="#4-将他们整合到一起，组成一个play" class="headerlink" title="4. 将他们整合到一起，组成一个play"></a>4. <strong>将他们整合到一起，组成一个play</strong></h4><p>这是一张实体关系图，他描述了playbook、play、host、task和module之间的关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">playbook--&gt;play</span><br><span class="line">play--&gt;host</span><br><span class="line">play--&gt;task</span><br><span class="line">task--&gt;module</span><br></pre></td></tr></table></figure>
<h4 id="5-跟踪主机状态"><a href="#5-跟踪主机状态" class="headerlink" title="5. 跟踪主机状态"></a>5. <strong>跟踪主机状态</strong></h4><p>当运行ansible-playbook时，Ansible便会输出他在play中执行每一个task的状态信息</p>
<p>有些任务的状态是changed，显示的黄色，状态ok，显示的是绿色</p>
<p>Ansible模块会在采取任何行动之前查看主机的状态是否需要改变，如果主机的参数与模块的参数相匹配，那么不会做任何操作，直接响应ok，如果参数不匹配，则会改变主机的状态并的返回changed</p>
<h4 id="6-vars"><a href="#6-vars" class="headerlink" title="6. vars"></a>6. <strong>vars</strong></h4><p>在playbook的play中可以使用vars区段定义变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">server_name: localhost</span><br></pre></td></tr></table></figure>
<h4 id="7-handler"><a href="#7-handler" class="headerlink" title="7. handler"></a>7. <strong>handler</strong></h4><p>handler是Ansible提供的条件机制之一，handler和task很相似，但是他只有被task通知后才会执行，Ansible识别到task改变了系统的状态，task就会触发通知机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">- name: install nginx</span><br><span class="line">	    yum: name=nginx update_cache=<span class="built_in">yes</span></span><br><span class="line">	    notify: restart nginx</span><br><span class="line">	handler:</span><br><span class="line">	  - name: restart nginx</span><br><span class="line">	    service: &gt;</span><br><span class="line">	        name=nginx</span><br><span class="line">	        state=restarted</span><br></pre></td></tr></table></figure>
<pre><code>  task将handler的名字`restart nginx`作为参数传递，只有`install nginx`这个task被执行成功了，才会触发`restart nginx`
</code></pre>
<blockquote>
<p>  注意：handler只会在task执行完毕了才会执行，即使触发了很多次也只会执行一次</p>
</blockquote>
<h3 id="五、inventory：描述你的服务器"><a href="#五、inventory：描述你的服务器" class="headerlink" title="五、inventory：描述你的服务器"></a>五、inventory：描述你的服务器</h3><h4 id="1-inventory描述"><a href="#1-inventory描述" class="headerlink" title="1. inventory描述"></a>1. <strong>inventory描述</strong></h4><p>在Ansible中，描述主机的方法是把它们写到inventory文件中，一个简单的inventory可以只包含一些主机列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">student01</span><br><span class="line">student02.example.com</span><br><span class="line">172.25.0.13</span><br></pre></td></tr></table></figure>
<h4 id="2-inventory行为参数"><a href="#2-inventory行为参数" class="headerlink" title="2. inventory行为参数"></a>2. <strong>inventory行为参数</strong></h4><table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">默认值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ansible_ssh_host</td>
<td align="left">主机的名字</td>
<td align="left">ssh目的主机</td>
</tr>
<tr>
<td align="left">ansible_ssh_port</td>
<td align="left">22</td>
<td align="left">ssh目的端口</td>
</tr>
<tr>
<td align="left">ansible_ssh_user</td>
<td align="left">root</td>
<td align="left">ssh登录用户</td>
</tr>
<tr>
<td align="left">ansible_ssh_pass</td>
<td align="left">none</td>
<td align="left">ssh认证密码</td>
</tr>
<tr>
<td align="left">ansible_connection</td>
<td align="left">smart</td>
<td align="left">ssh连接主机的连接模式</td>
</tr>
<tr>
<td align="left">ansible_ssh_private_key_file</td>
<td align="left">none</td>
<td align="left">ssh认证秘钥</td>
</tr>
<tr>
<td align="left">ansible_shell_type</td>
<td align="left">bash</td>
<td align="left">命令使用的shell</td>
</tr>
<tr>
<td align="left">ansible_python_interpreter</td>
<td align="left">&#x2F;usr&#x2F;bin&#x2F;python</td>
<td align="left">python解释器路径</td>
</tr>
</tbody></table>
<h4 id="3-群组"><a href="#3-群组" class="headerlink" title="3. 群组"></a>3. <strong>群组</strong></h4><p>在执行task的时候，我们希望针对一组主机执行操作，这时候就可以定义群组，Ansible有一个默认的群组<code>all</code>，包含了所有的主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># ansible all -i playbook/inventory/hosts -a &#x27;date&#x27;</span></span><br><span class="line">student02 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Fri May 19 16:11:53 CST 2017</span><br><span class="line"></span><br><span class="line">student03 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Fri May 19 16:11:53 CST 2017</span><br></pre></td></tr></table></figure>
<p>我们可以在inventory文件中定义自己的群组，inventory文件是<code>.ini</code>格式的，在<code>.ini</code>格式中，同类的配置值归类在一起组成区段，我定义了一个群组webserver，包含两台主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver]</span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br><span class="line">student03 ansible_ssh_host=172.25.0.13 ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
<p>上面的playbook&#x2F;inventory&#x2F;hosts中，student02是主机<code>172.25.0.12</code>的别名，指定ssh端口为22</p>
<h4 id="4-群组嵌套"><a href="#4-群组嵌套" class="headerlink" title="4. 群组嵌套"></a>4. 群组嵌套</h4><p>Ansible还支持群组嵌套，定义一个群组包含已经定义的两个群组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver02]</span><br><span class="line">student02 ansible_ssh_host=172.25.0.12 ansible_ssh_port=22</span><br><span class="line">[webserver03]</span><br><span class="line">student03 ansible_ssh_host=172.25.0.13 ansible_ssh_port=22</span><br><span class="line">[webserver]</span><br><span class="line">webserver02</span><br><span class="line">webserver03</span><br></pre></td></tr></table></figure>
<h4 id="5-编号主机"><a href="#5-编号主机" class="headerlink" title="5. 编号主机"></a>5. 编号主机</h4><p>当inventory包含很多主机的时候，可以通过编号范围指定主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/inventory/hosts </span></span><br><span class="line">[webserver]</span><br><span class="line">student[01:20] ansible_ssh_port=22</span><br></pre></td></tr></table></figure>
<h4 id="6-群组变量"><a href="#6-群组变量" class="headerlink" title="6. 群组变量"></a>6. 群组变量</h4><p>可以在工作目录playbook目录中新建目录host_vars&#x2F;production来存放变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># cat playbook/host_vars/production/webserver </span></span><br><span class="line">webserver:</span><br><span class="line">name=webserver</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/13/nginx%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E6%AD%A5%E9%AA%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/13/nginx%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E6%AD%A5%E9%AA%A4/" class="post-title-link" itemprop="url">nginx版本升级步骤</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-13 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-13T00:00:00+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:12:17" itemprop="dateModified" datetime="2022-12-14T16:12:17+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="nginx-x2F-openresty版本升级"><a href="#nginx-x2F-openresty版本升级" class="headerlink" title="nginx&#x2F;openresty版本升级"></a>nginx&#x2F;openresty版本升级</h3><hr>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWAAAABICAMAAAD/N9+RAAAAVFBMVEUAAAAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQAAmQDBect+AAAAG3RSTlMAB0AY8SD5SM82v1npsJ/YjSl0EVLftqllgMdZgsoQAAAHd0lEQVR42szZ6XabMBCG4ZGFxSazLzZz//fZc9I4JpbEN8LQ0/dnGwJ5DJGG0HdpM9kkuzVXiqussmRpLrRdnwqDp9ePyY7zXdFbqptHOz00RTVUxWiyquvJ26Upknp2/heWN0Uyzt3qYtKMn805ybsW/LdK01YVC6sVELH81XJ9o6j5q6Qkcepe83dJp8ipf161HSgm1TyPK5//cuN1d5KmE342bsnkLK6hre78LNG0KuWfOrFDwats69w8ln+qFIlrx9Vxf8808e8eJGx9YEXhCpZ3kX2gfFtbrX4m05IonTE7wsGLnpXY1/Kqr3v/5r+NcAOvy8HXCRt74W+alH568KqCJKmM37LafVhe3ZTU1/mmA7uV9Ar8vPjZVCPDZI+CDdwFC68yIooZnbhmIAx8XyoZu5mcYO9HzhSo47gGCqR53ULPlAGPkuyazJVeKWYsjH15Djy/VhPO8LoM/OJE4XNfeJ19LUfRj18KF9gLA2GZL4/UsLdFHQVccWyTCDjZD9wm7Kt2PgIgjH3ZBlf46iDgnOO7nwusavZmVoCaPU0q1pcnshyoOwa44PiS66nANw7U0isbK5x7j3gQB0uPAB54T8WZwA/RHrxhLIx9TbsBnLSfA6uRd9WdBzywCFiNUcJ5wr4eRByu7j8G7nhfpj0LuE0A8OtsSBj7ZooIL+dyYLxFm27+EvfSzgHua/GYXrK3Qol9a03bwNxEAeMt2ix/bptzgCeGwFhY7ouAufwIOA/PSni3nJ8B3DAElgtjXwxs8k+Al/BdiVfDWh0PPDAAjhXGvgTnVjkwujzbk1t4TWkOB24TBBwrjH2JQZnaC6xGsPdCT296MHA/MgKWC2NfL7Blp2ov8AM88/gNbX8osCrc5xMAA2Ho6wIXHTt1+4C1iZwMW8NvzYcCN67vAICBMPZ1galip3QXcAXHXzyVlB8AYyiT5wAYCWNfF1gtYGYWAufhNynyTWqiDwPOjeelnQiYShMQBr5+YNIWzMwy4CX69afv1NNRwHr07FKEwDT4hTPs6wL7P+tCxQKXm/eifJ963wmMF7hCYWBXGJdpAsBUopkZAyv3j3+i9PUtTa/U9VcAGC1wmgAwFsa+LnBooLxj4K0t2qjo8AAwWuAIAO8TznoSANMEZmYErA14p3EyMF7gSgLAQBj4ImBVg5kZAM/8u4VAJwJ7l+2GADAQBr4A2D+1Z0oMnKM3Y2cD4wUOAANh5IuB6cJOsxg4Q0eeCwwXuFETBnZLDfSVA1NwZsbAJXwN/C+B7771BAAjYeyLgX0z8yACVlawx1NaXh+5TcMLHACGwtgXA6OZ2QUObdGsorfabjIsr4wcNOACB4CBMPLFwOHpcuwx8NWgLXTJURW0H1gtngUOA8cLLz1FAsOZWQ4MfFH5B8CV7x75b4D/NHduS47CMBCVwYFAiDEmCQT+/z/3ZWumah1otZdL/MxMZc5gybJanU8tLI9DhF8PESXJ10k64PAxyn1LiPisMhr/N8kNHF+bpwPOis95+juS3IJOrsgQYBlXj2mWFVHRgHGC+4pj2kKjbG4ufKGRLmdtTTJgc12WKn1BofE7zBTXzAhwtlIqP9h5gmTAbq1xcHqpvBbHBgRY7suXPTl/ROMB4wR36mUPKjXnNwLcrVxXXimRZTLgDBSiZ15XYj3XAwAWv3zh7gnAXtIAx6Etnq888cIdX/fZDgDul1tGvf4Vtn0S4M8J7i7ROq1lhCVHzzwGvBpYbJ5AOEgq4EEzZn5K01MrmqvNOmDTLrft+8FSRzQecFBpO05p26tlnw7oIso14YnJ3i5aL6DF0wMuleqkM4Qn+smcAKRTL1Y65UDQVAO+WK2+7gTplH54usjWAXek+K+LCuxEwGMLul0R4EPFfz8L18zzKmDxIKSCN95LIuBGr3GujpevErqxGQDuLaPuyUAfBAPGg6Mx4OME2DhQVgUJWAIzQnBFfRAeMI5N1XEjBBiwjCxg0+qHYG7wt/GA8capDh+CqYkpCoykjPKWesio2gywEwD4qDEuDNjUJGCptQqUAB5MB3w1APBhg4gYsPQtCbib00Zpi3wrwM1FAOBjR2lrZBXCARY3J623bAS4yAQAPnIYHAOWkgSc2xS+T7MV4CAA8LF2BhiwBAwYP4+lPBsBdgIAH2XIgQHjTf+SrRw5auEAG5Dg9ID3t5TBgM3EWR88eMAVCVieYM5aDXgHUyQAmKiZR9nIFckJC/gFnALUgHew9QKAiZq5A3+EXspDAw7gP64GvIcxXQvfHl2B7tiozSf+y1JSNQ31gRYDQb6HteKQ4B3s4QucflRrDW8OKiHBujCO3s0u5qAjwKR0vnkDozL1emgd5W6EWa1ud7l97G0n3jhYzACOEMlHtVpjeBA/mLf/7IOoQsa7y+b7GDR3Rbw98fKQLy+5xv7VIXowIhy1ztUfbdzLYrz7cbrvRb/K+nf7wPPQpAXsEQ/7l2AXW97/AGkCwaNsIif8zU3y5eZaO/mK/jKDV1s872/Fz11K5TLE1zzEiP1km8ndDMcj3JvmFfqdvubhD8TgHPiN+LViAAAAAElFTkSuQmCC"></p>
<blockquote>
<p>nginx和openresty升级方式大同小异，这里以openresty为例介绍openresty平滑升级的详细操作方法</p>
</blockquote>
<h4 id="1-查看nginx当前版本以及编译参数"><a href="#1-查看nginx当前版本以及编译参数" class="headerlink" title="1. 查看nginx当前版本以及编译参数"></a>1. 查看nginx当前版本以及编译参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~<span class="comment"># /usr/local/openresty/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: openresty/1.11.2.1</span><br><span class="line">configure arguments: --prefix=/usr/local/openresty/nginx</span><br></pre></td></tr></table></figure>

<h4 id="2-下载最新版本nginx-解压"><a href="#2-下载最新版本nginx-解压" class="headerlink" title="2. 下载最新版本nginx,解压"></a>2. 下载最新版本nginx,解压</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~<span class="comment"># wget https://openresty.org/download/openresty-1.11.2.4.tar.gz -O /tmp/openresty-1.11.2.4.tar.gz</span></span><br><span class="line">root@yunwei:~<span class="comment"># cd /tmp/</span></span><br><span class="line">root@yunwei:/tmp<span class="comment"># tar -xzvf openresty-1.11.2.4.tar.gz</span></span><br></pre></td></tr></table></figure>

<h4 id="3-编译openresty"><a href="#3-编译openresty" class="headerlink" title="3. 编译openresty"></a>3. 编译openresty</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:/tmp<span class="comment"># cd openresty-1.11.2.4/</span></span><br><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># ./configure --prefix=/usr/local/openresty  --with-luajit --with-http_iconv_module --with-http_stub_status_module --add-module=../ngx_dynamic_upstream-master -j6 &amp;&amp; make -j6</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：不要进行make install，这里的编译参数要与原环境编译参数一致，否则可能引起服务启动失败</p>
</blockquote>
<h4 id="4-找到编辑的二进制命令，测试能否执行"><a href="#4-找到编辑的二进制命令，测试能否执行" class="headerlink" title="4. 找到编辑的二进制命令，测试能否执行"></a>4. 找到编辑的二进制命令，测试能否执行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># ls build/nginx-1.11.2/objs/nginx</span></span><br><span class="line">build/nginx-1.11.2/objs/nginx</span><br><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># build/nginx-1.11.2/objs/nginx -v</span></span><br><span class="line">nginx version: openresty/1.11.2.4</span><br></pre></td></tr></table></figure>

<h4 id="5-备份旧版本的nginx文件"><a href="#5-备份旧版本的nginx文件" class="headerlink" title="5. 备份旧版本的nginx文件"></a>5. 备份旧版本的nginx文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@openresty-japi-write01:~<span class="comment"># cp /usr/local/openresty/nginx/sbin/nginx /tmp/nginx.bak</span></span><br></pre></td></tr></table></figure>

<h4 id="6-使用编译生成的二进制nginx文件，升级生产环境版本"><a href="#6-使用编译生成的二进制nginx文件，升级生产环境版本" class="headerlink" title="6. 使用编译生成的二进制nginx文件，升级生产环境版本"></a>6. 使用编译生成的二进制nginx文件，升级生产环境版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># install build/nginx-1.11.2/objs/nginx /usr/local/openresty/nginx/sbin/nginx</span></span><br><span class="line">root@yunwei:/tmp/openresty-1.11.2.4<span class="comment"># /usr/local/openresty/nginx/sbin/nginx -v</span></span><br><span class="line">nginx version: openresty/1.11.2.4</span><br></pre></td></tr></table></figure>

<h4 id="7-在不影响生产环境的情况下重启nginx服务，才能生效"><a href="#7-在不影响生产环境的情况下重启nginx服务，才能生效" class="headerlink" title="7. 在不影响生产环境的情况下重启nginx服务，才能生效"></a>7. 在不影响生产环境的情况下重启nginx服务，才能生效</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~# /usr/local/openresty/nginx/sbin/nginx -s stop</span><br><span class="line">root@yunwei:~# /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">root@yunwei:~# curl -I 127.0.0.1:8081</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Server: openresty/1.11.2.4</span><br><span class="line">Date: Thu, 13 Jul 2017 08:34:35 GMT</span><br></pre></td></tr></table></figure>

<h4 id="8-最后检查日志是否正常"><a href="#8-最后检查日志是否正常" class="headerlink" title="8. 最后检查日志是否正常"></a>8. 最后检查日志是否正常</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@yunwei:~<span class="comment"># tailf /data/nginx/log/access.log</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/13/nginx%E7%9A%84%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/13/nginx%E7%9A%84%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">nginx的学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-13 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-13T00:00:00+08:00">2017-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:12:17" itemprop="dateModified" datetime="2022-12-14T16:12:17+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、用户访问网站的完整访问流程"><a href="#一、用户访问网站的完整访问流程" class="headerlink" title="一、用户访问网站的完整访问流程"></a>一、用户访问网站的完整访问流程</h3><h4 id="1-客户端用户在浏览器输入网址www-baidu-com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www-baidu-com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www-baidu-com的服务器。"><a href="#1-客户端用户在浏览器输入网址www-baidu-com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www-baidu-com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www-baidu-com的服务器。" class="headerlink" title="1. 客户端用户在浏览器输入网址www.baidu.com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www.baidu.com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www.baidu.com的服务器。"></a>1. 客户端用户在浏览器输入网址<a target="_blank" rel="noopener" href="http://www.baidu.com,回车后,系统首先会查找系统本地的dns缓存及hosts文件信息,确定是否存在www.baidu.com域名对应的ip解析记录,如果有就直接获取ip地址,然后去访问这个ip地址对应的域名www.baidu.com的服务器./">www.baidu.com，回车后，系统首先会查找系统本地的DNS缓存及hosts文件信息，确定是否存在www.baidu.com域名对应的ip解析记录，如果有就直接获取ip地址，然后去访问这个ip地址对应的域名www.baidu.com的服务器。</a></h4><h4 id="2-如果客户端本地DNS缓存及hosts文件没有www-baidu-com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local-DNS服务器解析，如果local-DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local-DNS会请求其他的DNS服务器"><a href="#2-如果客户端本地DNS缓存及hosts文件没有www-baidu-com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local-DNS服务器解析，如果local-DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local-DNS会请求其他的DNS服务器" class="headerlink" title="2. 如果客户端本地DNS缓存及hosts文件没有www.baidu.com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local DNS服务器解析，如果local DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local DNS会请求其他的DNS服务器"></a>2. 如果客户端本地DNS缓存及hosts文件没有<a target="_blank" rel="noopener" href="http://www.baidu.com域名对应的ip解析记录,那么系统会把浏览器的解析请求发送给客户端本地设置的local/">www.baidu.com域名对应的ip解析记录，那么系统会把浏览器的解析请求发送给客户端本地设置的local</a> DNS服务器解析，如果local DNS服务器的本地缓存有对应的解析记录就会返回IP地址给客户端，如果没有，则local DNS会请求其他的DNS服务器</h4><h4 id="3-local-DNS从DNS系统的根开始请求对www-baidu-com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www-baidu-com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www-baidu-com对应的ip解析记录，如果没有解析记录，表示企业没有对www-baidu-com域名做解析设置，即网站没有架设好"><a href="#3-local-DNS从DNS系统的根开始请求对www-baidu-com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www-baidu-com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www-baidu-com对应的ip解析记录，如果没有解析记录，表示企业没有对www-baidu-com域名做解析设置，即网站没有架设好" class="headerlink" title="3. local DNS从DNS系统的根开始请求对www.baidu.com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www.baidu.com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www.baidu.com对应的ip解析记录，如果没有解析记录，表示企业没有对www.baidu.com域名做解析设置，即网站没有架设好"></a>3. local DNS从DNS系统的根开始请求对<a target="_blank" rel="noopener" href="http://www.baidu.com域名的解析,并针对各个层级的dns服务器系统进行一系列的查找,最终会找到www.baidu.com域名对应的授权dns服务器,而这个授权的dns服务器是企业购买域名时用于管理域名解析的服务器,这个授权服务器会有www.baidu.com对应的ip解析记录,如果没有解析记录,表示企业没有对www.baidu.com域名做解析设置,即网站没有架设好/">www.baidu.com域名的解析，并针对各个层级的DNS服务器系统进行一系列的查找，最终会找到www.baidu.com域名对应的授权DNS服务器，而这个授权的DNS服务器是企业购买域名时用于管理域名解析的服务器，这个授权服务器会有www.baidu.com对应的ip解析记录，如果没有解析记录，表示企业没有对www.baidu.com域名做解析设置，即网站没有架设好</a></h4><h4 id="4-www-baidu-com域名的授权DNS服务器会把www-baidu-com对应的最终ip解析记录发给local-DNS"><a href="#4-www-baidu-com域名的授权DNS服务器会把www-baidu-com对应的最终ip解析记录发给local-DNS" class="headerlink" title="4. www.baidu.com域名的授权DNS服务器会把www.baidu.com对应的最终ip解析记录发给local DNS"></a>4. <a target="_blank" rel="noopener" href="http://www.baidu.com域名的授权dns服务器会把www.baidu.com对应的最终ip解析记录发给local/">www.baidu.com域名的授权DNS服务器会把www.baidu.com对应的最终ip解析记录发给local</a> DNS</h4><h4 id="5-local-DNS把来自授权DNS服务器www-baidu-com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS-TTL值控制的时间内不会过期"><a href="#5-local-DNS把来自授权DNS服务器www-baidu-com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS-TTL值控制的时间内不会过期" class="headerlink" title="5. local DNS把来自授权DNS服务器www.baidu.com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS TTL值控制的时间内不会过期"></a>5. local DNS把来自授权DNS服务器<a target="_blank" rel="noopener" href="http://www.baidu.com对应的ip解析记录发给客户端浏览器,并且他会把该域名和ip的对应解析缓存起来,以便下一次更快的返回相同解析请求的记录,这些缓存记录在dns/">www.baidu.com对应的ip解析记录发给客户端浏览器，并且他会把该域名和ip的对应解析缓存起来，以便下一次更快的返回相同解析请求的记录，这些缓存记录在DNS</a> TTL值控制的时间内不会过期</h4><h4 id="6-客户端浏览器获取www-baidu-com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器"><a href="#6-客户端浏览器获取www-baidu-com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器" class="headerlink" title="6. 客户端浏览器获取www.baidu.com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器"></a>6. 客户端浏览器获取<a target="_blank" rel="noopener" href="http://www.baidu.com的对应ip,浏览器会请求获得ip地址对应的网站服务器,网站服务器接收到客户的请求并响应处理,将客户请求的内容返回给客户端浏览器/">www.baidu.com的对应ip，浏览器会请求获得ip地址对应的网站服务器，网站服务器接收到客户的请求并响应处理，将客户请求的内容返回给客户端浏览器</a></h4><h3 id="二、ginx源码包安装"><a href="#二、ginx源码包安装" class="headerlink" title="二、ginx源码包安装"></a>二、ginx源码包安装</h3><h4 id="1-安装Nginx依赖包"><a href="#1-安装Nginx依赖包" class="headerlink" title="1. 安装Nginx依赖包"></a>1. 安装Nginx依赖包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># yum -y install gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel open openssl-devel</span></span><br></pre></td></tr></table></figure>
<h4 id="2-解压nginx安装包"><a href="#2-解压nginx安装包" class="headerlink" title="2. 解压nginx安装包"></a>2. 解压nginx安装包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># tar -xzvf nginx-1.13.0.tar.gz</span></span><br></pre></td></tr></table></figure>
<h4 id="3-生成Makefile文件"><a href="#3-生成Makefile文件" class="headerlink" title="3. 生成Makefile文件"></a>3. 生成Makefile文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># cd nginx-1.13.0/</span></span><br><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx-1.13.0 --with-http_stub_status_module --with-http_ssl_module</span></span><br><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># ll Makefile </span></span><br><span class="line">-rw-r--r--. 1 root root 376 May 22 10:39 Makefile</span><br></pre></td></tr></table></figure>
<h4 id="4-nginx的编译安装"><a href="#4-nginx的编译安装" class="headerlink" title="4. nginx的编译安装"></a>4. nginx的编译安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@student02 ~]<span class="comment"># useradd nginx -s /sbin/nologin -M</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ln -s /usr/local/nginx-1.13.0 /usr/local/nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ln -s /usr/local/nginx/sbin/nginx /usr/sbin/nginx</span></span><br></pre></td></tr></table></figure>
<h4 id="5-nginx安装目录介绍"><a href="#5-nginx安装目录介绍" class="headerlink" title="5. nginx安装目录介绍"></a>5. nginx安装目录介绍</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 nginx-1.13.0]<span class="comment"># cd /usr/local/nginx/</span></span><br><span class="line">[root@student02 nginx]<span class="comment"># ls</span></span><br><span class="line">conf  html  logs  sbin</span><br></pre></td></tr></table></figure>
<blockquote>
<p>conf存放了nginx所有的配置文件，nginx.conf是nginx的主配置文件，html目录存放了nginx服务器在运行过程中调用的网页文件，logs目录存放nginx的日志，sbin目录只有一个nginx文件，是nginx服务器的主程序</p>
</blockquote>
<h4 id="6-nginx的版本"><a href="#6-nginx的版本" class="headerlink" title="6. nginx的版本"></a>6. nginx的版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -v</span></span><br><span class="line">nginx version: nginx/1.10.2</span><br></pre></td></tr></table></figure>
<h4 id="7-检查nginx配置文件语法"><a href="#7-检查nginx配置文件语法" class="headerlink" title="7. 检查nginx配置文件语法"></a>7. 检查nginx配置文件语法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure>
<h4 id="8-启动nginx服务"><a href="#8-启动nginx服务" class="headerlink" title="8. 启动nginx服务"></a>8. 启动nginx服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ps -ef |grep nginx</span></span><br><span class="line">root       3757      1  0 11:00 ?        00:00:00 nginx: master process nginx</span><br><span class="line">nginx      3758   3757  0 11:00 ?        00:00:00 nginx: worker process</span><br><span class="line">root       3760   1074  0 11:00 pts/0    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>
<h4 id="9-重启nginx服务"><a href="#9-重启nginx服务" class="headerlink" title="9. 重启nginx服务"></a>9. 重启nginx服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># nginx -s stop</span></span><br><span class="line">[root@student02 ~]<span class="comment"># nginx</span></span><br><span class="line">[root@student02 ~]<span class="comment"># nginx -s reload</span></span><br></pre></td></tr></table></figure>
<h4 id="10-查看nginx服务端口"><a href="#10-查看nginx服务端口" class="headerlink" title="10. 查看nginx服务端口"></a>10. 查看nginx服务端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># lsof -i :80</span></span><br><span class="line">COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx   3757  root    8u  IPv4  23526      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   3757  root    9u  IPv6  23527      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   3809 nginx    8u  IPv4  23526      0t0  TCP *:http (LISTEN)</span><br><span class="line">nginx   3809 nginx    9u  IPv6  23527      0t0  TCP *:http (LISTEN)</span><br><span class="line">[root@student02 ~]<span class="comment"># netstat -nultp |grep :80&#x27; &#x27;</span></span><br><span class="line">tcp        0      0 0.0.0.0:80    0.0.0.0:*      LISTEN  3757/nginx: master</span><br><span class="line">tcp6       0      0 :::80         :::*           LISTEN  3757/nginx: master</span><br></pre></td></tr></table></figure>
<h4 id="11-检测nginx访问"><a href="#11-检测nginx访问" class="headerlink" title="11. 检测nginx访问"></a>11. 检测nginx访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># wget 172.25.0.12</span></span><br><span class="line">[root@student02 ~]<span class="comment"># curl 172.25.0.12</span></span><br></pre></td></tr></table></figure>

<h3 id="三、HTTP协议"><a href="#三、HTTP协议" class="headerlink" title="三、HTTP协议"></a>三、HTTP协议</h3><h4 id="1-HTTP的请求方法"><a href="#1-HTTP的请求方法" class="headerlink" title="1. HTTP的请求方法"></a>1. HTTP的请求方法</h4><p>在HTTP通信中，每个HTTP请求报文都包含一个请求方法，用于告诉web服务器需要执行哪些具体动作，这些动作包括：获取指定web页面、提交内容到服务器、删除服务器上资源文件等，这些HTTP请求报文的方法称作HTTP请求方法</p>
<table>
<thead>
<tr>
<th align="left">HTTP请求方法</th>
<th align="left">作用描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">客户端请求指定资源信息，服务器返回指定资源</td>
</tr>
<tr>
<td align="left">HEAD</td>
<td align="left">值请求相应报文中的HTTP首部</td>
</tr>
<tr>
<td align="left">POST</td>
<td align="left">将客户端的数据提交到服务器</td>
</tr>
<tr>
<td align="left">PUT</td>
<td align="left">从客户端上传数据取代指定的文档内容</td>
</tr>
<tr>
<td align="left">DELETE</td>
<td align="left">请求服务器删除Request-URI所标识的资源</td>
</tr>
<tr>
<td align="left">MOVE</td>
<td align="left">请求服务器将指定的页面移至另一个网络地址</td>
</tr>
</tbody></table>
<h4 id="2-HTTP状态码"><a href="#2-HTTP状态码" class="headerlink" title="2. HTTP状态码"></a>2. HTTP状态码</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/ELK%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E8%B0%83%E4%BC%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/ELK%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E8%B0%83%E4%BC%98/" class="post-title-link" itemprop="url">ELK日志系统安装调优</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-11T00:00:00+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:12:17" itemprop="dateModified" datetime="2022-12-14T16:12:17+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ELK日志系统安装调优"><a href="#ELK日志系统安装调优" class="headerlink" title="ELK日志系统安装调优"></a>ELK日志系统安装调优</h2><p>@(ELK安装配置手册)[运维,基本操作, 安装]</p>
<p>[TOC]</p>
<h3 id="ELK日志系统安装"><a href="#ELK日志系统安装" class="headerlink" title="ELK日志系统安装"></a>ELK日志系统安装</h3><h4 id="zookeeper安装"><a href="#zookeeper安装" class="headerlink" title="zookeeper安装"></a>zookeeper安装</h4><blockquote>
<p>zookeeper是kafka的组件，部署在kafka节点上</p>
</blockquote>
<ol>
<li><p>官网下载zookeeper</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/stable/apache-zookeeper-3.5.5-bin.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf apache-zookeeper-3.5.5-bin.tar.gz -C /opt/</span><br><span class="line"><span class="built_in">ln</span> -sf /opt/apache-zookeeper-3.5.5-bin /opt/zookeeper</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/opt/zookeeper/conf/zoo.cfg &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">tickTime=2000</span></span><br><span class="line"><span class="string">dataDir=/data/zookeeper/data</span></span><br><span class="line"><span class="string">dataLogDir=/data/zookeeper/logs</span></span><br><span class="line"><span class="string">clientPort=2181</span></span><br><span class="line"><span class="string">admin.serverPort=2182</span></span><br><span class="line"><span class="string">initLimit=10</span></span><br><span class="line"><span class="string">syncLimit=5</span></span><br><span class="line"><span class="string">server.1=172.22.3.61:2888:3888</span></span><br><span class="line"><span class="string">server.2=172.22.3.62:2888:3888</span></span><br><span class="line"><span class="string">server.3=172.22.3.63:2888:3888</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成唯一myid</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/zookeeper/data /data/zookeeper/logs</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;/data/zookeeper/data/myid</span><br><span class="line"><span class="built_in">echo</span> 2 &gt;/data/zookeeper/data/myid</span><br><span class="line"><span class="built_in">echo</span> 3 &gt;/data/zookeeper/data/myid</span><br></pre></td></tr></table></figure>
</li>
<li><p>systemd启动zookeeper</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/zookeeper.service &lt;&lt;-<span class="string">EOF </span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=zookeeper</span></span><br><span class="line"><span class="string">After=network.target remote-fs.target nss-lookup.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">Environment=&quot;JAVA_HOME=/opt/jdk&quot;</span></span><br><span class="line"><span class="string">ExecStart=/opt/zookeeper/bin/zkServer.sh start /opt/zookeeper/conf/zoo.cfg</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill \$MAINPID</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> zookeeper.service</span><br><span class="line">systemctl start zookeeper.service</span><br></pre></td></tr></table></figure>

<h4 id="kafka安装"><a href="#kafka安装" class="headerlink" title="kafka安装"></a>kafka安装</h4><blockquote>
<p>kafka推荐三台4C8G集群，100G的SSD磁盘，日志保留12小时。</p>
</blockquote>
<ol>
<li><p>官网下载kafka</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.3.0/kafka_2.12-2.3.0.tgz</span><br></pre></td></tr></table></figure></li>
<li><p>解压文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf kafka_2.12-2.3.0.tgz -C /opt/</span><br><span class="line"><span class="built_in">ln</span> -s /opt/kafka_2.12-2.3.0 /opt/kafka</span><br></pre></td></tr></table></figure></li>
<li><p>修改配置，broker.id为1,2,3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /opt/kafka/config/server.properties &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">broker.id=1</span></span><br><span class="line"><span class="string">delete.topic.enable=true</span></span><br><span class="line"><span class="string">listeners=PLAINTEXT://0.0.0.0:9092</span></span><br><span class="line"><span class="string">num.network.threads=3</span></span><br><span class="line"><span class="string">num.io.threads=8</span></span><br><span class="line"><span class="string">socket.send.buffer.bytes=1024000</span></span><br><span class="line"><span class="string">socket.receive.buffer.bytes=1024000</span></span><br><span class="line"><span class="string">socket.request.max.bytes=104857600</span></span><br><span class="line"><span class="string">log.dirs=/data/kafka/logs</span></span><br><span class="line"><span class="string">num.partitions=3</span></span><br><span class="line"><span class="string">default.replication.factor=2</span></span><br><span class="line"><span class="string">num.recovery.threads.per.data.dir=2</span></span><br><span class="line"><span class="string">offsets.topic.replication.factor=2</span></span><br><span class="line"><span class="string">transaction.state.log.replication.factor=2</span></span><br><span class="line"><span class="string">transaction.state.log.min.isr=2</span></span><br><span class="line"><span class="string">log.retention.hours=24</span></span><br><span class="line"><span class="string">log.segment.bytes=1073741824</span></span><br><span class="line"><span class="string">log.retention.check.interval.ms=300000</span></span><br><span class="line"><span class="string">zookeeper.connect=172.22.3.61:2181,172.22.3.62:2181,172.22.3.63:2181</span></span><br><span class="line"><span class="string">zookeeper.connection.timeout.ms=6000</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>systemd启动kafka</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/kafka.service &lt;&lt;-<span class="string">EOF </span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=kafka</span></span><br><span class="line"><span class="string">After=network.target remote-fs.target nss-lookup.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">Environment=&quot;JAVA_HOME=/opt/jdk&quot;</span></span><br><span class="line"><span class="string">ExecStart=/opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill \$MAINPID</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/kafka/data /data/kafka/logs</span><br><span class="line">systemctl <span class="built_in">enable</span> kafka.service</span><br><span class="line">systemctl start kafka.service</span><br></pre></td></tr></table></figure>

<h4 id="filebeat安装"><a href="#filebeat安装" class="headerlink" title="filebeat安装"></a>filebeat安装</h4><blockquote>
<p>每台需要收集日志的节点需要安装filebeat，将生产的日志发送给kafka保存起来</p>
</blockquote>
<ol>
<li><p>官网下载filebeat</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.2-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p>解压文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf filebeat-7.3.2-linux-x86_64.tar.gz -C /opt/</span><br><span class="line"><span class="built_in">ln</span> -s /opt/filebeat-7.3.2-linux-x86_64 /opt/filebeat</span><br></pre></td></tr></table></figure>
</li>
<li><p>applog filebeat配置，type需要修改（line8-applog、tech-applog）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/opt/filebeat/filebeat.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="string">- type: log</span></span><br><span class="line"><span class="string">  paths:</span></span><br><span class="line"><span class="string">  - /data/logs/*/*.log</span></span><br><span class="line"><span class="string">  fields:</span></span><br><span class="line"><span class="string">    type: $&#123;HOSTNAME%%-*&#125;-applog</span></span><br><span class="line"><span class="string">  multiline:</span></span><br><span class="line"><span class="string">    pattern: &#x27;^\|&#x27;</span></span><br><span class="line"><span class="string">    negate: true</span></span><br><span class="line"><span class="string">    match: after</span></span><br><span class="line"><span class="string">  tail_files: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">output.kafka:</span></span><br><span class="line"><span class="string">  hosts: [&quot;172.22.3.61:9092&quot;, &quot;172.22.3.62:9092&quot;, &quot;172.22.3.63:9092&quot;]</span></span><br><span class="line"><span class="string">  topic: &#x27;%&#123;[fields][type]&#125;&#x27;</span></span><br><span class="line"><span class="string">  partition.round_robin:</span></span><br><span class="line"><span class="string">    reachable_only: false</span></span><br><span class="line"><span class="string">  compression: gzip</span></span><br><span class="line"><span class="string">  max_message_bytes: 1000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">logging.to_files: true</span></span><br><span class="line"><span class="string">logging.files:</span></span><br><span class="line"><span class="string">  path: /var/log/filebeat</span></span><br><span class="line"><span class="string">  name: filebeat</span></span><br><span class="line"><span class="string">  rotateeverybytes: 10485760</span></span><br><span class="line"><span class="string">  keepfiles: 7</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>nginx filebeat配置，type需要修改（nginx-access、pre-nginx-access）</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/opt/filebeat/filebeat.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="string">- type: log</span></span><br><span class="line"><span class="string">  paths:</span></span><br><span class="line"><span class="string">  - /data/nginx/logs/access.log</span></span><br><span class="line"><span class="string">  fields:</span></span><br><span class="line"><span class="string">    type: nginx-access</span></span><br><span class="line"><span class="string">  tail_files: true</span></span><br><span class="line"><span class="string">- type: log</span></span><br><span class="line"><span class="string">  paths:</span></span><br><span class="line"><span class="string">  - /data/nginx/logs/error.log</span></span><br><span class="line"><span class="string">  fields:</span></span><br><span class="line"><span class="string">    type: nginx-error</span></span><br><span class="line"><span class="string">  tail_files: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">output.kafka:</span></span><br><span class="line"><span class="string">  hosts: [&quot;172.22.3.61:9092&quot;, &quot;172.22.3.62:9092&quot;, &quot;172.22.3.63:9092&quot;]</span></span><br><span class="line"><span class="string">  topic: &#x27;%&#123;[fields][type]&#125;&#x27;</span></span><br><span class="line"><span class="string">  partition.round_robin:</span></span><br><span class="line"><span class="string">    reachable_only: false</span></span><br><span class="line"><span class="string">  compression: gzip</span></span><br><span class="line"><span class="string">  max_message_bytes: 1000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">logging.to_files: true</span></span><br><span class="line"><span class="string">logging.files:</span></span><br><span class="line"><span class="string">  path: /var/log/filebeat</span></span><br><span class="line"><span class="string">  name: filebeat</span></span><br><span class="line"><span class="string">  rotateeverybytes: 10485760</span></span><br><span class="line"><span class="string">  keepfiles: 7</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>


<ol start="5">
<li>systemd启动服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/systemd/system/filebeat.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=filebeat</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">ExecStart=/opt/filebeat/filebeat -c /opt/filebeat/filebeat.yml</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill \$MAINPID</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl <span class="built_in">enable</span> filebeat.service</span><br><span class="line">systemctl start filebeat.service</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="elasticsearch安装"><a href="#elasticsearch安装" class="headerlink" title="elasticsearch安装"></a>elasticsearch安装</h4><blockquote>
<p>elasticsearch推荐单台配置为16U64G，JVM为31G，每台可以处理日志1w条&#x2F;s，1亿日志、50G磁盘空间，计算自己适合的台数。</p>
</blockquote>
<ol>
<li><p>官网下载elasticsearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.3.2-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p>解压文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf elasticsearch-7.4.2-linux-x86_64.tar.gz -C /opt/</span><br><span class="line"><span class="built_in">ln</span> -sf /opt/elasticsearch-7.4.2 /opt/elasticsearch</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/opt/elasticsearch/config/elasticsearch.yml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">cluster.name: sre-elasticsearch-prod</span></span><br><span class="line"><span class="string">node.name: sre-elasticsearch-prod01</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">bootstrap.memory_lock: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">path.data: /data/elasticsearch/data</span></span><br><span class="line"><span class="string">path.logs: /data/elasticsearch/logs</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">network.host: 0.0.0.0</span></span><br><span class="line"><span class="string">http.port: 9200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts: [&quot;172.22.3.69&quot;, &quot;172.22.3.70&quot;, &quot;172.22.3.71&quot;, &quot;172.22.3.73&quot;, &quot;172.22.3.74&quot;]</span></span><br><span class="line"><span class="string">discovery.zen.minimum_master_nodes: 3</span></span><br><span class="line"><span class="string">cluster.initial_master_nodes: [&quot;172.22.3.69&quot;, &quot;172.22.3.70&quot;, &quot;172.22.3.71&quot;, &quot;172.22.3.73&quot;, &quot;172.22.3.74&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gateway.recover_after_nodes: 3</span></span><br><span class="line"><span class="string">action.destructive_requires_name: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xpack.security.enabled: true</span></span><br><span class="line"><span class="string">xpack.security.transport.ssl.enabled: true</span></span><br><span class="line"><span class="string">xpack.security.transport.ssl.verification_mode: certificate</span></span><br><span class="line"><span class="string">xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12</span></span><br><span class="line"><span class="string">xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>systemd启动elasticsearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/elasticsearch.service &lt;&lt;-<span class="string">EOF </span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=elasticsearch</span></span><br><span class="line"><span class="string">After=network.target remote-fs.target nss-lookup.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=akulaku</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">Environment=&quot;JAVA_HOME=/opt/jdk&quot;</span></span><br><span class="line"><span class="string">ExecStart=/opt/elasticsearch/bin/elasticsearch</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill \$MAINPID</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改jvm参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/elasticsearch/config/jvm.options</span><br></pre></td></tr></table></figure>
</li>
<li><p>几个节点修改完配置后普通用户启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/elasticsearch/data /data/elasticsearch/logs /opt/elasticsearch/config/certs</span><br><span class="line"><span class="built_in">chown</span> akulaku:akulaku -R /data/elasticsearch/ /opt/elasticsearch-7.4.2/</span><br><span class="line">systemctl <span class="built_in">enable</span> elasticsearch.service</span><br><span class="line">systemctl start elasticsearch.service</span><br></pre></td></tr></table></figure></li>
<li><p>修改limit限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system.conf</span><br><span class="line">DefaultLimitCORE=infinity</span><br><span class="line">DefaultLimitNOFILE=655350</span><br><span class="line">DefaultLimitNPROC=204800</span><br><span class="line">DefaultLimitMEMLOCK=infinity</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看服务的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cat/health</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置index模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;order&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: 60001,</span><br><span class="line">  <span class="string">&quot;index_patterns&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;logstash-*&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;2s&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_default_&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;_all&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;message_field&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;path_match&quot;</span>: <span class="string">&quot;message&quot;</span>,</span><br><span class="line">            <span class="string">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">              <span class="string">&quot;norms&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;string_fields&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;match&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">            <span class="string">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">              <span class="string">&quot;norms&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">                  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;ignore_above&quot;</span>: 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;@version&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;geoip&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;dynamic&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;ip&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;latitude&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;half_float&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;longitude&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;half_float&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">          <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aliases&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="安装ik分词"><a href="#安装ik分词" class="headerlink" title="安装ik分词"></a>安装ik分词</h5><ol>
<li>在所有elasticsearch安装ik插件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="安装cerebro"><a href="#安装cerebro" class="headerlink" title="安装cerebro"></a>安装cerebro</h5><ol>
<li><p>下载cerebro管理elasticsearch集群（<a target="_blank" rel="noopener" href="https://github.com/lmenezes/cerebro/releases%EF%BC%89">https://github.com/lmenezes/cerebro/releases）</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/lmenezes/cerebro/releases/download/v0.8.4/cerebro-0.8.4.tgz</span><br></pre></td></tr></table></figure>
<p>tar -xzf cerebro-0.8.4.tgz -C &#x2F;opt&#x2F;<br>ln -s &#x2F;opt&#x2F;cerebro-0.8.4 &#x2F;opt&#x2F;cerebro</p>
</li>
<li><p>systemd启动cerebro</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/systemd/system/cerebro.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=cerebro</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">Environment=&quot;JAVA_HOME=/opt/jdk&quot;</span></span><br><span class="line"><span class="string">ExecStart=/opt/cerebro/bin/cerebro</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill -s QUIT \$MAINPID</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="logstash安装"><a href="#logstash安装" class="headerlink" title="logstash安装"></a>logstash安装</h4><pre><code>&gt; logstash建议单台处理所有topic，JVM为机器内存90%，不会存在资源分配不均衡的问题，logstash需要注意的是pipeline.batch.size和pipeline.batch.delay这两个配置，要多测试，调试出最大的索引速率，elasticsearch索引默认是世界时间，可以添加一段ruby的配置将世界时间转换成北京时间，还有去除一些不需要的字段的操作，可以加快搜索速度，节省存储空间
</code></pre>
<ol>
<li><p>官网下载logstash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-7.3.2.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p>解压文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf logstash-7.3.2.tar.gz -C /opt/</span><br><span class="line"><span class="built_in">ln</span> -s /opt/logstash-7.3.2 /opt/logstash</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /opt/logstash/config/logstash.yml </span><br><span class="line">pipeline.workers: 32</span><br><span class="line">pipeline.batch.size: 2500</span><br><span class="line">pipeline.batch.delay: 20</span><br><span class="line">pipeline.output.workers: 32</span><br><span class="line"></span><br><span class="line">http.host: <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">http.port: 9600</span><br><span class="line"></span><br><span class="line">path.config: <span class="string">&quot;/usr/local/logstash/config/yunwei-logstash.conf&quot;</span></span><br><span class="line"></span><br><span class="line">xpack.monitoring.enabled: <span class="literal">true</span></span><br><span class="line">xpack.monitoring.elasticsearch.url: <span class="string">&quot;http://172.20.40.20:9200&quot;</span></span><br><span class="line">xpack.monitoring.collection.interval: 10s</span><br><span class="line">xpack.monitoring.collection.pipeline.details.enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /opt/logstash/config/sre-logstash-prod.conf </span><br><span class="line">input&#123;</span><br><span class="line">    kafka&#123;</span><br><span class="line">        bootstrap_servers =&gt; <span class="string">&quot;172.22.3.61:9092,172.22.3.62:9092,172.22.3.63:9092&quot;</span></span><br><span class="line">        group_id =&gt; <span class="string">&quot;sre-logstash-prod&quot;</span></span><br><span class="line">        topics =&gt; [<span class="string">&quot;nginx-access&quot;</span>, <span class="string">&quot;nginx-error&quot;</span>, <span class="string">&quot;line8-applog&quot;</span>, <span class="string">&quot;tech-applog&quot;</span>]</span><br><span class="line">        consumer_threads =&gt; 24</span><br><span class="line">        codec =&gt; json</span><br><span class="line">        decorate_events =&gt; <span class="literal">false</span></span><br><span class="line">        client_id =&gt; <span class="string">&quot;sre-logstash-prod01&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">    <span class="keyword">if</span> [fields][<span class="built_in">type</span>] == <span class="string">&quot;nginx-access&quot;</span> &#123;</span><br><span class="line">        grok&#123;</span><br><span class="line">            patterns_dir =&gt; [<span class="string">&quot;/opt/logstash/config/pattarns&quot;</span>]</span><br><span class="line">            match =&gt; [<span class="string">&quot;message&quot;</span>,<span class="string">&quot;%&#123;NGINXACCESSLOG&#125;&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        geoip&#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;client_ip&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        mutate&#123;</span><br><span class="line">            convert =&gt; &#123; <span class="string">&quot;request_time&quot;</span> =&gt; <span class="string">&quot;float&quot;</span>&#125;</span><br><span class="line">            convert =&gt; &#123; <span class="string">&quot;response_time&quot;</span> =&gt; <span class="string">&quot;float&quot;</span>&#125;</span><br><span class="line">            convert =&gt; &#123; <span class="string">&quot;response_status&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span>&#125;</span><br><span class="line">            convert =&gt; &#123; <span class="string">&quot;upstream_status&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ruby&#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                    request = event.get(&#x27;request&#x27;)</span></span><br><span class="line"><span class="string">                    if request.include?&#x27;?&#x27;</span></span><br><span class="line"><span class="string">                        request_path = request.split(&#x27;?&#x27;)[0]</span></span><br><span class="line"><span class="string">                        event.set(&#x27;request_path&#x27;, request_path)</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        event.set(&#x27;request_path&#x27;, request)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">date</span>&#123;</span><br><span class="line">            match =&gt; [<span class="string">&quot;logtime&quot;</span>,<span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> [fields][<span class="built_in">type</span>] == <span class="string">&quot;nginx-error&quot;</span> &#123;</span><br><span class="line">        grok&#123;</span><br><span class="line">            patterns_dir =&gt; [<span class="string">&quot;/opt/logstash/config/pattarns&quot;</span>]</span><br><span class="line">            match =&gt; [<span class="string">&quot;message&quot;</span>,<span class="string">&quot;%&#123;NGINXERRORLOG&#125;&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> [fields][<span class="built_in">type</span>] <span class="keyword">in</span> [<span class="string">&quot;line8-applog&quot;</span>, <span class="string">&quot;tech-applog&quot;</span>] &#123;</span><br><span class="line">        grok&#123;</span><br><span class="line">            patterns_dir =&gt; [<span class="string">&quot;/opt/logstash/config/pattarns&quot;</span>]</span><br><span class="line">            match =&gt; [<span class="string">&quot;message&quot;</span>,<span class="string">&quot;%&#123;APPLOG&#125;&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        ruby&#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;event.set(&#x27;project_name&#x27;, event.get(&#x27;[log][file][path]&#x27;).split(&#x27;/&#x27;)[-1].sub(&#x27;.log&#x27;, &#x27;&#x27;))&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ruby&#123;</span><br><span class="line">        code =&gt; <span class="string">&quot;event.set(&#x27;day&#x27;, (event.get(&#x27;@timestamp&#x27;).time.localtime + 8*60*60).strftime(&#x27;%Y.%m.%d&#x27;))&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    grok&#123;</span><br><span class="line">        overwrite =&gt; [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    mutate&#123;</span><br><span class="line">        add_field =&gt; &#123;<span class="string">&#x27;topic&#x27;</span> =&gt; <span class="string">&quot;%&#123;[fields][type]&#125;&quot;</span>&#125;</span><br><span class="line">        remove_field =&gt; [<span class="string">&quot;@version&quot;</span>,<span class="string">&quot;agent&quot;</span>,<span class="string">&quot;input&quot;</span>,<span class="string">&quot;ecs&quot;</span>,<span class="string">&quot;tags&quot;</span>,<span class="string">&quot;fields&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts=&gt; [<span class="string">&quot;172.22.3.69:9200&quot;</span>, <span class="string">&quot;172.22.3.70:9200&quot;</span>, <span class="string">&quot;172.22.3.71:9200&quot;</span>]</span><br><span class="line">    index =&gt; <span class="string">&quot;logstash-%&#123;topic&#125;-%&#123;day&#125;&quot;</span></span><br><span class="line">    user =&gt; <span class="string">&quot;elastic&quot;</span></span><br><span class="line">    password =&gt; <span class="string">&quot;xxx&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>systemd启动服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/systemd/system/logstash.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=logstash</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=akulaku</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">ExecStart=/opt/logstash/bin/logstash</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill -s QUIT \$MAINPID</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>####kibana安装</p>
<blockquote>
<p>kibana配置可以很低，前面最好加一个nginx，可以打印出访问日志</p>
</blockquote>
<ol>
<li><p>官网下载kibana</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://artifacts.elastic.co/downloads/kibana/kibana-7.3.2-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf kibana-7.3.2-linux-x86_64.tar.gz -C /opt/</span><br><span class="line"><span class="built_in">ln</span> -s /opt/kibana-7.3.2-linux-x86_64 /opt/kibana</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/opt/kibana/config/kibana.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server.host: &quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="string">server.port: 5601</span></span><br><span class="line"><span class="string">server.maxPayloadBytes: 1048576</span></span><br><span class="line"><span class="string">server.name: &quot;sre-kibana-prod01&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">elasticsearch.hosts: &quot;http://172.22.3.69:9200&quot;</span></span><br><span class="line"><span class="string">elasticsearch.pingTimeout: 1500</span></span><br><span class="line"><span class="string">elasticsearch.requestTimeout: 60000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">logging.quiet: true</span></span><br><span class="line"><span class="string">ops.interval: 5000</span></span><br><span class="line"><span class="string">i18n.locale: &#x27;cn&#x27;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>systemd启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/systemd/system/kibana.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=kibana</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=akulaku</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">ExecStart=/opt/kibana/bin/kibana</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill -s QUIT \$MAINPID</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="openresty代理"><a href="#openresty代理" class="headerlink" title="openresty代理"></a>openresty代理</h4><blockquote>
<p>kibana和elasticsearch前面加上openresty代理，可以做到请求负载均衡和打印访问日志</p>
</blockquote>
<ol>
<li>openresty配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /usr/local/openresty/nginx/conf/vhost/localhost.conf </span><br><span class="line">upstream yunwei_elasticsearch &#123;</span><br><span class="line">    zone zone_for_yunwei_elasticsearch 2m;</span><br><span class="line">    server 172.20.40.14:9200 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    server 172.20.40.15:9200 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    server 172.20.40.16:9200 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    server 172.20.40.17:9200 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    server 172.20.40.18:9200 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    ip_hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream yunwei_kibana &#123;</span><br><span class="line">    zone zone_for_yunwei_kibana 2m;</span><br><span class="line">    server 172.20.40.20:5601 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    ip_hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://yunwei_kibana;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9200;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://yunwei_elasticsearch;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="elasticsearch使用"><a href="#elasticsearch使用" class="headerlink" title="elasticsearch使用"></a>elasticsearch使用</h3><h4 id="x-park插件sql查询"><a href="#x-park插件sql查询" class="headerlink" title="x-park插件sql查询"></a>x-park插件sql查询</h4><blockquote>
<p>x-park可以支持直接使用sql语法从elasticsearch查询数据</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /_xpack/sql?format=txt</span><br><span class="line">&#123;<span class="string">&quot;query&quot;</span>:<span class="string">&quot;select \&quot;@timestamp\&quot;,message from \&quot;logstash-architecture-*\&quot; where fields.app=&#x27;message-sms&#x27; and message like &#x27;%Notice%&#x27; and \&quot;@timestamp\&quot;&gt;&#x27;2018-08-16T16:00:00.000Z&#x27;&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改所有索引备份数"><a href="#修改所有索引备份数" class="headerlink" title="修改所有索引备份数"></a>修改所有索引备份数</h4><blockquote>
<p>建议number_of_shards为机器数量，不重要的服务，如日志服务number_of_replicas可以设置为0，不需要搜索实时性可以设置refresh_interval大一点，减小elasticsearch压力</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT _all/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index&quot;</span>: &#123;</span><br><span class="line">     <span class="string">&quot;number_of_shards&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">     <span class="string">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">     <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;10s&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>####关闭字段_all</p>
<blockquote>
<p>_all带来搜索方便，其代价是增加了系统在索引阶段对CPU和存储空间资源的开销</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT _all/_mappings</span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;_default_&quot;</span>: &#123;</span><br><span class="line">     <span class="string">&quot;_all&quot;</span>: &#123;</span><br><span class="line">       <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查看所有索引信息"><a href="#查看所有索引信息" class="headerlink" title="查看所有索引信息"></a>查看所有索引信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices</span><br></pre></td></tr></table></figure>

<h4 id="elasticsearch升级"><a href="#elasticsearch升级" class="headerlink" title="elasticsearch升级"></a>elasticsearch升级</h4><ol>
<li><p>禁用分片分配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.enable&quot;</span>: <span class="string">&quot;primaries&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止非必要索引并执行同步刷新（可选）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST _flush/synced</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止并升级单个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop elasticsearch.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动已升级的节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/nodes</span><br></pre></td></tr></table></figure></li>
<li><p>重新启用分片分配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.enable&quot;</span>: <span class="string">&quot;all&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>等待节点恢复</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/health</span><br><span class="line">GET /_cat/recovery</span><br></pre></td></tr></table></figure>
</li>
<li><p>重复操作</p>
</li>
</ol>
<h4 id="elasticsearch清理n天之前的索引"><a href="#elasticsearch清理n天之前的索引" class="headerlink" title="elasticsearch清理n天之前的索引"></a>elasticsearch清理n天之前的索引</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">delete_day_ago = <span class="number">6</span></span><br><span class="line">elasticsearch_url = <span class="string">&#x27;http://172.22.3.78:9200&#x27;</span></span><br><span class="line">auth_user = (<span class="string">&#x27;elastic&#x27;</span>, <span class="string">&#x27;123&#x27;</span>)</span><br><span class="line"></span><br><span class="line">res = requests.get(<span class="string">&#x27;&#123;&#125;/_cat/indices&#x27;</span>.<span class="built_in">format</span>(elasticsearch_url), auth=auth_user)</span><br><span class="line">index_list = res.text.split()[<span class="number">2</span>::<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">index_expired_day = time.strftime(<span class="string">&quot;%Y.%m.%d&quot;</span>, time.localtime(time.time() - delete_day_ago * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>))</span><br><span class="line">index_expired_timestamp = time.mktime(time.strptime(index_expired_day, <span class="string">&#x27;%Y.%m.%d&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> index_list:</span><br><span class="line">    <span class="keyword">if</span> index.startswith(<span class="string">&#x27;logstash-&#x27;</span>):</span><br><span class="line">        index_day = index[-<span class="number">10</span>:]</span><br><span class="line">        index_timestamp = time.mktime(time.strptime(index_day, <span class="string">&#x27;%Y.%m.%d&#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(index_timestamp) &lt; index_expired_timestamp:</span><br><span class="line">            requests.delete(<span class="string">&#x27;&#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(elasticsearch_url,index), auth=auth_user)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;DELETE: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(index))</span><br></pre></td></tr></table></figure>

<h4 id="ik分词使用"><a href="#ik分词使用" class="headerlink" title="ik分词使用"></a>ik分词使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;安徽省长江流域&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="kafka的基本命令使用"><a href="#kafka的基本命令使用" class="headerlink" title="kafka的基本命令使用"></a>kafka的基本命令使用</h3><h4 id="列出所有可用的topic"><a href="#列出所有可用的topic" class="headerlink" title="列出所有可用的topic"></a>列出所有可用的topic</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br></pre></td></tr></table></figure>

<h4 id="新建topic命令-partitions为kafka节点倍数"><a href="#新建topic命令-partitions为kafka节点倍数" class="headerlink" title="新建topic命令(partitions为kafka节点倍数)"></a>新建topic命令(partitions为kafka节点倍数)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh -zookeeper localhost:2181 -replication-factor 2 -partitions 12 -create -topic line8-applog</span><br></pre></td></tr></table></figure>
<h4 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a>删除topic</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --delete --zookeeper localhost:2181 --topic line8-applog</span><br></pre></td></tr></table></figure>

<h4 id="彻底删除Kafka中的topic"><a href="#彻底删除Kafka中的topic" class="headerlink" title="彻底删除Kafka中的topic"></a>彻底删除Kafka中的topic</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/zkCli.sh</span><br><span class="line">deleteall /brokers/topics/line8-applog</span><br><span class="line">deleteall /admin/delete_topics/line8-applog</span><br></pre></td></tr></table></figure>

<h4 id="查看kafka数据"><a href="#查看kafka数据" class="headerlink" title="查看kafka数据"></a>查看kafka数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-consumer-groups.sh --bootstrap-server 172.22.3.61:9092 --describe --group sre-logstash-prod --topic nginx-access</span><br></pre></td></tr></table></figure>

<h4 id="调整topic分片数"><a href="#调整topic分片数" class="headerlink" title="调整topic分片数"></a>调整topic分片数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --alter --topic nginx-access --zookeeper localhost:2181 --partitions 9</span><br></pre></td></tr></table></figure>

<h4 id="单个topic修改数据过期时间"><a href="#单个topic修改数据过期时间" class="headerlink" title="单个topic修改数据过期时间"></a>单个topic修改数据过期时间</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-configs.sh --zookeeper localhost:2181  --entity-type topics --alter --entity-name line8-applog --add-config retention.ms=86400000</span><br></pre></td></tr></table></figure>

<h4 id="查看topic配置"><a href="#查看topic配置" class="headerlink" title="查看topic配置"></a>查看topic配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-configs.sh --zookeeper localhost:2181 --entity-type topics --describe --entity-name line8-applog</span><br></pre></td></tr></table></figure>

<h4 id="命令行从头开始消费数据"><a href="#命令行从头开始消费数据" class="headerlink" title="命令行从头开始消费数据"></a>命令行从头开始消费数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-console-consumer.sh --bootstrap-server 172.22.3.61:9092 --topic line8-applog --from-beginning</span><br></pre></td></tr></table></figure>

<h4 id="修改topic的备份数量"><a href="#修改topic的备份数量" class="headerlink" title="修改topic的备份数量"></a>修改topic的备份数量</h4><h5 id="查看当前的topic信息"><a href="#查看当前的topic信息" class="headerlink" title="查看当前的topic信息"></a>查看当前的topic信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --zookeeper localhost:2181 --describe  --topic line8-applog</span><br></pre></td></tr></table></figure>

<h5 id="编辑修改的策略文件replication-json"><a href="#编辑修改的策略文件replication-json" class="headerlink" title="编辑修改的策略文件replication.json"></a>编辑修改的策略文件replication.json</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;line8-applog&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;replicas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">3</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;line8-applog&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;replicas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">1</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;line8-applog&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;replicas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">2</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="执行策略"><a href="#执行策略" class="headerlink" title="执行策略"></a>执行策略</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file replication.json --execute</span><br></pre></td></tr></table></figure>

<h5 id="查看进度"><a href="#查看进度" class="headerlink" title="查看进度"></a>查看进度</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file replication.json --verify</span><br></pre></td></tr></table></figure>

<h5 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-console-producer.sh --broker-list 172.22.3.61:9092 --topic line8-applog</span><br></pre></td></tr></table></figure>

<h5 id="python测试"><a href="#python测试" class="headerlink" title="python测试"></a>python测试</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> kafka <span class="keyword">import</span> KafkaProducer</span><br><span class="line"></span><br><span class="line">kafka_obj = KafkaProducer(bootstrap_servers=[<span class="string">&#x27;172.22.3.61:9092&#x27;</span>])</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;11010119900300&quot;</span>,<span class="string">&quot;account&quot;</span>:<span class="string">&quot;1000&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(data).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">res = kafka_obj.send(<span class="string">&#x27;line8-applog&#x27;</span>, <span class="built_in">str</span>(data).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">kafka_obj.flush()</span><br><span class="line">kafka_obj.close()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/docker%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/docker%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">docker的安装配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-11T00:00:00+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:12:17" itemprop="dateModified" datetime="2022-12-14T16:12:17+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>容器是linux支持的</p>
<p>容器的隔离</p>
<p><code>chroot</code>：隔离分区<br><code>cgroup</code>：隔离资源（CPU、内存）<br><code>netns</code>：隔离网络<br>namespace<br>ipc</p>
<p>docker安装前提</p>
<p>3.0以后版本的内核</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># uname -r</span></span><br><span class="line">3.10.0-229.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>实验环境</p>
<table>
<thead>
<tr>
<th align="left">docker节点</th>
<th align="left">机器域名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">控制节点</td>
<td align="left">master.pod0.example.com</td>
</tr>
<tr>
<td align="left">计算节点</td>
<td align="left">node.pod0.example.com</td>
</tr>
</tbody></table>
<p>master节点安装docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@foundation0 ~]<span class="comment"># ssh root@master.pod0.example.com</span></span><br><span class="line">[root@master ~]<span class="comment"># yum -y install docker</span></span><br></pre></td></tr></table></figure>

<p>启动docker服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># systemctl enable docker</span></span><br><span class="line">[root@master ~]<span class="comment"># systemctl start docker</span></span><br></pre></td></tr></table></figure>


<p>docker子命令不能tab补齐，安装bash命令补齐工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># yum -y install bash-completion</span></span><br><span class="line">[root@master ~]<span class="comment"># su -</span></span><br><span class="line">[root@master ~]<span class="comment"># docker </span></span><br><span class="line">attach   commit   create   events   <span class="built_in">export</span>   <span class="built_in">history</span>  import   inspect  load     <span class="built_in">logout</span>   pause    ps       push     restart  rmi      save     start    stop     top      version  </span><br><span class="line">build    <span class="built_in">cp</span>       diff     <span class="built_in">exec</span>     <span class="built_in">help</span>     images   info     <span class="built_in">kill</span>     login    logs     port     pull     rename   <span class="built_in">rm</span>       run      search   stats    tag      unpause  <span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<p>查看docker版本,docker是使用go语言写的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker version</span></span><br><span class="line">Client version: 1.7.1</span><br><span class="line">Client API version: 1.19</span><br><span class="line">Package Version (client): docker-1.7.1-108.el7.x86_64</span><br><span class="line">Go version (client): go1.4.2</span><br><span class="line">Git commit (client): 3043001/1.7.1</span><br><span class="line">OS/Arch (client): linux/amd64</span><br><span class="line">Server version: 1.7.1</span><br><span class="line">Server API version: 1.19</span><br><span class="line">Package Version (server): docker-1.7.1-108.el7.x86_64</span><br><span class="line">Go version (server): go1.4.2</span><br><span class="line">Git commit (server): 3043001/1.7.1</span><br><span class="line">OS/Arch (server): linux/amd64</span><br></pre></td></tr></table></figure>

<p>容器和镜像</p>
<p>需要先有镜像，docker所有的镜像都是分层的tar包，分层利于二次修改，底层镜像尽量使用厂商的镜像</p>
<p>镜像启动之后就是容器</p>
<p>docker的配置文件中修改docker仓库的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># vim /etc/sysconfig/docker</span></span><br><span class="line">ADD_REGISTRY=<span class="string">&#x27;--add-registry workstation.pod0.example.com:5000&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在不使用证书加密的情况下，加入信任的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSECURE_REGISTRY=<span class="string">&#x27;--insecure-registry workstation.pod0.example.com:5000&#x27;</span></span><br></pre></td></tr></table></figure>

<p>把docker官网加入黑名单，不到docker官网搜索镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BLOCK_REGISTRY=<span class="string">&#x27;--block-registry docker.io&#x27;</span></span><br></pre></td></tr></table></figure>

<p>修改配置文件后重启生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<p>docker搜索镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker search rhel7</span></span><br><span class="line">INDEX         NAME                                                            DESCRIPTION   STARS     OFFICIAL   AUTOMATED</span><br><span class="line">example.com   workstation.pod0.example.com:5000/library/rhel7                               0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/mysql-55-rhel7                   0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/nodejs-010-rhel7                 0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/php-55-rhel7                     0                    </span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift3/ruby-20-rhel7                    0</span><br></pre></td></tr></table></figure>

<p>下载rhel7镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker pull rhel7</span></span><br></pre></td></tr></table></figure>

<p>查看本地镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">workstation.pod0.example.com:5000/rhel7   latest              275be1d3d070        22 months ago       158.3 MB</span><br></pre></td></tr></table></figure>
<p>docker的工作目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cd /var/lib/docker/</span></span><br><span class="line">[root@master docker]<span class="comment"># ls</span></span><br><span class="line">containers  devicemapper  graph  init  linkgraph.db  repositories-devicemapper  tmp  trust  volumes</span><br></pre></td></tr></table></figure>

<p>docker启动后的临时文件在containers目录中</p>
<p>运行rhel7镜像，打开bash服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker run -it rhel7 bash</span></span><br><span class="line">Usage of loopback devices is strongly discouraged <span class="keyword">for</span> production use. Either use `--storage-opt dm.thinpooldev` or u</span><br><span class="line">se `--storage-opt dm.no_warn_on_loop_devices=<span class="literal">true</span>` to suppress this warning.</span><br><span class="line">[root@48632bcb1e45 /]<span class="comment"># ls</span></span><br><span class="line">bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure>

<p><code>-i</code>：交互式界面<br><code>-t</code>：打开一个命令行终端<br><code>-d</code>：启动后放到后台运行</p>
<p>发现容器是一个独立的系统，有自己的根分区</p>
<p>查看启动的容器任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">7b34f87319b2        rhel7               <span class="string">&quot;bash&quot;</span>              2 minutes ago       Up About a minute                       adoring_hoover</span><br></pre></td></tr></table></figure>

<p>查看容器的进程列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker top 7b34f87319b2</span></span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                1044                711                 0                   09:22               pts/2               00:00:00            bash</span><br></pre></td></tr></table></figure>

<p>持久化存储需要挂载外部存储设备</p>
<p>停止和启动docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker stop 7b34f87319b2</span></span><br><span class="line">7b34f87319b2</span><br><span class="line">[root@master ~]<span class="comment"># docker start 7b34f87319b2</span></span><br><span class="line">7b34f87319b2</span><br></pre></td></tr></table></figure>

<p>下载hello-openshift镜像,镜像里面有一个8080端口的jboss服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker search hello</span></span><br><span class="line">INDEX         NAME                                                          DESCRIPTION   STARS     OFFICIAL   AUTOMATED</span><br><span class="line">example.com   workstation.pod0.example.com:5000/openshift/hello-openshift                 0 </span><br><span class="line">[root@master ~]<span class="comment"># docker pull openshift/hello-openshift</span></span><br></pre></td></tr></table></figure>

<p>启动hello-openshift镜像，把容器的8080端口映射到物理机的18080端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker run -p 18080:8080 openshift/hello-openshift</span></span><br><span class="line">Usage of loopback devices is strongly discouraged <span class="keyword">for</span> production use. Either use `--storage-opt dm.thinpooldev` or use `--storage-opt dm.no_warn_</span><br><span class="line">on_loop_devices=<span class="literal">true</span>` to suppress this warning.</span><br><span class="line">serving on 8080</span><br><span class="line">serving on 8888</span><br></pre></td></tr></table></figure>

<p>查看容器启动的进程，可以看到状况映射的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND              CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">7ed43f0360a5        openshift/hello-openshift   <span class="string">&quot;/hello-openshift&quot;</span>   3 minutes ago       Up 3 minutes        8888/tcp, 0.0.0.0:18080-&gt;8080/tcp   clever_sinoussi</span><br></pre></td></tr></table></figure>

<p>查看容器的所有信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker inspect 7ed43f0360a5</span></span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;Id&quot;</span>: <span class="string">&quot;7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4&quot;</span>,</span><br><span class="line"><span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2017-06-12T02:37:32.33856856Z&quot;</span>,</span><br><span class="line"><span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/hello-openshift&quot;</span>,</span><br><span class="line"><span class="string">&quot;Args&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Running&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;Paused&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Restarting&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;OOMKilled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Dead&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Pid&quot;</span>: 1414,</span><br><span class="line"><span class="string">&quot;ExitCode&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2017-06-12T02:37:33.008916483Z&quot;</span>,</span><br><span class="line"><span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Image&quot;</span>: <span class="string">&quot;0f7a086fa28fd211eb84e4b88c3aadca2eabb3dc02eba94bd4e5efaf2ba65ee5&quot;</span>,</span><br><span class="line"><span class="string">&quot;NetworkSettings&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Bridge&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;dfb34bb05f5e8b49a339e7403d210910ecef129c9962421fda1d48eb0c548c37&quot;</span>,</span><br><span class="line"><span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.42.1&quot;</span>,</span><br><span class="line"><span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;HairpinMode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.3&quot;</span>,</span><br><span class="line"><span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line"><span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;LinkLocalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;LinkLocalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line"><span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;ad45105bbd0e776c6770a2c3587049f033ed0bb7c05c9eacf6fddafa230478e7&quot;</span>,</span><br><span class="line"><span class="string">&quot;PortMapping&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Ports&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;8080/tcp&quot;</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;18080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;8888/tcp&quot;</span>: null</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;SandboxKey&quot;</span>: <span class="string">&quot;/var/run/docker/netns/7ed43f0360a5&quot;</span>,</span><br><span class="line"><span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;SecondaryIPv6Addresses&quot;</span>: null</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;ResolvConfPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/resolv.conf&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostnamePath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/hostname&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostsPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/hosts&quot;</span>,</span><br><span class="line"><span class="string">&quot;LogPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1cc3adb5a4e4/7ed43f0360a5dd09d2541e12d934569157ddec0754359cac592f1</span></span><br><span class="line"><span class="string">cc3adb5a4e4-json.log&quot;</span>,    <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;/clever_sinoussi&quot;</span>,</span><br><span class="line"><span class="string">&quot;RestartCount&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;devicemapper&quot;</span>,</span><br><span class="line"><span class="string">&quot;ExecDriver&quot;</span>: <span class="string">&quot;native-0.2&quot;</span>,</span><br><span class="line"><span class="string">&quot;MountLabel&quot;</span>: <span class="string">&quot;system_u:object_r:svirt_sandbox_file_t:s0:c882,c888&quot;</span>,</span><br><span class="line"><span class="string">&quot;ProcessLabel&quot;</span>: <span class="string">&quot;system_u:system_r:svirt_lxc_net_t:s0:c882,c888&quot;</span>,</span><br><span class="line"><span class="string">&quot;Volumes&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;VolumesRW&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;AppArmorProfile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;ExecIDs&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;HostConfig&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Binds&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ContainerIDFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;LxcConf&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;Memory&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;MemorySwap&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;CpuShares&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;CpuPeriod&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;CpusetCpus&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;CpusetMems&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;CpuQuota&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;BlkioWeight&quot;</span>: 0,</span><br><span class="line"><span class="string">&quot;OomKillDisable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Privileged&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;PortBindings&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;8080/tcp&quot;</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;HostIp&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;HostPort&quot;</span>: <span class="string">&quot;18080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;PublishAllPorts&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Dns&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;DnsSearch&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ExtraHosts&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;VolumesFrom&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Devices&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;NetworkMode&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line"><span class="string">&quot;IpcMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;PidMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;UTSMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;CapAdd&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;CapDrop&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;RestartPolicy&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Name&quot;</span>: <span class="string">&quot;no&quot;</span>,</span><br><span class="line"><span class="string">&quot;MaximumRetryCount&quot;</span>: 0</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;SecurityOpt&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ReadonlyRootfs&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Ulimits&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;LogConfig&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Type&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line"><span class="string">&quot;Config&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;CgroupParent&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;7ed43f0360a5&quot;</span>,</span><br><span class="line"><span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;PortSpecs&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;8080/tcp&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;8888/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;Env&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Cmd&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Image&quot;</span>: <span class="string">&quot;openshift/hello-openshift&quot;</span>,</span><br><span class="line"><span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;VolumeDriver&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;Entrypoint&quot;</span>: [</span><br><span class="line"><span class="string">&quot;/hello-openshift&quot;</span></span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;NetworkDisabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line"><span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&quot;Init&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>从容器的信息中查找容器的ip地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker inspect 7ed43f0360a5 |grep -iw ipaddress</span></span><br><span class="line"><span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.3&quot;</span>,</span><br></pre></td></tr></table></figure>

<p>访问容器里面的服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># curl http://172.17.0.3:8080</span></span><br><span class="line">Hello OpenShift!</span><br></pre></td></tr></table></figure>

<p>安装完docker后自动生成一个docker的虚拟网卡，相当于一个虚拟交换机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># ifconfig docker0</span></span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">inet 172.17.42.1  netmask 255.255.0.0  broadcast 0.0.0.0</span><br><span class="line">inet6 fe80::5484:7aff:fefe:9799  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">ether 56:84:7a:fe:97:99  txqueuelen 0  (Ethernet)</span><br><span class="line">RX packets 27  bytes 1810 (1.7 KiB)</span><br><span class="line">RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">TX packets 16  bytes 1247 (1.2 KiB)</span><br><span class="line">TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

<p>访问本机的18080端口效果是一样的，这就是docker端口映射</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># curl http://master.pod0.example.com:18080</span></span><br><span class="line">Hello OpenShift!</span><br></pre></td></tr></table></figure>

<p>查看所有的容器，包含停止运行的容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                      PORTS               NAMES</span><br><span class="line">7b34f87319b2        rhel7               <span class="string">&quot;bash&quot;</span>              14 hours ago        Exited (137) 12 hours ago                       adoring_hoover</span><br></pre></td></tr></table></figure>

<p>删除容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker stop 16cf4aa41625</span></span><br><span class="line">16cf4aa41625</span><br><span class="line">[root@master ~]<span class="comment"># docker rm 16cf4aa41625</span></span><br><span class="line">16cf4aa41625</span><br></pre></td></tr></table></figure>

<p>删除镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                                                    TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">workstation.pod0.example.com:5000/openshift/hello-openshift   latest              0f7a086fa28f        22 months ago       5.77 MB</span><br><span class="line">workstation.pod0.example.com:5000/rhel7                       latest              275be1d3d070        22 months ago       158.3 MB</span><br><span class="line">[root@master ~]<span class="comment"># docker rmi 0f7a086fa28f</span></span><br><span class="line">Untagged: workstation.pod0.example.com:5000/openshift/hello-openshift:latest</span><br><span class="line">Deleted: 0f7a086fa28fd211eb84e4b88c3aadca2eabb3dc02eba94bd4e5efaf2ba65ee5</span><br><span class="line">Deleted: 0b3f61faa394f34f8444abf70ffc3ffe52fd913bd58cdc2a3de7366b007e7d73</span><br><span class="line">Deleted: 77bb0f21469da7badd05d18664260c33d7e2fc81766715c3aac3f2d0e5e93ad0</span><br><span class="line">Deleted: 66849f7009a5237fb9651fa489555256b15a0df0415d9927fe828345804bbe2c</span><br></pre></td></tr></table></figure>

<p>把下载的镜像标准输出到tar包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># docker save 0f7a086fa28f &gt; hello-openshift.tar</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://keemozhang.com/2017/07/11/gpg%E5%8A%A0%E8%A7%A3%E5%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="keemozhang">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己的无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="keemozhang blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/11/gpg%E5%8A%A0%E8%A7%A3%E5%AF%86/" class="post-title-link" itemprop="url">使用GPG加密解密步骤</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-11 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-11T00:00:00+08:00">2017-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-14 16:12:17" itemprop="dateModified" datetime="2022-12-14T16:12:17+08:00">2022-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>安装gpg软件包<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># yum -y install gnupg</span></span><br></pre></td></tr></table></figure></li>
<li>生成密钥对<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># gpg --gen-key</span></span><br><span class="line">Please select what kind of key you want:</span><br><span class="line">(1) RSA and RSA (default)</span><br><span class="line">(2) DSA and Elgamal</span><br><span class="line">(3) DSA (sign only)</span><br><span class="line">(4) RSA (sign only)</span><br><span class="line">Your selection?1 <span class="comment">###直接回车，默认加密方式</span></span><br><span class="line">RSA keys may be between 1024 and 4096 bits long.</span><br><span class="line">What keysize <span class="keyword">do</span> you want? (2048) <span class="comment">###直接回车，默认秘钥长度</span></span><br><span class="line">Please specify how long the key should be valid.</span><br><span class="line">0 = key does not expire</span><br><span class="line">&lt;n&gt;  = key expires <span class="keyword">in</span> n days</span><br><span class="line">&lt;n&gt;w = key expires <span class="keyword">in</span> n weeks</span><br><span class="line">&lt;n&gt;m = key expires <span class="keyword">in</span> n months</span><br><span class="line">&lt;n&gt;y = key expires <span class="keyword">in</span> n years</span><br><span class="line">Key is valid <span class="keyword">for</span>? (0) <span class="comment">###直接回车，秘钥不过期</span></span><br><span class="line">Is this correct? (y/N)y <span class="comment">###“y”，确认</span></span><br><span class="line">Real name: welab <span class="comment">##输入姓名“welab”</span></span><br><span class="line">Email address:  <span class="comment">###可以不填</span></span><br><span class="line">Comment: <span class="comment">###可以不填</span></span><br><span class="line">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O <span class="comment">###&quot;O&quot;确认信息正确</span></span><br><span class="line">Passphrase ************* <span class="comment">###输入私钥的保护密码&quot;xxx&quot;</span></span><br><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line">some other action (<span class="built_in">type</span> on the keyboard, move the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance to gain enough entropy. <span class="comment">###这时候需要一些动作帮助生成秘钥</span></span><br><span class="line">gpg: checking the trustdb</span><br><span class="line">gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</span><br><span class="line">gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</span><br><span class="line">pub   2048R/C2673128 2017-05-17</span><br><span class="line">Key fingerprint = 853E BF25 AAEB 7DD7 42AD  F6E0 A13E DDBA C267 3128</span><br><span class="line">uid                  welab</span><br><span class="line">sub   2048R/62345630 2017-05-17 <span class="comment">###秘钥生成成功</span></span><br></pre></td></tr></table></figure></li>
<li>查看生成的公私钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># gpg -K ###查看公钥</span></span><br><span class="line">/root/.gnupg/secring.gpg</span><br><span class="line">------------------------</span><br><span class="line">sec   2048R/C2673128 2017-05-17</span><br><span class="line">uid                  welab</span><br><span class="line">ssb   2048R/62345630 2017-05-17</span><br><span class="line">[root@student01 ~]<span class="comment"># gpg -k</span></span><br><span class="line">/root/.gnupg/pubring.gpg <span class="comment">###查看私钥</span></span><br><span class="line">------------------------</span><br><span class="line">pub   2048R/C2673128 2017-05-17</span><br><span class="line">uid                  welab</span><br><span class="line">sub   2048R/62345630 2017-05-17</span><br></pre></td></tr></table></figure></li>
<li>导出公私钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># gpg --export -a C2673128 -o welab_C2673128_pub.key ##导出公钥</span></span><br><span class="line">[root@student01 ~]<span class="comment"># gpg --export-secret-keys -a C2673128 -o C2673128_welab_sec.key ###导出私钥</span></span><br></pre></td></tr></table></figure></li>
<li>将公钥发送给合作伙伴<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># scp C2673128_welab_pub.key root@student02:/root/</span></span><br></pre></td></tr></table></figure></li>
<li>导入合作伙伴公钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># gpg --import C2673128_welab_pub.key</span></span><br></pre></td></tr></table></figure></li>
<li>合作伙伴使用公钥加密文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># echo test &gt;test.txt</span></span><br><span class="line">[root@student02 ~]<span class="comment"># gpg -aer C2673128 test.txt ###指定公钥加密文件</span></span><br><span class="line">gpg: 62345630: There is no assurance this key belongs to the named user</span><br><span class="line"></span><br><span class="line">pub  2048R/62345630 2017-05-17 welab</span><br><span class="line">Primary key fingerprint: 853E BF25 AAEB 7DD7 42AD  F6E0 A13E DDBA C267 3128</span><br><span class="line">Subkey fingerprint: 1705 894F 9842 52CA 9BC8  10BA AC23 FFC1 6234 5630</span><br><span class="line"></span><br><span class="line">It is NOT certain that the key belongs to the person named</span><br><span class="line"><span class="keyword">in</span> the user ID.  If you *really* know what you are doing,</span><br><span class="line">you may answer the next question with <span class="built_in">yes</span>.</span><br><span class="line"></span><br><span class="line">Use this key anyway? (y/N) y <span class="comment">###使用key</span></span><br><span class="line">[root@student02 ~]<span class="comment"># ls test.txt.asc </span></span><br><span class="line">test.txt.asc <span class="comment">###生成加密文件</span></span><br></pre></td></tr></table></figure></li>
<li>合作伙伴把加密后的文件发送给我们，我们用私钥解密<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@student02 ~]<span class="comment"># scp test.txt.asc root@student01:/root/</span></span><br><span class="line">[root@student01 ~]<span class="comment"># gpg --passphrase xxx -o test.txt -d test.txt.asc ###输入私钥密码，使用私钥解密文件</span></span><br><span class="line">[root@student01 ~]<span class="comment"># cat test.txt</span></span><br><span class="line"><span class="built_in">test</span> <span class="comment">###文件已解密</span></span><br></pre></td></tr></table></figure></li>
<li>有时需要两台机器都能使用私钥来解密文件，可以把私钥发给第二台机器导入 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@student01 ~]<span class="comment"># scp C2673128_welab_sec.key root@student02:/root/</span></span><br><span class="line">[root@student02 ~]<span class="comment"># gpg --import C2673128_welab_sec.key ###导入私钥</span></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="keemozhang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">keemozhang</p>
  <div class="site-description" itemprop="description">人的一切痛苦，本质上都是对自己的无能的愤怒。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">keemozhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
